Compiling Program: C:\DataFlex Projects\Centros\AppSrc\WebApp.src
Memory Available: 7019065344
1>Use AllWebAppClasses.pkg
Using pre-compiled package ALLWEBAPPCLASSES.PKG
Including file: AllWebAppClasses.x64.pkd    (C:\Program Files\DataFlex 25.0\Pkg\AllWebAppClasses.x64.pkd)
36303>Use cConnection.pkg
36303>Use cWebMenuItem.pkg
36303>Use cSQLExecutor.pkg
Including file: cSQLExecutor.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cSQLExecutor.pkg)
36303>>>Use GlobalFunctionsProcedures.pkg
36303>>>Use cConnection.pkg
36303>>>
36303>>>// The cBaseSQLExecute class is defined in the runtime, we define it here for codesense and
36303>>>// reference but skip compiling it.
36303>>>
36303>>>
36303>>>Struct tSQLColumnInfo
36303>>>    String  sName
36303>>>    Integer iType 
36303>>>    Integer iSize
36303>>>    Integer iDigits
36303>>>    Boolean bNullable
36303>>>    String  sBaseColumnName
36303>>>    String  sBaseTableName
36303>>>    String  sLocalTypeName
36303>>>End_Struct
36303>>>
36303>>>Struct tSQLParamInfo
36303>>>    String sName
36303>>>    String sValue
36303>>>End_Struct
36303>>>
36303>>>Class cSQLExecutor is a cBaseSQLExecutor
36304>>>
36304>>>    Procedure Construct_Object
36306>>>        Forward Send Construct_Object
36308>>>
36308>>>        Property String Private_psConnectionId
36309>>>        Property String Private_psDriverId
36310>>>    End_Procedure
36311>>>
36311>>>    Procedure OnSQLError String SQLState String SQLMessage
36313>>>        Error DFERR_PROGRAM (SFormat("SQLExecutor error: %1 SQLState: %2", SQLMessage, SQLState ))
36314>>>>
36314>>>    End_Procedure
36315>>>    
36315>>>    Procedure OnSQLPreExecute String sSQLQuery
36317>>>    End_Procedure
36318>>>    
36318>>>    Procedure OnSQLPostExecute String sSQLQuery
36320>>>    End_Procedure  
36321>>>
36321>>>    Procedure Set psConnectionId String sConnectionId
36323>>>        Set Private_psConnectionId to sConnectionId
36324>>>        Set piDriverIndex to 0
36325>>>        Set piConnectionIndex to 0  
36326>>>        
36326>>>        Send UpdateConnectionDetails        
36327>>>    End_Procedure
36328>>>
36328>>>    Function psConnectionId Returns String
36330>>>        Function_Return (Private_psConnectionId(Self))
36331>>>    End_Function
36332>>>
36332>>>    Function psDriverId Returns String
36334>>>        Function_Return (Private_psDriverId(Self))
36335>>>    End_Function
36336>>>    
36336>>>    Procedure UpdateConnectionDetails
36338>>>        String  sConnectionId
36338>>>        Get Private_psConnectionId to sConnectionId            
36339>>>        If (sConnectionId <> '') Begin
36341>>>            Send ManagedConnectionDetails sConnectionId
36342>>>        End
36342>>>>
36342>>>        Else Begin
36343>>>            Error DFERR_PROGRAM (SFormat(C_$SQLExecutorNoConnectionId))
36344>>>>
36344>>>        End           
36344>>>>
36344>>>    End_Procedure
36345>>>
36345>>>    Procedure ManagedConnectionDetails String sConnectionId
36347>>>        tConnection ManagedConnection
36347>>>        tConnection ManagedConnection
36347>>>        String  sDriver
36347>>>        Integer iDriverIndex
36347>>>        Boolean bConnectionIsLoggedIn 
36347>>>        Boolean bSuccess
36347>>>        Integer iIndex
36347>>>        Integer iConnectionIndex
36347>>>        
36347>>>        If (ghoConnection) Begin            
36349>>>            Get ConnectionIdIndex of ghoConnection sConnectionId to iIndex
36350>>>            If (iIndex = -1) Begin
36352>>>                Error DFERR_PROGRAM (SFormat(C_$ConnectionIdNotFound,sConnectionId))
36353>>>>
36353>>>            End
36353>>>>
36353>>>            Else Begin
36354>>>                Get ConnectionIdInfo of ghoConnection sConnectionId to ManagedConnection
36355>>>                Move ManagedConnection.sDriver      to sDriver
36356>>>                Move ManagedConnection.iDriverIndex to iDriverIndex
36357>>>                Get IsConnectionIdLoggedIn of ghoConnection sConnectionId to bConnectionIsLoggedIn
36358>>>                If (not(bConnectionIsLoggedIn)) Begin
36360>>>                    Get LoginConnectionId of ghoConnection sConnectionId to bSuccess
36361>>>                    Get IsConnectionIdLoggedIn of ghoConnection sConnectionId to bConnectionIsLoggedIn
36362>>>                End
36362>>>>
36362>>>                If (bConnectionIsLoggedIn) Begin
36364>>>                    Get ConnectionDatabaseIdHandle of ghoConnection ManagedConnection to iConnectionIndex
36365>>>                    
36365>>>                    If (iConnectionIndex) Begin
36367>>>                        Set piConnectionIndex  to iConnectionIndex
36368>>>                        Set piDriverIndex      to iDriverIndex
36369>>>                        Set Private_psDriverId to sDriver
36370>>>                    End
36370>>>>
36370>>>                End
36370>>>>
36370>>>            End
36370>>>>
36370>>>        End
36370>>>>
36370>>>    End_Procedure
36371>>>End_Class
36372>
36372>Object oApplication is a cApplication
36374>    Object oConnection is a cConnection
36376>        Use LoginEncryption.pkg
Including file: LoginEncryption.pkg    (C:\Program Files\DataFlex 25.0\Pkg\LoginEncryption.pkg)
36376>>>Use cLoginEncryption.pkg
Including file: cLoginEncryption.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cLoginEncryption.pkg)
36376>>>>>Use cCryptographerEx.pkg
36376>>>>>
36376>>>>>Class cLoginEncryption is a cObject
36377>>>>>    
36377>>>>>    Procedure Construct_Object
36379>>>>>        Forward Send Construct_Object
36381>>>>>        // this must be set to a multi (40ish) character random key
36381>>>>>        Property String psEncryptPassword ""
36382>>>>>        
36382>>>>>        Object oDataCrypter is a cCryptographerEx
36384>>>>>            Set piHash to CALG_SHA_256
36385>>>>>            Set piCipher to CALG_AES_256
36386>>>>>            Set psProvider to "" //  Not providing a specific provider gives the default provider for the provider type
36387>>>>>            Set piProvider to PROV_RSA_AES
36388>>>>>        End_Object
36389>>>>>    End_Procedure
36390>>>>>    
36390>>>>>    // This can be augmented to return a password encryption key using any
36390>>>>>    // hidden mechanism desired.
36390>>>>>    Function GetEncryptionPassword Returns String
36392>>>>>        String sPassword
36392>>>>>        Get psEncryptPassword to sPassword
36393>>>>>        Function_Return sPassword
36394>>>>>    End_Function
36395>>>>>    
36395>>>>>    // Encrypts a string into an unreadable hash that can later be decrypted using DecryptKey.
36395>>>>>    //
36395>>>>>    // Params:
36395>>>>>    //   sPlainText     String to encrypt.
36395>>>>>    // Returns:
36395>>>>>    //   Base64 encoded hash.
36395>>>>>    Function EncryptPassword String sPlainText Returns String
36397>>>>>        String sEncryptPassword sBase64
36397>>>>>        UChar[] ucBinary
36398>>>>>        Pointer pBase64
36398>>>>>        Integer iVoid
36398>>>>>        
36398>>>>>        //  Encrypt Key
36398>>>>>        Get GetEncryptionPassword to sEncryptPassword
36399>>>>>        If (sEncryptPassword = "") Begin
36401>>>>>            Error DFERR_PROGRAM "No encryption password set"
36402>>>>>>
36402>>>>>        End
36402>>>>>>
36402>>>>>        
36402>>>>>        Get Encrypt of oDataCrypter (StringToUCharArray(sEncryptPassword)) (StringToUCharArray(sPlainText)) to ucBinary
36403>>>>>        
36403>>>>>        If (SizeOfArray(ucBinary) = 0) Begin
36405>>>>>            Error DFERR_PROGRAM "Unable to encrypt database login password"
36406>>>>>>
36406>>>>>            Function_Return ""
36407>>>>>        End
36407>>>>>>
36407>>>>>        
36407>>>>>        //  Encode binary hash to Base64
36407>>>>>        Move (Base64Encode(AddressOf(ucBinary), SizeOfArray(ucBinary))) to pBase64
36408>>>>>        Move (PointerToString(pBase64)) to sBase64
36409>>>>>        Move (Free(pBase64)) to iVoid
36410>>>>>        
36410>>>>>        Function_Return sBase64
36411>>>>>    End_Function
36412>>>>>    
36412>>>>>    
36412>>>>>    // Decrypts the unreadable hash generated by EncryptKey into a readable string.
36412>>>>>    //
36412>>>>>    // Params:
36412>>>>>    //   sBase64EncryptedPassword       Base64 Encrypted password
36412>>>>>    // Returns:
36412>>>>>    //   Readable plain text password
36412>>>>>    Function DecryptPassword String sBase64EncryptedPassword Returns String
36414>>>>>        String sEncryptPassword
36414>>>>>        UChar[] ucBinary ucPlain
36416>>>>>        Boolean bIsHex
36416>>>>>        Integer iLen iVoid
36416>>>>>        Pointer pBinary
36416>>>>>        
36416>>>>>        If (sBase64EncryptedPassword <> "") Begin
36418>>>>>            //  Decode from Base64
36418>>>>>            Move (Base64Decode(AddressOf(sBase64EncryptedPassword), &iLen)) to pBinary
36419>>>>>            
36419>>>>>            Move (ResizeArray(ucBinary, iLen, 0)) to ucBinary
36420>>>>>            Move (MemCopy(AddressOf(ucBinary), pBinary, iLen)) to iVoid
36421>>>>>                        
36421>>>>>            Move (Free(pBinary)) to iVoid
36422>>>>>            
36422>>>>>            //  Encrypted binary hash to string
36422>>>>>            Get GetEncryptionPassword to sEncryptPassword
36423>>>>>            Get Decrypt of oDataCrypter (StringToUCharArray(sEncryptPassword)) ucBinary to ucPlain
36424>>>>>        End
36424>>>>>>
36424>>>>>        
36424>>>>>        Function_Return (UCharArrayToString(ucPlain))
36425>>>>>    End_Function
36426>>>>>End_Class
36427>>>
36427>>>Object oLoginEncryption is a cLoginEncryption
36429>>>
36429>>>    // this must be created in your appsrc directory and must contain an encryption
36429>>>    // key that is set to psEncryptPassword. It will look something like this
36429>>>    //
36429>>>    // Set psEncryptPassword to "JchUAo7W@r.b{<Yk~OONi0nq=sMi[*Rn[A-`Vo)q"
36429>>>    //  
Including file: LoginEncryptionKey.inc    (C:\DataFlex Projects\Centros\AppSrc\LoginEncryptionKey.inc)
36429>>>>// Studio generated login encryption key
36429>>>>Set psEncryptPassword to "nX,`aCLjN<#ah&V#INur~oy)$^b,#I6q2>P:)4@*"
36430>>>>
36430>>>    
36430>>>    // use this to register this object to your cConnection Object. This object
36430>>>    // must be created after the cConnection object
36430>>>    Move Self to ghoLoginEncryption
36431>>>End_Object
36432>    End_Object
36433>End_Object
36434>
36434>
36434>
36434>
36434>Object oWebApp is a cWebApp
36436>    Set psTheme to "Df_Material"
36437>    Set peAlignView to alignCenter
36438>    Set peLoginMode to lmLoginNone
36439>    
36439>    // It is important to set this so that all views will default
36439>    // to drill down style views.
36439>    Set peApplicationStyle to wvsDrillDown   
36440>    Set peApplicationStateMode to asmHistoryAndUrls 
36441>    Set psEncryptPassword to "CA{z(/<Zy2q^w6Gp7Z7z.)Wr#>YCvgJA%}m0z:a,"
36442>
36442>    Object oSQLExecutor is a cSQLExecutor
36444>        Move Self to ghoSQLExecutor
36445>        Set psConnectionId to "Centros"
36446>    End_Object
36447>    
36447>    Object oViewStack is a cWebViewStack
36449>    End_Object
36450>    
36450>    Procedure HideHeader
36453>        WebSet pbRender of oHeaderPanel to False
36454>    End_Procedure
36455>
36455>    Procedure ShowHeader
36458>        WebSet pbRender of oHeaderPanel to True 
36459>    End_Procedure
36460>
36460>    Object oHeaderPanel is a cWebPanel
36462>        Set peRegion to prTop
36463>        Set psCSSClass to "HeaderPanel"
36464>        
36464>        Object oMenuPanel is a cWebPanel
36466>            Set peRegion to prLeft
36467>            Set piWidth to 50
36468>            
36468>            Object oMenuButton is a cWebMenuButton
36470>                Set piMenuHeight to 500
36471>
36471>                Object oDashboard_itm is a cWebMenuItem
36473>                    Set psCaption to C_$Dashboard
36474>                    
36474>                    WebRegisterPath ntNavigateBegin oDashboard
36480>
36480>                    Procedure OnClick
36483>                        Send NavigatePath
36484>                    End_Procedure
36485>                End_Object
36486>
36486>                Object oViewMenu is a cWebMenuItem
36488>                    Set psCaption to C_$View
36489>
36489>                    Object oDummieEmailItem1 is a cWebMenuItem
36491>                        Set psCaption to "DummieEmail"
36492>
36492>                        WebRegisterPath ntNavigateBegin oDummieEmail
36498>
36498>                        Procedure OnClick
36501>                            Forward Send OnClick
36503>                                Send NavigatePath
36504>                        End_Procedure
36505>                    End_Object
36506>
36506>                    Object oDummieDniItem1 is a cWebMenuItem
36508>                        Set psCaption to "DummieDni"
36509>
36509>                        WebRegisterPath ntNavigateBegin oDummieDni
36515>
36515>                        Procedure OnClick
36518>                            Forward Send OnClick
36520>                                Send NavigatePath
36521>                        End_Procedure
36522>                    End_Object
36523>
36523>                    Object oStudentsItem1 is a cWebMenuItem
36525>                        Set psCaption to "Students"
36526>
36526>                        WebRegisterPath ntNavigateBegin oSelectStudents
36532>
36532>                        Procedure OnClick
36535>                            Forward Send OnClick
36537>                                Send NavigatePath
36538>                        End_Procedure
36539>                    End_Object
36540>
36540>                    Object oCentroItem1 is a cWebMenuItem
36542>                        Set psCaption to "Centro"
36543>
36543>                        WebRegisterPath ntNavigateBegin oSelectCentro
36549>
36549>                        Procedure OnClick
36552>                            Forward Send OnClick
36554>                                Send NavigatePath
36555>                        End_Procedure
36556>                    End_Object
36557>                End_Object
36558>
36558>                Object oSignOut_itm is a cWebMenuItem
36560>                    Set psCaption to C_$LogOut
36561>
36561>                    Procedure OnClick
36564>                        Send RequestLogOut of ghoWebSessionManager
36565>                    End_Procedure
36566>                End_Object
36567>            End_Object  
36568>
36568>            Object oBackButton is a cWebButton
36570>                Set psCSSClass to "WebBack_Icon"
36571>                Set pbRender to False
36572>                
36572>                Procedure OnClick
36575>                    Handle hoTop
36575>                    
36575>                    Get TopViewHandle of oViewStack to hoTop
36576>                    If (hoTop > 0) Begin
36578>                        Send NavigateCancel of hoTop 
36579>                    End
36579>                End_Procedure
36580>            End_Object
36581>            
36581>            Send AddClient of oViewStack Self
36582>                
36582>            Procedure OnUpdateViewStack
36585>                Handle hoTop hoDflt
36585>                Integer eMode
36585>                Boolean bTop
36585>                
36585>                WebGet peMode of (Owner(Self)) to eMode
36586>                
36586>                Get TopViewHandle of oViewStack to hoTop
36587>                Get GetDefaultView to hoDflt
36588>                Move (hoTop=0 or hoTop=hoDflt) to bTop
36589>                
36589>                WebSet pbRender of oBackButton to (not(bTop) and eMode >= rmMobile)
36590>                WebSet pbRender of oMenuButton to (bTop or eMode < rmMobile)
36591>            End_Procedure
36592>
36592>        End_Object
36593>
36593>        Object oCaptionPanel is a cWebPanel
36595>            Set piColumnCount to 12
36596>
36596>            Object oCaptionBreadcrumb is a cWebBreadcrumb
36598>                Set peBreadcrumbStyle to crumbCaption
36599>                WebSetResponsive peBreadcrumbStyle rmMobile to crumbDropDown
36600>            End_Object         
36601>        End_Object
36602>        
36602>        Object oActionPanel is a cWebPanel
36604>            Set peRegion to prRight
36605>            Set piColumnCount to 1
36606>            Set piWidth to 120
36607>
36607>            Object oMainActions is a cWebActionBar
36609>                Set psGroupName to "MainActions"
36610>
36610>                Set piColumnSpan to 0
36611>                Set peAlign to alignRight
36612>            End_Object
36613>        End_Object
36614>
36614>        Object oBreadcrumbPanel is a cWebPanel
36616>            Set peRegion to prBottom
36617>            
36617>            Object oHorizontalBreadcrumb is a cWebBreadcrumb
36619>                WebSetResponsive pbRender rmMobile to False
36620>            End_Object         
36621>        End_Object
36622>
36622>    End_Object    
36623>
36623>    Use SessionManager.wo
Including file: SessionManager.wo    (C:\DataFlex Projects\Centros\AppSrc\SessionManager.wo)
36623>>>Use cWebSessionManagerStandard.pkg
Including file: cWebSessionManagerStandard.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cWebSessionManagerStandard.pkg)
36623>>>>>Use cWebSessionManager.pkg
36623>>>>>Use cWebAppSessionDataDictionary.dd
Including file: cWebAppSessionDataDictionary.dd    (C:\Program Files\DataFlex 25.0\Pkg\cWebAppSessionDataDictionary.dd)
36623>>>>>>>Use DataDict.pkg
36623>>>>>>>
36623>>>>>>>Open WebAppSession
Including file: WebAppSession.fd    (C:\DataFlex Projects\Centros\DDSrc\WebAppSession.fd)
36625>>>>>>>Open WebAppUser
Including file: WebAppUser.fd    (C:\DataFlex Projects\Centros\DDSrc\WebAppUser.fd)
36627>>>>>>>
36627>>>>>>>Class cWebAppSessionDataDictionary is a DataDictionary
36628>>>>>>>    Procedure Construct_Object
36630>>>>>>>        Forward Send Construct_Object
36632>>>>>>>
36632>>>>>>>        Set Main_File to WebAppSession.File_Number
36633>>>>>>>
36633>>>>>>>        Set Add_Server_File to WebAppUser.File_Number
36634>>>>>>>
36634>>>>>>>        Set ParentNullAllowed WebAppUser.File_Number to True
36635>>>>>>>
36635>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
36636>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
36637>>>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
36638>>>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
36639>>>>>>>
36639>>>>>>>        Set Field_Checkbox_Values Field WebAppSession.Active to "Y" "N"
36640>>>>>>>        Set Field_Error Field WebAppSession.Active to 500 "Invalid WebAppSession Active State"
36641>>>>>>>    End_Procedure
36642>>>>>>>
36642>>>>>>>    Procedure Creating
36644>>>>>>>        DateTime dtCurrentDateTime
36644>>>>>>>        
36644>>>>>>>        Forward Send Creating
36646>>>>>>>        
36646>>>>>>>        //  Init usecounter
36646>>>>>>>        Move 0 to WebAppSession.UseCount
36647>>>>>>>        
36647>>>>>>>        //  Set the creation and access time to the current time
36647>>>>>>>        Move (CurrentDateTime()) to dtCurrentDateTime
36648>>>>>>>    
36648>>>>>>>        Get TimeToString dtCurrentDateTime to WebAppSession.CreateTime
36649>>>>>>>        Get TimeToString dtCurrentDateTime to WebAppSession.LastAccessTime
36650>>>>>>>        
36650>>>>>>>        Move dtCurrentDateTime to WebAppSession.CreateDate
36651>>>>>>>        Move dtCurrentDateTime to WebAppSession.LastAccessDate
36652>>>>>>>    End_Procedure
36653>>>>>>>    
36653>>>>>>>    //
36653>>>>>>>    //  Converts the given time to an string that can be saved in the database.
36653>>>>>>>    //
36653>>>>>>>    //  Params:
36653>>>>>>>    //      dtTime  Time to convert
36653>>>>>>>    //  Returns:
36653>>>>>>>    //      String with "HH:MM:SS" format
36653>>>>>>>    //
36653>>>>>>>    Function TimeToString DateTime dtTime Returns String
36655>>>>>>>        String sHours sMinutes sSeconds
36655>>>>>>>        
36655>>>>>>>        //  Extract parts
36655>>>>>>>        Move (String(DateGetHour(dtTime))) to sHours
36656>>>>>>>        Move (String(DateGetMinute(dtTime))) to sMinutes
36657>>>>>>>        Move (String(DateGetSecond(dtTime))) to sSeconds
36658>>>>>>>        
36658>>>>>>>        //  Fill out with 0
36658>>>>>>>        If (Length(sHours) = 1) ;            Move ("0" + sHours) to sHours
36661>>>>>>>        If (Length(sMinutes) = 1) ;            Move ("0" + sMinutes) to sMinutes
36664>>>>>>>        If (Length(sSeconds) = 1) ;            Move ("0" + sSeconds) to sSeconds
36667>>>>>>>        
36667>>>>>>>        Function_Return (sHours + ":" + sMinutes + ":" + sSeconds)
36668>>>>>>>    End_Function
36669>>>>>>>    
36669>>>>>>>    //
36669>>>>>>>    //  Sets the time of the datetime variable to the time in the string.
36669>>>>>>>    //
36669>>>>>>>    //  Params:
36669>>>>>>>    //      dtTime  Datetime variable to add time to
36669>>>>>>>    //      sTimeString String with time in the format "HH:MM:SS"
36669>>>>>>>    //  Returns:
36669>>>>>>>    //      dtDateTime with the loaded time
36669>>>>>>>    //
36669>>>>>>>    Function StringToTime DateTime dtTime String sTimeString Returns DateTime
36671>>>>>>>        String sHours sMinutes sSeconds
36671>>>>>>>        
36671>>>>>>>        //  Extract parts
36671>>>>>>>        Move (Mid(sTimeString, 2, 1)) to sHours
36672>>>>>>>        Move (Mid(sTimeString, 2, 4)) to sMinutes
36673>>>>>>>        Move (Mid(sTimeString, 2, 7)) to sSeconds
36674>>>>>>>        
36674>>>>>>>        //  Set to DateTime
36674>>>>>>>        Move (DateSetHour(dtTime, (Integer(sHours)))) to dtTime
36675>>>>>>>        Move (DateSetMinute(dtTime, (Integer(sMinutes)))) to dtTime
36676>>>>>>>        Move (DateSetSecond(dtTime, (Integer(sSeconds)))) to dtTime
36677>>>>>>>        
36677>>>>>>>        Function_Return dtTime
36678>>>>>>>    End_Function
36679>>>>>>>End_Class
36680>>>>>Use cWebAppUserDataDictionary.dd
Including file: cWebAppUserDataDictionary.dd    (C:\Program Files\DataFlex 25.0\Pkg\cWebAppUserDataDictionary.dd)
36680>>>>>>>Use DataDict.pkg
36680>>>>>>>Open WebAppUser
36682>>>>>>>Open WebAppSession
36684>>>>>>>
36684>>>>>>>Class cWebAppUserDataDictionary is a DataDictionary
36685>>>>>>>    
36685>>>>>>>    Procedure Construct_Object
36687>>>>>>>        Forward Send Construct_Object
36689>>>>>>>        Set Main_File to WebAppUser.File_Number
36690>>>>>>>
36690>>>>>>>        Set Add_Client_File to WebAppSession.File_Number
36691>>>>>>>
36691>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
36692>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
36693>>>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
36694>>>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
36695>>>>>>>    End_Procedure
36696>>>>>>>
36696>>>>>>>End_Class
36697>>>>>
36697>>>>>Use cPasswordHasher.pkg
Including file: cPasswordHasher.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cPasswordHasher.pkg)
36697>>>>>>>Use GlobalFunctionsProcedures.pkg
36697>>>>>>>
36697>>>>>>>Define CNG_BCRYPT_HASH_LENGTH           for "HashDigestLength"
36697>>>>>>>
36697>>>>>>>External_Function CNG_BCryptGenRandom "BCryptGenRandom" Bcrypt.dll ;    Handle   hAlgorithm ;    Pointer  pbBuffer ;    UInteger cbBuffer ;    UInteger dwFlags ;    Returns Integer
36698>>>>>>>
36698>>>>>>>External_Function CNG_BCryptOpenAlgorithmProvider "BCryptOpenAlgorithmProvider" Bcrypt.dll ;    Pointer  phAlgorithm ;    Pointer  pszAlgId ;    Pointer  pszImplementation ;    UInteger dwFlags ;    Returns Integer
36699>>>>>>>
36699>>>>>>>External_Function CNG_BCryptCloseAlgorithmProvider "BCryptCloseAlgorithmProvider" Bcrypt.dll ;    Handle   hAlgorithm ;    UInteger dwFlags ;    Returns Integer
36700>>>>>>>
36700>>>>>>>External_Function CNG_BCryptDeriveKeyPBKDF2 "BCryptDeriveKeyPBKDF2" Bcrypt.dll ;    Handle   hPrf ;    Pointer  pbPassword ;    UInteger cbPassword ;    Pointer  pbSalt ;    UInteger cbSalt ;    BigInt   cIterations ;    Pointer  pbDerivedKey ;    UInteger cbDerivedKey ;    UInteger dwFlags ;    Returns Integer
36701>>>>>>>
36701>>>>>>>External_Function CNG_BCryptGetProperty "BCryptGetProperty" Bcrypt.dll ;    Handle   hObject ;    Pointer  pszProperty ;    Pointer  pbOutput ;    UInteger cbOutput ;    Pointer  pcbResult ;    UInteger dwFlags ;    Returns Integer
36702>>>>>>>
36702>>>>>>>Class cPasswordHasher_CNG_PBKDF2_HMAC_Mixin is a Mixin
36703>>>>>>>
36703>>>>>>>    Function CNG_PBKDF2_HMAC_BufferSizeEx Handle hoProv Returns UInteger
36705>>>>>>>        Integer iErr
36705>>>>>>>        UInteger uiHashLen
36705>>>>>>>        
36705>>>>>>>        UInteger uiCbOut
36705>>>>>>>        WString wsHashLengthProperty
36705>>>>>>>        Move CNG_BCRYPT_HASH_LENGTH to wsHashLengthProperty
36706>>>>>>>        Move (CNG_BCryptGetProperty(hoProv, AddressOf(wsHashLengthProperty), AddressOf(uiHashLen), 4, AddressOf(uiCbOut), 0)) to iErr
36707>>>>>>>        If (iErr) Begin
36709>>>>>>>            Function_Return 0
36710>>>>>>>        End
36710>>>>>>>>
36710>>>>>>>        
36710>>>>>>>        Function_Return uiHashLen
36711>>>>>>>    End_Function
36712>>>>>>>    
36712>>>>>>>    Function CNG_PBKDF2_HMAC_BufferSize WString wsAlgo Returns UInteger
36714>>>>>>>        Integer iErr
36714>>>>>>>        UInteger uiHashLen
36714>>>>>>>        
36714>>>>>>>        // Open the algorithm.
36714>>>>>>>        Handle hoProv
36714>>>>>>>        Move (CNG_BCryptOpenAlgorithmProvider(AddressOf(hoProv), AddressOf(wsAlgo), 0, |CI$00000008 /*BCRYPT_ALG_HANDLE_HMAC_FLAG*/)) to iErr
36715>>>>>>>        If (iErr) Begin
36717>>>>>>>            Function_Return 0
36718>>>>>>>        End
36718>>>>>>>>
36718>>>>>>>        
36718>>>>>>>        Get CNG_PBKDF2_HMAC_BufferSizeEx hoProv to uiHashLen
36719>>>>>>>        
36719>>>>>>>        Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36720>>>>>>>        
36720>>>>>>>        Function_Return uiHashLen
36721>>>>>>>    End_Function
36722>>>>>>>    
36722>>>>>>>    Function CNG_PBKDF2_HMAC    WString wsAlgo ;                                UChar[] ucaData ;                                UChar[] ucaSalt ;                                UInteger uiTimeCost ;                                UChar[] ByRef ucaHashOut ;                                Boolean bOptThrow ;                                Returns Boolean
36724>>>>>>>        Integer iErr iHashLen
36724>>>>>>>        
36724>>>>>>>        // Handle Optionals
36724>>>>>>>        // First the optional throwing of errors.
36724>>>>>>>        Boolean bThrow
36724>>>>>>>        Move True to bThrow
36725>>>>>>>        If (num_arguments > 4) Move bOptThrow to bThrow
36728>>>>>>>        
36728>>>>>>>        // Open the algorithm.
36728>>>>>>>        Handle hoProv
36728>>>>>>>        Move (CNG_BCryptOpenAlgorithmProvider(AddressOf(hoProv), AddressOf(wsAlgo), 0, |CI$00000008 /*BCRYPT_ALG_HANDLE_HMAC_FLAG*/)) to iErr
36729>>>>>>>        If (iErr) Begin
36731>>>>>>>            If (bThrow) Error 8710 "Failed to open up the algo provider."
36734>>>>>>>            Function_Return False
36735>>>>>>>        End
36735>>>>>>>>
36735>>>>>>>        
36735>>>>>>>        Get CNG_PBKDF2_HMAC_BufferSizeEx hoProv to iHashLen
36736>>>>>>>        If (not(iHashLen)) Begin
36738>>>>>>>            If (bThrow) Error 8710 "Failed to get expected length of hash."
36741>>>>>>>            Function_Return False
36742>>>>>>>        End
36742>>>>>>>>
36742>>>>>>>        
36742>>>>>>>        // Resize buffers to the expected output.
36742>>>>>>>        Move (ResizeArray(ucaHashOut, iHashLen)) to ucaHashOut
36743>>>>>>>        
36743>>>>>>>        Move (CNG_BCryptDeriveKeyPBKDF2(hoProv, AddressOf(ucaData), SizeOfArray(ucaData), AddressOf(ucaSalt), SizeOfArray(ucaSalt), uiTimeCost, AddressOf(ucaHashOut), SizeOfArray(ucaHashOut), 0)) to iErr
36744>>>>>>>        If (iErr) Begin
36746>>>>>>>            Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36747>>>>>>>            If (bThrow) Error 8710 "Failed to create hash."
36750>>>>>>>            Function_Return False
36751>>>>>>>        End
36751>>>>>>>>
36751>>>>>>>        
36751>>>>>>>        Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36752>>>>>>>        If (iErr) Begin
36754>>>>>>>            If (bThrow) Error 8710 "Failed to close algo provider."
36757>>>>>>>            Function_Return False
36758>>>>>>>        End
36758>>>>>>>>
36758>>>>>>>        
36758>>>>>>>        Function_Return True
36759>>>>>>>    End_Function
36760>>>>>>>End_Class
36761>>>>>>>
36761>>>>>>>Class cPasswordHasher_Mixin is a Mixin
36762>>>>>>>    
36762>>>>>>>    Import_Class_Protocol cPasswordHasher_CNG_PBKDF2_HMAC_Mixin
36763>>>>>>>    
36763>>>>>>>    Enum_List // Algorithmes available for password hashing
36763>>>>>>>        Define C_PWH_PBKDF2_HMAC_SHA_256        for 0 // Requires TimeCost
36763>>>>>>>        Define C_PWH_PBKDF2_HMAC_SHA_512              // Requires TimeCost
36763>>>>>>>    End_Enum_List
36763>>>>>>>    
36763>>>>>>>    Function RandomBuffer UInteger uiSize Returns UChar[]
36765>>>>>>>        UChar[] ucaBuffer
36766>>>>>>>        Move (ResizeArray(ucaBuffer, uiSize)) to ucaBuffer
36767>>>>>>>        If (CNG_BCryptGenRandom(0, AddressOf(ucaBuffer), uiSize, |CI$00000002 /*BCRYPT_USE_SYSTEM_PREFERRED_RNG*/)) Begin
36769>>>>>>>            Error 8710 "Failed to create random buffer."
36770>>>>>>>>
36770>>>>>>>        End
36770>>>>>>>>
36770>>>>>>>        Function_Return ucaBuffer
36771>>>>>>>    End_Function
36772>>>>>>>    
36772>>>>>>>    Function Base64EncodeArr UChar[] ucaBuffer Returns String
36774>>>>>>>        Integer iErr
36774>>>>>>>        Pointer pBase64
36774>>>>>>>        String sBase64
36774>>>>>>>        Move (Base64Encode(AddressOf(ucaBuffer), SizeOfArray(ucaBuffer))) to pBase64
36775>>>>>>>        If (not(pBase64)) Begin
36777>>>>>>>            Function_Return sBase64
36778>>>>>>>        End
36778>>>>>>>>
36778>>>>>>>        Move (PointerToString(pBase64)) to sBase64
36779>>>>>>>        Move (Free(pBase64)) to iErr
36780>>>>>>>        Function_Return sBase64
36781>>>>>>>    End_Function
36782>>>>>>>    
36782>>>>>>>    Function Base64DecodeArr String sBase64 Returns UChar[]
36784>>>>>>>        Integer iLen
36784>>>>>>>        Pointer pBase64
36784>>>>>>>        UChar[] ucaBuffer
36785>>>>>>>        Move (Base64Decode(AddressOf(sBase64), &iLen)) to pBase64
36786>>>>>>>        If (not(pBase64)) Begin
36788>>>>>>>            Function_Return ucaBuffer
36789>>>>>>>        End
36789>>>>>>>>
36789>>>>>>>        
36789>>>>>>>        Move (ResizeArray(ucaBuffer, iLen)) to ucaBuffer
36790>>>>>>>        Move (MemCopy(AddressOf(ucaBuffer), pBase64, iLen)) to iLen
36791>>>>>>>        Move (Free(pBase64)) to iLen
36792>>>>>>>        Function_Return ucaBuffer
36793>>>>>>>    End_Function
36794>>>>>>>    
36794>>>>>>>    Function CreatePasswordHashExWithSalt UInteger uiAlgo UChar[] ucaSalt String sPassword String ByRef sHash UInteger uiOptTimeCost Returns Boolean
36796>>>>>>>        Boolean bOk bRequireTimeCost
36796>>>>>>>        UChar[] ucaHash
36797>>>>>>>        
36797>>>>>>>        Case Begin
36797>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36799>>>>>>>                Get CNG_PBKDF2_HMAC "SHA256" (StringToUCharArray(sPassword)) ucaSalt uiOptTimeCost (&ucaHash) False to bOk
36800>>>>>>>                If (not(bOk)) Function_Return False
36803>>>>>>>                
36803>>>>>>>                Move True to bRequireTimeCost
36804>>>>>>>                Case Break
36805>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36808>>>>>>>                Get CNG_PBKDF2_HMAC "SHA512" (StringToUCharArray(sPassword)) ucaSalt uiOptTimeCost (&ucaHash) False to bOk
36809>>>>>>>                If (not(bOk)) Function_Return False
36812>>>>>>>                
36812>>>>>>>                Move True to bRequireTimeCost
36813>>>>>>>                Case Break
36814>>>>>>>            Case Else
36814>>>>>>>                Error 8710 "Invalid algorithm selected."
36815>>>>>>>>
36815>>>>>>>                Function_Return False
36816>>>>>>>        Case End
36816>>>>>>>        
36816>>>>>>>        String sSalt
36816>>>>>>>        Get Base64EncodeArr ucaSalt to sSalt
36817>>>>>>>        If (not(SizeOfString(sSalt))) Function_Return False
36820>>>>>>>        Get Base64EncodeArr ucaHash to sHash
36821>>>>>>>        If (not(SizeOfString(sHash))) Function_Return False
36824>>>>>>>        
36824>>>>>>>        If (bRequireTimeCost) Begin
36826>>>>>>>            Move (SFormat("%1$%2$%3$%4",            ;                            String(uiAlgo),         ;                            sSalt,                  ;                            String(uiOptTimeCost),  ;                            sHash)) to sHash
36827>>>>>>>        End
36827>>>>>>>>
36827>>>>>>>        Else Begin
36828>>>>>>>            Move (SFormat("%1$%2$%3",               ;                            String(uiAlgo),         ;                            sSalt,                  ;                            sHash)) to sHash
36829>>>>>>>        End
36829>>>>>>>>
36829>>>>>>>        
36829>>>>>>>        Function_Return bOk
36830>>>>>>>    End_Function
36831>>>>>>>    
36831>>>>>>>    Function CreatePasswordHashEx UInteger uiAlgo UInteger uiSaltSize String sPassword String ByRef sHash UInteger uiOptTimeCost Returns Boolean
36833>>>>>>>        UChar[] ucaSalt
36834>>>>>>>        Get RandomBuffer uiSaltSize to ucaSalt
36835>>>>>>>        If (not(SizeOfArray(ucaSalt))) Function_Return False
36838>>>>>>>        
36838>>>>>>>        If (num_arguments > 4) Begin
36840>>>>>>>            Function_Return (CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sHash, uiOptTimeCost))
36841>>>>>>>        End
36841>>>>>>>>
36841>>>>>>>        Function_Return (CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sHash))
36842>>>>>>>    End_Function
36843>>>>>>>    
36843>>>>>>>    Function VerifyPasswordHash String sPassword String sHash Returns Boolean
36845>>>>>>>        Boolean bRequiresTimeCost
36845>>>>>>>        UInteger uiAlgo uiTimeCost
36845>>>>>>>        Integer iBegin iEnd
36845>>>>>>>        String sSalt
36845>>>>>>>        
36845>>>>>>>        Move 1 to iBegin
36846>>>>>>>        
36846>>>>>>>        // Parse Algo
36846>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36847>>>>>>>        If (not(iEnd)) Function_Return False
36850>>>>>>>        Move (Mid(sHash, iEnd - iBegin, iBegin)) to uiAlgo
36851>>>>>>>        
36851>>>>>>>        // Parse Salt
36851>>>>>>>        Move (iEnd + 1) to iBegin
36852>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36853>>>>>>>        If (not(iEnd)) Function_Return False
36856>>>>>>>        Move (Mid(sHash, iEnd - iBegin, iBegin)) to sSalt
36857>>>>>>>        
36857>>>>>>>        Case Begin
36857>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36859>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36862>>>>>>>                Move True to bRequiresTimeCost
36863>>>>>>>                Case Break
36864>>>>>>>            Case Else
36864>>>>>>>                Error 8710 "Invalid algorithm selected."
36865>>>>>>>>
36865>>>>>>>                Function_Return False
36866>>>>>>>        Case End
36866>>>>>>>        
36866>>>>>>>        // Parse optional timecost
36866>>>>>>>        If (bRequiresTimeCost) Begin
36868>>>>>>>            Move (iEnd + 1) to iBegin
36869>>>>>>>            Move (Pos("$", sHash, iBegin)) to iEnd
36870>>>>>>>            If (not(iEnd)) Function_Return False
36873>>>>>>>            Move (Mid(sHash, iEnd - iBegin, iBegin)) to uiTimeCost
36874>>>>>>>        End
36874>>>>>>>>
36874>>>>>>>        
36874>>>>>>>        // Parse rest hash
36874>>>>>>>        Move (iEnd + 1) to iBegin
36875>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36876>>>>>>>        If (iEnd) Function_Return False // inverse check if there are any other errors.
36879>>>>>>>        
36879>>>>>>>        // Base64Decode
36879>>>>>>>        UChar[] ucaSalt
36880>>>>>>>        Get Base64DecodeArr sSalt to ucaSalt
36881>>>>>>>        If (not(SizeOfArray(ucaSalt))) Function_Return False
36884>>>>>>>        
36884>>>>>>>        // Create new hash
36884>>>>>>>        String sNewHash
36884>>>>>>>        If (bRequiresTimeCost) Begin
36886>>>>>>>            If (not(CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sNewHash, uiTimeCost))) Begin
36888>>>>>>>                Function_Return False 
36889>>>>>>>            End
36889>>>>>>>>
36889>>>>>>>        End
36889>>>>>>>>
36889>>>>>>>        Else Begin
36890>>>>>>>            If (not(CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sNewHash))) Begin
36892>>>>>>>                Function_Return False 
36893>>>>>>>            End
36893>>>>>>>>
36893>>>>>>>        End
36893>>>>>>>>
36893>>>>>>>        Function_Return (sNewHash = sHash)
36894>>>>>>>    End_Function
36895>>>>>>>    
36895>>>>>>>    Function RequiredBufferSizeEx UInteger uiAlgo UInteger uiSaltSize UInteger uiOptTimeCost Returns UBigInt
36897>>>>>>>        Boolean bRequireTimeCost
36897>>>>>>>        UBigInt ullSize
36897>>>>>>>        UChar[] ucaSalt
36898>>>>>>>        String sSalt
36898>>>>>>>        
36898>>>>>>>        Get RandomBuffer uiSaltSize to ucaSalt
36899>>>>>>>        Get Base64EncodeArr ucaSalt to sSalt
36900>>>>>>>        If (not(SizeOfString(sSalt))) Function_Return 0
36903>>>>>>>        
36903>>>>>>>        Case Begin
36903>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36905>>>>>>>                Get CNG_PBKDF2_HMAC_BufferSize "SHA256" to ullSize
36906>>>>>>>                Move True to bRequireTimeCost
36907>>>>>>>                Case Break
36908>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36911>>>>>>>                Get CNG_PBKDF2_HMAC_BufferSize "SHA512" to ullSize
36912>>>>>>>                Move True to bRequireTimeCost
36913>>>>>>>                Case Break
36914>>>>>>>            Case Else
36914>>>>>>>                Error 8710 "Invalid algorithm selected."
36915>>>>>>>>
36915>>>>>>>                Function_Return 0
36916>>>>>>>        Case End
36916>>>>>>>        
36916>>>>>>>        // calculate base64 in a non-floating-manner
36916>>>>>>>        Move (((ullSize + 3 -1) / 3) * 4) to ullSize
36917>>>>>>>        
36917>>>>>>>        Move (ullSize + SizeOfString(String(uiAlgo))) to ullSize
36918>>>>>>>        Move (ullSize + SizeOfString(sSalt)) to ullSize
36919>>>>>>>        If (bRequireTimeCost) Begin
36921>>>>>>>            Move (ullSize + SizeOfString(String(uiOptTimeCost))) to ullSize
36922>>>>>>>            Move (ullSize + 3 /*$*/) to ullSize
36923>>>>>>>        End
36923>>>>>>>>
36923>>>>>>>        Else Begin
36924>>>>>>>            Move (ullSize + 2 /*$*/) to ullSize
36925>>>>>>>        End
36925>>>>>>>>
36925>>>>>>>        
36925>>>>>>>        Function_Return ullSize
36926>>>>>>>    End_Function
36927>>>>>>>End_Class
36928>>>>>>>
36928>>>>>>>Class cPasswordHasher is a cObject
36929>>>>>>>    
36929>>>>>>>    Import_Class_Protocol cPasswordHasher_Mixin
36930>>>>>>>    
36930>>>>>>>    Procedure Construct_Object
36932>>>>>>>        Forward Send Construct_Object
36934>>>>>>>        
36934>>>>>>>        Property UInteger   peAlgorithm         C_PWH_PBKDF2_HMAC_SHA_512 
36935>>>>>>>        Property UInteger   puiSaltSize         16
36936>>>>>>>        
36936>>>>>>>        Property UInteger   puiOptTimeCost      420000
36937>>>>>>>    End_Procedure
36938>>>>>>>    
36938>>>>>>>    Function CreatePasswordHash String sPassword String ByRef sHash Returns Boolean
36940>>>>>>>        Boolean bOk
36940>>>>>>>        UInteger uiAlgo
36940>>>>>>>        Get peAlgorithm to uiAlgo
36941>>>>>>>        
36941>>>>>>>        Case Begin
36941>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36943>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36946>>>>>>>                Get CreatePasswordHashEx uiAlgo (puiSaltSize(Self)) sPassword (&sHash) (puiOptTimeCost(Self)) to bOk
36947>>>>>>>                Case Break
36948>>>>>>>            Case Else
36948>>>>>>>                Error 8710 "Invalid algorithm selected."
36949>>>>>>>>
36949>>>>>>>                Function_Return False
36950>>>>>>>        Case End
36950>>>>>>>        
36950>>>>>>>        Function_Return bOk
36951>>>>>>>    End_Function
36952>>>>>>>    
36952>>>>>>>    Function RequiredBufferSize Returns UBigInt
36954>>>>>>>        UBigInt ullSize
36954>>>>>>>        UInteger uiAlgo
36954>>>>>>>        Get peAlgorithm to uiAlgo
36955>>>>>>>        
36955>>>>>>>        Case Begin
36955>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36957>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36960>>>>>>>                Get RequiredBufferSizeEx uiAlgo (puiSaltSize(Self)) (puiOptTimeCost(Self)) to ullSize
36961>>>>>>>                Case Break
36962>>>>>>>            Case Else
36962>>>>>>>                Error 8710 "Invalid algorithm selected."
36963>>>>>>>>
36963>>>>>>>                Function_Return 0
36964>>>>>>>        Case End
36964>>>>>>>        
36964>>>>>>>        Function_Return ullSize
36965>>>>>>>    End_Function
36966>>>>>>>
36966>>>>>>>End_Class
36967>>>>>
36967>>>>>Class cWebSessionManagerStandard is a cWebSessionManager
36968>>>>>    
36968>>>>>    Procedure Construct_Object
36970>>>>>        Handle hoObj
36970>>>>>        
36970>>>>>        Forward Send Construct_Object
36972>>>>>        
36972>>>>>        Set pbSessionCookieHttpOnly to True
36973>>>>>        
36973>>>>>        Property Handle phoUserDD 0      // Handle to the WebAppUser DDO
36974>>>>>        Property Handle phoSessionDD 0   // Handle to the WebAppSession DDO  
36975>>>>>        Property Handle phoCrypto 0      // Handle to the PasswordHasher
36976>>>>>        
36976>>>>>        Get CreateNamed (RefClass(cWebAppUserDataDictionary)) 'oUserDD' to hoObj
36977>>>>>        Set phoUserDD to hoObj
36978>>>>>        
36978>>>>>        Get CreateNamed (RefClass(cWebAppSessionDataDictionary)) 'oSessionDD' to hoObj
36979>>>>>        Set DDO_Server of hoObj to (phoUserDD(Self))
36980>>>>>        Set phoSessionDD to hoObj
36981>>>>>        
36981>>>>>        Property Handle phoCrypto 0   // Handle to the Cryptographer
36982>>>>>        Get CreateNamed (RefClass(cPasswordHasher)) 'oCrypto' to hoObj
36983>>>>>        Set phoCrypto to hoObj
36984>>>>>        
36984>>>>>        Property Boolean pbPasswordHashing True
36985>>>>>        
36985>>>>>        Property Boolean pbCreatingNewSession False
36986>>>>>        Property String psLoginName
36987>>>>>        Property String psUserName ""
36988>>>>>        Property Integer piUserRights 0
36989>>>>>    End_Procedure
36990>>>>>    
36990>>>>>    Procedure End_Construct_Object
36992>>>>>        Forward Send End_Construct_Object
36994>>>>>        
36994>>>>>        Handle hoCrypto
36994>>>>>        Integer iFieldLen
36994>>>>>        If (pbPasswordHashing(Self)) Begin
36996>>>>>            Get phoCrypto to hoCrypto
36997>>>>>            Get_Attribute DF_FIELD_LENGTH of (RefTable(WebAppUser)) (RefTable(WebAppUser.Password)) to iFieldLen
37000>>>>>            If (iFieldLen < (RequiredBufferSize(hoCrypto) + 3)) Begin
37002>>>>>                Error DFERR_PROGRAM "The password field of WebAppUser is not large enough (128)"
37003>>>>>>
37003>>>>>            End
37003>>>>>>
37003>>>>>        End
37003>>>>>>
37003>>>>>    End_Procedure
37004>>>>>    
37004>>>>>    Function CreateSession String sRemoteAddress Returns String
37006>>>>>        String sSessionKey
37006>>>>>        Integer iErr
37006>>>>>        Boolean bLogWebSession
37006>>>>>        Handle hoSessionDD       
37006>>>>>        Get phoSessionDD to hoSessionDD
37007>>>>>        
37007>>>>>        //  Get session key
37007>>>>>        Forward Get CreateSession sRemoteAddress to sSessionKey
37009>>>>>        
37009>>>>>        Get pbLogWebSession to bLogWebSession
37010>>>>>        If not bLogWebSession Begin
37012>>>>>            Function_Return sSessionKey        
37013>>>>>        End
37013>>>>>>
37013>>>>>
37013>>>>>        //  Store session
37013>>>>>        Send Clear of hoSessionDD
37014>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.SessionKey to sSessionKey
37015>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.RemoteAddress to sRemoteAddress
37016>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.Active to "Y"
37017>>>>>        Get Request_Validate of hoSessionDD to iErr
37018>>>>>        If (iErr) Begin
37020>>>>>            // this should not happen. If it does its a programming error
37020>>>>>            Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37021>>>>>>
37021>>>>>            Function_Return ""
37022>>>>>        End
37022>>>>>>
37022>>>>>        Send Request_Save of hoSessionDD
37023>>>>>        If (Err) Begin
37025>>>>>            // this shouldn't happen, if it does likely a duplicate session key issue, even through request_save already gave an error we give another one to make tracking down easier
37025>>>>>            Error DFERR_PROGRAM C_$WebAppSessionSaveFailed
37026>>>>>>
37026>>>>>            Function_Return ""
37027>>>>>        End
37027>>>>>>
37027>>>>>       
37027>>>>>        Function_Return sSessionKey        
37028>>>>>    End_Function
37029>>>>>    
37029>>>>>    Function ValidateSession String sSessionKey Boolean bOptLoadWebApp Returns Boolean
37031>>>>>        DateTime dtLastAccess dtCurrent
37031>>>>>        TimeSpan tsDiff
37031>>>>>        Integer iErr iSessionTimeout iSpanMinutes
37031>>>>>        Boolean bResult bCreatingNewSession
37031>>>>>        Boolean bLogWebSession bLoadWebApp
37031>>>>>        Integer eLoginMode
37031>>>>>        String sTime
37031>>>>>        Handle hoSessionDD hoUserDD       
37031>>>>>        
37031>>>>>        Move False to bLoadWebApp
37032>>>>>        If (num_arguments >= 2) Begin
37034>>>>>            Move bOptLoadWebApp to bLoadWebApp
37035>>>>>        End
37035>>>>>>
37035>>>>>        
37035>>>>>        Get phoSessionDD to hoSessionDD
37036>>>>>        Get phoUserDD to hoUserDD
37037>>>>>        
37037>>>>>        Get pbLogWebSession to bLogWebSession
37038>>>>>        Get peLoginMode to eLoginMode
37039>>>>>        
37039>>>>>        // for this object, you can only disable logging if login completely is disabled
37039>>>>>        If (not(bLogWebSession) and (eLoginMode<>lmLoginNone)) Begin
37041>>>>>            Error DFERR_PROGRAM C_$WebSessionLoggingMustBeEnabled
37042>>>>>>
37042>>>>>            Function_Return False
37043>>>>>        End
37043>>>>>>
37043>>>>>
37043>>>>>        //  Clear session properties
37043>>>>>        Set psSessionKey to ""
37044>>>>>        Send UpdateSessionProperties True
37045>>>>>        
37045>>>>>        If not bLogWebSession Begin
37047>>>>>            Forward Get ValidateSession sSessionKey to bResult
37049>>>>>            Function_Return bResult
37050>>>>>        End        
37050>>>>>>
37050>>>>>        
37050>>>>>        Move False to bResult
37051>>>>>        Get piSessionTimeout to iSessionTimeout 
37052>>>>>        
37052>>>>>        //  Check if session exists
37052>>>>>        Send Clear of hoSessionDD
37053>>>>>        Move sSessionKey to WebAppSession.SessionKey
37054>>>>>        Send Find of hoSessionDD EQ Index.1
37055>>>>>            
37055>>>>>        If (Found) Begin
37057>>>>>            //  Calculate timespan between now and last access time
37057>>>>>            Move (CurrentDateTime()) to dtCurrent
37058>>>>>            Move WebAppSession.LastAccessDate to dtLastAccess
37059>>>>>            Get StringToTime of hoSessionDD dtLastAccess WebAppSession.LastAccessTime to dtLastAccess
37060>>>>>            Move (dtCurrent - dtLastAccess) to tsDiff
37061>>>>>            Move (SpanTotalMinutes(tsDiff)) to iSpanMinutes
37062>>>>>            
37062>>>>>            //  Check if session didn't time out
37062>>>>>            If (IsDateValid(dtLastAccess) and (iSessionTimeout <= 0 or (iSpanMinutes < iSessionTimeout)) and WebAppSession.Active = "Y") Begin
37064>>>>>                Forward Get ValidateSession sSessionKey to bResult
37066>>>>>                   
37066>>>>>                If (bResult) Begin
37068>>>>>                    //  Update session record
37068>>>>>                    Get TimeToString of hoSessionDD dtCurrent to sTime 
37069>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.LastAccessDate to dtCurrent
37070>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.LastAccessTime to sTime
37071>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.UseCount to (WebAppSession.UseCount + 1)
37072>>>>>                    Get Request_Validate of hoSessionDD to iErr
37073>>>>>                    If (iErr) Begin
37075>>>>>                        // this should not happen. If it does its a programming error
37075>>>>>                        Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37076>>>>>>
37076>>>>>                        Function_Return False
37077>>>>>                    End
37077>>>>>>
37077>>>>>                    Send Request_Save of hoSessionDD
37078>>>>>                    
37078>>>>>                    //  Update user properties
37078>>>>>                    Send UpdateSessionProperties False
37079>>>>>                End
37079>>>>>>
37079>>>>>            End
37079>>>>>>
37079>>>>>            Else Begin
37080>>>>>                // Test the Creating New Session Flag to protect against infinite recursion....
37080>>>>>                Get pbCreatingNewSession to bCreatingNewSession
37081>>>>>                
37081>>>>>                If (not(bCreatingNewSession)) Begin
37083>>>>>                    If (not(bLoadWebApp)) Begin
37085>>>>>                        Move False to bResult   //  We can only continue immediately if we were loading the webapp, other operations are not allowed!
37086>>>>>                        Error DFERR_WEBAPP_SESSION_TIMEOUT "Your application session has timed out or is inactive, please login again."
37087>>>>>>
37087>>>>>                        Send NavigateRefresh of ghoWebApp          // refresh the WebApp at the client (triggers a login)
37088>>>>>                    End
37088>>>>>>
37088>>>>>                    Else Begin
37089>>>>>                        Set pbCreatingNewSession to True                    
37090>>>>>                        Get RecreateSession of ghoWebApp to bResult 
37091>>>>>                        Set pbCreatingNewSession to False                        
37092>>>>>                    End
37092>>>>>>
37092>>>>>                End
37092>>>>>>
37092>>>>>            End
37092>>>>>>
37092>>>>>        End
37092>>>>>>
37092>>>>>        Else Begin
37093>>>>>            Error DFERR_WEBAPP_BAD_SESSION_KEY "Session key not known (reload page to recreate session)"
37094>>>>>>
37094>>>>>        End
37094>>>>>>
37094>>>>>        
37094>>>>>        Function_Return bResult
37095>>>>>    End_Function
37096>>>>>    
37096>>>>>    Function CreatePasswordHash String sPassword String ByRef sHash Returns Boolean
37098>>>>>        If (not(pbPasswordHashing(Self))) Begin
37100>>>>>            Move sPassword to sHash
37101>>>>>            Function_Return True
37102>>>>>        End
37102>>>>>>
37102>>>>>        
37102>>>>>        If (not(CreatePasswordHash(phoCrypto(Self), sPassword, &sHash))) Begin
37104>>>>>            Function_Return False
37105>>>>>        End
37105>>>>>>
37105>>>>>        Move ("V1$" + sHash) to sHash
37106>>>>>        Function_Return True
37107>>>>>    End_Function
37108>>>>>    
37108>>>>>    Function VerifyPasswordHash String sUserPassword String sEnteredPassword Boolean ByRef bShouldUpgrade Returns Boolean
37110>>>>>        If (not(pbPasswordHashing(Self))) Begin
37112>>>>>            Move False to bShouldUpgrade
37113>>>>>            Function_Return (sUserPassword = sEnteredPassword)
37114>>>>>        End
37114>>>>>>
37114>>>>>        
37114>>>>>        String sVersion
37114>>>>>        Move (Left(sUserPassword, 3)) to sVersion
37115>>>>>        If (sVersion = "V1$") Begin
37117>>>>>            If (num_arguments > 2) Move False to bShouldUpgrade
37120>>>>>            Function_Return (VerifyPasswordHash(phoCrypto(Self), sEnteredPassword, Right(sUserPassword, Length(sUserPassword) - 3)))
37121>>>>>        End
37121>>>>>>
37121>>>>>        Else Begin
37122>>>>>            If (num_arguments > 2) Move True to bShouldUpgrade
37125>>>>>            Function_Return False
37126>>>>>        End
37126>>>>>>
37126>>>>>    End_Function
37127>>>>>    
37127>>>>>    Function UserRegister String sLoginName String sPassword Returns Boolean
37129>>>>>        Handle hoUserDD
37129>>>>>        Integer iErr
37129>>>>>        Get phoUserDD to hoUserDD
37130>>>>>        
37130>>>>>        //  Find the user
37130>>>>>        Send Clear of hoUserDD
37131>>>>>        Move sLoginName to WebAppUser.LoginName
37132>>>>>        Send Find of hoUserDD EQ Index.1
37133>>>>>        If (Found) Begin
37135>>>>>            Send Clear of hoUserDD
37136>>>>>            Function_Return False
37137>>>>>        End
37137>>>>>>
37137>>>>>        
37137>>>>>        Send Clear of hoUserDD
37138>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.FullName to sLoginName
37139>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.LoginName to sLoginName
37140>>>>>        If (not(CreatePasswordHash(Self, Trim(sPassword), &sPassword))) Begin
37142>>>>>            Send Clear of hoUserDD
37143>>>>>            Function_Return False
37144>>>>>        End
37144>>>>>>
37144>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37145>>>>>        Get Request_Validate of hoUserDD to iErr
37146>>>>>        If (iErr) Begin
37148>>>>>            Send Clear of hoUserDD
37149>>>>>            Function_Return False
37150>>>>>        End
37150>>>>>>
37150>>>>>        
37150>>>>>        Send Request_Save of hoUserDD
37151>>>>>        Function_Return (not(Err))
37152>>>>>    End_Function
37153>>>>>    
37153>>>>>    Function UserLogin String sLoginName String sPassword Returns Boolean
37155>>>>>        String sSessionKey sUserPassword
37155>>>>>        Handle hoSessionDD hoUserDD
37155>>>>>        Boolean bMatch bUpgrade
37155>>>>>        
37155>>>>>        Get phoSessionDD to hoSessionDD
37156>>>>>        Get phoUserDD to hoUserDD
37157>>>>>        Integer iErr eLoginMode
37157>>>>>        
37157>>>>>        // Refind session record
37157>>>>>        Get psSessionKey to sSessionKey
37158>>>>>        Send Clear of hoSessionDD
37159>>>>>        Move sSessionKey to WebAppSession.SessionKey
37160>>>>>        Send Find of hoSessionDD EQ Index.1
37161>>>>>        
37161>>>>>        If (Found and WebAppSession.SessionKey = sSessionKey) Begin
37163>>>>>            Get peLoginMode to eLoginMode
37164>>>>>            
37164>>>>>            //  Find the user
37164>>>>>            Move sLoginName to WebAppUser.LoginName
37165>>>>>            Send Find of hoUserDD EQ Index.1
37166>>>>>            
37166>>>>>            // Check username and password
37166>>>>>            If (Found and (Lowercase(sLoginName) = Lowercase(Trim(WebAppUser.LoginName)))) Begin
37168>>>>>                Get Field_Current_Value of hoUserDD Field WebAppUser.Password to sUserPassword
37169>>>>>                Get VerifyPasswordHash (Trim(sUserPassword)) (Trim(sPassword)) (&bUpgrade) to bMatch
37170>>>>>                
37170>>>>>                If (bMatch) Begin
37172>>>>>                    // Store the login
37172>>>>>                    If (bUpgrade) Begin
37174>>>>>                        Get CreatePasswordHash (Trim(sPassword)) (&sPassword) to bUpgrade
37175>>>>>                        If (bUpgrade) Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37178>>>>>                    End
37178>>>>>>
37178>>>>>                    Set Field_Changed_Value of hoUserDD Field WebAppUser.LastLogin to (CurrentDateTime())
37179>>>>>                    Get Request_Validate of hoSessionDD to iErr
37180>>>>>                    If (iErr) Begin
37182>>>>>                        // this should not happen. If it does its a programming error
37182>>>>>                        Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37183>>>>>>
37183>>>>>                        Function_Return False
37184>>>>>                    End
37184>>>>>>
37184>>>>>                    
37184>>>>>                    Send Request_Save of hoSessionDD
37185>>>>>                    
37185>>>>>                    // Update session properties
37185>>>>>                    Send UpdateSessionProperties False
37186>>>>>                    Send NotifyChangeRights
37187>>>>>                    Function_Return True
37188>>>>>                End
37188>>>>>>
37188>>>>>                Else Begin
37189>>>>>                    //  We should rely directly on this buffer elsewhere but just be sure
37189>>>>>                    Send Clear of hoUserDD
37190>>>>>                End
37190>>>>>>
37190>>>>>            End
37190>>>>>>
37190>>>>>            Else Begin
37191>>>>>                // This is added to delay latency to avoid hackers finding out whether the user exists or not.
37191>>>>>                Get CreatePasswordHash "This is to delay the response latency." (&sPassword) to iErr
37192>>>>>            End
37192>>>>>>
37192>>>>>        End
37192>>>>>>
37192>>>>>        Else Begin
37193>>>>>            // This is added to delay latency to avoid hackers finding out whether the user exists or not.
37193>>>>>            Get CreatePasswordHash "This is to delay the response latency." (&sPassword) to iErr
37194>>>>>        End
37194>>>>>>
37194>>>>>          
37194>>>>>        Function_Return False
37195>>>>>    End_Function
37196>>>>>    
37196>>>>>    Function SetUserPassword String sLoginName String sPassword Returns Boolean
37198>>>>>        Handle hoUserDD
37198>>>>>        Integer iErr
37198>>>>>        Get phoUserDD to hoUserDD
37199>>>>>        
37199>>>>>        //  Find the user
37199>>>>>        Send Clear of hoUserDD
37200>>>>>        Move sLoginName to WebAppUser.LoginName
37201>>>>>        Send Find of hoUserDD EQ Index.1
37202>>>>>        If (not(Found)) Begin
37204>>>>>            Send Clear of hoUserDD
37205>>>>>            Function_Return False
37206>>>>>        End
37206>>>>>>
37206>>>>>        
37206>>>>>        If (not(CreatePasswordHash(Self, Trim(sPassword), &sPassword))) Begin
37208>>>>>            Send Clear of hoUserDD
37209>>>>>            Function_Return False
37210>>>>>        End
37210>>>>>>
37210>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37211>>>>>        Get Request_Validate of hoUserDD to iErr
37212>>>>>        If (iErr) Begin
37214>>>>>            Send Clear of hoUserDD
37215>>>>>            Function_Return False
37216>>>>>        End
37216>>>>>>
37216>>>>>        
37216>>>>>        Send Request_Save of hoUserDD
37217>>>>>        Function_Return (not(Err))
37218>>>>>    End_Function
37219>>>>>    
37219>>>>>    Function IsLoggedIn Returns Boolean
37221>>>>>        String sLoginName
37221>>>>>        Boolean bLogWebSession bLoggedIn
37221>>>>>        
37221>>>>>        Get pbLogWebSession to bLogWebSession
37222>>>>>        If not bLogWebSession Begin
37224>>>>>            Forward Get IsLoggedIn to bLoggedIn
37226>>>>>            Function_Return bLoggedIn
37227>>>>>        End
37227>>>>>>
37227>>>>>        
37227>>>>>        Get psLoginName to sLoginName
37228>>>>>        
37228>>>>>        Function_Return (sLoginName <> "")
37229>>>>>    End_Function
37230>>>>>    
37230>>>>>    
37230>>>>>    //
37230>>>>>    // This procedure is called when validating a session and after logging in. Its purpose is to 
37230>>>>>    // update properties based on the session and user data. Augment this function to update 
37230>>>>>    // properties based on the session / user table. Note that WebAppUser and WebAppSession contain
37230>>>>>    // the right records when this procedure is called.
37230>>>>>    //
37230>>>>>    // Params:
37230>>>>>    //      bClear   True if the procedure is called before session validation to clear properties.
37230>>>>>    //
37230>>>>>    Procedure UpdateSessionProperties Boolean bClear
37232>>>>>        Handle hoUserDD
37232>>>>>        
37232>>>>>        Get phoUserDD to hoUserDD
37233>>>>>        
37233>>>>>        //  Update user properties
37233>>>>>        If (not(bClear) and HasRecord(hoUserDD)) Begin
37235>>>>>            Set psUsername to (Trim(WebAppUser.FullName))
37236>>>>>            Set psLoginName to (Trim(WebAppUser.LoginName))
37237>>>>>            Set piUserRights to WebAppUser.Rights
37238>>>>>            
37238>>>>>            Send OnSessionPropertiesSet 
37239>>>>>        End
37239>>>>>>
37239>>>>>        Else Begin
37240>>>>>            Set psUsername to ""
37241>>>>>            Set psLoginName to ""
37242>>>>>            Set piUserRights to 0
37243>>>>>            
37243>>>>>            Send OnSessionPropertiesClear
37244>>>>>        End
37244>>>>>>
37244>>>>>    End_Procedure
37245>>>>>    
37245>>>>>    Procedure OnSessionPropertiesSet
37247>>>>>        //  Empty event stub
37247>>>>>    End_Procedure
37248>>>>>    
37248>>>>>    Procedure OnSessionPropertiesClear
37250>>>>>        //  Empty event stub
37250>>>>>    End_Procedure
37251>>>>>    
37251>>>>>    Procedure EndSession
37253>>>>>        Integer iErr
37253>>>>>        Boolean bLogWebSession
37253>>>>>        Handle hoSessionDD       
37253>>>>>        
37253>>>>>        Get phoSessionDD to hoSessionDD
37254>>>>>        Get pbLogWebSession to bLogWebSession
37255>>>>>        If not bLogWebSession Begin
37257>>>>>            Forward Send EndSession
37259>>>>>            Procedure_Return
37260>>>>>        End
37260>>>>>>
37260>>>>>            
37260>>>>>        //  Check if session exists
37260>>>>>        Send Clear of hoSessionDD
37261>>>>>        Get psSessionKey to WebAppSession.SessionKey
37262>>>>>        
37262>>>>>        Send Find of hoSessionDD EQ Index.1
37263>>>>>        If (Found) Begin
37265>>>>>            Set Field_Changed_Value of hoSessionDD Field WebAppSession.Active to "N"
37266>>>>>            Get Request_Validate of hoSessionDD to iErr
37267>>>>>            If (iErr) Begin
37269>>>>>                // this should not happen. If it does its a programming error
37269>>>>>                Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37270>>>>>>
37270>>>>>                Procedure_Return
37271>>>>>            End
37271>>>>>>
37271>>>>>            Send Request_Save of hoSessionDD
37272>>>>>        End
37272>>>>>>
37272>>>>>    End_Procedure
37273>>>>>
37273>>>>>End_Class
37274>>>>>
37274>>>
37274>>>Object oSessionManager is a cWebSessionManagerStandard
37276>>>End_Object
37277>>>
37277>>>
37277>    Use Login.wo
Including file: Login.wo    (C:\DataFlex Projects\Centros\AppSrc\Login.wo)
37277>>>Use cWebView.pkg
37277>>>Use cWebForm.pkg
37277>>>Use cWebButton.pkg
37277>>>Use cWebPanel.pkg
37277>>>Use cWebLabel.pkg
37277>>>Use cWebSpacer.pkg
37277>>>Use cWebImage.pkg
37277>>>
37277>>>Object oLogin is a cWebView
37279>>>    Set piMinWidth to 250
37280>>>    Set piMaxWidth to 420
37281>>>    Set pbLoginModeEnforced to False
37282>>>    Set piColumnCount to 12
37283>>>    Set psCSSClass to "LoginView"
37284>>>    Set pbServerOnSubmit to True
37285>>>    
37285>>>    Set psStateViewName to "Login"
37286>>>    Set pbStateReplace to True  // Always replace the state so the login never becomes its own history item
37287>>>    
37287>>>    Property String psPrevStateHash ""  // Remember the state hash that the user navigated too so we can redirect after login
37290>>>    
37290>>>    Delegate Set phoLoginView to Self
37292>>>    
37292>>>    Object oTopSpacer is a cWebSpacer
37294>>>        Set pbFillHeight to True
37295>>>        Set piColumnSpan to 12
37296>>>    End_Object
37297>>>    
37297>>>    Object oWarning is a cWebLabel
37299>>>        Set pbVisible to False
37300>>>        Set psCaption to "Invalid User ID or password. \n\rHint: 'admin' & 'admin'."
37301>>>        Set peAlign to alignCenter
37302>>>        Set piColumnSpan to 12
37303>>>        Set psCSSClass to "LoginWarning"
37304>>>    End_Object
37305>>>    
37305>>>    Object oLogo is a cWebImage
37307>>>        Set piColumnSpan to 10
37308>>>        Set psUrl to "images/DF_Logo_Retina.png"
37309>>>        Set pePosition to wiFit
37310>>>        Set piColumnIndex to 1
37311>>>        Set piHeight to 160
37312>>>        
37312>>>        WebSetResponsive piHeight rmMobile to 100  // Best for small smart phones
37313>>>    End_Object
37314>>>    
37314>>>    Object oLoginName is a cWebForm
37316>>>        Set psLabel to "User ID:"
37317>>>        Set peLabelPosition to lpTop
37318>>>        Set piMaxLength to 20
37319>>>        Set piColumnIndex to 1
37320>>>        Set pbShowLabel to False
37321>>>        Set psPlaceHolder to "loginname"
37322>>>        Set piColumnSpan to 10
37323>>>        Set psAutoComplete to "username"
37324>>>    End_Object
37325>>>    
37325>>>    Object oPassword is a cWebForm
37327>>>        Set psLabel to "Password:"
37328>>>        Set pbPassword to True
37329>>>        Set peLabelAlign to alignLeft
37330>>>        Set piMaxLength to 20
37331>>>        Set peLabelPosition to lpTop
37332>>>        Set pbShowLabel to False
37333>>>        Set psPlaceHolder to "password"
37334>>>        Set piColumnSpan to 10
37335>>>        Set piColumnIndex to 1
37336>>>        Set psAutoComplete to "current-password"
37337>>>    End_Object
37338>>>    
37338>>>    Object oWebSpacer1 is a cWebSpacer
37340>>>        Set piColumnSpan to 12
37341>>>        Set piHeight to 10
37342>>>    End_Object
37343>>>    
37343>>>    Object oLoginButton is a cWebButton
37345>>>        Set pbShowLabel to False
37346>>>        Set psCaption to "sign in"
37347>>>        Set pbServerOnClick to True
37348>>>        Set piColumnSpan to 10
37349>>>        Set piColumnIndex to 1
37350>>>        
37350>>>        Procedure OnClick
37353>>>            Send DoLogin
37354>>>        End_Procedure
37355>>>    End_Object
37356>>>    
37356>>>    Object oBottomSpacer is a cWebSpacer
37358>>>        Set pbFillHeight to True
37359>>>        Set piColumnSpan to 12
37360>>>    End_Object
37361>>>    
37361>>>    Procedure DoLogin
37364>>>        String sLoginName sPassword sPrevStateHash
37364>>>        Boolean bResult
37364>>>        
37364>>>        WebGet psValue of oLoginName to sLoginName
37365>>>        WebGet psValue of oPassword to sPassword
37366>>>        
37366>>>        Get UserLogin of ghoWebSessionManager sLoginName sPassword to bResult
37367>>>        
37367>>>        If (bResult) Begin
37369>>>            Send Hide of oLogin
37370>>>            Send ShowHeader of ghoWebApp
37371>>>            WebSet psCSSClass of ghoWebApp to ""
37372>>>            
37372>>>            WebGet psPrevStateHash to sPrevStateHash
37373>>>            Send NavigateToStateHash of ghoWebApp sPrevStateHash True
37374>>>            
37374>>>            // clear the login values. we don't want to return the login id & password as synchronized properties....
37374>>>            WebSet psValue of oLoginName to ""
37375>>>            WebSet psValue of oPassword  to ""
37376>>>            WebSet pbVisible of oWarning to False
37377>>>        End
37377>>>>
37377>>>        Else Begin
37378>>>            WebSet pbVisible of oWarning to True
37379>>>        End
37379>>>>
37379>>>    End_Procedure
37380>>>    
37380>>>    Procedure OnSubmit
37383>>>        Send DoLogin
37384>>>    End_Procedure
37385>>>    
37385>>>    Procedure OnLoad
37388>>>        String sPrevStateHash sView
37388>>>        
37388>>>        Forward Send OnLoad
37390>>>        
37390>>>        //  Store the current state so we can go back to that later (only if it points to a different view)
37390>>>        Get StateHash of ghoWebApp to sPrevStateHash
37391>>>        Send ParseViewStateHash sPrevStateHash (&sView)
37392>>>        If (Lowercase(sView) <> Lowercase(psStateViewName(Self))) Begin
37394>>>            WebSet psPrevStateHash to sPrevStateHash
37395>>>        End
37395>>>>
37395>>>        
37395>>>    End_Procedure
37396>>>    
37396>>>    Procedure OnBeforeShow
37399>>>        //  Hide header & apply nice background style
37399>>>        Send HideHeader to ghoWebApp
37400>>>        WebSet psCSSClass of ghoWebApp to "LoginBackground"
37401>>>    End_Procedure
37402>>>    
37402>>>End_Object
37403>>>
37403>>>
37403>>>
37403>>>
37403>    Use WebResourceManager.wo
Including file: WebResourceManager.wo    (C:\DataFlex Projects\Centros\AppSrc\WebResourceManager.wo)
37403>>>Use cWebResourceManager.pkg
37403>>>
37403>>>Object oWebResourceManager is a cWebResourceManager
37405>>>End_Object
37406>    
37406>    Use Dashboard.wo
Including file: Dashboard.wo    (C:\DataFlex Projects\Centros\AppSrc\Dashboard.wo)
37406>>>Use cWebView.pkg
37406>>>Use cWebPanel.pkg
37406>>>Use cWebForm.pkg
37406>>>Use cWebButton.pkg
37406>>>Use cWebGroup.pkg
37406>>>Use cWebSpacer.pkg
37406>>>Use cWebHtmlBox.pkg
37406>>>Use cWebMenuGroup.pkg
37406>>>Use cWebMenuItem.pkg
37406>>>Use cWebLabel.pkg
37406>>>Use cWebList.pkg
37406>>>Use cWebColumn.pkg
37406>>>
37406>>>Object oDashboard is a cWebView
37408>>>
37408>>>    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  
37408>>>    // Add a DDO Structure 
37408>>>    //
37408>>>    // There is no need to synchronize a DD structure on the client so we do
37408>>>    // not set the Server property or send ADDOStructure. We will simply use
37408>>>    // DDO's to mine data and generate HTML for our cWebHTMLBox objects.
37408>>>    // It is the HTML in these objects that is sent to the client each time 
37408>>>    // this page is shown.
37408>>>    //
37408>>>    // Also, it is important for the drill-down Navigation interface that we
37408>>>    // do not set the Server property to some DDO because this will affect 
37408>>>    // constraints in the next view that we navigate to.
37408>>>    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
37408>>>
37408>>>    Set piMaxWidth to 1024
37409>>>    
37409>>>    Set psCaption to "Dashboard"
37410>>>    Set peViewType to vtUndefined
37411>>>    Set pbShowCaption to False
37412>>>    Set psCSSClass to "Dashboard"
37413>>>    
37413>>>    Object oWebMainPanel is a cWebPanel
37415>>>        Set piColumnCount to 24
37416>>>        
37416>>>        // - - - - - - - - - - - - - - -
37416>>>        // Main Panel's Responsive Rules
37416>>>        // - - - - - - - - - - - - - - -
37416>>>        WebSetResponsive piColumnCount rmMobile to 1
37417>>>        WebSetResponsive piColumnCount rmTabletPortrait to 16
37418>>>    
37418>>>        Object oTiles_grp is a cWebGroup
37420>>>            Set piColumnSpan to 8
37421>>>            Set pbShowBorder to False
37422>>>            Set pbShowCaption to False
37423>>>            Set piColumnCount to 12
37424>>>            
37424>>>            Set psCSSClass to "TilesGroup"
37425>>>    
37425>>>            Object oWelcomeTile is a cWebHtmlBox
37427>>>                Set piColumnSpan to 6
37428>>>                Set psCSSClass to "Tile Light"
37429>>>                Set psHtml to '<div Class="WebCon_Sizer"><div class="Tile_Title">Welcome</div><div Class="Tile_Subtitle">--</div></div>'
37430>>>    
37430>>>                Procedure OnLoad
37433>>>                    Send UpdateHTML ('<div class="WebCon_Sizer">' + ;                                     '<div class="Tile_Title">Welcome</div>' +;                                     '<div class="Tile_Subtitle">' - htmlEncode(psUserName(ghoWebSessionManager)) - '</div>' +;                                     '</div>')
37434>>>                End_Procedure
37435>>>                
37435>>>            End_Object
37436>>>    
37436>>>            Object oTile2 is a cWebHtmlBox
37438>>>                Set pbServerOnClick to True
37439>>>                Set piColumnSpan to 6
37440>>>                Set piColumnIndex to 6
37441>>>                Set psCSSClass to "Tile LightAlternate"
37442>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Email</div><div class="Tile_Subtitle"></div></div>'
37443>>>                                
37443>>>                WebRegisterPath ntNavigateForwardCustom oDummieEmail
37449>>>                
37449>>>                Procedure OnClick String sId String sParam
37452>>>                    Send NavigatePath
37453>>>                End_Procedure
37454>>>                
37454>>>            End_Object
37455>>>    
37455>>>            Object oTile3 is a cWebHtmlBox
37457>>>                Set pbServerOnClick to True
37458>>>                Set piColumnSpan to 6
37459>>>                Set psCSSClass to "Tile Dark"
37460>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Dni</div><div class="Tile_Subtitle"></div></div>'
37461>>>    
37461>>>                 WebRegisterPath ntNavigateForwardCustom oDummieDni
37467>>>                
37467>>>                Procedure OnClick String sId String sParam
37470>>>                    Send NavigatePath
37471>>>                End_Procedure
37472>>>                
37472>>>            End_Object
37473>>>            
37473>>>                
37473>>>    
37473>>>            Object oTile4 is a cWebHtmlBox
37475>>>                Set pbServerOnClick to True
37476>>>                Set piColumnSpan to 6
37477>>>                Set piColumnIndex to 6
37478>>>                Set psCSSClass to "Tile DarkAlternate"
37479>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Centros</div><div class="Tile_Subtitle"></div></div>'
37480>>>            
37480>>>                WebRegisterPath ntNavigateForwardCustom oSelectCentro
37486>>>                
37486>>>                Procedure OnClick String sId String sParam
37489>>>                    Send NavigatePath
37490>>>                End_Procedure
37491>>>            End_Object
37492>>>                
37492>>>            Object oTile5 is a cWebHtmlBox
37494>>>                Set pbServerOnClick to True
37495>>>                Set piColumnSpan to 6
37496>>>                Set psCSSClass to "Tile Dark"
37497>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Alummnos</div><div class="Tile_Subtitle"></div></div>'
37498>>>    
37498>>>                 WebRegisterPath ntNavigateForwardCustom oSelectStudents
37504>>>                
37504>>>                Procedure OnClick String sId String sParam
37507>>>                    Send NavigatePath
37508>>>                End_Procedure
37509>>>            End_Object
37510>>>            
37510>>>             Object oTile6 is a cWebHtmlBox
37512>>>                Set pbServerOnClick to True
37513>>>                Set piColumnSpan to 6
37514>>>                Set psCSSClass to "Tile Dark"
37515>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Telefono</div><div class="Tile_Subtitle"></div></div>'
37516>>>    
37516>>>                 WebRegisterPath ntNavigateForwardCustom oDummieTelefono
37522>>>                
37522>>>                Procedure OnClick String sId String sParam
37525>>>                    Send NavigatePath
37526>>>                End_Procedure
37527>>>            End_Object
37528>>>        End_Object
37529>>>    
37529>>>    End_Object
37530>>>    
37530>>>    Procedure OnBeforeShow
37533>>>        // Each time this view is shown we will update the appropriate information.
37533>>>    End_Procedure
37534>>>
37534>>>End_Object
37535>    Use DummieEmail.wo
Including file: DummieEmail.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieEmail.wo)
37535>>>Use cWebView.pkg
37535>>>Use cWebPanel.pkg
37535>>>Use cWebForm.pkg 
37535>>>
37535>>>Use zEmailValidation.pkg
Including file: zEmailValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zEmailValidation.pkg)
37535>>>>>Function zValidarEmail String sEmail  String ByRef sMsg Returns Boolean
37538>>>>> 
37538>>>>>  Boolean bRet
37538>>>>>  String[] aEmail 
37539>>>>>  
37539>>>>>    Get zSplitEmail sEmail  to aEmail 
37540>>>>>    
37540>>>>>    Get zArrobaCheck aEmail (&sMsg)  to bRet
37541>>>>>    If (not (bRet)) Function_Return False 
37544>>>>>    
37544>>>>>    Get zLocalAndressCheck aEmail (&sMsg)  to bRet
37545>>>>>    If (not (bRet)) Function_Return False
37548>>>>>    
37548>>>>>    Get zDominioAndExtensionCheck aEmail (&sMsg) to bRet
37549>>>>>    If (not (bRet)) Function_Return False
37552>>>>>    
37552>>>>>    Get zLocalAndressSizeCheck aEmail (&sMsg) to bRet 
37553>>>>>    If (not (bRet)) Function_Return False 
37556>>>>>    
37556>>>>>    Get zDomSizeCheck aEmail (&sMsg) to bRet 
37557>>>>>    If (not (bRet)) Function_Return False
37560>>>>>    
37560>>>>>    
37560>>>>>    Function_Return True
37561>>>>>End_Function
37562>>>>>
37562>>>>>
37562>>>>>
37562>>>>>Function zSplitEmail String sEmail Returns String[]
37565>>>>>    String[] aEmail
37566>>>>>    
37566>>>>>    Move (StrSplitToArray (sEmail , "@")) to aEmail
37567>>>>>    Function_Return aEmail
37568>>>>>End_Function
37569>>>>>
37569>>>>>
37569>>>>>
37569>>>>>Function zArrobaCheck String[] aEmail String ByRef sMsg Returns Boolean
37572>>>>>    If (SizeOfArray(aEmail) > 2) Begin 
37574>>>>>        Move "No se permite ms de un @ en el correo" to sMsg
37575>>>>>        Function_Return False 
37576>>>>>        
37576>>>>>    End
37576>>>>>>
37576>>>>>    If (SizeOfArray(aEmail) < 2) Begin
37578>>>>>        Move "Porfavor el correo tiene que contener un @" to sMsg
37579>>>>>        Function_Return False
37580>>>>>    End
37580>>>>>>
37580>>>>>    Function_Return True
37581>>>>>
37581>>>>>End_Function
37582>>>>>
37582>>>>>
37582>>>>>Function zLocalAndressCheck String[] aEmail String ByRef sMsg Returns Boolean
37585>>>>>    
37585>>>>>    String[] aRet
37586>>>>>    Object oEmailPattern is a cRegEx
37588>>>>>        Set psExpression to "^[a-zA-Z0-9._%+]+$"
37589>>>>>    End_Object
37590>>>>>    
37590>>>>>    Get MatchAll of oEmailPattern (aEmail[0]) to aRet
37591>>>>>    
37591>>>>>    If (SizeOfArray(aRet) = 1 ) Begin
37593>>>>>            Function_Return True
37594>>>>>            
37594>>>>>    End
37594>>>>>>
37594>>>>>    
37594>>>>>    Move "Antes del @ solo puede haber un codigo alfanumerico y/o (. , _ , % , +)" to sMsg
37595>>>>>    Function_Return False
37596>>>>>End_Function
37597>>>>>
37597>>>>>Function zDominioAndExtensionCheck String[] aEmail String ByRef sMsg Returns Boolean
37600>>>>>    
37600>>>>>    String[] aRet aDomRet
37602>>>>>    Integer iPospoint
37602>>>>>    String sExtensionDom
37602>>>>>    Object oEmailPattern is a cRegEx
37604>>>>>        Set psExpression to "^[a-zA-Z0-9-]+\.[a-zA-Z]{2,7}$"
37605>>>>>    End_Object
37606>>>>>    
37606>>>>>    Get MatchAll of oEmailPattern (aEmail[1]) to aRet
37607>>>>>    
37607>>>>>    
37607>>>>>    Move (RightPos ( "." , aRet[0] )) to iPospoint
37608>>>>>    Move (Mid(aRet[0] , (Length(aRet[0]) - iPospoint) , (iPospoint + 1))) to sExtensionDom
37609>>>>>    
37609>>>>>    If (SizeOfArray(aRet) = 1 ) Begin
37611>>>>>        If (Length(sExtensionDom) > 1 and Length(sExtensionDom) < 8) Begin
37613>>>>>            
37613>>>>>            Function_Return True 
37614>>>>>        End
37614>>>>>>
37614>>>>>            
37614>>>>>    End
37614>>>>>>
37614>>>>>    
37614>>>>>    Move "Despues del @ solo puede contener un codigo alfanumerico seguido de un punto y la extesion que tiene una longitud enttre 2 y 7, solo permitiendo letras" to sMsg
37615>>>>>    Function_Return False
37616>>>>>    
37616>>>>>    
37616>>>>>End_Function
37617>>>>>
37617>>>>>Function zLocalAndressSizeCheck String[] aEmail String ByRef sMsg Returns Boolean
37620>>>>>    
37620>>>>>     If (Length(aEmail[0]) < 65) Begin
37622>>>>>        Function_Return True
37623>>>>>     End
37623>>>>>>
37623>>>>>     Move "La parte de la direccin local Solo puede tener un maximo de 65 caracteres " to sMsg
37624>>>>>        Function_Return False
37625>>>>>End_Function
37626>>>>>
37626>>>>>
37626>>>>>Function zDomSizeCheck String[] aEmail String ByRef sMsg Returns Boolean
37629>>>>>    
37629>>>>>   
37629>>>>>    If (Length(aEmail[1]) < 256 ) Begin
37631>>>>>        Function_Return True
37632>>>>>    End
37632>>>>>>
37632>>>>>    
37632>>>>>    Move "El el dominio no puede superar los 255 caracteres" to sMsg
37633>>>>>    
37633>>>>>    
37633>>>>>    Function_Return False 
37634>>>>>End_Function
37635>>>>>
37635>>>>>
37635>>>Use cWebButton.pkg
37635>>>Use cWebSpacer.pkg
37635>>>Use cWebLabel.pkg
37635>>>
37635>>>Object oDummieEmail is a cWebView
37637>>>    Set piWidth to 700
37638>>>    Set psCaption to "DummieEmail"
37639>>>
37639>>>    // Your DDO structure will go here
37639>>>
37639>>>    Object oWebMainPanel is a cWebPanel
37641>>>        Set piColumnCount to 12
37642>>>        
37642>>>        // place controls here
37642>>>        // Your view will grow as controls are added
37642>>>        
37642>>>        Object oEmail_Form is a cWebForm
37644>>>            Set piColumnSpan to 0
37645>>>            Set psLabel to "Email"
37646>>>        End_Object
37647>>>
37647>>>        Object oError_Label is a cWebLabel
37649>>>            Set psCaption to ""
37650>>>            Set piColumnSpan to 13
37651>>>            Set piColumnIndex to 0
37652>>>        End_Object
37653>>>
37653>>>        Object oWebSpacer1 is a cWebSpacer
37655>>>            Set piColumnSpan to 12
37656>>>        End_Object
37657>>>
37657>>>        Object oValidar_Button is a cWebButton
37659>>>            Set piColumnSpan to 4
37660>>>            Set piColumnIndex to 4
37661>>>            Set psCaption to "Validar"
37662>>>        
37662>>>            Procedure OnClick
37665>>>                Boolean bRet
37665>>>                String sEmail sMsg
37665>>>                WebGet psValue of oEmail_Form to sEmail
37666>>>                Get zValidarEmail sEmail (&sMsg) to bRet
37667>>>                
37667>>>                WebSet psBackgroundColor of oEmail_Form to "#ffffff"
37668>>>                WebSet psCaption of oError_Label to ""
37669>>>                
37669>>>                If (bRet) Begin
37671>>>                    WebSet psBackgroundColor of oEmail_Form to "green"
37672>>>                    
37672>>>                End
37672>>>>
37672>>>                If (not (bRet)) Begin
37674>>>                    WebSet psBackgroundColor of oEmail_Form to "red"
37675>>>                    WebSet psCaption of oError_Label to sMsg
37676>>>                End
37676>>>>
37676>>>                
37676>>>            End_Procedure
37677>>>        End_Object
37678>>>        
37678>>>        
37678>>>        
37678>>>    End_Object 
37679>>>
37679>>>End_Object
37680>    Use DummineDniValidation.wo
Including file: DummineDniValidation.wo    (C:\DataFlex Projects\Centros\AppSrc\DummineDniValidation.wo)
37680>>>Use cWebWidget.pkg
Including file: cWebWidget.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cWebWidget.pkg)
37680>>>>>Use cWebGroup.pkg
37680>>>>>Use cWebDDOSync_Mixin.pkg
37680>>>>>Use WebWidgetStructs.pkg
Including file: WebWidgetStructs.pkg    (C:\Program Files\DataFlex 25.0\Pkg\WebWidgetStructs.pkg)
37680>>>>>>>// WCT: Wizard Control Type
37680>>>>>>>Enum_List
37680>>>>>>>    Define WCT_Form       for 0
37680>>>>>>>    Define WCT_Combo      for 1
37680>>>>>>>    Define WCT_Slider     for 2
37680>>>>>>>    Define WCT_Checkbox   for 3
37680>>>>>>>End_Enum_List
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigPropSettings
37680>>>>>>>    String sOptLabel
37680>>>>>>>    String sOptDescription
37680>>>>>>>    Integer eControlType        // 0 = form, 1 = combo, 2 = slider, 3 = checkbox. Use above enum
37680>>>>>>>    Boolean bOptValidateValue   // Whether to validate the given value versus any of the underlying options
37680>>>>>>>    Integer iOptMinValue
37680>>>>>>>    Integer iOptMaxValue
37680>>>>>>>    Integer iOptStepSize
37680>>>>>>>    String[] asOptValues
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigProp
37680>>>>>>>    String sObjName
37680>>>>>>>    String sPropName
37680>>>>>>>    tWidgetConfigPropSettings Settings
37680>>>>>>>    tWidgetConfigPropSettings Settings
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigPropValue
37680>>>>>>>    String sObjName
37680>>>>>>>    String sPropName
37680>>>>>>>    String sValue
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetDef
37680>>>>>>>    String sName
37680>>>>>>>    String sDynId
37680>>>>>>>    Integer iRowIndex
37680>>>>>>>    Integer iColIndex
37680>>>>>>>    Integer iRowSpan
37680>>>>>>>    Integer iColSpan
37680>>>>>>>    Boolean bFillHeight
37680>>>>>>>    tWidgetConfigPropValue[] aConfig // ToDo: This could be smarter, aggregate by child-object and list all props there.
37680>>>>>>>    tWidgetConfigPropValue[] aConfig // ToDo: This could be smarter, aggregate by child-object and list all props there.
37680>>>>>>>    tWebPropRule[] aResponsivePropRules
37680>>>>>>>    tWebPropRule[] aResponsivePropRules
37680>>>>>>>End_Struct
37680>>>>>
37680>>>>>//  Function from cWebDynamicObjectContainer
37680>>>>>Register_Function TruncateName String sObjectName Returns String
37680>>>>>
37680>>>>>//Struct tWidget
37680>>>>>//    String sId
37680>>>>>//    tWidgetDef WidgetDef
37680>>>>>//End_Struct
37680>>>>>
37680>>>>>Class cWebWidget is a cWebGroup
37681>>>>>    
37681>>>>>    Procedure Construct_Object
37683>>>>>        Forward Send Construct_Object
37685>>>>>        
37685>>>>>        Property Integer piDefaultColSpan 1
37686>>>>>        Property Integer piDefaultRowSpan 1
37687>>>>>        
37687>>>>>        Property String psDynamicWidgetId                   // Set by the container to easily find this widget for dynamic configuration
37689>>>>>        
37689>>>>>        Property String psWidgetName
37691>>>>>        
37691>>>>>        Property String psWidgetCaption ""
37692>>>>>        Property String psWidgetDescription ""
37693>>>>>        
37693>>>>>        Property Boolean pbAllowConfiguration True
37695>>>>>        
37695>>>>>        Property Boolean pbConfigurable False
37697>>>>>        
37697>>>>>        Property Handle phoConfigWizard C_WebUnresolvedObject
37698>>>>>        
37698>>>>>        // Default to flow to make the designer work with the widgetcontainer and because we do not want widgets to inherit whatever is set at the dashboard view
37698>>>>>        Set peLayoutType to ltFlow
37699>>>>>        Set pbFillHeight to True
37700>>>>>        Set pbScroll to True
37701>>>>>        
37701>>>>>        Set psJSClass to 'df.WebWidget'
37702>>>>>        
37702>>>>>        Send Define_cWebDDOSync_mixin
37703>>>>>    End_Procedure
37704>>>>>    
37704>>>>>    Import_Class_Protocol cWebDDOSync_mixin
37705>>>>>    
37705>>>>>    Function IsWebWidget Returns Boolean
37707>>>>>        Function_Return True
37708>>>>>    End_Function
37709>>>>>    
37709>>>>>    Procedure InitWidget
37711>>>>>        Boolean bConfigurable
37711>>>>>        
37711>>>>>        Get IsConfigurable to bConfigurable
37712>>>>>        WebSet pbConfigurable to bConfigurable
37713>>>>>        
37713>>>>>        Send OnInitializeWidget
37714>>>>>    End_Procedure
37715>>>>>    
37715>>>>>    Function ConfigurablePropExists tWidgetConfigProp WidgetConfigProp Returns Boolean
37717>>>>>        Boolean bExists
37717>>>>>        tWidgetConfigProp[] aConfigurableProps 
37717>>>>>        tWidgetConfigProp[] aConfigurableProps 
37718>>>>>        
37718>>>>>        Get GetConfigurableProps to aConfigurableProps
37719>>>>>        
37719>>>>>        Get ConfigurablePropExistsEx aConfigurableProps WidgetConfigProp to bExists
37720>>>>>        
37720>>>>>        Function_Return bExists
37721>>>>>    End_Function
37722>>>>>    
37722>>>>>    Function ConfigurablePropExistsEx tWidgetConfigProp[] aConfigurableProps tWidgetConfigProp WidgetConfigProp Returns Boolean
37724>>>>>        Integer i iProps
37724>>>>>        String sTrimmedObjName
37724>>>>>        
37724>>>>>        Get TrimDynamicObjectName WidgetConfigProp.sObjName to sTrimmedObjName
37725>>>>>        
37725>>>>>        Move ((SizeOfArray(aConfigurableProps)) - 1) to iProps
37726>>>>>        
37726>>>>>        For i from 0 to iProps
37732>>>>>>
37732>>>>>            If (aConfigurableProps[i].sObjName = sTrimmedObjName and aConfigurableProps[i].sPropName = WidgetConfigProp.sPropName) Begin
37734>>>>>                Function_Return True
37735>>>>>            End
37735>>>>>>
37735>>>>>        Loop
37736>>>>>>
37736>>>>>        
37736>>>>>        Function_Return False
37737>>>>>    End_Function
37738>>>>>    
37738>>>>>    // Gets the configurable props for this widget
37738>>>>>    // This is used by the configuration wizard to build a configuration dialog, based on the prop settings
37738>>>>>    Function GetConfigurableProps Returns tWidgetConfigProp[]
37740>>>>>        tWidgetConfigProp[] aConfigurableProps
37740>>>>>        tWidgetConfigProp[] aConfigurableProps
37741>>>>>
37741>>>>>        Send OnGetConfigurableProps (&aConfigurableProps)
37742>>>>>        
37742>>>>>        Function_Return aConfigurableProps
37743>>>>>    End_Function
37744>>>>>    
37744>>>>>    Function IsConfigurable Returns Boolean
37746>>>>>        Boolean bAllowConfig
37746>>>>>        tWidgetConfigProp[] aConfigurableProps
37746>>>>>        tWidgetConfigProp[] aConfigurableProps
37747>>>>>        
37747>>>>>        Move ( ((phoConfigWizard(Self)) <> C_WebUnresolvedObject) and (pbAllowConfiguration(Self)) ) to bAllowConfig
37748>>>>>        
37748>>>>>        Send OnDetermineConfigurableState (&bAllowConfig)
37749>>>>>        
37749>>>>>        Function_Return bAllowConfig
37750>>>>>    End_Function
37751>>>>>    
37751>>>>>    Function GetConfigurablePropValues Returns tWidgetConfigPropValue[]
37753>>>>>        tWidgetConfigProp[] aProps
37753>>>>>        tWidgetConfigProp[] aProps
37754>>>>>        tWidgetConfigPropValue[] aValues
37754>>>>>        tWidgetConfigPropValue[] aValues
37755>>>>>        tWebPropMetaData PropMeta
37755>>>>>        tWebPropMetaData PropMeta
37755>>>>>        Variant vValue
37755>>>>>        Integer i iProps iType
37755>>>>>        Boolean bValid
37755>>>>>        String sDynamicObjectId
37755>>>>>        Handle hoObj
37755>>>>>        tWidgetConfigPropValue CurValue EmptyValue
37755>>>>>        tWidgetConfigPropValue CurValue EmptyValue
37755>>>>>        
37755>>>>>        // Get all config props
37755>>>>>        
37755>>>>>        Get GetConfigurableProps to aProps
37756>>>>>        
37756>>>>>        Move ((SizeOfArray(aProps)) - 1) to iProps
37757>>>>>        
37757>>>>>        For i from 0 to iProps
37763>>>>>>
37763>>>>>            Delegate Get TruncateName aProps[i].sObjName to sDynamicObjectId
37765>>>>>            If (sDynamicObjectId <> "") Begin
37767>>>>>                WebGet psDynamicWidgetId to sDynamicObjectId
37768>>>>>                Move (sDynamicObjectId + '.' + aProps[i].sObjName) to sDynamicObjectId
37769>>>>>                
37769>>>>>                Get DynamicObject sDynamicObjectId to hoObj
37770>>>>>            End
37770>>>>>>
37770>>>>>            Else Begin
37771>>>>>                Move (Self) to hoObj
37772>>>>>            End
37772>>>>>>
37772>>>>>            
37772>>>>>            If (hoObj <> 0) Begin
37774>>>>>                Move EmptyValue to CurValue
37775>>>>>                
37775>>>>>                Get FindWebPropertyMetaByName of hoObj aProps[i].sPropName to PropMeta
37776>>>>>                If (PropMeta.hmGetter <> 0) Begin
37778>>>>>                    Get GetSyncProp of hoObj hoObj PropMeta.hmGetter PropMeta.sName to vValue
37779>>>>>                    
37779>>>>>                    Get VariantType vValue to iType
37780>>>>>                    If (iType = OLE_VT_Empty) Begin
37782>>>>>                        Move False to bValid
37783>>>>>                    End
37783>>>>>>
37783>>>>>                    Else Begin
37784>>>>>                        Get VerifyConfigurablePropValue aProps[i] vValue to bValid
37785>>>>>                    End
37785>>>>>>
37785>>>>>                    
37785>>>>>                    If (bValid) Begin
37787>>>>>                        Move sDynamicObjectId to CurValue.sObjName
37788>>>>>                        Move aProps[i].sPropName to CurValue.sPropName
37789>>>>>                        Move vValue to CurValue.sValue
37790>>>>>                        Move CurValue to aValues[-1]
37791>>>>>                    End
37791>>>>>>
37791>>>>>                    Else Begin
37792>>>>>                        Function_Return EmptyValue
37793>>>>>                    End
37793>>>>>>
37793>>>>>                End
37793>>>>>>
37793>>>>>                Else Begin
37794>>>>>                    Function_Return EmptyValue
37795>>>>>                End
37795>>>>>>
37795>>>>>            End
37795>>>>>>
37795>>>>>        Loop
37796>>>>>>
37796>>>>>        
37796>>>>>        Function_Return aValues
37797>>>>>    End_Function
37798>>>>>    
37798>>>>>    Function VerifyConfigurablePropValue tWidgetConfigProp ConfigProp Variant vValue Returns Boolean
37800>>>>>        // Check variant type
37800>>>>>        // check if variant within acceptable range of values
37800>>>>>        Integer iType iVals i
37800>>>>>        Number nCur
37800>>>>>        
37800>>>>>        If (not(ConfigProp.Settings.bOptValidateValue)) Begin
37802>>>>>            Function_Return True
37803>>>>>        End
37803>>>>>>
37803>>>>>        
37803>>>>>        Get VariantType vValue to iType
37804>>>>>        Move ((SizeOfArray(ConfigProp.Settings.asOptValues)) -1) to iVals
37805>>>>>        
37805>>>>>        If (iType = OLE_VT_I4 or iType = OLE_VT_I8 or ;            iType = OLE_VT_R4 or iType = OLE_VT_I8) Begin
37807>>>>>            // compare min, max and allowed vals
37807>>>>>            If (vValue >= ConfigProp.Settings.iOptMinValue and vValue =< ConfigProp.Settings.iOptMaxValue) Begin
37809>>>>>                // check step size
37809>>>>>                If (ConfigProp.Settings.iOptStepSize > 0) Begin
37811>>>>>                    Move ConfigProp.Settings.iOptMinValue to nCur
37812>>>>>                    While (nCur <= ConfigProp.Settings.iOptMaxValue)
37816>>>>>                        If (vValue = nCur) Begin
37818>>>>>                            Function_Return True
37819>>>>>                        End
37819>>>>>>
37819>>>>>                        Move (nCur + ConfigProp.Settings.iOptStepSize) to nCur
37820>>>>>                    Loop
37821>>>>>>
37821>>>>>                End
37821>>>>>>
37821>>>>>                Else Begin
37822>>>>>                    Function_Return True
37823>>>>>                End
37823>>>>>>
37823>>>>>            End
37823>>>>>>
37823>>>>>            
37823>>>>>            For i from 0 to iVals
37829>>>>>>
37829>>>>>                If (vValue = ConfigProp.Settings.asOptValues[i]) Begin
37831>>>>>                    Function_Return True
37832>>>>>                End
37832>>>>>>
37832>>>>>            Loop
37833>>>>>>
37833>>>>>        End
37833>>>>>>
37833>>>>>        If (iType = OLE_VT_Bstr) Begin
37835>>>>>            // compare allowed values
37835>>>>>            If (iVals <= 0) Begin
37837>>>>>                Function_Return True
37838>>>>>            End
37838>>>>>>
37838>>>>>            
37838>>>>>            For i from 0 to iVals
37844>>>>>>
37844>>>>>                If (vValue = ConfigProp.Settings.asOptValues[i]) Begin
37846>>>>>                    Function_Return True
37847>>>>>                End
37847>>>>>>
37847>>>>>            Loop
37848>>>>>>
37848>>>>>        End
37848>>>>>>
37848>>>>>        
37848>>>>>        
37848>>>>>        
37848>>>>>        Function_Return False
37849>>>>>    End_Function
37850>>>>>    
37850>>>>>    // Performs the equivalent of a webget for objects within this widget
37850>>>>>    Function GetWidgetConfigurablePropValue String sObj String sProp Returns Variant
37852>>>>>        String sDynamicObjectId
37852>>>>>        Handle hoObj
37852>>>>>        tWebPropMetaData PropMeta
37852>>>>>        tWebPropMetaData PropMeta
37852>>>>>        Variant vRet
37852>>>>>        
37852>>>>>        Delegate Get TruncateName sObj to sDynamicObjectId
37854>>>>>        Get DynamicObject sDynamicObjectId to hoObj
37855>>>>>        
37855>>>>>        If (hoObj <> 0) Begin
37857>>>>>            Get FindWebPropertyMetaByName of hoObj sProp to PropMeta
37858>>>>>            Get GetSyncProp of hoObj hoObj PropMeta.hmGetter PropMeta.sName to vRet
37859>>>>>        End
37859>>>>>>
37859>>>>>        
37859>>>>>        Function_Return vRet
37860>>>>>    End_Function
37861>>>>>    
37861>>>>>    Function TrimDynamicObjectName String sObjName Returns String
37863>>>>>        String[] asObjName
37864>>>>>        String sRetName
37864>>>>>        
37864>>>>>        Delegate Get TruncateName sObjName to sObjName
37866>>>>>        
37866>>>>>        Move (StrSplitToArray(sObjName, psDynamicWidgetID(Self))) to asObjName
37867>>>>>        
37867>>>>>        If (SizeOfArray(asObjName) > 1) Begin
37869>>>>>            Move asObjName[1] to sRetName
37870>>>>>            // Get rid of initial '.' if we end up with such a name
37870>>>>>            If ((Pos('.', sRetName)) = 1) Begin
37872>>>>>                Move (Replace('.', sRetName, '')) to sRetName
37873>>>>>            End
37873>>>>>>
37873>>>>>        End
37873>>>>>>
37873>>>>>        
37873>>>>>        Function_Return sRetName
37874>>>>>    End_Function
37875>>>>>    
37875>>>>>    Function CreateConfigurableProp Handle hoObj Handle hmPropFunc Returns tWidgetConfigProp
37877>>>>>        tWidgetConfigProp WidgetConfigProp
37877>>>>>        tWidgetConfigProp WidgetConfigProp
37877>>>>>        tWebPropMetaData PropMeta
37877>>>>>        tWebPropMetaData PropMeta
37877>>>>>        String sObjName
37877>>>>>        String[] asObjName
37878>>>>>        Boolean bIsDynamic
37878>>>>>        
37878>>>>>        Get IsDynamicObject of hoObj to bIsDynamic
37879>>>>>        If (bIsDynamic) Begin
37881>>>>>            Get TrimDynamicObjectName (WebObjectName(hoObj)) to WidgetConfigProp.sObjName
37882>>>>>        End
37882>>>>>>
37882>>>>>        Else Begin
37883>>>>>            // Assume Default widget & top level prop (will correct itself when attempting to apply)
37883>>>>>            Move "" to WidgetConfigProp.sObjName
37884>>>>>        End
37884>>>>>>
37884>>>>>
37884>>>>>        Get FindWebPropertyMeta of hoObj hmPropFunc to PropMeta
37885>>>>>        Move PropMeta.sName to WidgetConfigProp.sPropName
37886>>>>>
37886>>>>>        Function_Return WidgetConfigProp
37887>>>>>    End_Function
37888>>>>>    
37888>>>>>    Procedure OnInitializeWidget
37890>>>>>    End_Procedure
37891>>>>>    
37891>>>>>    Procedure OnGetConfigurableProps tWidgetConfigProp[] ByRef aConfigurableProps
37893>>>>>        // This event can be used to modify the initial set of configurable props based on for example permissions
37893>>>>>    End_Procedure
37894>>>>>    
37894>>>>>    Procedure OnWidgetPropsChanged
37896>>>>>    End_Procedure
37897>>>>>    
37897>>>>>    Procedure OnDetermineConfigurableState Boolean ByRef bAllow
37899>>>>>    End_Procedure
37900>>>>>    
37900>>>>>    Function AllowAccess Returns Boolean
37902>>>>>        // Override with your custom logic to determine if this widget should be rendered or not under certain circumstances
37902>>>>>        Function_Return True
37903>>>>>    End_Function
37904>>>>>    
37904>>>>>    // Used by AllowViewAccess to determine the name passed to the session manager.
37904>>>>>    Function ViewName Returns String
37906>>>>>        Function_Return (psWidgetName(Self))
37907>>>>>    End_Function
37908>>>>>    
37908>>>>>    // DDO Sync logic
37908>>>>>    Procedure Call_PreSync
37910>>>>>        Boolean bAllow bOrigSync
37910>>>>>        
37910>>>>>        Get pbSynchronizing to bOrigSync
37911>>>>>        Set pbSynchronizing to True
37912>>>>>        
37912>>>>>        Get SyncDDOs to bAllow        
37913>>>>>         
37913>>>>>        Broadcast Recursive Send UpdateDataBinding
37915>>>>>        
37915>>>>>        Set pbSynchronizing to bOrigSync
37916>>>>>    End_Procedure
37917>>>>>    
37917>>>>>    Procedure Call_PostSync
37919>>>>>        Send StoreDDOStates
37920>>>>>    End_Procedure
37921>>>>>    
37921>>>>>    
37921>>>>>    Procedure RegisterDDOStructure
37923>>>>>        // Override to do nothing
37923>>>>>    End_Procedure
37924>>>>>    
37924>>>>>    // Called by cWebDDOSync_mixin
37924>>>>>    Function IsDynamicConstraints Returns Boolean
37926>>>>>        Function_Return False
37927>>>>>    End_Function
37928>>>>>
37928>>>>>    // Override to not check parent, widgets should be encapsulated - we don't want to bleed the view's DDO's into them
37928>>>>>    Function Server Returns Integer
37930>>>>>        Integer hoServer
37930>>>>>        Get private_Server to hoServer
37931>>>>>//        If (hoServer = 0) Begin
37931>>>>>//            Function_Return (Locate_Server(parent(Self)))
37931>>>>>//        End
37931>>>>>        Function_Return hoServer
37932>>>>>    End_Function  
37933>>>>>
37933>>>>>    Function Widget Returns Handle 
37935>>>>>        Function_Return Self
37936>>>>>    End_Function
37937>>>>>
37937>>>>>    Procedure End_Construct_Object
37939>>>>>        Forward Send End_Construct_Object
37941>>>>>        
37941>>>>>        Send Attach_Deo_To_Server                       // Attach the DEO to the server DDs
37942>>>>>        Broadcast Recursive Send Attach_Deo_To_Server   // Make Child DEO's attach to their server
37944>>>>>        Broadcast Recursive Set In_Use_State to True    // Set each DDO's In_Use_State
37946>>>>>        Send WriteDDOCache                              // Store a cache of the DDO objects
37947>>>>>    End_Procedure
37948>>>>>   
37948>>>>>End_Class
37949>>>
37949>>>Composite oDummineDniValidation is a cWebWidget
37953>>>
37953>>>    // Your DDO structure will go here
37953>>>
37953>>>    Set piDefaultColSpan to 4
37954>>>    Set piDefaultRowSpan to 5
37955>>>    
37955>>>    Set psWidgetName to "oDummineDniValidation"
37956>>>    Set psWidgetCaption to "DummineDniValidation"
37957>>>    Set psWidgetDescription to "My custom widget"
37958>>>
37958>>>    Set piColumnCount to 12
37959>>>        
37959>>>End_Composite
37961>    Use DummieDni.wo
Including file: DummieDni.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieDni.wo)
37961>>>Use cWebView.pkg
37961>>>Use cWebPanel.pkg
37961>>>Use cWebForm.pkg 
37961>>>Use cWebButton.pkg
37961>>>Use cWebSpacer.pkg
37961>>>Use cWebLabel.pkg
37961>>>
37961>>>Use zDniValidation.pkg
Including file: zDniValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zDniValidation.pkg)
37961>>>>>Function zDniValidation  String sDni  String ByRef sMsg Returns Boolean
37964>>>>>    String sLetter sNumber 
37964>>>>>    Boolean bRet
37964>>>>>    
37964>>>>>    Get zNieComprobation sDni to sDni
37965>>>>>    
37965>>>>>    Get zDniNumberComprobation sDni (&sMsg) to bRet
37966>>>>>    If (not (bRet)) Function_Return False
37969>>>>>    
37969>>>>>    Move (Mid(sDni, 1 , 9)) to   sLetter
37970>>>>>    Move (Mid(sDni, 8, 1 ))  to sNumber
37971>>>>>    Move (Uppercase(sLetter)) to sLetter
37972>>>>>
37972>>>>>   
37972>>>>>   Get zDniLetterComprobation sLetter sNumber (&sMsg) to bRet
37973>>>>>   If (not (bRet)) Function_Return False
37976>>>>>  Function_Return True
37977>>>>>      
37977>>>>>End_Function
37978>>>>>
37978>>>>>Function zNieComprobation String sDni Returns String 
37981>>>>>
37981>>>>>    
37981>>>>>    
37981>>>>>       If (Uppercase(sDni) matches "X????????" )  Begin
37983>>>>>        Move ("0" + Mid (sDni, 8, 2)) to sDni
37984>>>>>        Function_Return (sDni)
37985>>>>>    End
37985>>>>>>
37985>>>>>       If (Uppercase(sDni) matches "Y????????" )  Begin
37987>>>>>       
37987>>>>>        Move ("1" + Mid (sDni, 8, 2)) to sDni
37988>>>>>        Function_Return sDni
37989>>>>>    End
37989>>>>>>
37989>>>>>     If (Uppercase(sDni) matches "Z????????" )  Begin
37991>>>>>       
37991>>>>>        Move ("2" + Mid (sDni, 8, 2)) to sDni
37992>>>>>        Function_Return sDni
37993>>>>>    End
37993>>>>>>
37993>>>>>   
37993>>>>>    Function_Return sDni
37994>>>>>End_Function
37995>>>>>
37995>>>>>
37995>>>>>
37995>>>>>Function zDniNumberComprobation String sDni String ByRef sMSg Returns Boolean
37998>>>>>    String[] aRet
37999>>>>>    Object oDnipattern is a cRegEx
38001>>>>>        Set psExpression to "^[0-9]{8}[a-zA-Z]{1}+$"
38002>>>>>    End_Object
38003>>>>>    Get MatchAll of oDnipattern (sDni) to aRet
38004>>>>>    If (SizeOfArray(aRet) = 1) Begin
38006>>>>>        Function_Return True
38007>>>>>    End
38007>>>>>>
38007>>>>>    
38007>>>>>    Move "Porfavor Introduzca un formato de dni valido 8 digitos y una letra" to sMSg
38008>>>>>    Function_Return False
38009>>>>>End_Function
38010>>>>>
38010>>>>>
38010>>>>>/**Function zDniLetterComprobation String sLetter String sNumber String ByRef sMsg Returns Boolean    String sValidationLeter    Move "T,R,W,A,G,M,Y,F,P,D,X,B,N,J,Z,S,Q,V,H,L,C,K,E" to sValidationLeter     String[] aValidationLeter        Move (StrSplitToArray (sValidationLeter, ",")) to aValidationLeter    If (aValidationLeter[(Mod(Integer(sNumber), 23 ) )] = sLetter ) Begin        Function_Return True    End    Move "La letra no es coincidene con los numeros" to sMsg    Function_Return False    End_Function**/
38010>>>>>
38010>>>>>
38010>>>>>Function zDniLetterComprobation String sLetter String sNumber String ByRef sMsg Returns Boolean
38013>>>>>    String sValidationLeter sTrueLetter
38013>>>>>    Move "TRWAGMYFPDXBNJZSQVHLCKE" to sValidationLeter
38014>>>>>
38014>>>>>    
38014>>>>>    Move (Mid(sValidationLeter, 1 , (Mod(Integer(sNumber), 23) + 1))) to sTrueLetter
38015>>>>>    If (sTrueLetter = sLetter ) Begin
38017>>>>>        Function_Return True
38018>>>>>    End
38018>>>>>>
38018>>>>>    Move "La letra no es coincidene con los numeros" to sMsg
38019>>>>>    Function_Return False
38020>>>>>    
38020>>>>>End_Function
38021>>>
38021>>>Object oDummieDni is a cWebView
38023>>>    Set piWidth to 700
38024>>>    Set psCaption to "DummieDni"
38025>>>
38025>>>    // Your DDO structure will go here
38025>>>
38025>>>    Object oWebMainPanel is a cWebPanel
38027>>>        Set piColumnCount to 12
38028>>>        
38028>>>        // place controls here
38028>>>        // Your view will grow as controls are added
38028>>>        
38028>>>        Object oForm_Dni is a cWebForm
38030>>>            Set piColumnSpan to 0
38031>>>            Set psLabel to "introduzca DNI"
38032>>>        End_Object
38033>>>
38033>>>        Object oWebLabel_sMsg_Err is a cWebLabel
38035>>>            Set psCaption to ""
38036>>>            Set piColumnIndex to 0
38037>>>            Set piColumnSpan to 12
38038>>>        End_Object
38039>>>
38039>>>        Object oWebSpacer1 is a cWebSpacer
38041>>>            Set piColumnSpan to 12
38042>>>        End_Object
38043>>>
38043>>>        Object oValidationButton is a cWebButton
38045>>>            Set piColumnSpan to 6
38046>>>            Set psCaption to "Validar"
38047>>>            Set piColumnIndex to 3
38048>>>        
38048>>>            Procedure OnClick
38051>>>                Boolean bRet
38051>>>                String sDni sMsg
38051>>>                WebGet psValue of oForm_Dni to sDni
38052>>>                Get zDniValidation sDni (&sMsg) to bRet
38053>>>                
38053>>>                WebSet psBackgroundColor of oForm_Dni to "#ffffff"
38054>>>                WebSet psCaption of oWebLabel_sMsg_Err to ""
38055>>>                
38055>>>                If (bRet) Begin
38057>>>                    WebSet psBackgroundColor of oForm_Dni to "green"
38058>>>                    
38058>>>                End
38058>>>>
38058>>>                If (not (bRet)) Begin
38060>>>                    WebSet psBackgroundColor of oForm_Dni to "red"
38061>>>                    WebSet psCaption of oWebLabel_sMsg_Err to sMsg
38062>>>                End
38062>>>>
38062>>>                
38062>>>                
38062>>>            End_Procedure
38063>>>        End_Object
38064>>>        
38064>>>    End_Object 
38065>>>
38065>>>End_Object
38066>    Use ZoomAllStudents.wo
Including file: ZoomAllStudents.wo    (C:\DataFlex Projects\Centros\AppSrc\ZoomAllStudents.wo)
38066>>>// C:\DataFlex Projects\Centros\AppSrc\ZoomAllStudents.wo
38066>>>// Todos los estudiantes
38066>>>//
38066>>>
38066>>>Use cWebView.pkg
38066>>>Use cWebPanel.pkg
38066>>>Use cWebMenuGroup.pkg
38066>>>Use cWebMenuItem.pkg
38066>>>Use cWebForm.pkg
38066>>>Use cWebTabContainer.pkg
38066>>>Use cWebTabPage.pkg
38066>>>Use cWebCheckBox.pkg
38066>>>
38066>>>Use cCentrosDataDictionary.dd
Including file: cCentrosDataDictionary.dd    (C:\DataFlex Projects\Centros\DDSrc\cCentrosDataDictionary.dd)
38066>>>>>Use DataDict.pkg
38066>>>>>
38066>>>>>Open Centros
Including file: Centros.fd    (C:\DataFlex Projects\Centros\DDSrc\Centros.fd)
38068>>>>>Open Alumnos
Including file: Alumnos.fd    (C:\DataFlex Projects\Centros\DDSrc\Alumnos.fd)
38070>>>>>
38070>>>>>Class cCentrosDataDictionary is a DataDictionary
38071>>>>>    
38071>>>>>    Procedure Construct_Object
38073>>>>>        Forward Send Construct_Object
38075>>>>>        Set Main_File to Centros.File_Number
38076>>>>>
38076>>>>>        Set Add_Client_File to Alumnos.File_Number
38077>>>>>
38077>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
38078>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
38079>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
38080>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
38081>>>>>
38081>>>>>        Set Field_Mask_Type Field Centros.CodigoPostal to Mask_Numeric_Window
38082>>>>>        
38082>>>>>
38082>>>>>
38082>>>>>        Set Field_Mask_Type Field Centros.FechaCreacionRegistro to Mask_DateTime_Window
38083>>>>>        Set Field_Option Field Centros.FechaCreacionRegistro DD_NOENTER to True
38084>>>>>
38084>>>>>        Set Field_Mask_Type Field Centros.FechaUltimaModificacion to Mask_DateTime_Window
38085>>>>>        Set Field_Option Field Centros.FechaUltimaModificacion DD_NOENTER to True
38086>>>>>       
38086>>>>>         
38086>>>>>
38086>>>>>    End_Procedure
38087>>>>>
38087>>>>>    Procedure Field_Defaults
38089>>>>>         DateTime dtCurrentDateTime
38089>>>>>         
38089>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38090>>>>>       
38090>>>>>        Forward Send Field_Defaults
38092>>>>>        Set Field_Changed_Value Field Centros.FechaCreacionRegistro to  dtCurrentDateTime 
38093>>>>>        Set Field_Changed_Value Field Centros.FechaUltimaModificacion to  dtCurrentDateTime 
38094>>>>>        
38094>>>>>    End_Procedure
38095>>>>>    
38095>>>>>     Procedure Update
38097>>>>>        Forward Send Update
38099>>>>>        Move  (CurrentDateTime())  to Centros.FechaUltimaModificacion
38100>>>>>    End_Procedure
38101>>>>>
38101>>>>>
38101>>>>>End_Class
38102>>>Use cAlumnosDataDictionary.dd
Including file: cAlumnosDataDictionary.dd    (C:\DataFlex Projects\Centros\DDSrc\cAlumnosDataDictionary.dd)
38102>>>>>Use DataDict.pkg
38102>>>>>
38102>>>>>Use zEmailValidation.pkg
38102>>>>>Use zDniValidation.pkg
38102>>>>>
38102>>>>>
38102>>>>>Open Alumnos
38104>>>>>Open Centros
38106>>>>>
38106>>>>>Register_Function zValidateErr_StudentEmail Integer iField Returns Boolean
38106>>>>>Register_Function zValidateErr_StudentDni Integer iField Returns Boolean
38106>>>>>Object oGender is a DescriptionValidationTable
38108>>>>>    Procedure Fill_List
38111>>>>>        Forward Send Fill_List
38113>>>>>        Send Add_Table_Value "H" "Hombre"
38114>>>>>        Send Add_Table_Value "M" "Mujer"
38115>>>>>        Send Add_Table_Value "N" "Prefiero no responder"
38116>>>>>        Send Add_Table_Value "O" "Otro"
38117>>>>>    End_Procedure
38118>>>>>End_Object
38119>>>>>
38119>>>>>
38119>>>>>
38119>>>>>
38119>>>>>Class cAlumnosDataDictionary is a DataDictionary
38120>>>>>    
38120>>>>>    Procedure Construct_Object
38122>>>>>        Forward Send Construct_Object
38124>>>>>        Set Main_File to Alumnos.File_Number
38125>>>>>
38125>>>>>        Set Add_Server_File to Centros.File_Number
38126>>>>>
38126>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
38127>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
38128>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
38129>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
38130>>>>>
38130>>>>>        Set Field_Option Field Alumnos.AlumnosId DD_REQUIRED to True
38131>>>>>
38131>>>>>        Set Field_Class_Name Field Alumnos.Sexo to "Combo"
38132>>>>>        Set Field_Value_Table Field Alumnos.Sexo to oGender
38133>>>>>
38133>>>>>        Set Field_Mask_Type Field Alumnos.CodigoPostal to Mask_Numeric_Window
38134>>>>>        
38134>>>>>
38134>>>>>
38134>>>>>        Set Field_Mask_Type Field Alumnos.FechaCreacionRegistro to Mask_DateTime_Window
38135>>>>>        Set Field_Option Field Alumnos.FechaCreacionRegistro DD_NOENTER to True
38136>>>>>
38136>>>>>        Set Field_Mask_Type Field Alumnos.FechaUltimaModificacion to Mask_DateTime_Window
38137>>>>>        Set Field_Option Field Alumnos.FechaUltimaModificacion DD_NOENTER to True
38138>>>>>        
38138>>>>>        Set Field_Validate_msg Field Alumnos.Email to get_zValidateErr_StudentEmail
38139>>>>>        Set Field_Validate_msg Field Alumnos.Dni to get_zValidateErr_StudentDni
38140>>>>>
38140>>>>>    End_Procedure
38141>>>>>
38141>>>>>
38141>>>>>
38141>>>>>    Function zValidateErr_StudentDni Integer iField Returns Boolean
38143>>>>>        Boolean bret
38143>>>>>        String sDni sMsg
38143>>>>>        Get Field_Current_Value Field Alumnos.Dni to sDni
38144>>>>>        Get zDniValidation sDni (&sMsg) to bret
38145>>>>>        If (not (bret)) Begin
38147>>>>>                Send Data_set_error iField DFERR_OPERATOR sMsg
38148>>>>>        Function_Return True        
38149>>>>>        End
38149>>>>>>
38149>>>>>        Function_Return False
38150>>>>>    End_Function
38151>>>>>
38151>>>>>
38151>>>>>    Function zValidateErr_StudentEmail Integer iField Returns Boolean
38153>>>>>        Boolean bret
38153>>>>>        String sEmail sMsg
38153>>>>>        Get Field_Current_Value Field Alumnos.Email to sEmail
38154>>>>>        Get zValidarEmail sEmail (&sMsg) to bret
38155>>>>>        If (not (bret)) Begin
38157>>>>>                Send Data_set_error iField DFERR_OPERATOR sMsg
38158>>>>>        Function_Return True        
38159>>>>>        End
38159>>>>>>
38159>>>>>        Function_Return False
38160>>>>>    End_Function
38161>>>>>                
38161>>>>>  
38161>>>>>  
38161>>>>>    Procedure Field_Defaults
38163>>>>>         DateTime dtCurrentDateTime
38163>>>>>         
38163>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38164>>>>>       
38164>>>>>        Forward Send Field_Defaults
38166>>>>>        Set Field_Changed_Value Field Alumnos.FechaCreacionRegistro to  dtCurrentDateTime
38167>>>>>        Set Field_Changed_Value Field Alumnos.FechaUltimaModificacion to  dtCurrentDateTime 
38168>>>>>    End_Procedure
38169>>>>>
38169>>>>>    Procedure Update
38171>>>>>        Forward Send Update
38173>>>>>        
38173>>>>>         DateTime dtCurrentDateTime
38173>>>>>         
38173>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38174>>>>>       
38174>>>>>        Set Field_Changed_Value Field Alumnos.FechaUltimaModificacion to  dtCurrentDateTime
38175>>>>>        
38175>>>>>    End_Procedure
38176>>>>>
38176>>>>>
38176>>>>>End_Class
38177>>>Use cWebCombo.pkg
38177>>>
38177>>>Object oZoomAllStudents is a cWebView
38179>>>    Set piColumnCount to 12
38180>>>    Set psCaption to "Todos los estudiantes"
38181>>>    Set peWebViewStyle to wvsDrilldown
38182>>>    Set peViewType to vtZoom
38183>>>    Set pbShowCaption to False
38184>>>    Set Verify_Save_Msg to 0
38185>>>    Set piMaxWidth to 1024
38186>>>
38186>>>    Object oCentros_DD is a cCentrosDataDictionary
38188>>>    End_Object 
38189>>>
38189>>>    Object oAlumnos_DD is a cAlumnosDataDictionary
38191>>>        Set DDO_Server To oCentros_DD
38192>>>    End_Object 
38193>>>
38193>>>    Set Main_DD To oAlumnos_DD
38194>>>    Set Server  To oAlumnos_DD
38195>>>
38195>>>
38195>>>    Object oWebMainPanel is a cWebPanel
38197>>>        Set piColumnCount to 12
38198>>>        WebSetResponsive piColumnCount rmMobile to 4
38199>>>
38199>>>        Object oAlumnosNombre is a cWebForm
38201>>>            Entry_Item Alumnos.Nombre
38202>>>            Set piColumnSpan to 6
38203>>>            Set piColumnIndex to 0
38204>>>            Set peLabelPosition to lpTop
38205>>>            Set psLabel to "Nombre"
38206>>>        End_Object 
38207>>>
38207>>>        Object oAlumnosApellidos is a cWebForm
38209>>>            Entry_Item Alumnos.Apellidos
38210>>>            Set piColumnSpan to 6
38211>>>            Set piColumnIndex to 6
38212>>>            Set peLabelPosition to lpTop
38213>>>            Set psLabel to "Apellidos"
38214>>>        End_Object 
38215>>>
38215>>>        Object oWebTabContainer is a cWebTabContainer
38217>>>            Set pbFillHeight to True
38218>>>            Set piColumnSpan to 12
38219>>>            Set pbShowLabel to False
38220>>>
38220>>>            Object oPage1 is a cWebTabPage
38222>>>                Set piColumnCount to 12
38223>>>                Set psCaption to "informacin Personal"
38224>>>
38224>>>                Object oAlumnoPrefijoTlfn is a cWebCombo
38226>>>                    Entry_Item Alumnos.PrefijoTlfn
38227>>>                    Set psLabel to "Prefijo"
38228>>>                    Set piColumnIndex to 0
38229>>>                    
38229>>>                    
38229>>>                    Set pbServerOnChange to True
38230>>>                    Set peLabelPosition to lpTop
38231>>>                    Set piColumnSpan to 2
38232>>>                    
38232>>>                    String[][] aResultsPrefijosPaises
38232>>>
38232>>>                    Procedure OnFill
38235>>>                    Integer inumPaises i
38235>>>                        Forward Send OnFill
38237>>>                        
38237>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT PrefijoTlfn, ISO3                            FROM Centros.dbo.Country;" to aResultsPrefijosPaises
38238>>>                            
38238>>>                        Move (SizeOfArray(aResultsPrefijosPaises)) to inumPaises    
38239>>>                        If (not(Err)) Begin
38241>>>                             For i from 0 to (inumPaises - 1)
38247>>>>
38247>>>                                Send AddComboItem aResultsPrefijosPaises[i][0] (aResultsPrefijosPaises[i][1] + "(" + aResultsPrefijosPaises[i][0] + ")")
38248>>>                             Loop
38249>>>>
38249>>>                        End
38249>>>>
38249>>>                        
38249>>>                    End_Procedure 
38250>>>                End_Object
38251>>>                WebSetResponsive piColumnCount rmMobile to 4
38252>>>
38252>>>                Object oAlumnosNumeroTelefono is a cWebForm
38254>>>                    Entry_Item Alumnos.NumeroTelefono
38255>>>                    Set piColumnSpan to 3
38256>>>                    Set piColumnIndex to 2
38257>>>                    Set peLabelPosition to lpTop
38258>>>                    Set psLabel to "Numero Telefono"
38259>>>                End_Object 
38260>>>
38260>>>                Object oAlumnosDni is a cWebForm
38262>>>                    Entry_Item Alumnos.Dni
38263>>>                    Set piColumnSpan to 2
38264>>>                    Set piColumnIndex to 5
38265>>>                    Set peLabelPosition to lpTop
38266>>>                    Set psLabel to "Dni"
38267>>>                End_Object 
38268>>>
38268>>>                Object oAlumnosSexo is a cWebCombo
38270>>>                    Entry_Item Alumnos.Sexo
38271>>>                    Set piColumnSpan to 3
38272>>>                    Set piColumnIndex to 8
38273>>>                    Set psCaption to "Sexo"
38274>>>                    Set pbShowLabel to True
38275>>>                    Set peLabelPosition to lpTop
38276>>>                    Set psLabel to "Gnero"
38277>>>                End_Object 
38278>>>
38278>>>                Object oAlumnosEmail is a cWebForm
38280>>>             
38280>>>                    Entry_Item Alumnos.Email
38281>>>                    Set piColumnSpan to 12
38282>>>                    Set piColumnIndex to 0
38283>>>                    Set peLabelPosition to lpTop
38284>>>                    Set psLabel to "Email"
38285>>>                End_Object 
38286>>>            End_Object 
38287>>>
38287>>>            Object oPage2 is a cWebTabPage
38289>>>                Set piColumnCount to 12
38290>>>                Set psCaption to "Ubicacin"
38291>>>                WebSetResponsive piColumnCount rmMobile to 4
38292>>>
38292>>>                Object oAlumnosPais is a cWebCombo
38294>>>                    Entry_Item Alumnos.Pais
38295>>>                    Set piColumnSpan to 3
38296>>>                    Set piColumnIndex to 0
38297>>>                    Set peLabelPosition to lpTop
38298>>>                    Set psLabel to "Pais"
38299>>>                    
38299>>>                    Set pbServerOnChange to True
38300>>>                    
38300>>>                    String[][] aResultsPaises
38300>>>
38300>>>                    Procedure OnFill
38303>>>                    Integer inumPaises i
38303>>>                        Forward Send OnFill
38305>>>                        
38305>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT id, Nombre                            FROM Centros.dbo.Country;" to aResultsPaises
38306>>>                            
38306>>>                        Move (SizeOfArray(aResultsPaises[0])) to inumPaises    
38307>>>                        If (not(Err)) Begin
38309>>>                             For i from 0 to (inumPaises - 1)
38315>>>>
38315>>>                                Send AddComboItem aResultsPaises[i][0] aResultsPaises[i][1] 
38316>>>                             Loop
38317>>>>
38317>>>                        End
38317>>>>
38317>>>                     
38317>>>                        
38317>>>                        
38317>>>                    End_Procedure
38318>>>
38318>>>                    Procedure OnChange String sNewValue String sOldValue
38321>>>                        Forward Send OnChange sNewValue sOldValue
38323>>>                        WebSet psValue of oAlumnosComunidadAutonoma to ""
38324>>>                        WebSet psValue of oAlumnosLocalidad to ""
38325>>>                       Send Refill of oAlumnosComunidadAutonoma 
38326>>>                    End_Procedure
38327>>>
38327>>>                    
38327>>>                    
38327>>>
38327>>>
38327>>>                End_Object 
38328>>>
38328>>>                Object oAlumnosComunidadAutonoma is a cWebCombo
38330>>>                    Entry_Item Alumnos.ComunidadAutonoma
38331>>>                    Set piColumnSpan to 3
38332>>>                    Set piColumnIndex to 4
38333>>>                    Set peLabelPosition to lpTop
38334>>>                    Set psLabel to "Comunidad Autonoma"
38335>>>                    Set pbServerOnChange to True
38336>>>                    
38336>>>                    
38336>>>                    Procedure OnFill
38339>>>                        Forward Send OnFill
38341>>>                        String  sPaisElegido sSQL
38341>>>                        Integer  inumComunidadAutonoma  i
38341>>>                        String[][]  aResults
38342>>>                 
38342>>>                        WebGet psValue of oAlumnosPais to sPaisElegido                   
38343>>>                        If (sPaisElegido = "") Procedure_Return
38346>>>                        Move ("SELECT S.id AS ComunidadAutonomaId, S.Nombre AS ComunidadAutonoma FROM Centros.dbo.State S WHERE S.CountryId = '" + sPaisElegido + "';") to sSQL 
38347>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38348>>>                                                
38348>>>                        If (not(Err)) Begin
38350>>>                            Move (SizeOfArray(aResults)) to inumComunidadAutonoma    
38351>>>                            For i from 0 to (inumComunidadAutonoma - 1)
38357>>>>
38357>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38358>>>                            Loop
38359>>>>
38359>>>                        End                        
38359>>>>
38359>>>                    End_Procedure
38360>>>                    
38360>>>                    Procedure OnChange String sNewValue String sOldValue
38363>>>                        Forward Send OnChange sNewValue sOldValue
38365>>>                        Send Refill of oAlumnosLocalidad 
38366>>>                        WebSet psValue of oAlumnosLocalidad to ""
38367>>>                    End_Procedure    
38368>>>                    
38368>>>                End_Object 
38369>>>
38369>>>                Object oAlumnosLocalidad is a cWebCombo
38371>>>                    Entry_Item Alumnos.Localidad
38372>>>                    Set piColumnSpan to 4
38373>>>                    Set piColumnIndex to 8
38374>>>                    Set peLabelPosition to lpTop
38375>>>                    Set psLabel to "Localidad"
38376>>>                    
38376>>>                    Procedure OnFill
38379>>>                        Forward Send OnFill
38381>>>                        String  sComunidadAutonomaElegida sSQL
38381>>>                        Integer  inumProvincia  i
38381>>>                        String[][]  aResults
38382>>>                 
38382>>>                        WebGet psValue of oAlumnosComunidadAutonoma to sComunidadAutonomaElegida                   
38383>>>                        If (sComunidadAutonomaElegida = "") Procedure_Return
38386>>>                        Move ("SELECT P.id AS ProvinciaId, P.Nombre AS Provincia FROM Centros.dbo.Province P WHERE P.StateId = '" + sComunidadAutonomaElegida + "';") to sSQL 
38387>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38388>>>                                                
38388>>>                        If (not(Err)) Begin
38390>>>                            Move (SizeOfArray(aResults)) to inumProvincia    
38391>>>                            For i from 0 to (inumProvincia - 1)
38397>>>>
38397>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38398>>>                            Loop
38399>>>>
38399>>>                        End                        
38399>>>>
38399>>>                    End_Procedure
38400>>>                    
38400>>>                    
38400>>>                End_Object 
38401>>>
38401>>>                Object oAlumnosDirreccion is a cWebForm
38403>>>                    Entry_Item Alumnos.Dirreccion
38404>>>                    Set piColumnSpan to 7
38405>>>                    Set piColumnIndex to 0
38406>>>                    Set peLabelPosition to lpTop
38407>>>                    Set psLabel to "Dirreccion"
38408>>>                End_Object 
38409>>>
38409>>>                Object oAlumnosCodigoPostal is a cWebForm
38411>>>                    Entry_Item Alumnos.CodigoPostal
38412>>>                    Set piColumnSpan to 2
38413>>>                    Set piColumnIndex to 8
38414>>>                    Set peLabelPosition to lpTop
38415>>>                    Set psLabel to "Codigo Postal"
38416>>>                End_Object 
38417>>>
38417>>>                Object oCentrosId is a cWebForm
38419>>>                    Entry_Item Centros.Id
38420>>>                    Set piColumnSpan to 2
38421>>>                    Set piColumnIndex to 10
38422>>>                    Set peLabelPosition to lpTop
38423>>>                    Set psLabel to "id del Centro "
38424>>>                    Set pbPromptButton to True
38425>>>
38425>>>// ToDo: Fill in the from-child parent Select view object name for navigate forward
38425>>>                    WebRegisterPath ntNavigateForward oSelectCentro
38431>>>
38431>>>                    Procedure OnPrompt
38434>>>                        Send NavigatePath
38435>>>                        
38435>>>                        
38435>>>                        
38435>>>                    End_Procedure
38436>>>                End_Object 
38437>>>            End_Object 
38438>>>
38438>>>            Object oPage3 is a cWebTabPage
38440>>>                Set piColumnCount to 12
38441>>>                Set psCaption to "Registros"
38442>>>                WebSetResponsive piColumnCount rmMobile to 4
38443>>>
38443>>>                Object oAlumnosFechaCreacionRegistro is a cWebForm
38445>>>                    Entry_Item Alumnos.FechaCreacionRegistro
38446>>>                    Set piColumnSpan to 3
38447>>>                    Set piColumnIndex to 0
38448>>>                    Set peLabelPosition to lpTop
38449>>>                    Set psLabel to "Fecha de creacion del registro"
38450>>>                End_Object 
38451>>>
38451>>>                Object oAlumnosFechaUltimaModificacion is a cWebForm
38453>>>                    Entry_Item Alumnos.FechaUltimaModificacion
38454>>>                    Set piColumnSpan to 3
38455>>>                    Set piColumnIndex to 3
38456>>>                    Set peLabelPosition to lpTop
38457>>>                    Set psLabel to "Fecha ultima modificacion"
38458>>>                End_Object 
38459>>>            End_Object 
38460>>>        End_Object 
38461>>>    End_Object 
38462>>>
38462>>>    Object oActionGroup is a cWebMenuGroup
38464>>>
38464>>>        Object oSaveBtn is a cWebMenuItem
38466>>>            Set psCSSClass to "WebSaveMenuItem"
38467>>>            Set psCaption to "Save"
38468>>>
38468>>>            Procedure OnClick
38471>>>                Send Request_Save
38472>>>            End_Procedure
38473>>>
38473>>>        End_Object 
38474>>>
38474>>>        Object oEditBtn is a cWebMenuItem
38476>>>            Set psCSSClass to "WebEditMenuItem"
38477>>>            Set psCaption to "Edit"
38478>>>            Procedure OnClick
38481>>>                Send ChangeEditMode True
38482>>>                Send SetActionButtons
38483>>>            End_Procedure
38484>>>
38484>>>        End_Object 
38485>>>
38485>>>        Object oDeleteBtn is a cWebMenuItem
38487>>>            Set psCSSClass to "WebDeleteMenuItem"
38488>>>            Set psCaption to "Delete"
38489>>>            Set peActionDisplay to adMenu
38490>>>
38490>>>            Procedure OnClick
38493>>>                Send Request_Delete
38494>>>            End_Procedure
38495>>>
38495>>>        End_Object 
38496>>>
38496>>>        Object oCancelChangesBtn is a cWebMenuItem
38498>>>            Set psCSSClass to "WebIcon_Refresh"
38499>>>            Set psCaption to "Clear Changes"
38500>>>            Set peActionDisplay to adMenu
38501>>>            Procedure OnClick
38504>>>                Send RefreshRecord
38505>>>            End_Procedure
38506>>>
38506>>>        End_Object 
38507>>>    End_Object 
38508>>>
38508>>>    Procedure SetActionButtons
38511>>>        tWebNavigateData NavigateData
38511>>>        tWebNavigateData NavigateData
38511>>>        Boolean bHasRecord
38511>>>        Handle hoDD
38511>>>
38511>>>        Get Server to hoDD
38512>>>        Get GetNavigateData to NavigateData
38513>>>        Get HasRecord of hoDD to bHasRecord
38514>>>
38514>>>        // let's hide all buttons and then Show the ones we want
38514>>>        WebSet pbRender of oEditBtn to False
38515>>>        WebSet pbRender of oSaveBtn to False
38516>>>        WebSet pbRender of oCancelChangesBtn to False
38517>>>        WebSet pbRender of oDeleteBtn to False
38518>>>
38518>>>        If (NavigateData.bReadOnly) Begin
38520>>>            WebSet pbRender of oEditBtn to True
38521>>>        End
38521>>>>
38521>>>        Else Begin
38522>>>            WebSet pbRender of oSaveBtn to True
38523>>>            WebSet pbRender of oCancelChangesBtn to True
38524>>>            WebSet pbRender of oDeleteBtn to bHasRecord
38525>>>        End
38525>>>>
38525>>>    End_Procedure
38526>>>
38526>>>    Procedure OnViewSaved Handle hoServer Boolean bChanged
38529>>>        // Close after save
38529>>>        Send NavigateClose Self
38530>>>    End_Procedure
38531>>>
38531>>>    // this will close the view after a delete
38531>>>    Procedure OnViewDeleted Handle hoDDO
38534>>>        Send NavigateClose Self
38535>>>    End_Procedure
38536>>>
38536>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
38539>>>        Case Begin
38539>>>            Case (NavigateData.eNavigateType = nfFromMain)
38541>>>                // If from main, this is a propbably a main file Select to Zoom.
38541>>>                Case Break
38542>>>
38542>>>            Case (NavigateData.eNavigateType = nfFromParent)
38545>>>                // If from parent, this is a constrained drill down.
38545>>>                Case Break
38546>>>
38546>>>            Case (NavigateData.eNavigateType = nfFromChild)
38549>>>                // If from child, this is a probably a parent Zoom from a Zoom.
38549>>>                Case Break
38550>>>
38550>>>            Case Else // must be nfUndefined
38550>>>
38550>>>        Case End
38550>>>
38550>>>        Send SetActionButtons
38551>>>
38551>>>    End_Procedure
38552>>>
38552>>>End_Object 
38553>    Use SelectStudents.wo
Including file: SelectStudents.wo    (C:\DataFlex Projects\Centros\AppSrc\SelectStudents.wo)
38553>>>// C:\DataFlex Projects\Centros\AppSrc\SelectStudents.wo
38553>>>// Students
38553>>>//
38553>>>
38553>>>Use cWebView.pkg
38553>>>Use cWebList.pkg
38553>>>Use cWebMenuGroup.pkg
38553>>>Use cWebMenuItem.pkg
38553>>>Use cWebColumnButton.pkg
38553>>>Use cWebColumn.pkg
38553>>>Use ZoomAllStudents.wo
38553>>>
38553>>>Use cCentrosDataDictionary.dd
38553>>>Use cAlumnosDataDictionary.dd
38553>>>
38553>>>Object oSelectStudents is a cWebView
38555>>>    Set psCaption to "Students"
38556>>>    Set peWebViewStyle to wvsDrilldown
38557>>>    Set peViewType to vtSelect
38558>>>    Set piColumnCount to 12
38559>>>    Set pbShowCaption to False
38560>>>    Set piMaxWidth to 1024
38561>>>
38561>>>    Object oCentros_DD is a cCentrosDataDictionary
38563>>>    End_Object 
38564>>>
38564>>>    Object oAlumnos_DD is a cAlumnosDataDictionary
38566>>>        Set DDO_Server To oCentros_DD
38567>>>    End_Object 
38568>>>
38568>>>    Set Main_DD To oAlumnos_DD
38569>>>    Set Server  To oAlumnos_DD
38570>>>
38570>>>
38570>>>    Object oList is a cWebList
38572>>>        Set piColumnSpan to 0
38573>>>        Set psCSSClass to "MobileList"
38574>>>        Set pbServerOnRowClick to True
38575>>>        Set pbFillHeight to True
38576>>>        Set pbShowHeader to False
38577>>>        Set piSortColumn to 0
38578>>>
38578>>>        Object oAlumnosNombre is a cWebColumn
38580>>>            Entry_Item Alumnos.Nombre
38581>>>            Set psCaption to "Alumnos.Nombre"
38582>>>            Set piWidth to 1000
38583>>>        End_Object 
38584>>>
38584>>>        Object oAlumnosApellidos is a cWebColumn
38586>>>            Entry_Item Alumnos.Apellidos
38587>>>            Set psCaption to "Alumnos.Apellidos"
38588>>>            Set piWidth to 1000
38589>>>        End_Object 
38590>>>
38590>>>        Object oDetailButton is a cWebColumnButton
38592>>>            Set psCaption to "btn"
38593>>>            Set piWidth to 45
38594>>>            Set pbFixedWidth to True
38595>>>            Set pbResizable to False
38596>>>            Set piListRowSpan to 2
38597>>>            Set psBtnCssClass to "WebButtonIcon WebIcon_Info"
38598>>>            Set peAlign to alignRight
38599>>>
38599>>>            WebRegisterPath ntNavigateForward oZoomAllStudents
38605>>>
38605>>>            Procedure OnClick
38608>>>                Send NavigatePath
38609>>>            End_Procedure
38610>>>
38610>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38613>>>                Move True to NavigateData.bReadOnly
38614>>>            End_Procedure
38615>>>
38615>>>        End_Object 
38616>>>
38616>>>        Object oAlumnosDni is a cWebColumn
38618>>>            Entry_Item Alumnos.Dni
38619>>>            Set psCaption to "Alumnos.Dni"
38620>>>            Set piWidth to 100
38621>>>            Set pbNewLine to True
38622>>>            Set psCSSClass to "RowDetail"
38623>>>        End_Object 
38624>>>
38624>>>        Object oCentrosId is a cWebColumn
38626>>>            Entry_Item Centros.Id
38627>>>            Set psCaption to "Alumnos.CentrosId"
38628>>>            Set piWidth to 100
38629>>>            Set psCSSClass to "RowDetail"
38630>>>        End_Object 
38631>>>
38631>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38631>>>//        WebRegisterPath ntNavigateForward oSelectView
38631>>>
38631>>>        Procedure OnRowClick String sRowId
38634>>>            tWebNavigateData NavigateData
38634>>>            tWebNavigateData NavigateData
38634>>>            Get GetNavigateData to NavigateData
38635>>>
38635>>>            Case Begin
38635>>>                Case (NavigateData.eNavigateType = nfFromParent)
38637>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38637>>>Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
38638>>>>
38638>>>//                    Send NavigateForward of oSelectView Self
38638>>>                    Case Break
38639>>>
38639>>>                Case (NavigateData.eNavigateType = nfFromChild)
38642>>>                    Send NavigateClose Self
38643>>>                    Case Break
38644>>>
38644>>>                Case (NavigateData.eNavigateType = nfFromMain)
38647>>>                    Send NavigateClose Self
38648>>>                    Case Break
38649>>>
38649>>>                Case Else // must be nfUndefined
38649>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38649>>>Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
38650>>>>
38650>>>//                    Send NavigateForward of oSelectView Self
38650>>>
38650>>>            Case End
38650>>>        End_Procedure
38651>>>
38651>>>        Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38654>>>            Move True to NavigateData.bReadOnly
38655>>>        End_Procedure
38656>>>
38656>>>    End_Object 
38657>>>
38657>>>    Object oActionGroup is a cWebMenuGroup
38659>>>
38659>>>        Object oSearch is a cWebMenuItem
38661>>>            Set psCSSClass to "WebPromptMenuItem"
38662>>>            Set psCaption to "Search"
38663>>>
38663>>>            Procedure OnClick
38666>>>                Send Search of oList
38667>>>            End_Procedure
38668>>>
38668>>>        End_Object 
38669>>>
38669>>>        Object oNewButton is a cWebMenuItem
38671>>>            Set psCSSClass to "WebClearMenuItem"
38672>>>            Set psCaption to "New"
38673>>>
38673>>>            WebRegisterPath ntNavigateForward oZoomAllStudents
38679>>>
38679>>>            Procedure OnClick
38682>>>                Send NavigatePath
38683>>>            End_Procedure
38684>>>
38684>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38687>>>                Move True to NavigateData.bNewRecord
38688>>>            End_Procedure
38689>>>
38689>>>        End_Object 
38690>>>    End_Object 
38691>>>
38691>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
38694>>>        WebSet pbRender of oNewButton to True
38695>>>        WebSet pbRender of oDetailButton to True
38696>>>
38696>>>        Case Begin
38696>>>            Case (NavigateData.eNavigateType = nfFromParent)
38698>>>                // If from parent, this is a constrained drill down
38698>>>                Case Break
38699>>>
38699>>>            Case (NavigateData.eNavigateType = nfFromChild)
38702>>>                // If from child, this is a probably a parent lookup from a Zoom
38702>>>                Case Break
38703>>>
38703>>>            Case (NavigateData.eNavigateType = nfFromMain)
38706>>>                // If from main, this is a probably a main-file lookup from a Zoom
38706>>>                WebSet pbRender of oDetailButton to False
38707>>>                Case Break
38708>>>
38708>>>            Case Else // must be nfUndefined
38708>>>                // This may be the start of a drilldown query or this may be used for some kind of custom query.
38708>>>
38708>>>        Case End
38708>>>
38708>>>    End_Procedure
38709>>>
38709>>>
38709>>>End_Object 
38710>    Use ZoomCentros.wo
Including file: ZoomCentros.wo    (C:\DataFlex Projects\Centros\AppSrc\ZoomCentros.wo)
38710>>>// C:\DataFlex Projects\Centros\AppSrc\ZoomCentros.wo
38710>>>// Centros
38710>>>//
38710>>>
38710>>>Use cWebView.pkg
38710>>>Use cWebPanel.pkg
38710>>>Use cWebMenuGroup.pkg
38710>>>Use cWebMenuItem.pkg
38710>>>Use cWebForm.pkg
38710>>>Use cWebTabContainer.pkg
38710>>>Use cWebTabPage.pkg
38710>>>
38710>>>Use cCentrosDataDictionary.dd
38710>>>
38710>>>Object oZoomCentros is a cWebView
38712>>>    Set piColumnCount to 12
38713>>>    Set psCaption to "Centros"
38714>>>    Set peWebViewStyle to wvsDrilldown
38715>>>    Set peViewType to vtZoom
38716>>>    Set pbShowCaption to False
38717>>>    Set Verify_Save_Msg to 0
38718>>>    Set piMaxWidth to 1024
38719>>>
38719>>>    Object oCentros_DD is a cCentrosDataDictionary
38721>>>    End_Object 
38722>>>
38722>>>    Set Main_DD To oCentros_DD
38723>>>    Set Server  To oCentros_DD
38724>>>
38724>>>
38724>>>    Object oWebMainPanel is a cWebPanel
38726>>>        Set piColumnCount to 12
38727>>>        WebSetResponsive piColumnCount rmMobile to 4
38728>>>
38728>>>        Object oCentrosNombre is a cWebForm
38730>>>            Entry_Item Centros.Nombre
38731>>>            Set piColumnSpan to 6
38732>>>            Set piColumnIndex to 0
38733>>>            Set peLabelPosition to lpTop
38734>>>            Set psLabel to "Nombre"
38735>>>        End_Object 
38736>>>
38736>>>        Object oCentrosPsNombre is a cWebForm
38738>>>            Entry_Item Centros.PsNombre
38739>>>            Set piColumnSpan to 6
38740>>>            Set piColumnIndex to 6
38741>>>            Set peLabelPosition to lpTop
38742>>>            Set psLabel to "PsNombre"
38743>>>        End_Object 
38744>>>
38744>>>        Object oCentrosEmpresa is a cWebForm
38746>>>            Entry_Item Centros.Empresa
38747>>>            Set piColumnSpan to 8
38748>>>            Set piColumnIndex to 0
38749>>>            Set peLabelPosition to lpTop
38750>>>            Set psLabel to "Empresa"
38751>>>        End_Object 
38752>>>
38752>>>        Object oWebTabContainer is a cWebTabContainer
38754>>>            Set pbFillHeight to True
38755>>>            Set piColumnSpan to 12
38756>>>            Set pbShowLabel to False
38757>>>
38757>>>            Object oPage1 is a cWebTabPage
38759>>>                Set piColumnCount to 12
38760>>>                Set psCaption to "Ubicacin"
38761>>>                WebSetResponsive piColumnCount rmMobile to 4
38762>>>
38762>>>                Object oCentrosPais is a cWebCombo
38764>>>                    Entry_Item Centros.Pais
38765>>>                    Set piColumnSpan to 4
38766>>>                    Set piColumnIndex to 0
38767>>>                    Set peLabelPosition to lpTop
38768>>>                    Set psLabel to "Pais"
38769>>>                    Set pbServerOnChange to True
38770>>>//                    
38770>>>//                    String[][] aResultsPaises
38770>>>
38770>>>                    Procedure OnFill
38773>>>                    Integer inumPaises i
38773>>>                        Forward Send OnFill
38775>>>                        
38775>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT id, Nombre                            from Centros.dbo.Country;" to aResultsPaises
38776>>>                            
38776>>>                        Move (SizeOfArray(aResultsPaises[0])) to inumPaises    
38777>>>                        If (not(Err)) Begin
38779>>>                             For i from 0 to (inumPaises - 1)
38785>>>>
38785>>>                                Send AddComboItem aResultsPaises[i][0] aResultsPaises[i][1] 
38786>>>                             Loop
38787>>>>
38787>>>                        End
38787>>>>
38787>>>                     
38787>>>                        
38787>>>                        
38787>>>                    End_Procedure
38788>>>
38788>>>                    Procedure OnChange String sNewValue String sOldValue
38791>>>                        Forward Send OnChange sNewValue sOldValue
38793>>>                        WebSet psValue of oCentrosComunidadAutonoma to ""
38794>>>                        WebSet psValue of oCentrosLocalidad to ""
38795>>>                       Send Refill of oCentrosComunidadAutonoma 
38796>>>                    End_Procedure
38797>>>
38797>>>                    
38797>>>                    
38797>>>                End_Object 
38798>>>
38798>>>                Object oCentrosComunidadAutonoma is a cWebCombo
38800>>>                    Entry_Item Centros.ComunidadAutonoma                   
38801>>>                    Set piColumnSpan to 4
38802>>>                    Set piColumnIndex to 4
38803>>>                    Set peLabelPosition to lpTop
38804>>>                    Set psLabel to "Comunidad Autonoma"
38805>>>                    Set pbServerOnChange to True
38806>>>                    
38806>>>                    
38806>>>                    Procedure OnFill
38809>>>                        Forward Send OnFill
38811>>>                        String  sPaisElegido sSQL
38811>>>                        Integer  inumComunidadAutonoma  i
38811>>>                        String[][]  aResults
38812>>>                 
38812>>>                        WebGet psValue of oCentrosPais to sPaisElegido                   
38813>>>                        If (sPaisElegido = "") Procedure_Return
38816>>>                        Move ("SELECT S.id AS ComunidadAutonomaId, S.Nombre AS ComunidadAutonoma FROM Centros.dbo.State S WHERE S.CountryId = '" + sPaisElegido + "';") to sSQL 
38817>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38818>>>                                                
38818>>>                        If (not(Err)) Begin
38820>>>                            Move (SizeOfArray(aResults)) to inumComunidadAutonoma    
38821>>>                            For i from 0 to (inumComunidadAutonoma - 1)
38827>>>>
38827>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38828>>>                            Loop
38829>>>>
38829>>>                        End                        
38829>>>>
38829>>>                    End_Procedure
38830>>>                    
38830>>>                    Procedure OnChange String sNewValue String sOldValue
38833>>>                        Forward Send OnChange sNewValue sOldValue
38835>>>                        Send Refill of oCentrosLocalidad 
38836>>>                        WebSet psValue of oCentrosLocalidad to ""
38837>>>                    End_Procedure    
38838>>>                    
38838>>>                    
38838>>>                End_Object 
38839>>>
38839>>>                Object oCentrosLocalidad is a cWebCombo
38841>>>                    Entry_Item Centros.Localidad
38842>>>                    Set piColumnSpan to 4
38843>>>                    Set piColumnIndex to 8
38844>>>                    Set peLabelPosition to lpTop
38845>>>                    Set psLabel to "Provincia"
38846>>>                    Set pbServerOnChange to True
38847>>>                    
38847>>>                    
38847>>>                    Procedure OnFill
38850>>>                        Forward Send OnFill
38852>>>                        String  sComunidadAutonomaElegida sSQL
38852>>>                        Integer  inumProvincia  i
38852>>>                        String[][]  aResults
38853>>>                 
38853>>>                        WebGet psValue of oCentrosComunidadAutonoma to sComunidadAutonomaElegida                   
38854>>>                        If (sComunidadAutonomaElegida = "") Procedure_Return
38857>>>                        Move ("SELECT P.id AS ProvinciaId, P.Nombre AS Provincia FROM Centros.dbo.Province P WHERE P.StateId = '" + sComunidadAutonomaElegida + "';") to sSQL 
38858>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38859>>>                                                
38859>>>                        If (not(Err)) Begin
38861>>>                            Move (SizeOfArray(aResults)) to inumProvincia    
38862>>>                            For i from 0 to (inumProvincia - 1)
38868>>>>
38868>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38869>>>                            Loop
38870>>>>
38870>>>                        End                        
38870>>>>
38870>>>                    End_Procedure
38871>>>            
38871>>>                End_Object 
38872>>>
38872>>>                Object oCentrosDireccion is a cWebForm
38874>>>                    Entry_Item Centros.Direccion
38875>>>                    Set piColumnSpan to 9
38876>>>                    Set piColumnIndex to 0
38877>>>                    Set peLabelPosition to lpTop
38878>>>                    Set psLabel to "Direccion"
38879>>>                End_Object 
38880>>>
38880>>>                Object oCentrosCodigoPostal is a cWebForm
38882>>>                    Entry_Item Centros.CodigoPostal
38883>>>                    Set piColumnSpan to 2
38884>>>                    Set piColumnIndex to 9
38885>>>                    Set peLabelPosition to lpTop
38886>>>                    Set psLabel to "Codigo Postal"
38887>>>                End_Object 
38888>>>            End_Object 
38889>>>
38889>>>            Object oPage2 is a cWebTabPage
38891>>>                Set piColumnCount to 12
38892>>>                Set psCaption to "Datos de Registro"
38893>>>                WebSetResponsive piColumnCount rmMobile to 4
38894>>>
38894>>>                Object oCentrosFechaCreacionRegistro is a cWebForm
38896>>>                    Entry_Item Centros.FechaCreacionRegistro
38897>>>                    Set piColumnSpan to 3
38898>>>                    Set piColumnIndex to 0
38899>>>                    Set peLabelPosition to lpTop
38900>>>                    Set psLabel to "Fecha de creacion del registro"
38901>>>                End_Object 
38902>>>
38902>>>                Object oCentrosFechaUltimaModificacion is a cWebForm
38904>>>                    Entry_Item Centros.FechaUltimaModificacion
38905>>>                    Set piColumnSpan to 3
38906>>>                    Set piColumnIndex to 3
38907>>>                    Set peLabelPosition to lpTop
38908>>>                    Set psLabel to "Fecha ultima de la modificacion"
38909>>>                End_Object 
38910>>>            End_Object 
38911>>>        End_Object 
38912>>>    End_Object 
38913>>>
38913>>>    Object oActionGroup is a cWebMenuGroup
38915>>>
38915>>>        Object oSaveBtn is a cWebMenuItem
38917>>>            Set psCSSClass to "WebSaveMenuItem"
38918>>>            Set psCaption to "Save"
38919>>>
38919>>>            Procedure OnClick
38922>>>                Send Request_Save
38923>>>            End_Procedure
38924>>>
38924>>>        End_Object 
38925>>>
38925>>>        Object oEditBtn is a cWebMenuItem
38927>>>            Set psCSSClass to "WebEditMenuItem"
38928>>>            Set psCaption to "Edit"
38929>>>            Procedure OnClick
38932>>>                Send ChangeEditMode True
38933>>>                Send SetActionButtons
38934>>>            End_Procedure
38935>>>
38935>>>        End_Object 
38936>>>
38936>>>        Object oDeleteBtn is a cWebMenuItem
38938>>>            Set psCSSClass to "WebDeleteMenuItem"
38939>>>            Set psCaption to "Delete"
38940>>>            Set peActionDisplay to adMenu
38941>>>
38941>>>            Procedure OnClick
38944>>>                Send Request_Delete
38945>>>            End_Procedure
38946>>>
38946>>>        End_Object 
38947>>>
38947>>>        Object oCancelChangesBtn is a cWebMenuItem
38949>>>            Set psCSSClass to "WebIcon_Refresh"
38950>>>            Set psCaption to "Clear Changes"
38951>>>            Set peActionDisplay to adMenu
38952>>>            Procedure OnClick
38955>>>                Send RefreshRecord
38956>>>            End_Procedure
38957>>>
38957>>>        End_Object 
38958>>>    End_Object 
38959>>>
38959>>>    Procedure SetActionButtons
38962>>>        tWebNavigateData NavigateData
38962>>>        tWebNavigateData NavigateData
38962>>>        Boolean bHasRecord
38962>>>        Handle hoDD
38962>>>
38962>>>        Get Server to hoDD
38963>>>        Get GetNavigateData to NavigateData
38964>>>        Get HasRecord of hoDD to bHasRecord
38965>>>
38965>>>        // let's hide all buttons and then Show the ones we want
38965>>>        WebSet pbRender of oEditBtn to False
38966>>>        WebSet pbRender of oSaveBtn to False
38967>>>        WebSet pbRender of oCancelChangesBtn to False
38968>>>        WebSet pbRender of oDeleteBtn to False
38969>>>
38969>>>        If (NavigateData.bReadOnly) Begin
38971>>>            WebSet pbRender of oEditBtn to True
38972>>>        End
38972>>>>
38972>>>        Else Begin
38973>>>            WebSet pbRender of oSaveBtn to True
38974>>>            WebSet pbRender of oCancelChangesBtn to True
38975>>>            WebSet pbRender of oDeleteBtn to bHasRecord
38976>>>        End
38976>>>>
38976>>>    End_Procedure
38977>>>
38977>>>    Procedure OnViewSaved Handle hoServer Boolean bChanged
38980>>>        // Close after save
38980>>>        Send NavigateClose Self
38981>>>    End_Procedure
38982>>>
38982>>>    // this will close the view after a delete
38982>>>    Procedure OnViewDeleted Handle hoDDO
38985>>>        Send NavigateClose Self
38986>>>    End_Procedure
38987>>>
38987>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
38990>>>        Case Begin
38990>>>            Case (NavigateData.eNavigateType = nfFromMain)
38992>>>                // If from main, this is a propbably a main file Select to Zoom.
38992>>>                Case Break
38993>>>
38993>>>            Case (NavigateData.eNavigateType = nfFromParent)
38996>>>                // If from parent, this is a constrained drill down.
38996>>>                Case Break
38997>>>
38997>>>            Case (NavigateData.eNavigateType = nfFromChild)
39000>>>                // If from child, this is a probably a parent Zoom from a Zoom.
39000>>>                Case Break
39001>>>
39001>>>            Case Else // must be nfUndefined
39001>>>
39001>>>        Case End
39001>>>
39001>>>        Send SetActionButtons
39002>>>
39002>>>    End_Procedure
39003>>>
39003>>>    Procedure OnBeforeShow
39006>>>        Forward Send OnBeforeShow
39008>>>        Send Refill of oCentrosComunidadAutonoma
39009>>>        Send Refill of oCentrosLocalidad
39010>>>    End_Procedure
39011>>>
39011>>>End_Object 
39012>    Use SelectCentro.wo
Including file: SelectCentro.wo    (C:\DataFlex Projects\Centros\AppSrc\SelectCentro.wo)
39012>>>// C:\DataFlex Projects\Centros\AppSrc\SelectCentro.wo
39012>>>// Centro
39012>>>//
39012>>>
39012>>>Use cWebView.pkg
39012>>>Use cWebList.pkg
39012>>>Use cWebMenuGroup.pkg
39012>>>Use cWebMenuItem.pkg
39012>>>Use cWebColumnButton.pkg
39012>>>Use cWebColumn.pkg
39012>>>Use ZoomCentros.wo
39012>>>
39012>>>Use cCentrosDataDictionary.dd
39012>>>Use cWebLabel.pkg
39012>>>
39012>>>Object oSelectCentro is a cWebView
39014>>>    Set psCaption to "Centro"
39015>>>    Set peWebViewStyle to wvsDrilldown
39016>>>    Set peViewType to vtSelect
39017>>>    Set piColumnCount to 12
39018>>>    Set pbShowCaption to False
39019>>>    Set piMaxWidth to 1024
39020>>>
39020>>>    Object oCentros_DD is a cCentrosDataDictionary
39022>>>    End_Object 
39023>>>
39023>>>    Set Main_DD To oCentros_DD
39024>>>    Set Server  To oCentros_DD
39025>>>
39025>>>
39025>>>    Object oList is a cWebList
39027>>>        Set piColumnSpan to 0
39028>>>        Set psCSSClass to "MobileList"
39029>>>        Set pbServerOnRowClick to True
39030>>>        Set pbFillHeight to True
39031>>>        Set pbShowHeader to False
39032>>>        Set piSortColumn to 0
39033>>>
39033>>> 
39033>>>        
39033>>>        Object oCentrosPsNombre is a cWebColumn
39035>>>            Entry_Item Centros.PsNombre
39036>>>            Set psCaption to "Centros.PsNombre"
39037>>>            Set psCSSClass to "RowCapion"
39038>>>            Set piWidth to 750
39039>>>        End_Object 
39040>>>    
39040>>>        Object oCentrosEmpresa is a cWebColumn
39042>>>            Entry_Item Centros.Empresa
39043>>>            Set psCaption to "Centros.Empresa"
39044>>>            Set piWidth to 188
39045>>>        End_Object 
39046>>>
39046>>>        Object oDetailButton is a cWebColumnButton
39048>>>            Set psCaption to "btn"
39049>>>            Set piWidth to 126
39050>>>            Set pbFixedWidth to True
39051>>>            Set pbResizable to False
39052>>>            Set piListRowSpan to 2
39053>>>            Set psBtnCssClass to "WebButtonIcon WebIcon_Info"
39054>>>            Set peAlign to alignRight
39055>>>            
39055>>>
39055>>>            WebRegisterPath ntNavigateForward oZoomCentros
39061>>>
39061>>>            Procedure OnClick
39064>>>                Send NavigatePath
39065>>>            End_Procedure
39066>>>
39066>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39069>>>                Move True to NavigateData.bReadOnly
39070>>>            End_Procedure
39071>>>
39071>>>        End_Object 
39072>>>
39072>>>        
39072>>>        Object oCentrosNombre is a cWebColumn
39074>>>            Entry_Item Centros.Nombre
39075>>>            Set psCaption to "Centros.Nombre"
39076>>>            Set piWidth to 750
39077>>>            Set psCSSClass to "RowDetail"
39078>>>            Set pbNewLine to True
39079>>>        End_Object
39080>>>
39080>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39080>>>       WebRegisterPath ntNavigateForward oZoomCentros
39086>>>
39086>>>        Procedure OnRowClick String sRowId
39089>>>            tWebNavigateData NavigateData
39089>>>            tWebNavigateData NavigateData
39089>>>            Get GetNavigateData to NavigateData
39090>>>
39090>>>            Case Begin
39090>>>                Case (NavigateData.eNavigateType = nfFromParent)
39092>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39092>>>//Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
39092>>>//                    Send NavigateForward of oSelectView Self
39092>>>                    Case Break
39093>>>
39093>>>                Case (NavigateData.eNavigateType = nfFromChild)
39096>>>                    Send NavigateClose Self
39097>>>                    Case Break
39098>>>
39098>>>                Case (NavigateData.eNavigateType = nfFromMain)
39101>>>                    Send NavigateClose Self
39102>>>                    Case Break
39103>>>
39103>>>                Case Else // must be nfUndefined
39103>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39103>>>//Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
39103>>>//                    Send NavigateForward of oSelectCentro Self
39103>>>
39103>>>            Case End
39103>>>        End_Procedure
39104>>>
39104>>>        Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39107>>>            Move True to NavigateData.bReadOnly
39108>>>        End_Procedure
39109>>>
39109>>>    End_Object 
39110>>>
39110>>>    Object oActionGroup is a cWebMenuGroup
39112>>>
39112>>>        Object oSearch is a cWebMenuItem
39114>>>            Set psCSSClass to "WebPromptMenuItem"
39115>>>            Set psCaption to "Search"
39116>>>
39116>>>            Procedure OnClick
39119>>>                Send Search of oList
39120>>>            End_Procedure
39121>>>
39121>>>        End_Object 
39122>>>
39122>>>        Object oNewButton is a cWebMenuItem
39124>>>            Set psCSSClass to "WebClearMenuItem"
39125>>>            Set psCaption to "New"
39126>>>
39126>>>            WebRegisterPath ntNavigateForward oZoomCentros
39132>>>
39132>>>            Procedure OnClick
39135>>>                Send NavigatePath
39136>>>            End_Procedure
39137>>>
39137>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39140>>>                Move True to NavigateData.bNewRecord
39141>>>            End_Procedure
39142>>>
39142>>>        End_Object 
39143>>>    End_Object 
39144>>>
39144>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
39147>>>        WebSet pbRender of oNewButton to True
39148>>>        WebSet pbRender of oDetailButton to True
39149>>>
39149>>>        Case Begin
39149>>>            Case (NavigateData.eNavigateType = nfFromParent)
39151>>>                // If from parent, this is a constrained drill down
39151>>>                Case Break
39152>>>
39152>>>            Case (NavigateData.eNavigateType = nfFromChild)
39155>>>                // If from child, this is a probably a parent lookup from a Zoom
39155>>>                Case Break
39156>>>
39156>>>            Case (NavigateData.eNavigateType = nfFromMain)
39159>>>                // If from main, this is a probably a main-file lookup from a Zoom
39159>>>                WebSet pbRender of oDetailButton to False
39160>>>                Case Break
39161>>>
39161>>>            Case Else // must be nfUndefined
39161>>>                // This may be the start of a drilldown query or this may be used for some kind of custom query.
39161>>>
39161>>>        Case End
39161>>>
39161>>>    End_Procedure
39162>>>
39162>>>
39162>>>End_Object 
39163>    Use DummieTelefono.wo
Including file: DummieTelefono.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieTelefono.wo)
39163>>>Use cWebView.pkg
39163>>>Use cWebPanel.pkg
39163>>>Use cWebForm.pkg 
39163>>>Use cWebGroup.pkg
39163>>>Use cWebMenuGroup.pkg 
39163>>>Use cWebMenuItem.pkg
39163>>>
39163>>>Use zTelefonoiValidation.pkg
Including file: zTelefonoiValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zTelefonoiValidation.pkg)
39163>>>>>Use cJsonHttpTransfer.pkg
Including file: cJsonHttpTransfer.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cJsonHttpTransfer.pkg)
39163>>>>>>>// DF JSON internet transfer class definitions.
39163>>>>>>>Use cHttpTransfer.pkg
Including file: cHttpTransfer.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cHttpTransfer.pkg)
39163>>>>>>>>>Use VDFBase.pkg
39163>>>>>>>>>Use GlobalFunctionsProcedures.pkg
39163>>>>>>>>>
39163>>>>>>>>>External_Function WinAPI_HttpQueryInfo "HttpQueryInfoW" WinInet.dll ;    Handle hRequest ;    DWord dwInfoLevel ;    Pointer lpBuffer ;    Pointer lpdwBufferLength ;    Pointer lpdwIndex ;    Returns Integer
39164>>>>>>>>>
39164>>>>>>>>>/*BOOL InternetSetOptionW(  [in] HINTERNET hInternet,  [in] DWORD     dwOption,  [in] LPVOID    lpBuffer,  [in] DWORD     dwBufferLength);*/
39164>>>>>>>>>External_Function WinAPI_InternetSetOption "InternetSetOptionW" WinInet.dll ;    Handle hInternet ;    DWord dwOption ;    Pointer lpBuffer ;    DWord dwBufferLength ;    Returns Integer
39165>>>>>>>>>
39165>>>>>>>>>/*BOOL InternetQueryOptionW(  [in]      HINTERNET hInternet,  [in]      DWORD     dwOption,  [out]     LPVOID    lpBuffer,  [in, out] LPDWORD   lpdwBufferLength);*/
39165>>>>>>>>>External_Function WinAPI_InternetQueryOption "InternetQueryOptionW" WinInet.dll ;    Handle hInternet ;    DWord dwOption ;    Pointer lpBuffer ;    Pointer lpdwBufferLength ;    Returns Integer
39166>>>>>>>>>
39166>>>>>>>>>
39166>>>>>>>>>//  Available options for dwInfoLevel of WinAPI_HttpQueryInfo
39166>>>>>>>>>Define HTTP_QUERY_MIME_VERSION                for 0
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_TYPE                for 1
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_TRANSFER_ENCODING   for 2
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_ID                  for 3
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_DESCRIPTION         for 4
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_LENGTH              for 5
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_LANGUAGE            for 6
39166>>>>>>>>>Define HTTP_QUERY_ALLOW                       for 7
39166>>>>>>>>>Define HTTP_QUERY_PUBLIC                      for 8
39166>>>>>>>>>Define HTTP_QUERY_DATE                        for 9
39166>>>>>>>>>Define HTTP_QUERY_EXPIRES                     for 10
39166>>>>>>>>>Define HTTP_QUERY_LAST_MODIFIED               for 11
39166>>>>>>>>>Define HTTP_QUERY_MESSAGE_ID                  for 12
39166>>>>>>>>>Define HTTP_QUERY_URI                         for 13
39166>>>>>>>>>Define HTTP_QUERY_DERIVED_FROM                for 14
39166>>>>>>>>>Define HTTP_QUERY_COST                        for 15
39166>>>>>>>>>Define HTTP_QUERY_LINK                        for 16
39166>>>>>>>>>Define HTTP_QUERY_PRAGMA                      for 17
39166>>>>>>>>>Define HTTP_QUERY_VERSION                     for 18  // special: part of status line
39166>>>>>>>>>Define HTTP_QUERY_STATUS_CODE                 for 19  // special: part of status line
39166>>>>>>>>>Define HTTP_QUERY_STATUS_TEXT                 for 20  // special: part of status line
39166>>>>>>>>>Define HTTP_QUERY_RAW_HEADERS                 for 21  // special: all headers as ASCIIZ
39166>>>>>>>>>Define HTTP_QUERY_RAW_HEADERS_CRLF            for 22  // special: all headers
39166>>>>>>>>>Define HTTP_QUERY_CONNECTION                  for 23
39166>>>>>>>>>Define HTTP_QUERY_ACCEPT                      for 24
39166>>>>>>>>>Define HTTP_QUERY_ACCEPT_CHARSET              for 25
39166>>>>>>>>>Define HTTP_QUERY_ACCEPT_ENCODING             for 26
39166>>>>>>>>>Define HTTP_QUERY_ACCEPT_LANGUAGE             for 27
39166>>>>>>>>>Define HTTP_QUERY_AUTHORIZATION               for 28
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_ENCODING            for 29
39166>>>>>>>>>Define HTTP_QUERY_FORWARDED                   for 30
39166>>>>>>>>>Define HTTP_QUERY_FROM                        for 31
39166>>>>>>>>>Define HTTP_QUERY_IF_MODIFIED_SINCE           for 32
39166>>>>>>>>>Define HTTP_QUERY_LOCATION                    for 33
39166>>>>>>>>>Define HTTP_QUERY_ORIG_URI                    for 34
39166>>>>>>>>>Define HTTP_QUERY_REFERER                     for 35
39166>>>>>>>>>Define HTTP_QUERY_RETRY_AFTER                 for 36
39166>>>>>>>>>Define HTTP_QUERY_SERVER                      for 37
39166>>>>>>>>>Define HTTP_QUERY_TITLE                       for 38
39166>>>>>>>>>Define HTTP_QUERY_USER_AGENT                  for 39
39166>>>>>>>>>Define HTTP_QUERY_WWW_AUTHENTICATE            for 40
39166>>>>>>>>>Define HTTP_QUERY_PROXY_AUTHENTICATE          for 41
39166>>>>>>>>>Define HTTP_QUERY_ACCEPT_RANGES               for 42
39166>>>>>>>>>Define HTTP_QUERY_SET_COOKIE                  for 43
39166>>>>>>>>>Define HTTP_QUERY_COOKIE                      for 44
39166>>>>>>>>>Define HTTP_QUERY_REQUEST_METHOD              for 45  // special: GET/POST etc.
39166>>>>>>>>>Define HTTP_QUERY_REFRESH                     for 46
39166>>>>>>>>>Define HTTP_QUERY_CONTENT_DISPOSITION         for 47
39166>>>>>>>>>
39166>>>>>>>>>
39166>>>>>>>>>Class cHttpTransfer is a cBaseHttpTransfer
39167>>>>>>>>>    
39167>>>>>>>>>    Function HttpPostRequest String sFilePath String sData Integer bDataIsFile Returns Integer
39169>>>>>>>>>        Integer bStat
39169>>>>>>>>>        Get HttpPostAddrRequest sFilePath (AddressOf(sData)) (SizeOfString(sData)) bDataIsfile to bStat
39170>>>>>>>>>        Function_Return bStat
39171>>>>>>>>>    End_Function
39172>>>>>>>>>    
39172>>>>>>>>>    // This event is triggered from the runtime. It now uses UChar arrays as the data might 
39172>>>>>>>>>    // not be a valid string (it can be any binary data). It still calls the original event for 
39172>>>>>>>>>    // backwards compatibility.
39172>>>>>>>>>    Procedure OnDataReceivedUC String sContentType UChar[] ucData
39174>>>>>>>>>        Send OnDataReceived sContentType (UCharArrayToString(ucData))
39175>>>>>>>>>    End_Procedure
39176>>>>>>>>>    
39176>>>>>>>>>    // Only use this event if you know for sure the data is a string and make sure piBufferSize is
39176>>>>>>>>>    // smaller than the argument size.
39176>>>>>>>>>    Procedure OnDataReceived String sContentType String sData
39178>>>>>>>>>        
39178>>>>>>>>>    End_Procedure
39179>>>>>>>>>    
39179>>>>>>>>>    // Called just before the request is sent. Use this message to set options to the RequestHandle if nessecary.
39179>>>>>>>>>    Procedure OnPreSendRequest 
39181>>>>>>>>>        
39181>>>>>>>>>    End_Procedure
39182>>>>>>>>>    
39182>>>>>>>>>    Function HttpPutRequest String sFilePath String sData Integer bDataIsFile Returns Integer
39184>>>>>>>>>        Integer bStat
39184>>>>>>>>>        Get HttpPutAddrRequest sFilePath (AddressOf(sData)) (SizeOfString(sData)) bDataIsfile to bStat
39185>>>>>>>>>        Function_Return bStat
39186>>>>>>>>>    End_Function
39187>>>>>>>>>    
39187>>>>>>>>>    // Retrieve header information associated with the previous request.
39187>>>>>>>>>    Function QueryInfo DWord dwInfoLevel Returns String
39189>>>>>>>>>        Handle hRequestHandle
39189>>>>>>>>>        WString wResult
39189>>>>>>>>>        Integer iBufferSize iRes iVoid
39189>>>>>>>>>
39189>>>>>>>>>        Get RequestHandle to hRequestHandle
39190>>>>>>>>>        
39190>>>>>>>>>        If (hRequestHandle) Begin
39192>>>>>>>>>            Move 200 to iBufferSize
39193>>>>>>>>>            Move (Repeat(" ", iBufferSize)) to wResult
39194>>>>>>>>>            Move (WinAPI_HttpQueryInfo(hRequestHandle, dwInfoLevel, AddressOf(wResult), AddressOf(iBufferSize), 0)) to iRes
39195>>>>>>>>>            
39195>>>>>>>>>            If (not(iRes) and GetLastError() = 122) Begin //  Insufficient buffersize, retry with received iBufferSize value
39197>>>>>>>>>                Increment iBufferSize      
39198>>>>>>>>>                
39198>>>>>>>>>                Move (Repeat(" ", iBufferSize)) to wResult
39199>>>>>>>>>                Move (WinAPI_HttpQueryInfo(hRequestHandle, dwInfoLevel, AddressOf(wResult), AddressOf(iBufferSize), 0)) to iRes  
39200>>>>>>>>>            End
39200>>>>>>>>>>
39200>>>>>>>>>            
39200>>>>>>>>>            If (not(iRes)) Begin
39202>>>>>>>>>                Move (ShowLastError()) to iVoid
39203>>>>>>>>>            End
39203>>>>>>>>>>
39203>>>>>>>>>        End
39203>>>>>>>>>>
39203>>>>>>>>>        
39203>>>>>>>>>        Function_Return (CString(wResult))
39204>>>>>>>>>    End_Function
39205>>>>>>>>>    
39205>>>>>>>>>    // Returns the statustext returned by the previous request.
39205>>>>>>>>>    Function ResponseStatusText Returns String
39207>>>>>>>>>        String sStatus
39207>>>>>>>>>        
39207>>>>>>>>>        Get QueryInfo HTTP_QUERY_STATUS_TEXT to sStatus
39208>>>>>>>>>        
39208>>>>>>>>>        Function_Return sStatus
39209>>>>>>>>>    End_Function
39210>>>>>>>>>    
39210>>>>>>>>>End_Class
39211>>>>>>>Use cJsonObject.pkg
39211>>>>>>>Use GlobalFunctionsProcedures.pkg
39211>>>>>>>
39211>>>>>>>// these define the three characters that define BOM for utf8.
39211>>>>>>>// These serve no purpos and are rarely used. If used they must be removed
39211>>>>>>>Define C_BOM1 for |CI$EF
39211>>>>>>>Define C_BOM2 for |CI$BB
39211>>>>>>>Define C_BOM3 for |CI$BF
39211>>>>>>>
39211>>>>>>>
39211>>>>>>>
39211>>>>>>>// define JSON transfer status codes used by peJsonTransferStatus
39211>>>>>>>Enum_List
39211>>>>>>>    Define jtsOk                 // ok
39211>>>>>>>    Define jtsHttpRequestFailed  // the post/get http request returned an error
39211>>>>>>>    Define jtsInvalidContentType // response content type not JSON
39211>>>>>>>    Define jtsNotJson            // return value not JSON (could not load in object)
39211>>>>>>>    Define jtsError              // unspecified return error
39211>>>>>>>End_Enum_List
39211>>>>>>>
39211>>>>>>>
39211>>>>>>>Class cJsonHttpTransfer is a cHttpTransfer
39212>>>>>>>    
39212>>>>>>>    Procedure Construct_Object
39214>>>>>>>        Forward Send Construct_object
39216>>>>>>>        
39216>>>>>>>        Property String  psContentTypeSent "application/json; charset=utf-8"     // default content type for posted data
39217>>>>>>>        
39217>>>>>>>        Property Boolean pbClearHeaders      True         // should headers always be cleared after a post
39218>>>>>>>        
39218>>>>>>>        Property UChar[] pucDataReceived                 // maintained by object
39219>>>>>>>        
39219>>>>>>>        Property String  psContentTypeReceived ''         // content type received
39220>>>>>>>        
39220>>>>>>>        Property String  psJsonParseError ''              // Set if response JSON can't be parsed
39221>>>>>>>        
39221>>>>>>>        Property String  psContentTypeExpected 'application/json' // content type received - expected value should be contained in here.
39222>>>>>>>        
39222>>>>>>>        Property Integer peJsonTransferStatus jtsOk
39223>>>>>>>        
39223>>>>>>>        // if true, the http post does not happend and whatever was posted is just returned as a copy.
39223>>>>>>>        // Good for internal Testing
39223>>>>>>>        Property Boolean pbPostLoopTest False
39224>>>>>>>        
39224>>>>>>>        Set piBufferSize to -1  //  No chunking needed
39225>>>>>>>        Set psAcceptTypes to "application/json"
39226>>>>>>>    End_Procedure
39227>>>>>>>    
39227>>>>>>>    // private helper function. Convert data passed by pointer to an JSON document.
39227>>>>>>>    // return 0, if error
39227>>>>>>>    //
39227>>>>>>>    Function UCharDatatoJson UChar[] ucJson Returns Handle
39229>>>>>>>        Integer iVoid bOk
39229>>>>>>>        Handle hoJson
39229>>>>>>>        String sError
39229>>>>>>>        Get Create of Desktop (RefClass(cJsonObject)) to hoJson
39230>>>>>>>        Get ParseUTF8 of hoJson ucJson to bOk
39231>>>>>>>        If not bOk Begin
39233>>>>>>>            // store the JSON parse error info
39233>>>>>>>            Get psParseError of hoJson to sError
39234>>>>>>>            Set psJsonParseError to sError
39235>>>>>>>            Send Destroy of hoJson
39236>>>>>>>            Move 0 to hoJson
39237>>>>>>>        End
39237>>>>>>>>
39237>>>>>>>        Function_Return hoJson
39238>>>>>>>    End_Function
39239>>>>>>>    
39239>>>>>>>    // Clear pucDataReceived
39239>>>>>>>    Procedure ClearDataReceived
39241>>>>>>>        UChar[] ucEmpty
39242>>>>>>>        
39242>>>>>>>        Set pucDataReceived to ucEmpty
39243>>>>>>>        Set psJsonParseError to ''
39244>>>>>>>    End_Procedure
39245>>>>>>>    
39245>>>>>>>    // augment to release any memor
39245>>>>>>>    Procedure Destroy_Object
39247>>>>>>>        Send ClearDataReceived
39248>>>>>>>        Forward Send Destroy_object
39250>>>>>>>    End_Procedure
39251>>>>>>>    
39251>>>>>>>    // called during http transfer. Take passed data and append to pucDataReceived.
39251>>>>>>>    // If new transfer save contenttype.
39251>>>>>>>    Procedure OnDataReceivedUC String sContentType UChar[] ucData
39253>>>>>>>        UChar[] ucBuffer
39254>>>>>>>        Integer iDataLen
39254>>>>>>>        
39254>>>>>>>        Move (SizeOfArray(ucData)) to iDataLen
39255>>>>>>>        
39255>>>>>>>        If (iDataLen > 0) Begin
39257>>>>>>>            Get pucDataReceived to ucBuffer
39258>>>>>>>            If (SizeOfArray(ucBuffer) > 0) Begin
39260>>>>>>>                Set pucDataReceived to (AppendArray(ucBuffer, ucData))
39261>>>>>>>            End
39261>>>>>>>>
39261>>>>>>>            Else Begin
39262>>>>>>>                Set psContentTypeReceived to sContentType
39263>>>>>>>                
39263>>>>>>>                If (iDataLen > 3 and ucData[0]=C_BOM1 and ucData[1]=C_BOM2 and ucData[2]=C_BOM3) Begin
39265>>>>>>>                    Set pucDataReceived to (CopyArray(ucData, 3, iDataLen - 1))
39266>>>>>>>                End
39266>>>>>>>>
39266>>>>>>>                Else Begin
39267>>>>>>>                    Set pucDataReceived to ucData
39268>>>>>>>                End
39268>>>>>>>>
39268>>>>>>>            End
39268>>>>>>>>
39268>>>>>>>        End
39268>>>>>>>>
39268>>>>>>>    End_Procedure
39269>>>>>>>    
39269>>>>>>>    Function LoopDataBack UChar[] ucData Returns Boolean
39271>>>>>>>        Pointer pInData
39271>>>>>>>        Boolean bOk
39271>>>>>>>        
39271>>>>>>>        Set pucDataReceived to ucData
39272>>>>>>>        Set psContentTypeReceived to (psContentTypeExpected(Self))
39273>>>>>>>        
39273>>>>>>>        Function_Return True
39274>>>>>>>    End_Function
39275>>>>>>>    
39275>>>>>>>    
39275>>>>>>>    Function HttpVerbJsonAddrExec String sHost String sFilePath Pointer pJson Integer iLen String sVerb  Returns Boolean
39277>>>>>>>        Boolean bOk
39277>>>>>>>        Integer iError
39277>>>>>>>        String sContentType
39277>>>>>>>        
39277>>>>>>>        Send ClearDataReceived  // this should be zero, just in case it is not
39278>>>>>>>        Set psRemoteHost to sHost
39279>>>>>>>        
39279>>>>>>>        Get psContentTypeSent to sContentType
39280>>>>>>>        If (iLen > 0 and sContentType <> "") Begin
39282>>>>>>>            Get AddHeader "Content-Type" sContentType to bok
39283>>>>>>>        End
39283>>>>>>>>
39283>>>>>>>        Get HttpVerbAddrRequest sFilePath pJson iLen False sVerb to bOK
39284>>>>>>>        
39284>>>>>>>        // You need to clear headers between posts. If you need to set custom headers you should
39284>>>>>>>        // set pbClearHeaders to false and then manually send ClearHeaders and AddHeaders in your code
39284>>>>>>>        If (pbClearHeaders(Self)) ;            Send ClearHeaders
39287>>>>>>>        
39287>>>>>>>        
39287>>>>>>>        Function_Return bOk
39288>>>>>>>    End_Function
39289>>>>>>>    
39289>>>>>>>    // We assume but do not verify that the data in ucJson is actually UTF8 JSON
39289>>>>>>>    Function HttpVerbJsonUChar String sHost String sFilePath UChar[] ucJson String sVerb Returns UChar[]
39291>>>>>>>        Integer iLen
39291>>>>>>>        Boolean bOk
39291>>>>>>>        UChar[] ucJsonReceived
39292>>>>>>>        String sContentTypeReceived sContentTypeExpected
39292>>>>>>>        
39292>>>>>>>        Move (SizeOfArray(ucJson)) to iLen
39293>>>>>>>        
39293>>>>>>>        If (pbPostLoopTest(Self)) Begin
39295>>>>>>>            Get LoopDataBack ucJson to bOk
39296>>>>>>>        End
39296>>>>>>>>
39296>>>>>>>        Else Begin
39297>>>>>>>            Get HttpVerbJsonAddrExec sHost sFilePath (AddressOf(ucJson)) iLen sVerb to bOk
39298>>>>>>>        End
39298>>>>>>>>
39298>>>>>>>                
39298>>>>>>>        If bOk Begin
39300>>>>>>>            Set peJsonTransferStatus to jtsOk
39301>>>>>>>            Get pucDataReceived to ucJsonReceived
39302>>>>>>>            
39302>>>>>>>            If (SizeOfArray(ucJsonReceived) > 0) Begin
39304>>>>>>>                // we have data, check that the content type is ok. This is as far
39304>>>>>>>                // as we can go here.
39304>>>>>>>                Get psContentTypeReceived to sContentTypeReceived
39305>>>>>>>                Get psContentTypeExpected to sContentTypeExpected
39306>>>>>>>                // If contentType expected is empty, we allow anything
39306>>>>>>>                If (sContentTypeExpected<>"" and pos(lowercase(sContentTypeExpected),lowercase(sContentTypeReceived))=0) Begin
39308>>>>>>>                    Set peJsonTransferStatus to jtsInvalidContentType
39309>>>>>>>                End
39309>>>>>>>>
39309>>>>>>>            End
39309>>>>>>>>
39309>>>>>>>        End
39309>>>>>>>>
39309>>>>>>>        Else Begin
39310>>>>>>>            Set peJsonTransferStatus to jtsHttpRequestFailed
39311>>>>>>>        End
39311>>>>>>>>
39311>>>>>>>                
39311>>>>>>>        Function_Return ucJsonReceived
39312>>>>>>>    End_Function
39313>>>>>>>    
39313>>>>>>>    // Generic HTTP Request - it is passed the Verb. Used by all other http requests
39313>>>>>>>    Function HttpVerbJson  String sHost String sFilePath Handle  hoJsonRequest String sVerb Boolean ByRef bOk Returns Handle
39315>>>>>>>        UChar[] ucJsonRequest ucJsonResponse
39317>>>>>>>        Handle hoJsonResponse
39317>>>>>>>        Integer eStat
39317>>>>>>>        
39317>>>>>>>        If (hoJsonRequest<>0) Begin
39319>>>>>>>            Get StringifyUTF8 of hoJsonRequest to ucJsonRequest
39320>>>>>>>        End
39320>>>>>>>>
39320>>>>>>>        
39320>>>>>>>        Get HttpVerbJsonUChar sHost sFilePath ucJsonRequest sVerb to ucJsonResponse
39321>>>>>>>        
39321>>>>>>>        If (SizeOfArray(ucJsonResponse)) Begin
39323>>>>>>>            Get UCharDatatoJson ucJsonResponse to hoJsonResponse
39324>>>>>>>            If (hoJsonResponse=0) Begin
39326>>>>>>>                // this indicates that data was returned but it could not be loaded as Json
39326>>>>>>>                Set peJsonTransferStatus to jtsNotJson
39327>>>>>>>                // note bad data is still is ppDataReceived (might be useful for debugging)
39327>>>>>>>            End
39327>>>>>>>>
39327>>>>>>>        End
39327>>>>>>>>
39327>>>>>>>        
39327>>>>>>>        // return Ok status by reference
39327>>>>>>>        Get peJsonTransferStatus to eStat
39328>>>>>>>        Move (eStat=jtsOk) to bOk
39329>>>>>>>        
39329>>>>>>>        Function_Return hoJsonResponse
39330>>>>>>>    End_Function
39331>>>>>>>    
39331>>>>>>>    Function HttpPostJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
39333>>>>>>>        Handle hoJson
39333>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "POST" (&bOk) to hoJson
39334>>>>>>>        Function_Return hoJson
39335>>>>>>>    End_Function
39336>>>>>>>    
39336>>>>>>>    Function HttpGetJson String sHost String sFilePath Boolean ByRef bOk Returns Handle
39338>>>>>>>        Pointer pJson
39338>>>>>>>        Integer iVoid iLen
39338>>>>>>>        Handle hoJson
39338>>>>>>>        Get HttpVerbJson sHost sFilePath 0 "GET" (&bOk) to hoJson
39339>>>>>>>        Function_Return hoJson
39340>>>>>>>    End_Function
39341>>>>>>>    
39341>>>>>>>    Function HttpPutJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
39343>>>>>>>        Handle hoJson
39343>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "PUT" (&bOk) to hoJson
39344>>>>>>>        Function_Return hoJson
39345>>>>>>>    End_Function
39346>>>>>>>    
39346>>>>>>>    Function HttpDeleteJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
39348>>>>>>>        Handle hoJson
39348>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "DELETE" (&bOk) to hoJson
39349>>>>>>>        Function_Return hoJson
39350>>>>>>>    End_Function
39351>>>>>>>    
39351>>>>>>>    Function HttpPatchJson  String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
39353>>>>>>>        Handle hoJson
39353>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "PATCH" (&bOk) to hoJson
39354>>>>>>>        Function_Return hoJson
39355>>>>>>>    End_Function
39356>>>>>>>    
39356>>>>>>>    // After an Json xfer request this message can be sent to display an error message if one occurred.
39356>>>>>>>    // Normally you would first check peJsonTransferStatus to see if it is not jtsOk. If not, send
39356>>>>>>>    // LastError to see the error
39356>>>>>>>    
39356>>>>>>>    // return last JSON transfer error text
39356>>>>>>>    Function TransferErrorDescription Returns String
39358>>>>>>>        String  sError sJsonError
39358>>>>>>>        Integer eJsonTransferStatus
39358>>>>>>>        Get peJsonTransferStatus to eJsonTransferStatus
39359>>>>>>>        Get psJsonParseError to sJsonError
39360>>>>>>>        Case Begin
39360>>>>>>>            Case (eJsonTransferStatus=jtsOk) ;                Move '' to sError
39363>>>>>>>            Case (eJsonTransferStatus=jtsHttpRequestFailed) ;                Move C_$HttpRequestFailed to sError
39367>>>>>>>            Case (eJsonTransferStatus=jtsInvalidContentType) ;                Move (SFormat(C_$InvalidContentTypeReceived,psContentTypeReceived(Self))) to sError
39371>>>>>>>            Case (eJsonTransferStatus=jtsNotJson) ;                Move (C_$ReceivedDataNotInJsonFormat * sJsonError) to sError
39375>>>>>>>            Case Else ;                Move C_$ReceivedDataIsBad to sError
39377>>>>>>>        Case End
39377>>>>>>>        Function_Return sError
39378>>>>>>>    End_Function
39379>>>>>>>    
39379>>>>>>>    // can be send to raise an error.
39379>>>>>>>    Procedure LastError
39381>>>>>>>        Integer eJsonTransferStatus
39381>>>>>>>        String sError
39381>>>>>>>        
39381>>>>>>>        Get peJsonTransferStatus to eJsonTransferStatus
39382>>>>>>>        If (eJsonTransferStatus<>jtsOk) Begin
39384>>>>>>>            Get TransferErrorDescription to sError
39385>>>>>>>            Error DFERR_JSON_HTTP sError
39386>>>>>>>>
39386>>>>>>>        End
39386>>>>>>>>
39386>>>>>>>    End_Procedure
39387>>>>>>>    
39387>>>>>>>    
39387>>>>>>>End_Class
39388>>>>>
39388>>>>>
39388>>>>>Function zTelefonoValidation Boolean bUseApi String sPrefijo String sTelefono  String ByRef sMsg Returns Boolean
39391>>>>>    
39391>>>>>     Boolean bRet
39391>>>>>     
39391>>>>>     
39391>>>>>     Get zNumeroCorrecto sTelefono (&sMsg) to bRet
39392>>>>>     If (not(bRet)) Function_Return False 
39395>>>>>     If (bUseApi) Get zValidarConApi sTelefono sPrefijo (&sMsg) to bRet
39398>>>>>     If (not(bRet)) Function_Return False
39401>>>>>    Function_Return True
39402>>>>>End_Function
39403>>>>>
39403>>>>>
39403>>>>>
39403>>>>>Function zNumeroCorrecto String sTelefono String ByRef sMsg Returns Boolean
39406>>>>>    String[] aRet
39407>>>>>    Object oTelefonopattern is a cRegEx
39409>>>>>        Set psExpression to "^(?:[-\s])?\d(?:[\d\s-]*\d)?(?:[-\s])?$"
39410>>>>>    End_Object
39411>>>>>    Get MatchAll of oTelefonopattern (sTelefono) to aRet
39412>>>>>        If (SizeOfArray(aRet) = 1) Begin
39414>>>>>        Function_Return True
39415>>>>>        End
39415>>>>>>
39415>>>>>    
39415>>>>>    Move "Porfavor Introduzca un formato de Telefono valido" to sMsg
39416>>>>>    Function_Return False    
39417>>>>>End_Function 
39418>>>>>
39418>>>>>Function zValidarConApi String sTelefono String sPrefijo String ByRef sMsg Returns Boolean
39421>>>>>    
39421>>>>>    Handle hoJsonReceived hoHttp
39421>>>>>    Boolean bOk bIsNull bRet
39421>>>>>    String  sNum sUrl
39421>>>>>     
39421>>>>>    Move (sPrefijo + sTelefono) to sNum
39422>>>>>   
39422>>>>>    Get Create (RefClass(cJsonHttpTransfer)) to hoHttp
39423>>>>>    Move False to bRet
39424>>>>>    
39424>>>>>    Get HttpGetJson of hohttp ("phonevalidation.abstractapi.com") ("/v1/?api_key=713383f7f21e45b1ac4054a472e00971&phone=" + sNum) (&bOk) to hoJsonReceived
39425>>>>>
39425>>>>>
39425>>>>>    If (bOk = True and ResponseStatusCode(hohttp) = 200 and hoJsonReceived <> 0) Begin
39427>>>>>        
39427>>>>>        If (HasMember(hoJsonReceived,"valid"))  Begin
39429>>>>>            Get IsMemberOfJsonType of hoJsonReceived "valid" jsonTypeNull  to bIsNull
39430>>>>>            If bIsNull  Move False to bRet
39433>>>>>            Else Move (MemberValue(hoJsonReceived,"valid")) to bRet
39435>>>>>        End
39435>>>>>>
39435>>>>>    End
39435>>>>>>
39435>>>>>    Send Destroy of hohttp
39436>>>>>    Function_Return bRet
39437>>>>>End_Function
39438>>>>>    
39438>>>>>    
39438>>>
39438>>>Object oDummieTelefono is a cWebView
39440>>>
39440>>>    // Your DDO structure will go here
39440>>>    Set piWidth to 700
39441>>>    Set psCaption to "DummieDni"
39442>>>
39442>>>    // Your DDO structure will go here
39442>>>
39442>>>    Object oWebMainPanel is a cWebPanel
39444>>>        Set piColumnCount to 12
39445>>>
39445>>>        Object oForm_Prefijo is a cWebForm
39447>>>            Set piColumnSpan to 3
39448>>>            Set psLabel to "Prefijo telefonico"
39449>>>            Set peLabelPosition to lpTop
39450>>>        End_Object
39451>>>        
39451>>>        // place controls here
39451>>>        // Your view will grow as controls are added
39451>>>        
39451>>>        Object oForm_telefono is a cWebForm
39453>>>            Set piColumnSpan to 9
39454>>>            Set psLabel to "Introduzca el telefono"
39455>>>            Set piColumnIndex to 3
39456>>>            Set peLabelPosition to lpTop
39457>>>        End_Object
39458>>>
39458>>>        Object oWebLabel_sMsg_Err is a cWebLabel
39460>>>            Set psCaption to ""
39461>>>            Set piColumnIndex to 0
39462>>>            Set piColumnSpan to 12
39463>>>        End_Object
39464>>>
39464>>>        Object oWebSpacer1 is a cWebSpacer
39466>>>            Set piColumnSpan to 12
39467>>>        End_Object
39468>>>
39468>>>        Object oValidationButton is a cWebButton
39470>>>            Set piColumnSpan to 6
39471>>>            Set psCaption to "Validar"
39472>>>            Set piColumnIndex to 3
39473>>>        
39473>>>            Procedure OnClick
39476>>>                Boolean bRet
39476>>>                String sTelefono sPrefijo sMsg
39476>>>                WebGet psValue of oForm_telefono to sTelefono
39477>>>                WebGet psValue of oForm_Prefijo to sPrefijo
39478>>>                Get zTelefonoValidation True sPrefijo sTelefono (&sMsg) to bRet
39479>>>                
39479>>>                WebSet psBackgroundColor of oForm_telefono to "#ffffff"
39480>>>                WebSet psBackgroundColor of oForm_Prefijo to "#ffffff"
39481>>>                WebSet psCaption of oWebLabel_sMsg_Err to ""
39482>>>                
39482>>>                If (bRet) Begin
39484>>>                    WebSet psBackgroundColor of oForm_telefono to "green"
39485>>>                    WebSet psBackgroundColor of oForm_Prefijo to "green"
39486>>>                    
39486>>>                End
39486>>>>
39486>>>                If (not (bRet)) Begin
39488>>>                    WebSet psBackgroundColor of oForm_Prefijo to "red"
39489>>>                    WebSet psBackgroundColor of oForm_telefono to "red"
39490>>>                    WebSet psCaption of oWebLabel_sMsg_Err to sMsg
39491>>>                End
39491>>>>
39491>>>                
39491>>>                
39491>>>            End_Procedure
39492>>>        End_Object
39493>>>        
39493>>>    End_Object
39494>>>
39494>>>    Procedure OnBeforeShow
39497>>>        Forward Send OnBeforeShow
39499>>>        WebSet psValue of oForm_Prefijo to "+34"
39500>>>    End_Procedure
39501>>>
39501>>>End_Object
39502>    Set phoDefaultView to oDashboard
39503>
39503>End_Object
39504>
39504>Send StartWebApp of oWebApp
39505>
Summary
Memory Available: 7021486080
Total Warnings : 0
Total Errors   : 0
Total Symbols  : 26019
Total Resources: 0
Total Commands : 39504
Total Windows  : 0
Total Pages    : 0
Static Data    : 494365
Message area   : 264356
Total Blocks   : 17585
