Compiling Program: C:\DataFlex Projects\Centros\AppSrc\WebApp.src
Memory Available: 8106024960
1>Use AllWebAppClasses.pkg
Using pre-compiled package ALLWEBAPPCLASSES.PKG
Including file: AllWebAppClasses.x64.pkd    (C:\Program Files\DataFlex 25.0\Pkg\AllWebAppClasses.x64.pkd)
36303>Use cConnection.pkg
36303>Use cWebMenuItem.pkg
36303>Use cSQLExecutor.pkg
Including file: cSQLExecutor.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cSQLExecutor.pkg)
36303>>>Use GlobalFunctionsProcedures.pkg
36303>>>Use cConnection.pkg
36303>>>
36303>>>// The cBaseSQLExecute class is defined in the runtime, we define it here for codesense and
36303>>>// reference but skip compiling it.
36303>>>
36303>>>
36303>>>Struct tSQLColumnInfo
36303>>>    String  sName
36303>>>    Integer iType 
36303>>>    Integer iSize
36303>>>    Integer iDigits
36303>>>    Boolean bNullable
36303>>>    String  sBaseColumnName
36303>>>    String  sBaseTableName
36303>>>    String  sLocalTypeName
36303>>>End_Struct
36303>>>
36303>>>Struct tSQLParamInfo
36303>>>    String sName
36303>>>    String sValue
36303>>>End_Struct
36303>>>
36303>>>Class cSQLExecutor is a cBaseSQLExecutor
36304>>>
36304>>>    Procedure Construct_Object
36306>>>        Forward Send Construct_Object
36308>>>
36308>>>        Property String Private_psConnectionId
36309>>>        Property String Private_psDriverId
36310>>>    End_Procedure
36311>>>
36311>>>    Procedure OnSQLError String SQLState String SQLMessage
36313>>>        Error DFERR_PROGRAM (SFormat("SQLExecutor error: %1 SQLState: %2", SQLMessage, SQLState ))
36314>>>>
36314>>>    End_Procedure
36315>>>    
36315>>>    Procedure OnSQLPreExecute String sSQLQuery
36317>>>    End_Procedure
36318>>>    
36318>>>    Procedure OnSQLPostExecute String sSQLQuery
36320>>>    End_Procedure  
36321>>>
36321>>>    Procedure Set psConnectionId String sConnectionId
36323>>>        Set Private_psConnectionId to sConnectionId
36324>>>        Set piDriverIndex to 0
36325>>>        Set piConnectionIndex to 0  
36326>>>        
36326>>>        Send UpdateConnectionDetails        
36327>>>    End_Procedure
36328>>>
36328>>>    Function psConnectionId Returns String
36330>>>        Function_Return (Private_psConnectionId(Self))
36331>>>    End_Function
36332>>>
36332>>>    Function psDriverId Returns String
36334>>>        Function_Return (Private_psDriverId(Self))
36335>>>    End_Function
36336>>>    
36336>>>    Procedure UpdateConnectionDetails
36338>>>        String  sConnectionId
36338>>>        Get Private_psConnectionId to sConnectionId            
36339>>>        If (sConnectionId <> '') Begin
36341>>>            Send ManagedConnectionDetails sConnectionId
36342>>>        End
36342>>>>
36342>>>        Else Begin
36343>>>            Error DFERR_PROGRAM (SFormat(C_$SQLExecutorNoConnectionId))
36344>>>>
36344>>>        End           
36344>>>>
36344>>>    End_Procedure
36345>>>
36345>>>    Procedure ManagedConnectionDetails String sConnectionId
36347>>>        tConnection ManagedConnection
36347>>>        tConnection ManagedConnection
36347>>>        String  sDriver
36347>>>        Integer iDriverIndex
36347>>>        Boolean bConnectionIsLoggedIn 
36347>>>        Boolean bSuccess
36347>>>        Integer iIndex
36347>>>        Integer iConnectionIndex
36347>>>        
36347>>>        If (ghoConnection) Begin            
36349>>>            Get ConnectionIdIndex of ghoConnection sConnectionId to iIndex
36350>>>            If (iIndex = -1) Begin
36352>>>                Error DFERR_PROGRAM (SFormat(C_$ConnectionIdNotFound,sConnectionId))
36353>>>>
36353>>>            End
36353>>>>
36353>>>            Else Begin
36354>>>                Get ConnectionIdInfo of ghoConnection sConnectionId to ManagedConnection
36355>>>                Move ManagedConnection.sDriver      to sDriver
36356>>>                Move ManagedConnection.iDriverIndex to iDriverIndex
36357>>>                Get IsConnectionIdLoggedIn of ghoConnection sConnectionId to bConnectionIsLoggedIn
36358>>>                If (not(bConnectionIsLoggedIn)) Begin
36360>>>                    Get LoginConnectionId of ghoConnection sConnectionId to bSuccess
36361>>>                    Get IsConnectionIdLoggedIn of ghoConnection sConnectionId to bConnectionIsLoggedIn
36362>>>                End
36362>>>>
36362>>>                If (bConnectionIsLoggedIn) Begin
36364>>>                    Get ConnectionDatabaseIdHandle of ghoConnection ManagedConnection to iConnectionIndex
36365>>>                    
36365>>>                    If (iConnectionIndex) Begin
36367>>>                        Set piConnectionIndex  to iConnectionIndex
36368>>>                        Set piDriverIndex      to iDriverIndex
36369>>>                        Set Private_psDriverId to sDriver
36370>>>                    End
36370>>>>
36370>>>                End
36370>>>>
36370>>>            End
36370>>>>
36370>>>        End
36370>>>>
36370>>>    End_Procedure
36371>>>End_Class
36372>
36372>Object oApplication is a cApplication
36374>    Object oConnection is a cConnection
36376>        Use LoginEncryption.pkg
Including file: LoginEncryption.pkg    (C:\Program Files\DataFlex 25.0\Pkg\LoginEncryption.pkg)
36376>>>Use cLoginEncryption.pkg
Including file: cLoginEncryption.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cLoginEncryption.pkg)
36376>>>>>Use cCryptographerEx.pkg
36376>>>>>
36376>>>>>Class cLoginEncryption is a cObject
36377>>>>>    
36377>>>>>    Procedure Construct_Object
36379>>>>>        Forward Send Construct_Object
36381>>>>>        // this must be set to a multi (40ish) character random key
36381>>>>>        Property String psEncryptPassword ""
36382>>>>>        
36382>>>>>        Object oDataCrypter is a cCryptographerEx
36384>>>>>            Set piHash to CALG_SHA_256
36385>>>>>            Set piCipher to CALG_AES_256
36386>>>>>            Set psProvider to "" //  Not providing a specific provider gives the default provider for the provider type
36387>>>>>            Set piProvider to PROV_RSA_AES
36388>>>>>        End_Object
36389>>>>>    End_Procedure
36390>>>>>    
36390>>>>>    // This can be augmented to return a password encryption key using any
36390>>>>>    // hidden mechanism desired.
36390>>>>>    Function GetEncryptionPassword Returns String
36392>>>>>        String sPassword
36392>>>>>        Get psEncryptPassword to sPassword
36393>>>>>        Function_Return sPassword
36394>>>>>    End_Function
36395>>>>>    
36395>>>>>    // Encrypts a string into an unreadable hash that can later be decrypted using DecryptKey.
36395>>>>>    //
36395>>>>>    // Params:
36395>>>>>    //   sPlainText     String to encrypt.
36395>>>>>    // Returns:
36395>>>>>    //   Base64 encoded hash.
36395>>>>>    Function EncryptPassword String sPlainText Returns String
36397>>>>>        String sEncryptPassword sBase64
36397>>>>>        UChar[] ucBinary
36398>>>>>        Pointer pBase64
36398>>>>>        Integer iVoid
36398>>>>>        
36398>>>>>        //  Encrypt Key
36398>>>>>        Get GetEncryptionPassword to sEncryptPassword
36399>>>>>        If (sEncryptPassword = "") Begin
36401>>>>>            Error DFERR_PROGRAM "No encryption password set"
36402>>>>>>
36402>>>>>        End
36402>>>>>>
36402>>>>>        
36402>>>>>        Get Encrypt of oDataCrypter (StringToUCharArray(sEncryptPassword)) (StringToUCharArray(sPlainText)) to ucBinary
36403>>>>>        
36403>>>>>        If (SizeOfArray(ucBinary) = 0) Begin
36405>>>>>            Error DFERR_PROGRAM "Unable to encrypt database login password"
36406>>>>>>
36406>>>>>            Function_Return ""
36407>>>>>        End
36407>>>>>>
36407>>>>>        
36407>>>>>        //  Encode binary hash to Base64
36407>>>>>        Move (Base64Encode(AddressOf(ucBinary), SizeOfArray(ucBinary))) to pBase64
36408>>>>>        Move (PointerToString(pBase64)) to sBase64
36409>>>>>        Move (Free(pBase64)) to iVoid
36410>>>>>        
36410>>>>>        Function_Return sBase64
36411>>>>>    End_Function
36412>>>>>    
36412>>>>>    
36412>>>>>    // Decrypts the unreadable hash generated by EncryptKey into a readable string.
36412>>>>>    //
36412>>>>>    // Params:
36412>>>>>    //   sBase64EncryptedPassword       Base64 Encrypted password
36412>>>>>    // Returns:
36412>>>>>    //   Readable plain text password
36412>>>>>    Function DecryptPassword String sBase64EncryptedPassword Returns String
36414>>>>>        String sEncryptPassword
36414>>>>>        UChar[] ucBinary ucPlain
36416>>>>>        Boolean bIsHex
36416>>>>>        Integer iLen iVoid
36416>>>>>        Pointer pBinary
36416>>>>>        
36416>>>>>        If (sBase64EncryptedPassword <> "") Begin
36418>>>>>            //  Decode from Base64
36418>>>>>            Move (Base64Decode(AddressOf(sBase64EncryptedPassword), &iLen)) to pBinary
36419>>>>>            
36419>>>>>            Move (ResizeArray(ucBinary, iLen, 0)) to ucBinary
36420>>>>>            Move (MemCopy(AddressOf(ucBinary), pBinary, iLen)) to iVoid
36421>>>>>                        
36421>>>>>            Move (Free(pBinary)) to iVoid
36422>>>>>            
36422>>>>>            //  Encrypted binary hash to string
36422>>>>>            Get GetEncryptionPassword to sEncryptPassword
36423>>>>>            Get Decrypt of oDataCrypter (StringToUCharArray(sEncryptPassword)) ucBinary to ucPlain
36424>>>>>        End
36424>>>>>>
36424>>>>>        
36424>>>>>        Function_Return (UCharArrayToString(ucPlain))
36425>>>>>    End_Function
36426>>>>>End_Class
36427>>>
36427>>>Object oLoginEncryption is a cLoginEncryption
36429>>>
36429>>>    // this must be created in your appsrc directory and must contain an encryption
36429>>>    // key that is set to psEncryptPassword. It will look something like this
36429>>>    //
36429>>>    // Set psEncryptPassword to "JchUAo7W@r.b{<Yk~OONi0nq=sMi[*Rn[A-`Vo)q"
36429>>>    //  
Including file: LoginEncryptionKey.inc    (C:\DataFlex Projects\Centros\AppSrc\LoginEncryptionKey.inc)
36429>>>>// Studio generated login encryption key
36429>>>>Set psEncryptPassword to "nX,`aCLjN<#ah&V#INur~oy)$^b,#I6q2>P:)4@*"
36430>>>>
36430>>>    
36430>>>    // use this to register this object to your cConnection Object. This object
36430>>>    // must be created after the cConnection object
36430>>>    Move Self to ghoLoginEncryption
36431>>>End_Object
36432>    End_Object
36433>End_Object
36434>
36434>
36434>
36434>
36434>Object oWebApp is a cWebApp
36436>    Set psTheme to "Df_Material"
36437>    Set peAlignView to alignCenter
36438>    Set peLoginMode to lmLoginNone
36439>    
36439>    // It is important to set this so that all views will default
36439>    // to drill down style views.
36439>    Set peApplicationStyle to wvsDrillDown   
36440>    Set peApplicationStateMode to asmHistoryAndUrls 
36441>    Set psEncryptPassword to "CA{z(/<Zy2q^w6Gp7Z7z.)Wr#>YCvgJA%}m0z:a,"
36442>
36442>    Object oSQLExecutor is a cSQLExecutor
36444>        Move Self to ghoSQLExecutor
36445>        Set psConnectionId to "Centros"
36446>    End_Object
36447>    
36447>    Object oViewStack is a cWebViewStack
36449>    End_Object
36450>    
36450>    Procedure HideHeader
36453>        WebSet pbRender of oHeaderPanel to False
36454>    End_Procedure
36455>
36455>    Procedure ShowHeader
36458>        WebSet pbRender of oHeaderPanel to True 
36459>    End_Procedure
36460>
36460>    Object oHeaderPanel is a cWebPanel
36462>        Set peRegion to prTop
36463>        Set psCSSClass to "HeaderPanel"
36464>        
36464>        Object oMenuPanel is a cWebPanel
36466>            Set peRegion to prLeft
36467>            Set piWidth to 50
36468>            
36468>            Object oMenuButton is a cWebMenuButton
36470>                Set piMenuHeight to 500
36471>
36471>                Object oDashboard_itm is a cWebMenuItem
36473>                    Set psCaption to C_$Dashboard
36474>                    
36474>                    WebRegisterPath ntNavigateBegin oDashboard
36480>
36480>                    Procedure OnClick
36483>                        Send NavigatePath
36484>                    End_Procedure
36485>                End_Object
36486>
36486>                Object oViewMenu is a cWebMenuItem
36488>                    Set psCaption to C_$View
36489>
36489>                    Object oDummieEmailItem1 is a cWebMenuItem
36491>                        Set psCaption to "DummieEmail"
36492>
36492>                        WebRegisterPath ntNavigateBegin oDummieEmail
36498>
36498>                        Procedure OnClick
36501>                            Forward Send OnClick
36503>                                Send NavigatePath
36504>                        End_Procedure
36505>                    End_Object
36506>
36506>                    Object oDummieDniItem1 is a cWebMenuItem
36508>                        Set psCaption to "DummieDni"
36509>
36509>                        WebRegisterPath ntNavigateBegin oDummieDni
36515>
36515>                        Procedure OnClick
36518>                            Forward Send OnClick
36520>                                Send NavigatePath
36521>                        End_Procedure
36522>                    End_Object
36523>
36523>                    Object oStudentsItem1 is a cWebMenuItem
36525>                        Set psCaption to "Students"
36526>
36526>                        WebRegisterPath ntNavigateBegin oSelectStudents
36532>
36532>                        Procedure OnClick
36535>                            Forward Send OnClick
36537>                                Send NavigatePath
36538>                        End_Procedure
36539>                    End_Object
36540>
36540>                    Object oCentroItem1 is a cWebMenuItem
36542>                        Set psCaption to "Centro"
36543>
36543>                        WebRegisterPath ntNavigateBegin oSelectCentro
36549>
36549>                        Procedure OnClick
36552>                            Forward Send OnClick
36554>                                Send NavigatePath
36555>                        End_Procedure
36556>                    End_Object
36557>                End_Object
36558>
36558>                Object oSignOut_itm is a cWebMenuItem
36560>                    Set psCaption to C_$LogOut
36561>
36561>                    Procedure OnClick
36564>                        Send RequestLogOut of ghoWebSessionManager
36565>                    End_Procedure
36566>                End_Object
36567>            End_Object  
36568>
36568>            Object oBackButton is a cWebButton
36570>                Set psCSSClass to "WebBack_Icon"
36571>                Set pbRender to False
36572>                
36572>                Procedure OnClick
36575>                    Handle hoTop
36575>                    
36575>                    Get TopViewHandle of oViewStack to hoTop
36576>                    If (hoTop > 0) Begin
36578>                        Send NavigateCancel of hoTop 
36579>                    End
36579>                End_Procedure
36580>            End_Object
36581>            
36581>            Send AddClient of oViewStack Self
36582>                
36582>            Procedure OnUpdateViewStack
36585>                Handle hoTop hoDflt
36585>                Integer eMode
36585>                Boolean bTop
36585>                
36585>                WebGet peMode of (Owner(Self)) to eMode
36586>                
36586>                Get TopViewHandle of oViewStack to hoTop
36587>                Get GetDefaultView to hoDflt
36588>                Move (hoTop=0 or hoTop=hoDflt) to bTop
36589>                
36589>                WebSet pbRender of oBackButton to (not(bTop) and eMode >= rmMobile)
36590>                WebSet pbRender of oMenuButton to (bTop or eMode < rmMobile)
36591>            End_Procedure
36592>
36592>        End_Object
36593>
36593>        Object oCaptionPanel is a cWebPanel
36595>            Set piColumnCount to 12
36596>
36596>            Object oCaptionBreadcrumb is a cWebBreadcrumb
36598>                Set peBreadcrumbStyle to crumbCaption
36599>                WebSetResponsive peBreadcrumbStyle rmMobile to crumbDropDown
36600>            End_Object         
36601>        End_Object
36602>        
36602>        Object oActionPanel is a cWebPanel
36604>            Set peRegion to prRight
36605>            Set piColumnCount to 1
36606>            Set piWidth to 120
36607>
36607>            Object oMainActions is a cWebActionBar
36609>                Set psGroupName to "MainActions"
36610>
36610>                Set piColumnSpan to 0
36611>                Set peAlign to alignRight
36612>            End_Object
36613>        End_Object
36614>
36614>        Object oBreadcrumbPanel is a cWebPanel
36616>            Set peRegion to prBottom
36617>            
36617>            Object oHorizontalBreadcrumb is a cWebBreadcrumb
36619>                WebSetResponsive pbRender rmMobile to False
36620>            End_Object         
36621>        End_Object
36622>
36622>    End_Object    
36623>
36623>    Use SessionManager.wo
Including file: SessionManager.wo    (C:\DataFlex Projects\Centros\AppSrc\SessionManager.wo)
36623>>>Use cWebSessionManagerStandard.pkg
Including file: cWebSessionManagerStandard.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cWebSessionManagerStandard.pkg)
36623>>>>>Use cWebSessionManager.pkg
36623>>>>>Use cWebAppSessionDataDictionary.dd
Including file: cWebAppSessionDataDictionary.dd    (C:\Program Files\DataFlex 25.0\Pkg\cWebAppSessionDataDictionary.dd)
36623>>>>>>>Use DataDict.pkg
36623>>>>>>>
36623>>>>>>>Open WebAppSession
Including file: WebAppSession.fd    (C:\DataFlex Projects\Centros\DDSrc\WebAppSession.fd)
36625>>>>>>>Open WebAppUser
Including file: WebAppUser.fd    (C:\DataFlex Projects\Centros\DDSrc\WebAppUser.fd)
36627>>>>>>>
36627>>>>>>>Class cWebAppSessionDataDictionary is a DataDictionary
36628>>>>>>>    Procedure Construct_Object
36630>>>>>>>        Forward Send Construct_Object
36632>>>>>>>
36632>>>>>>>        Set Main_File to WebAppSession.File_Number
36633>>>>>>>
36633>>>>>>>        Set Add_Server_File to WebAppUser.File_Number
36634>>>>>>>
36634>>>>>>>        Set ParentNullAllowed WebAppUser.File_Number to True
36635>>>>>>>
36635>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
36636>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
36637>>>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
36638>>>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
36639>>>>>>>
36639>>>>>>>        Set Field_Checkbox_Values Field WebAppSession.Active to "Y" "N"
36640>>>>>>>        Set Field_Error Field WebAppSession.Active to 500 "Invalid WebAppSession Active State"
36641>>>>>>>    End_Procedure
36642>>>>>>>
36642>>>>>>>    Procedure Creating
36644>>>>>>>        DateTime dtCurrentDateTime
36644>>>>>>>        
36644>>>>>>>        Forward Send Creating
36646>>>>>>>        
36646>>>>>>>        //  Init usecounter
36646>>>>>>>        Move 0 to WebAppSession.UseCount
36647>>>>>>>        
36647>>>>>>>        //  Set the creation and access time to the current time
36647>>>>>>>        Move (CurrentDateTime()) to dtCurrentDateTime
36648>>>>>>>    
36648>>>>>>>        Get TimeToString dtCurrentDateTime to WebAppSession.CreateTime
36649>>>>>>>        Get TimeToString dtCurrentDateTime to WebAppSession.LastAccessTime
36650>>>>>>>        
36650>>>>>>>        Move dtCurrentDateTime to WebAppSession.CreateDate
36651>>>>>>>        Move dtCurrentDateTime to WebAppSession.LastAccessDate
36652>>>>>>>    End_Procedure
36653>>>>>>>    
36653>>>>>>>    //
36653>>>>>>>    //  Converts the given time to an string that can be saved in the database.
36653>>>>>>>    //
36653>>>>>>>    //  Params:
36653>>>>>>>    //      dtTime  Time to convert
36653>>>>>>>    //  Returns:
36653>>>>>>>    //      String with "HH:MM:SS" format
36653>>>>>>>    //
36653>>>>>>>    Function TimeToString DateTime dtTime Returns String
36655>>>>>>>        String sHours sMinutes sSeconds
36655>>>>>>>        
36655>>>>>>>        //  Extract parts
36655>>>>>>>        Move (String(DateGetHour(dtTime))) to sHours
36656>>>>>>>        Move (String(DateGetMinute(dtTime))) to sMinutes
36657>>>>>>>        Move (String(DateGetSecond(dtTime))) to sSeconds
36658>>>>>>>        
36658>>>>>>>        //  Fill out with 0
36658>>>>>>>        If (Length(sHours) = 1) ;            Move ("0" + sHours) to sHours
36661>>>>>>>        If (Length(sMinutes) = 1) ;            Move ("0" + sMinutes) to sMinutes
36664>>>>>>>        If (Length(sSeconds) = 1) ;            Move ("0" + sSeconds) to sSeconds
36667>>>>>>>        
36667>>>>>>>        Function_Return (sHours + ":" + sMinutes + ":" + sSeconds)
36668>>>>>>>    End_Function
36669>>>>>>>    
36669>>>>>>>    //
36669>>>>>>>    //  Sets the time of the datetime variable to the time in the string.
36669>>>>>>>    //
36669>>>>>>>    //  Params:
36669>>>>>>>    //      dtTime  Datetime variable to add time to
36669>>>>>>>    //      sTimeString String with time in the format "HH:MM:SS"
36669>>>>>>>    //  Returns:
36669>>>>>>>    //      dtDateTime with the loaded time
36669>>>>>>>    //
36669>>>>>>>    Function StringToTime DateTime dtTime String sTimeString Returns DateTime
36671>>>>>>>        String sHours sMinutes sSeconds
36671>>>>>>>        
36671>>>>>>>        //  Extract parts
36671>>>>>>>        Move (Mid(sTimeString, 2, 1)) to sHours
36672>>>>>>>        Move (Mid(sTimeString, 2, 4)) to sMinutes
36673>>>>>>>        Move (Mid(sTimeString, 2, 7)) to sSeconds
36674>>>>>>>        
36674>>>>>>>        //  Set to DateTime
36674>>>>>>>        Move (DateSetHour(dtTime, (Integer(sHours)))) to dtTime
36675>>>>>>>        Move (DateSetMinute(dtTime, (Integer(sMinutes)))) to dtTime
36676>>>>>>>        Move (DateSetSecond(dtTime, (Integer(sSeconds)))) to dtTime
36677>>>>>>>        
36677>>>>>>>        Function_Return dtTime
36678>>>>>>>    End_Function
36679>>>>>>>End_Class
36680>>>>>Use cWebAppUserDataDictionary.dd
Including file: cWebAppUserDataDictionary.dd    (C:\Program Files\DataFlex 25.0\Pkg\cWebAppUserDataDictionary.dd)
36680>>>>>>>Use DataDict.pkg
36680>>>>>>>Open WebAppUser
36682>>>>>>>Open WebAppSession
36684>>>>>>>
36684>>>>>>>Class cWebAppUserDataDictionary is a DataDictionary
36685>>>>>>>    
36685>>>>>>>    Procedure Construct_Object
36687>>>>>>>        Forward Send Construct_Object
36689>>>>>>>        Set Main_File to WebAppUser.File_Number
36690>>>>>>>
36690>>>>>>>        Set Add_Client_File to WebAppSession.File_Number
36691>>>>>>>
36691>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
36692>>>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
36693>>>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
36694>>>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
36695>>>>>>>    End_Procedure
36696>>>>>>>
36696>>>>>>>End_Class
36697>>>>>
36697>>>>>Use cPasswordHasher.pkg
Including file: cPasswordHasher.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cPasswordHasher.pkg)
36697>>>>>>>Use GlobalFunctionsProcedures.pkg
36697>>>>>>>
36697>>>>>>>Define CNG_BCRYPT_HASH_LENGTH           for "HashDigestLength"
36697>>>>>>>
36697>>>>>>>External_Function CNG_BCryptGenRandom "BCryptGenRandom" Bcrypt.dll ;    Handle   hAlgorithm ;    Pointer  pbBuffer ;    UInteger cbBuffer ;    UInteger dwFlags ;    Returns Integer
36698>>>>>>>
36698>>>>>>>External_Function CNG_BCryptOpenAlgorithmProvider "BCryptOpenAlgorithmProvider" Bcrypt.dll ;    Pointer  phAlgorithm ;    Pointer  pszAlgId ;    Pointer  pszImplementation ;    UInteger dwFlags ;    Returns Integer
36699>>>>>>>
36699>>>>>>>External_Function CNG_BCryptCloseAlgorithmProvider "BCryptCloseAlgorithmProvider" Bcrypt.dll ;    Handle   hAlgorithm ;    UInteger dwFlags ;    Returns Integer
36700>>>>>>>
36700>>>>>>>External_Function CNG_BCryptDeriveKeyPBKDF2 "BCryptDeriveKeyPBKDF2" Bcrypt.dll ;    Handle   hPrf ;    Pointer  pbPassword ;    UInteger cbPassword ;    Pointer  pbSalt ;    UInteger cbSalt ;    BigInt   cIterations ;    Pointer  pbDerivedKey ;    UInteger cbDerivedKey ;    UInteger dwFlags ;    Returns Integer
36701>>>>>>>
36701>>>>>>>External_Function CNG_BCryptGetProperty "BCryptGetProperty" Bcrypt.dll ;    Handle   hObject ;    Pointer  pszProperty ;    Pointer  pbOutput ;    UInteger cbOutput ;    Pointer  pcbResult ;    UInteger dwFlags ;    Returns Integer
36702>>>>>>>
36702>>>>>>>Class cPasswordHasher_CNG_PBKDF2_HMAC_Mixin is a Mixin
36703>>>>>>>
36703>>>>>>>    Function CNG_PBKDF2_HMAC_BufferSizeEx Handle hoProv Returns UInteger
36705>>>>>>>        Integer iErr
36705>>>>>>>        UInteger uiHashLen
36705>>>>>>>        
36705>>>>>>>        UInteger uiCbOut
36705>>>>>>>        WString wsHashLengthProperty
36705>>>>>>>        Move CNG_BCRYPT_HASH_LENGTH to wsHashLengthProperty
36706>>>>>>>        Move (CNG_BCryptGetProperty(hoProv, AddressOf(wsHashLengthProperty), AddressOf(uiHashLen), 4, AddressOf(uiCbOut), 0)) to iErr
36707>>>>>>>        If (iErr) Begin
36709>>>>>>>            Function_Return 0
36710>>>>>>>        End
36710>>>>>>>>
36710>>>>>>>        
36710>>>>>>>        Function_Return uiHashLen
36711>>>>>>>    End_Function
36712>>>>>>>    
36712>>>>>>>    Function CNG_PBKDF2_HMAC_BufferSize WString wsAlgo Returns UInteger
36714>>>>>>>        Integer iErr
36714>>>>>>>        UInteger uiHashLen
36714>>>>>>>        
36714>>>>>>>        // Open the algorithm.
36714>>>>>>>        Handle hoProv
36714>>>>>>>        Move (CNG_BCryptOpenAlgorithmProvider(AddressOf(hoProv), AddressOf(wsAlgo), 0, |CI$00000008 /*BCRYPT_ALG_HANDLE_HMAC_FLAG*/)) to iErr
36715>>>>>>>        If (iErr) Begin
36717>>>>>>>            Function_Return 0
36718>>>>>>>        End
36718>>>>>>>>
36718>>>>>>>        
36718>>>>>>>        Get CNG_PBKDF2_HMAC_BufferSizeEx hoProv to uiHashLen
36719>>>>>>>        
36719>>>>>>>        Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36720>>>>>>>        
36720>>>>>>>        Function_Return uiHashLen
36721>>>>>>>    End_Function
36722>>>>>>>    
36722>>>>>>>    Function CNG_PBKDF2_HMAC    WString wsAlgo ;                                UChar[] ucaData ;                                UChar[] ucaSalt ;                                UInteger uiTimeCost ;                                UChar[] ByRef ucaHashOut ;                                Boolean bOptThrow ;                                Returns Boolean
36724>>>>>>>        Integer iErr iHashLen
36724>>>>>>>        
36724>>>>>>>        // Handle Optionals
36724>>>>>>>        // First the optional throwing of errors.
36724>>>>>>>        Boolean bThrow
36724>>>>>>>        Move True to bThrow
36725>>>>>>>        If (num_arguments > 4) Move bOptThrow to bThrow
36728>>>>>>>        
36728>>>>>>>        // Open the algorithm.
36728>>>>>>>        Handle hoProv
36728>>>>>>>        Move (CNG_BCryptOpenAlgorithmProvider(AddressOf(hoProv), AddressOf(wsAlgo), 0, |CI$00000008 /*BCRYPT_ALG_HANDLE_HMAC_FLAG*/)) to iErr
36729>>>>>>>        If (iErr) Begin
36731>>>>>>>            If (bThrow) Error 8710 "Failed to open up the algo provider."
36734>>>>>>>            Function_Return False
36735>>>>>>>        End
36735>>>>>>>>
36735>>>>>>>        
36735>>>>>>>        Get CNG_PBKDF2_HMAC_BufferSizeEx hoProv to iHashLen
36736>>>>>>>        If (not(iHashLen)) Begin
36738>>>>>>>            If (bThrow) Error 8710 "Failed to get expected length of hash."
36741>>>>>>>            Function_Return False
36742>>>>>>>        End
36742>>>>>>>>
36742>>>>>>>        
36742>>>>>>>        // Resize buffers to the expected output.
36742>>>>>>>        Move (ResizeArray(ucaHashOut, iHashLen)) to ucaHashOut
36743>>>>>>>        
36743>>>>>>>        Move (CNG_BCryptDeriveKeyPBKDF2(hoProv, AddressOf(ucaData), SizeOfArray(ucaData), AddressOf(ucaSalt), SizeOfArray(ucaSalt), uiTimeCost, AddressOf(ucaHashOut), SizeOfArray(ucaHashOut), 0)) to iErr
36744>>>>>>>        If (iErr) Begin
36746>>>>>>>            Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36747>>>>>>>            If (bThrow) Error 8710 "Failed to create hash."
36750>>>>>>>            Function_Return False
36751>>>>>>>        End
36751>>>>>>>>
36751>>>>>>>        
36751>>>>>>>        Move (CNG_BCryptCloseAlgorithmProvider(hoProv, 0)) to iErr
36752>>>>>>>        If (iErr) Begin
36754>>>>>>>            If (bThrow) Error 8710 "Failed to close algo provider."
36757>>>>>>>            Function_Return False
36758>>>>>>>        End
36758>>>>>>>>
36758>>>>>>>        
36758>>>>>>>        Function_Return True
36759>>>>>>>    End_Function
36760>>>>>>>End_Class
36761>>>>>>>
36761>>>>>>>Class cPasswordHasher_Mixin is a Mixin
36762>>>>>>>    
36762>>>>>>>    Import_Class_Protocol cPasswordHasher_CNG_PBKDF2_HMAC_Mixin
36763>>>>>>>    
36763>>>>>>>    Enum_List // Algorithmes available for password hashing
36763>>>>>>>        Define C_PWH_PBKDF2_HMAC_SHA_256        for 0 // Requires TimeCost
36763>>>>>>>        Define C_PWH_PBKDF2_HMAC_SHA_512              // Requires TimeCost
36763>>>>>>>    End_Enum_List
36763>>>>>>>    
36763>>>>>>>    Function RandomBuffer UInteger uiSize Returns UChar[]
36765>>>>>>>        UChar[] ucaBuffer
36766>>>>>>>        Move (ResizeArray(ucaBuffer, uiSize)) to ucaBuffer
36767>>>>>>>        If (CNG_BCryptGenRandom(0, AddressOf(ucaBuffer), uiSize, |CI$00000002 /*BCRYPT_USE_SYSTEM_PREFERRED_RNG*/)) Begin
36769>>>>>>>            Error 8710 "Failed to create random buffer."
36770>>>>>>>>
36770>>>>>>>        End
36770>>>>>>>>
36770>>>>>>>        Function_Return ucaBuffer
36771>>>>>>>    End_Function
36772>>>>>>>    
36772>>>>>>>    Function Base64EncodeArr UChar[] ucaBuffer Returns String
36774>>>>>>>        Integer iErr
36774>>>>>>>        Pointer pBase64
36774>>>>>>>        String sBase64
36774>>>>>>>        Move (Base64Encode(AddressOf(ucaBuffer), SizeOfArray(ucaBuffer))) to pBase64
36775>>>>>>>        If (not(pBase64)) Begin
36777>>>>>>>            Function_Return sBase64
36778>>>>>>>        End
36778>>>>>>>>
36778>>>>>>>        Move (PointerToString(pBase64)) to sBase64
36779>>>>>>>        Move (Free(pBase64)) to iErr
36780>>>>>>>        Function_Return sBase64
36781>>>>>>>    End_Function
36782>>>>>>>    
36782>>>>>>>    Function Base64DecodeArr String sBase64 Returns UChar[]
36784>>>>>>>        Integer iLen
36784>>>>>>>        Pointer pBase64
36784>>>>>>>        UChar[] ucaBuffer
36785>>>>>>>        Move (Base64Decode(AddressOf(sBase64), &iLen)) to pBase64
36786>>>>>>>        If (not(pBase64)) Begin
36788>>>>>>>            Function_Return ucaBuffer
36789>>>>>>>        End
36789>>>>>>>>
36789>>>>>>>        
36789>>>>>>>        Move (ResizeArray(ucaBuffer, iLen)) to ucaBuffer
36790>>>>>>>        Move (MemCopy(AddressOf(ucaBuffer), pBase64, iLen)) to iLen
36791>>>>>>>        Move (Free(pBase64)) to iLen
36792>>>>>>>        Function_Return ucaBuffer
36793>>>>>>>    End_Function
36794>>>>>>>    
36794>>>>>>>    Function CreatePasswordHashExWithSalt UInteger uiAlgo UChar[] ucaSalt String sPassword String ByRef sHash UInteger uiOptTimeCost Returns Boolean
36796>>>>>>>        Boolean bOk bRequireTimeCost
36796>>>>>>>        UChar[] ucaHash
36797>>>>>>>        
36797>>>>>>>        Case Begin
36797>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36799>>>>>>>                Get CNG_PBKDF2_HMAC "SHA256" (StringToUCharArray(sPassword)) ucaSalt uiOptTimeCost (&ucaHash) False to bOk
36800>>>>>>>                If (not(bOk)) Function_Return False
36803>>>>>>>                
36803>>>>>>>                Move True to bRequireTimeCost
36804>>>>>>>                Case Break
36805>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36808>>>>>>>                Get CNG_PBKDF2_HMAC "SHA512" (StringToUCharArray(sPassword)) ucaSalt uiOptTimeCost (&ucaHash) False to bOk
36809>>>>>>>                If (not(bOk)) Function_Return False
36812>>>>>>>                
36812>>>>>>>                Move True to bRequireTimeCost
36813>>>>>>>                Case Break
36814>>>>>>>            Case Else
36814>>>>>>>                Error 8710 "Invalid algorithm selected."
36815>>>>>>>>
36815>>>>>>>                Function_Return False
36816>>>>>>>        Case End
36816>>>>>>>        
36816>>>>>>>        String sSalt
36816>>>>>>>        Get Base64EncodeArr ucaSalt to sSalt
36817>>>>>>>        If (not(SizeOfString(sSalt))) Function_Return False
36820>>>>>>>        Get Base64EncodeArr ucaHash to sHash
36821>>>>>>>        If (not(SizeOfString(sHash))) Function_Return False
36824>>>>>>>        
36824>>>>>>>        If (bRequireTimeCost) Begin
36826>>>>>>>            Move (SFormat("%1$%2$%3$%4",            ;                            String(uiAlgo),         ;                            sSalt,                  ;                            String(uiOptTimeCost),  ;                            sHash)) to sHash
36827>>>>>>>        End
36827>>>>>>>>
36827>>>>>>>        Else Begin
36828>>>>>>>            Move (SFormat("%1$%2$%3",               ;                            String(uiAlgo),         ;                            sSalt,                  ;                            sHash)) to sHash
36829>>>>>>>        End
36829>>>>>>>>
36829>>>>>>>        
36829>>>>>>>        Function_Return bOk
36830>>>>>>>    End_Function
36831>>>>>>>    
36831>>>>>>>    Function CreatePasswordHashEx UInteger uiAlgo UInteger uiSaltSize String sPassword String ByRef sHash UInteger uiOptTimeCost Returns Boolean
36833>>>>>>>        UChar[] ucaSalt
36834>>>>>>>        Get RandomBuffer uiSaltSize to ucaSalt
36835>>>>>>>        If (not(SizeOfArray(ucaSalt))) Function_Return False
36838>>>>>>>        
36838>>>>>>>        If (num_arguments > 4) Begin
36840>>>>>>>            Function_Return (CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sHash, uiOptTimeCost))
36841>>>>>>>        End
36841>>>>>>>>
36841>>>>>>>        Function_Return (CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sHash))
36842>>>>>>>    End_Function
36843>>>>>>>    
36843>>>>>>>    Function VerifyPasswordHash String sPassword String sHash Returns Boolean
36845>>>>>>>        Boolean bRequiresTimeCost
36845>>>>>>>        UInteger uiAlgo uiTimeCost
36845>>>>>>>        Integer iBegin iEnd
36845>>>>>>>        String sSalt
36845>>>>>>>        
36845>>>>>>>        Move 1 to iBegin
36846>>>>>>>        
36846>>>>>>>        // Parse Algo
36846>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36847>>>>>>>        If (not(iEnd)) Function_Return False
36850>>>>>>>        Move (Mid(sHash, iEnd - iBegin, iBegin)) to uiAlgo
36851>>>>>>>        
36851>>>>>>>        // Parse Salt
36851>>>>>>>        Move (iEnd + 1) to iBegin
36852>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36853>>>>>>>        If (not(iEnd)) Function_Return False
36856>>>>>>>        Move (Mid(sHash, iEnd - iBegin, iBegin)) to sSalt
36857>>>>>>>        
36857>>>>>>>        Case Begin
36857>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36859>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36862>>>>>>>                Move True to bRequiresTimeCost
36863>>>>>>>                Case Break
36864>>>>>>>            Case Else
36864>>>>>>>                Error 8710 "Invalid algorithm selected."
36865>>>>>>>>
36865>>>>>>>                Function_Return False
36866>>>>>>>        Case End
36866>>>>>>>        
36866>>>>>>>        // Parse optional timecost
36866>>>>>>>        If (bRequiresTimeCost) Begin
36868>>>>>>>            Move (iEnd + 1) to iBegin
36869>>>>>>>            Move (Pos("$", sHash, iBegin)) to iEnd
36870>>>>>>>            If (not(iEnd)) Function_Return False
36873>>>>>>>            Move (Mid(sHash, iEnd - iBegin, iBegin)) to uiTimeCost
36874>>>>>>>        End
36874>>>>>>>>
36874>>>>>>>        
36874>>>>>>>        // Parse rest hash
36874>>>>>>>        Move (iEnd + 1) to iBegin
36875>>>>>>>        Move (Pos("$", sHash, iBegin)) to iEnd
36876>>>>>>>        If (iEnd) Function_Return False // inverse check if there are any other errors.
36879>>>>>>>        
36879>>>>>>>        // Base64Decode
36879>>>>>>>        UChar[] ucaSalt
36880>>>>>>>        Get Base64DecodeArr sSalt to ucaSalt
36881>>>>>>>        If (not(SizeOfArray(ucaSalt))) Function_Return False
36884>>>>>>>        
36884>>>>>>>        // Create new hash
36884>>>>>>>        String sNewHash
36884>>>>>>>        If (bRequiresTimeCost) Begin
36886>>>>>>>            If (not(CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sNewHash, uiTimeCost))) Begin
36888>>>>>>>                Function_Return False 
36889>>>>>>>            End
36889>>>>>>>>
36889>>>>>>>        End
36889>>>>>>>>
36889>>>>>>>        Else Begin
36890>>>>>>>            If (not(CreatePasswordHashExWithSalt(Self, uiAlgo, ucaSalt, sPassword, &sNewHash))) Begin
36892>>>>>>>                Function_Return False 
36893>>>>>>>            End
36893>>>>>>>>
36893>>>>>>>        End
36893>>>>>>>>
36893>>>>>>>        Function_Return (sNewHash = sHash)
36894>>>>>>>    End_Function
36895>>>>>>>    
36895>>>>>>>    Function RequiredBufferSizeEx UInteger uiAlgo UInteger uiSaltSize UInteger uiOptTimeCost Returns UBigInt
36897>>>>>>>        Boolean bRequireTimeCost
36897>>>>>>>        UBigInt ullSize
36897>>>>>>>        UChar[] ucaSalt
36898>>>>>>>        String sSalt
36898>>>>>>>        
36898>>>>>>>        Get RandomBuffer uiSaltSize to ucaSalt
36899>>>>>>>        Get Base64EncodeArr ucaSalt to sSalt
36900>>>>>>>        If (not(SizeOfString(sSalt))) Function_Return 0
36903>>>>>>>        
36903>>>>>>>        Case Begin
36903>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36905>>>>>>>                Get CNG_PBKDF2_HMAC_BufferSize "SHA256" to ullSize
36906>>>>>>>                Move True to bRequireTimeCost
36907>>>>>>>                Case Break
36908>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36911>>>>>>>                Get CNG_PBKDF2_HMAC_BufferSize "SHA512" to ullSize
36912>>>>>>>                Move True to bRequireTimeCost
36913>>>>>>>                Case Break
36914>>>>>>>            Case Else
36914>>>>>>>                Error 8710 "Invalid algorithm selected."
36915>>>>>>>>
36915>>>>>>>                Function_Return 0
36916>>>>>>>        Case End
36916>>>>>>>        
36916>>>>>>>        // calculate base64 in a non-floating-manner
36916>>>>>>>        Move (((ullSize + 3 -1) / 3) * 4) to ullSize
36917>>>>>>>        
36917>>>>>>>        Move (ullSize + SizeOfString(String(uiAlgo))) to ullSize
36918>>>>>>>        Move (ullSize + SizeOfString(sSalt)) to ullSize
36919>>>>>>>        If (bRequireTimeCost) Begin
36921>>>>>>>            Move (ullSize + SizeOfString(String(uiOptTimeCost))) to ullSize
36922>>>>>>>            Move (ullSize + 3 /*$*/) to ullSize
36923>>>>>>>        End
36923>>>>>>>>
36923>>>>>>>        Else Begin
36924>>>>>>>            Move (ullSize + 2 /*$*/) to ullSize
36925>>>>>>>        End
36925>>>>>>>>
36925>>>>>>>        
36925>>>>>>>        Function_Return ullSize
36926>>>>>>>    End_Function
36927>>>>>>>End_Class
36928>>>>>>>
36928>>>>>>>Class cPasswordHasher is a cObject
36929>>>>>>>    
36929>>>>>>>    Import_Class_Protocol cPasswordHasher_Mixin
36930>>>>>>>    
36930>>>>>>>    Procedure Construct_Object
36932>>>>>>>        Forward Send Construct_Object
36934>>>>>>>        
36934>>>>>>>        Property UInteger   peAlgorithm         C_PWH_PBKDF2_HMAC_SHA_512 
36935>>>>>>>        Property UInteger   puiSaltSize         16
36936>>>>>>>        
36936>>>>>>>        Property UInteger   puiOptTimeCost      420000
36937>>>>>>>    End_Procedure
36938>>>>>>>    
36938>>>>>>>    Function CreatePasswordHash String sPassword String ByRef sHash Returns Boolean
36940>>>>>>>        Boolean bOk
36940>>>>>>>        UInteger uiAlgo
36940>>>>>>>        Get peAlgorithm to uiAlgo
36941>>>>>>>        
36941>>>>>>>        Case Begin
36941>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36943>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36946>>>>>>>                Get CreatePasswordHashEx uiAlgo (puiSaltSize(Self)) sPassword (&sHash) (puiOptTimeCost(Self)) to bOk
36947>>>>>>>                Case Break
36948>>>>>>>            Case Else
36948>>>>>>>                Error 8710 "Invalid algorithm selected."
36949>>>>>>>>
36949>>>>>>>                Function_Return False
36950>>>>>>>        Case End
36950>>>>>>>        
36950>>>>>>>        Function_Return bOk
36951>>>>>>>    End_Function
36952>>>>>>>    
36952>>>>>>>    Function RequiredBufferSize Returns UBigInt
36954>>>>>>>        UBigInt ullSize
36954>>>>>>>        UInteger uiAlgo
36954>>>>>>>        Get peAlgorithm to uiAlgo
36955>>>>>>>        
36955>>>>>>>        Case Begin
36955>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_256)
36957>>>>>>>            Case (uiAlgo = C_PWH_PBKDF2_HMAC_SHA_512)
36960>>>>>>>                Get RequiredBufferSizeEx uiAlgo (puiSaltSize(Self)) (puiOptTimeCost(Self)) to ullSize
36961>>>>>>>                Case Break
36962>>>>>>>            Case Else
36962>>>>>>>                Error 8710 "Invalid algorithm selected."
36963>>>>>>>>
36963>>>>>>>                Function_Return 0
36964>>>>>>>        Case End
36964>>>>>>>        
36964>>>>>>>        Function_Return ullSize
36965>>>>>>>    End_Function
36966>>>>>>>
36966>>>>>>>End_Class
36967>>>>>
36967>>>>>Class cWebSessionManagerStandard is a cWebSessionManager
36968>>>>>    
36968>>>>>    Procedure Construct_Object
36970>>>>>        Handle hoObj
36970>>>>>        
36970>>>>>        Forward Send Construct_Object
36972>>>>>        
36972>>>>>        Set pbSessionCookieHttpOnly to True
36973>>>>>        
36973>>>>>        Property Handle phoUserDD 0      // Handle to the WebAppUser DDO
36974>>>>>        Property Handle phoSessionDD 0   // Handle to the WebAppSession DDO  
36975>>>>>        Property Handle phoCrypto 0      // Handle to the PasswordHasher
36976>>>>>        
36976>>>>>        Get CreateNamed (RefClass(cWebAppUserDataDictionary)) 'oUserDD' to hoObj
36977>>>>>        Set phoUserDD to hoObj
36978>>>>>        
36978>>>>>        Get CreateNamed (RefClass(cWebAppSessionDataDictionary)) 'oSessionDD' to hoObj
36979>>>>>        Set DDO_Server of hoObj to (phoUserDD(Self))
36980>>>>>        Set phoSessionDD to hoObj
36981>>>>>        
36981>>>>>        Property Handle phoCrypto 0   // Handle to the Cryptographer
36982>>>>>        Get CreateNamed (RefClass(cPasswordHasher)) 'oCrypto' to hoObj
36983>>>>>        Set phoCrypto to hoObj
36984>>>>>        
36984>>>>>        Property Boolean pbPasswordHashing True
36985>>>>>        
36985>>>>>        Property Boolean pbCreatingNewSession False
36986>>>>>        Property String psLoginName
36987>>>>>        Property String psUserName ""
36988>>>>>        Property Integer piUserRights 0
36989>>>>>    End_Procedure
36990>>>>>    
36990>>>>>    Procedure End_Construct_Object
36992>>>>>        Forward Send End_Construct_Object
36994>>>>>        
36994>>>>>        Handle hoCrypto
36994>>>>>        Integer iFieldLen
36994>>>>>        If (pbPasswordHashing(Self)) Begin
36996>>>>>            Get phoCrypto to hoCrypto
36997>>>>>            Get_Attribute DF_FIELD_LENGTH of (RefTable(WebAppUser)) (RefTable(WebAppUser.Password)) to iFieldLen
37000>>>>>            If (iFieldLen < (RequiredBufferSize(hoCrypto) + 3)) Begin
37002>>>>>                Error DFERR_PROGRAM "The password field of WebAppUser is not large enough (128)"
37003>>>>>>
37003>>>>>            End
37003>>>>>>
37003>>>>>        End
37003>>>>>>
37003>>>>>    End_Procedure
37004>>>>>    
37004>>>>>    Function CreateSession String sRemoteAddress Returns String
37006>>>>>        String sSessionKey
37006>>>>>        Integer iErr
37006>>>>>        Boolean bLogWebSession
37006>>>>>        Handle hoSessionDD       
37006>>>>>        Get phoSessionDD to hoSessionDD
37007>>>>>        
37007>>>>>        //  Get session key
37007>>>>>        Forward Get CreateSession sRemoteAddress to sSessionKey
37009>>>>>        
37009>>>>>        Get pbLogWebSession to bLogWebSession
37010>>>>>        If not bLogWebSession Begin
37012>>>>>            Function_Return sSessionKey        
37013>>>>>        End
37013>>>>>>
37013>>>>>
37013>>>>>        //  Store session
37013>>>>>        Send Clear of hoSessionDD
37014>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.SessionKey to sSessionKey
37015>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.RemoteAddress to sRemoteAddress
37016>>>>>        Set Field_Changed_Value of hoSessionDD Field WebAppSession.Active to "Y"
37017>>>>>        Get Request_Validate of hoSessionDD to iErr
37018>>>>>        If (iErr) Begin
37020>>>>>            // this should not happen. If it does its a programming error
37020>>>>>            Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37021>>>>>>
37021>>>>>            Function_Return ""
37022>>>>>        End
37022>>>>>>
37022>>>>>        Send Request_Save of hoSessionDD
37023>>>>>        If (Err) Begin
37025>>>>>            // this shouldn't happen, if it does likely a duplicate session key issue, even through request_save already gave an error we give another one to make tracking down easier
37025>>>>>            Error DFERR_PROGRAM C_$WebAppSessionSaveFailed
37026>>>>>>
37026>>>>>            Function_Return ""
37027>>>>>        End
37027>>>>>>
37027>>>>>       
37027>>>>>        Function_Return sSessionKey        
37028>>>>>    End_Function
37029>>>>>    
37029>>>>>    Function ValidateSession String sSessionKey Boolean bOptLoadWebApp Returns Boolean
37031>>>>>        DateTime dtLastAccess dtCurrent
37031>>>>>        TimeSpan tsDiff
37031>>>>>        Integer iErr iSessionTimeout iSpanMinutes
37031>>>>>        Boolean bResult bCreatingNewSession
37031>>>>>        Boolean bLogWebSession bLoadWebApp
37031>>>>>        Integer eLoginMode
37031>>>>>        String sTime
37031>>>>>        Handle hoSessionDD hoUserDD       
37031>>>>>        
37031>>>>>        Move False to bLoadWebApp
37032>>>>>        If (num_arguments >= 2) Begin
37034>>>>>            Move bOptLoadWebApp to bLoadWebApp
37035>>>>>        End
37035>>>>>>
37035>>>>>        
37035>>>>>        Get phoSessionDD to hoSessionDD
37036>>>>>        Get phoUserDD to hoUserDD
37037>>>>>        
37037>>>>>        Get pbLogWebSession to bLogWebSession
37038>>>>>        Get peLoginMode to eLoginMode
37039>>>>>        
37039>>>>>        // for this object, you can only disable logging if login completely is disabled
37039>>>>>        If (not(bLogWebSession) and (eLoginMode<>lmLoginNone)) Begin
37041>>>>>            Error DFERR_PROGRAM C_$WebSessionLoggingMustBeEnabled
37042>>>>>>
37042>>>>>            Function_Return False
37043>>>>>        End
37043>>>>>>
37043>>>>>
37043>>>>>        //  Clear session properties
37043>>>>>        Set psSessionKey to ""
37044>>>>>        Send UpdateSessionProperties True
37045>>>>>        
37045>>>>>        If not bLogWebSession Begin
37047>>>>>            Forward Get ValidateSession sSessionKey to bResult
37049>>>>>            Function_Return bResult
37050>>>>>        End        
37050>>>>>>
37050>>>>>        
37050>>>>>        Move False to bResult
37051>>>>>        Get piSessionTimeout to iSessionTimeout 
37052>>>>>        
37052>>>>>        //  Check if session exists
37052>>>>>        Send Clear of hoSessionDD
37053>>>>>        Move sSessionKey to WebAppSession.SessionKey
37054>>>>>        Send Find of hoSessionDD EQ Index.1
37055>>>>>            
37055>>>>>        If (Found) Begin
37057>>>>>            //  Calculate timespan between now and last access time
37057>>>>>            Move (CurrentDateTime()) to dtCurrent
37058>>>>>            Move WebAppSession.LastAccessDate to dtLastAccess
37059>>>>>            Get StringToTime of hoSessionDD dtLastAccess WebAppSession.LastAccessTime to dtLastAccess
37060>>>>>            Move (dtCurrent - dtLastAccess) to tsDiff
37061>>>>>            Move (SpanTotalMinutes(tsDiff)) to iSpanMinutes
37062>>>>>            
37062>>>>>            //  Check if session didn't time out
37062>>>>>            If (IsDateValid(dtLastAccess) and (iSessionTimeout <= 0 or (iSpanMinutes < iSessionTimeout)) and WebAppSession.Active = "Y") Begin
37064>>>>>                Forward Get ValidateSession sSessionKey to bResult
37066>>>>>                   
37066>>>>>                If (bResult) Begin
37068>>>>>                    //  Update session record
37068>>>>>                    Get TimeToString of hoSessionDD dtCurrent to sTime 
37069>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.LastAccessDate to dtCurrent
37070>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.LastAccessTime to sTime
37071>>>>>                    Set Field_Changed_Value of hoSessionDD Field WebAppSession.UseCount to (WebAppSession.UseCount + 1)
37072>>>>>                    Get Request_Validate of hoSessionDD to iErr
37073>>>>>                    If (iErr) Begin
37075>>>>>                        // this should not happen. If it does its a programming error
37075>>>>>                        Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37076>>>>>>
37076>>>>>                        Function_Return False
37077>>>>>                    End
37077>>>>>>
37077>>>>>                    Send Request_Save of hoSessionDD
37078>>>>>                    
37078>>>>>                    //  Update user properties
37078>>>>>                    Send UpdateSessionProperties False
37079>>>>>                End
37079>>>>>>
37079>>>>>            End
37079>>>>>>
37079>>>>>            Else Begin
37080>>>>>                // Test the Creating New Session Flag to protect against infinite recursion....
37080>>>>>                Get pbCreatingNewSession to bCreatingNewSession
37081>>>>>                
37081>>>>>                If (not(bCreatingNewSession)) Begin
37083>>>>>                    If (not(bLoadWebApp)) Begin
37085>>>>>                        Move False to bResult   //  We can only continue immediately if we were loading the webapp, other operations are not allowed!
37086>>>>>                        Error DFERR_WEBAPP_SESSION_TIMEOUT "Your application session has timed out or is inactive, please login again."
37087>>>>>>
37087>>>>>                        Send NavigateRefresh of ghoWebApp          // refresh the WebApp at the client (triggers a login)
37088>>>>>                    End
37088>>>>>>
37088>>>>>                    Else Begin
37089>>>>>                        Set pbCreatingNewSession to True                    
37090>>>>>                        Get RecreateSession of ghoWebApp to bResult 
37091>>>>>                        Set pbCreatingNewSession to False                        
37092>>>>>                    End
37092>>>>>>
37092>>>>>                End
37092>>>>>>
37092>>>>>            End
37092>>>>>>
37092>>>>>        End
37092>>>>>>
37092>>>>>        Else Begin
37093>>>>>            Error DFERR_WEBAPP_BAD_SESSION_KEY "Session key not known (reload page to recreate session)"
37094>>>>>>
37094>>>>>        End
37094>>>>>>
37094>>>>>        
37094>>>>>        Function_Return bResult
37095>>>>>    End_Function
37096>>>>>    
37096>>>>>    Function CreatePasswordHash String sPassword String ByRef sHash Returns Boolean
37098>>>>>        If (not(pbPasswordHashing(Self))) Begin
37100>>>>>            Move sPassword to sHash
37101>>>>>            Function_Return True
37102>>>>>        End
37102>>>>>>
37102>>>>>        
37102>>>>>        If (not(CreatePasswordHash(phoCrypto(Self), sPassword, &sHash))) Begin
37104>>>>>            Function_Return False
37105>>>>>        End
37105>>>>>>
37105>>>>>        Move ("V1$" + sHash) to sHash
37106>>>>>        Function_Return True
37107>>>>>    End_Function
37108>>>>>    
37108>>>>>    Function VerifyPasswordHash String sUserPassword String sEnteredPassword Boolean ByRef bShouldUpgrade Returns Boolean
37110>>>>>        If (not(pbPasswordHashing(Self))) Begin
37112>>>>>            Move False to bShouldUpgrade
37113>>>>>            Function_Return (sUserPassword = sEnteredPassword)
37114>>>>>        End
37114>>>>>>
37114>>>>>        
37114>>>>>        String sVersion
37114>>>>>        Move (Left(sUserPassword, 3)) to sVersion
37115>>>>>        If (sVersion = "V1$") Begin
37117>>>>>            If (num_arguments > 2) Move False to bShouldUpgrade
37120>>>>>            Function_Return (VerifyPasswordHash(phoCrypto(Self), sEnteredPassword, Right(sUserPassword, Length(sUserPassword) - 3)))
37121>>>>>        End
37121>>>>>>
37121>>>>>        Else Begin
37122>>>>>            If (num_arguments > 2) Move True to bShouldUpgrade
37125>>>>>            Function_Return False
37126>>>>>        End
37126>>>>>>
37126>>>>>    End_Function
37127>>>>>    
37127>>>>>    Function UserRegister String sLoginName String sPassword Returns Boolean
37129>>>>>        Handle hoUserDD
37129>>>>>        Integer iErr
37129>>>>>        Get phoUserDD to hoUserDD
37130>>>>>        
37130>>>>>        //  Find the user
37130>>>>>        Send Clear of hoUserDD
37131>>>>>        Move sLoginName to WebAppUser.LoginName
37132>>>>>        Send Find of hoUserDD EQ Index.1
37133>>>>>        If (Found) Begin
37135>>>>>            Send Clear of hoUserDD
37136>>>>>            Function_Return False
37137>>>>>        End
37137>>>>>>
37137>>>>>        
37137>>>>>        Send Clear of hoUserDD
37138>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.FullName to sLoginName
37139>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.LoginName to sLoginName
37140>>>>>        If (not(CreatePasswordHash(Self, Trim(sPassword), &sPassword))) Begin
37142>>>>>            Send Clear of hoUserDD
37143>>>>>            Function_Return False
37144>>>>>        End
37144>>>>>>
37144>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37145>>>>>        Get Request_Validate of hoUserDD to iErr
37146>>>>>        If (iErr) Begin
37148>>>>>            Send Clear of hoUserDD
37149>>>>>            Function_Return False
37150>>>>>        End
37150>>>>>>
37150>>>>>        
37150>>>>>        Send Request_Save of hoUserDD
37151>>>>>        Function_Return (not(Err))
37152>>>>>    End_Function
37153>>>>>    
37153>>>>>    Function UserLogin String sLoginName String sPassword Returns Boolean
37155>>>>>        String sSessionKey sUserPassword
37155>>>>>        Handle hoSessionDD hoUserDD
37155>>>>>        Boolean bMatch bUpgrade
37155>>>>>        
37155>>>>>        Get phoSessionDD to hoSessionDD
37156>>>>>        Get phoUserDD to hoUserDD
37157>>>>>        Integer iErr eLoginMode
37157>>>>>        
37157>>>>>        // Refind session record
37157>>>>>        Get psSessionKey to sSessionKey
37158>>>>>        Send Clear of hoSessionDD
37159>>>>>        Move sSessionKey to WebAppSession.SessionKey
37160>>>>>        Send Find of hoSessionDD EQ Index.1
37161>>>>>        
37161>>>>>        If (Found and WebAppSession.SessionKey = sSessionKey) Begin
37163>>>>>            Get peLoginMode to eLoginMode
37164>>>>>            
37164>>>>>            //  Find the user
37164>>>>>            Move sLoginName to WebAppUser.LoginName
37165>>>>>            Send Find of hoUserDD EQ Index.1
37166>>>>>            
37166>>>>>            // Check username and password
37166>>>>>            If (Found and (Lowercase(sLoginName) = Lowercase(Trim(WebAppUser.LoginName)))) Begin
37168>>>>>                Get Field_Current_Value of hoUserDD Field WebAppUser.Password to sUserPassword
37169>>>>>                Get VerifyPasswordHash (Trim(sUserPassword)) (Trim(sPassword)) (&bUpgrade) to bMatch
37170>>>>>                
37170>>>>>                If (bMatch) Begin
37172>>>>>                    // Store the login
37172>>>>>                    If (bUpgrade) Begin
37174>>>>>                        Get CreatePasswordHash (Trim(sPassword)) (&sPassword) to bUpgrade
37175>>>>>                        If (bUpgrade) Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37178>>>>>                    End
37178>>>>>>
37178>>>>>                    Set Field_Changed_Value of hoUserDD Field WebAppUser.LastLogin to (CurrentDateTime())
37179>>>>>                    Get Request_Validate of hoSessionDD to iErr
37180>>>>>                    If (iErr) Begin
37182>>>>>                        // this should not happen. If it does its a programming error
37182>>>>>                        Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37183>>>>>>
37183>>>>>                        Function_Return False
37184>>>>>                    End
37184>>>>>>
37184>>>>>                    
37184>>>>>                    Send Request_Save of hoSessionDD
37185>>>>>                    
37185>>>>>                    // Update session properties
37185>>>>>                    Send UpdateSessionProperties False
37186>>>>>                    Send NotifyChangeRights
37187>>>>>                    Function_Return True
37188>>>>>                End
37188>>>>>>
37188>>>>>                Else Begin
37189>>>>>                    //  We should rely directly on this buffer elsewhere but just be sure
37189>>>>>                    Send Clear of hoUserDD
37190>>>>>                End
37190>>>>>>
37190>>>>>            End
37190>>>>>>
37190>>>>>            Else Begin
37191>>>>>                // This is added to delay latency to avoid hackers finding out whether the user exists or not.
37191>>>>>                Get CreatePasswordHash "This is to delay the response latency." (&sPassword) to iErr
37192>>>>>            End
37192>>>>>>
37192>>>>>        End
37192>>>>>>
37192>>>>>        Else Begin
37193>>>>>            // This is added to delay latency to avoid hackers finding out whether the user exists or not.
37193>>>>>            Get CreatePasswordHash "This is to delay the response latency." (&sPassword) to iErr
37194>>>>>        End
37194>>>>>>
37194>>>>>          
37194>>>>>        Function_Return False
37195>>>>>    End_Function
37196>>>>>    
37196>>>>>    Function SetUserPassword String sLoginName String sPassword Returns Boolean
37198>>>>>        Handle hoUserDD
37198>>>>>        Integer iErr
37198>>>>>        Get phoUserDD to hoUserDD
37199>>>>>        
37199>>>>>        //  Find the user
37199>>>>>        Send Clear of hoUserDD
37200>>>>>        Move sLoginName to WebAppUser.LoginName
37201>>>>>        Send Find of hoUserDD EQ Index.1
37202>>>>>        If (not(Found)) Begin
37204>>>>>            Send Clear of hoUserDD
37205>>>>>            Function_Return False
37206>>>>>        End
37206>>>>>>
37206>>>>>        
37206>>>>>        If (not(CreatePasswordHash(Self, Trim(sPassword), &sPassword))) Begin
37208>>>>>            Send Clear of hoUserDD
37209>>>>>            Function_Return False
37210>>>>>        End
37210>>>>>>
37210>>>>>        Set Field_Changed_Value of hoUserDD Field WebAppUser.Password to sPassword
37211>>>>>        Get Request_Validate of hoUserDD to iErr
37212>>>>>        If (iErr) Begin
37214>>>>>            Send Clear of hoUserDD
37215>>>>>            Function_Return False
37216>>>>>        End
37216>>>>>>
37216>>>>>        
37216>>>>>        Send Request_Save of hoUserDD
37217>>>>>        Function_Return (not(Err))
37218>>>>>    End_Function
37219>>>>>    
37219>>>>>    Function IsLoggedIn Returns Boolean
37221>>>>>        String sLoginName
37221>>>>>        Boolean bLogWebSession bLoggedIn
37221>>>>>        
37221>>>>>        Get pbLogWebSession to bLogWebSession
37222>>>>>        If not bLogWebSession Begin
37224>>>>>            Forward Get IsLoggedIn to bLoggedIn
37226>>>>>            Function_Return bLoggedIn
37227>>>>>        End
37227>>>>>>
37227>>>>>        
37227>>>>>        Get psLoginName to sLoginName
37228>>>>>        
37228>>>>>        Function_Return (sLoginName <> "")
37229>>>>>    End_Function
37230>>>>>    
37230>>>>>    
37230>>>>>    //
37230>>>>>    // This procedure is called when validating a session and after logging in. Its purpose is to 
37230>>>>>    // update properties based on the session and user data. Augment this function to update 
37230>>>>>    // properties based on the session / user table. Note that WebAppUser and WebAppSession contain
37230>>>>>    // the right records when this procedure is called.
37230>>>>>    //
37230>>>>>    // Params:
37230>>>>>    //      bClear   True if the procedure is called before session validation to clear properties.
37230>>>>>    //
37230>>>>>    Procedure UpdateSessionProperties Boolean bClear
37232>>>>>        Handle hoUserDD
37232>>>>>        
37232>>>>>        Get phoUserDD to hoUserDD
37233>>>>>        
37233>>>>>        //  Update user properties
37233>>>>>        If (not(bClear) and HasRecord(hoUserDD)) Begin
37235>>>>>            Set psUsername to (Trim(WebAppUser.FullName))
37236>>>>>            Set psLoginName to (Trim(WebAppUser.LoginName))
37237>>>>>            Set piUserRights to WebAppUser.Rights
37238>>>>>            
37238>>>>>            Send OnSessionPropertiesSet 
37239>>>>>        End
37239>>>>>>
37239>>>>>        Else Begin
37240>>>>>            Set psUsername to ""
37241>>>>>            Set psLoginName to ""
37242>>>>>            Set piUserRights to 0
37243>>>>>            
37243>>>>>            Send OnSessionPropertiesClear
37244>>>>>        End
37244>>>>>>
37244>>>>>    End_Procedure
37245>>>>>    
37245>>>>>    Procedure OnSessionPropertiesSet
37247>>>>>        //  Empty event stub
37247>>>>>    End_Procedure
37248>>>>>    
37248>>>>>    Procedure OnSessionPropertiesClear
37250>>>>>        //  Empty event stub
37250>>>>>    End_Procedure
37251>>>>>    
37251>>>>>    Procedure EndSession
37253>>>>>        Integer iErr
37253>>>>>        Boolean bLogWebSession
37253>>>>>        Handle hoSessionDD       
37253>>>>>        
37253>>>>>        Get phoSessionDD to hoSessionDD
37254>>>>>        Get pbLogWebSession to bLogWebSession
37255>>>>>        If not bLogWebSession Begin
37257>>>>>            Forward Send EndSession
37259>>>>>            Procedure_Return
37260>>>>>        End
37260>>>>>>
37260>>>>>            
37260>>>>>        //  Check if session exists
37260>>>>>        Send Clear of hoSessionDD
37261>>>>>        Get psSessionKey to WebAppSession.SessionKey
37262>>>>>        
37262>>>>>        Send Find of hoSessionDD EQ Index.1
37263>>>>>        If (Found) Begin
37265>>>>>            Set Field_Changed_Value of hoSessionDD Field WebAppSession.Active to "N"
37266>>>>>            Get Request_Validate of hoSessionDD to iErr
37267>>>>>            If (iErr) Begin
37269>>>>>                // this should not happen. If it does its a programming error
37269>>>>>                Error DFERR_PROGRAM C_$WebAppSessionValidateFailed
37270>>>>>>
37270>>>>>                Procedure_Return
37271>>>>>            End
37271>>>>>>
37271>>>>>            Send Request_Save of hoSessionDD
37272>>>>>        End
37272>>>>>>
37272>>>>>    End_Procedure
37273>>>>>
37273>>>>>End_Class
37274>>>>>
37274>>>
37274>>>Object oSessionManager is a cWebSessionManagerStandard
37276>>>End_Object
37277>>>
37277>>>
37277>    Use Login.wo
Including file: Login.wo    (C:\DataFlex Projects\Centros\AppSrc\Login.wo)
37277>>>Use cWebView.pkg
37277>>>Use cWebForm.pkg
37277>>>Use cWebButton.pkg
37277>>>Use cWebPanel.pkg
37277>>>Use cWebLabel.pkg
37277>>>Use cWebSpacer.pkg
37277>>>Use cWebImage.pkg
37277>>>
37277>>>Object oLogin is a cWebView
37279>>>    Set piMinWidth to 250
37280>>>    Set piMaxWidth to 420
37281>>>    Set pbLoginModeEnforced to False
37282>>>    Set piColumnCount to 12
37283>>>    Set psCSSClass to "LoginView"
37284>>>    Set pbServerOnSubmit to True
37285>>>    
37285>>>    Set psStateViewName to "Login"
37286>>>    Set pbStateReplace to True  // Always replace the state so the login never becomes its own history item
37287>>>    
37287>>>    Property String psPrevStateHash ""  // Remember the state hash that the user navigated too so we can redirect after login
37290>>>    
37290>>>    Delegate Set phoLoginView to Self
37292>>>    
37292>>>    Object oTopSpacer is a cWebSpacer
37294>>>        Set pbFillHeight to True
37295>>>        Set piColumnSpan to 12
37296>>>    End_Object
37297>>>    
37297>>>    Object oWarning is a cWebLabel
37299>>>        Set pbVisible to False
37300>>>        Set psCaption to "Invalid User ID or password. \n\rHint: 'admin' & 'admin'."
37301>>>        Set peAlign to alignCenter
37302>>>        Set piColumnSpan to 12
37303>>>        Set psCSSClass to "LoginWarning"
37304>>>    End_Object
37305>>>    
37305>>>    Object oLogo is a cWebImage
37307>>>        Set piColumnSpan to 10
37308>>>        Set psUrl to "images/DF_Logo_Retina.png"
37309>>>        Set pePosition to wiFit
37310>>>        Set piColumnIndex to 1
37311>>>        Set piHeight to 160
37312>>>        
37312>>>        WebSetResponsive piHeight rmMobile to 100  // Best for small smart phones
37313>>>    End_Object
37314>>>    
37314>>>    Object oLoginName is a cWebForm
37316>>>        Set psLabel to "User ID:"
37317>>>        Set peLabelPosition to lpTop
37318>>>        Set piMaxLength to 20
37319>>>        Set piColumnIndex to 1
37320>>>        Set pbShowLabel to False
37321>>>        Set psPlaceHolder to "loginname"
37322>>>        Set piColumnSpan to 10
37323>>>        Set psAutoComplete to "username"
37324>>>    End_Object
37325>>>    
37325>>>    Object oPassword is a cWebForm
37327>>>        Set psLabel to "Password:"
37328>>>        Set pbPassword to True
37329>>>        Set peLabelAlign to alignLeft
37330>>>        Set piMaxLength to 20
37331>>>        Set peLabelPosition to lpTop
37332>>>        Set pbShowLabel to False
37333>>>        Set psPlaceHolder to "password"
37334>>>        Set piColumnSpan to 10
37335>>>        Set piColumnIndex to 1
37336>>>        Set psAutoComplete to "current-password"
37337>>>    End_Object
37338>>>    
37338>>>    Object oWebSpacer1 is a cWebSpacer
37340>>>        Set piColumnSpan to 12
37341>>>        Set piHeight to 10
37342>>>    End_Object
37343>>>    
37343>>>    Object oLoginButton is a cWebButton
37345>>>        Set pbShowLabel to False
37346>>>        Set psCaption to "sign in"
37347>>>        Set pbServerOnClick to True
37348>>>        Set piColumnSpan to 10
37349>>>        Set piColumnIndex to 1
37350>>>        
37350>>>        Procedure OnClick
37353>>>            Send DoLogin
37354>>>        End_Procedure
37355>>>    End_Object
37356>>>    
37356>>>    Object oBottomSpacer is a cWebSpacer
37358>>>        Set pbFillHeight to True
37359>>>        Set piColumnSpan to 12
37360>>>    End_Object
37361>>>    
37361>>>    Procedure DoLogin
37364>>>        String sLoginName sPassword sPrevStateHash
37364>>>        Boolean bResult
37364>>>        
37364>>>        WebGet psValue of oLoginName to sLoginName
37365>>>        WebGet psValue of oPassword to sPassword
37366>>>        
37366>>>        Get UserLogin of ghoWebSessionManager sLoginName sPassword to bResult
37367>>>        
37367>>>        If (bResult) Begin
37369>>>            Send Hide of oLogin
37370>>>            Send ShowHeader of ghoWebApp
37371>>>            WebSet psCSSClass of ghoWebApp to ""
37372>>>            
37372>>>            WebGet psPrevStateHash to sPrevStateHash
37373>>>            Send NavigateToStateHash of ghoWebApp sPrevStateHash True
37374>>>            
37374>>>            // clear the login values. we don't want to return the login id & password as synchronized properties....
37374>>>            WebSet psValue of oLoginName to ""
37375>>>            WebSet psValue of oPassword  to ""
37376>>>            WebSet pbVisible of oWarning to False
37377>>>        End
37377>>>>
37377>>>        Else Begin
37378>>>            WebSet pbVisible of oWarning to True
37379>>>        End
37379>>>>
37379>>>    End_Procedure
37380>>>    
37380>>>    Procedure OnSubmit
37383>>>        Send DoLogin
37384>>>    End_Procedure
37385>>>    
37385>>>    Procedure OnLoad
37388>>>        String sPrevStateHash sView
37388>>>        
37388>>>        Forward Send OnLoad
37390>>>        
37390>>>        //  Store the current state so we can go back to that later (only if it points to a different view)
37390>>>        Get StateHash of ghoWebApp to sPrevStateHash
37391>>>        Send ParseViewStateHash sPrevStateHash (&sView)
37392>>>        If (Lowercase(sView) <> Lowercase(psStateViewName(Self))) Begin
37394>>>            WebSet psPrevStateHash to sPrevStateHash
37395>>>        End
37395>>>>
37395>>>        
37395>>>    End_Procedure
37396>>>    
37396>>>    Procedure OnBeforeShow
37399>>>        //  Hide header & apply nice background style
37399>>>        Send HideHeader to ghoWebApp
37400>>>        WebSet psCSSClass of ghoWebApp to "LoginBackground"
37401>>>    End_Procedure
37402>>>    
37402>>>End_Object
37403>>>
37403>>>
37403>>>
37403>>>
37403>    Use WebResourceManager.wo
Including file: WebResourceManager.wo    (C:\DataFlex Projects\Centros\AppSrc\WebResourceManager.wo)
37403>>>Use cWebResourceManager.pkg
37403>>>
37403>>>Object oWebResourceManager is a cWebResourceManager
37405>>>End_Object
37406>    
37406>    Use Dashboard.wo
Including file: Dashboard.wo    (C:\DataFlex Projects\Centros\AppSrc\Dashboard.wo)
37406>>>Use cWebView.pkg
37406>>>Use cWebPanel.pkg
37406>>>Use cWebForm.pkg
37406>>>Use cWebButton.pkg
37406>>>Use cWebGroup.pkg
37406>>>Use cWebSpacer.pkg
37406>>>Use cWebHtmlBox.pkg
37406>>>Use cWebMenuGroup.pkg
37406>>>Use cWebMenuItem.pkg
37406>>>Use cWebLabel.pkg
37406>>>Use cWebList.pkg
37406>>>Use cWebColumn.pkg
37406>>>
37406>>>Object oDashboard is a cWebView
37408>>>
37408>>>    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  
37408>>>    // Add a DDO Structure 
37408>>>    //
37408>>>    // There is no need to synchronize a DD structure on the client so we do
37408>>>    // not set the Server property or send ADDOStructure. We will simply use
37408>>>    // DDO's to mine data and generate HTML for our cWebHTMLBox objects.
37408>>>    // It is the HTML in these objects that is sent to the client each time 
37408>>>    // this page is shown.
37408>>>    //
37408>>>    // Also, it is important for the drill-down Navigation interface that we
37408>>>    // do not set the Server property to some DDO because this will affect 
37408>>>    // constraints in the next view that we navigate to.
37408>>>    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
37408>>>
37408>>>    Set piMaxWidth to 1024
37409>>>    
37409>>>    Set psCaption to "Dashboard"
37410>>>    Set peViewType to vtUndefined
37411>>>    Set pbShowCaption to False
37412>>>    Set psCSSClass to "Dashboard"
37413>>>    
37413>>>    Object oWebMainPanel is a cWebPanel
37415>>>        Set piColumnCount to 24
37416>>>        
37416>>>        // - - - - - - - - - - - - - - -
37416>>>        // Main Panel's Responsive Rules
37416>>>        // - - - - - - - - - - - - - - -
37416>>>        WebSetResponsive piColumnCount rmMobile to 1
37417>>>        WebSetResponsive piColumnCount rmTabletPortrait to 16
37418>>>    
37418>>>        Object oTiles_grp is a cWebGroup
37420>>>            Set piColumnSpan to 8
37421>>>            Set pbShowBorder to False
37422>>>            Set pbShowCaption to False
37423>>>            Set piColumnCount to 12
37424>>>            
37424>>>            Set psCSSClass to "TilesGroup"
37425>>>    
37425>>>            Object oWelcomeTile is a cWebHtmlBox
37427>>>                Set piColumnSpan to 6
37428>>>                Set psCSSClass to "Tile Light"
37429>>>                Set psHtml to '<div Class="WebCon_Sizer"><div class="Tile_Title">Welcome</div><div Class="Tile_Subtitle">--</div></div>'
37430>>>    
37430>>>                Procedure OnLoad
37433>>>                    Send UpdateHTML ('<div class="WebCon_Sizer">' + ;                                     '<div class="Tile_Title">Welcome</div>' +;                                     '<div class="Tile_Subtitle">' - htmlEncode(psUserName(ghoWebSessionManager)) - '</div>' +;                                     '</div>')
37434>>>                End_Procedure
37435>>>                
37435>>>            End_Object
37436>>>    
37436>>>            Object oTile2 is a cWebHtmlBox
37438>>>                Set pbServerOnClick to True
37439>>>                Set piColumnSpan to 6
37440>>>                Set piColumnIndex to 6
37441>>>                Set psCSSClass to "Tile LightAlternate"
37442>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Email</div><div class="Tile_Subtitle"></div></div>'
37443>>>                                
37443>>>                WebRegisterPath ntNavigateForwardCustom oDummieEmail
37449>>>                
37449>>>                Procedure OnClick String sId String sParam
37452>>>                    Send NavigatePath
37453>>>                End_Procedure
37454>>>                
37454>>>            End_Object
37455>>>    
37455>>>            Object oTile3 is a cWebHtmlBox
37457>>>                Set pbServerOnClick to True
37458>>>                Set piColumnSpan to 6
37459>>>                Set psCSSClass to "Tile Dark"
37460>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Dni</div><div class="Tile_Subtitle"></div></div>'
37461>>>    
37461>>>                 WebRegisterPath ntNavigateForwardCustom oDummieDni
37467>>>                
37467>>>                Procedure OnClick String sId String sParam
37470>>>                    Send NavigatePath
37471>>>                End_Procedure
37472>>>                
37472>>>            End_Object
37473>>>            
37473>>>                
37473>>>    
37473>>>            Object oTile4 is a cWebHtmlBox
37475>>>                Set pbServerOnClick to True
37476>>>                Set piColumnSpan to 6
37477>>>                Set piColumnIndex to 6
37478>>>                Set psCSSClass to "Tile DarkAlternate"
37479>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Centros</div><div class="Tile_Subtitle"></div></div>'
37480>>>            
37480>>>                WebRegisterPath ntNavigateForwardCustom oSelectCentro
37486>>>                
37486>>>                Procedure OnClick String sId String sParam
37489>>>                    Send NavigatePath
37490>>>                End_Procedure
37491>>>            End_Object
37492>>>                
37492>>>            Object oTile5 is a cWebHtmlBox
37494>>>                Set pbServerOnClick to True
37495>>>                Set piColumnSpan to 6
37496>>>                Set psCSSClass to "Tile Dark"
37497>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Alummnos</div><div class="Tile_Subtitle"></div></div>'
37498>>>    
37498>>>                 WebRegisterPath ntNavigateForwardCustom oSelectStudents
37504>>>                
37504>>>                Procedure OnClick String sId String sParam
37507>>>                    Send NavigatePath
37508>>>                End_Procedure
37509>>>            End_Object
37510>>>            
37510>>>             Object oTile6 is a cWebHtmlBox
37512>>>                Set pbServerOnClick to True
37513>>>                Set piColumnSpan to 6
37514>>>                Set psCSSClass to "Tile Dark"
37515>>>                Set psHtml to '<div class="WebCon_Sizer" data-ServerOnClick="openview"><div Class="Tile_Title">Dummie Telefono</div><div class="Tile_Subtitle"></div></div>'
37516>>>    
37516>>>                 WebRegisterPath ntNavigateForwardCustom oDummieTelefono
37522>>>                
37522>>>                Procedure OnClick String sId String sParam
37525>>>                    Send NavigatePath
37526>>>                End_Procedure
37527>>>            End_Object
37528>>>        End_Object
37529>>>    
37529>>>    End_Object
37530>>>    
37530>>>    Procedure OnBeforeShow
37533>>>        // Each time this view is shown we will update the appropriate information.
37533>>>    End_Procedure
37534>>>
37534>>>End_Object
37535>    Use DummieEmail.wo
Including file: DummieEmail.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieEmail.wo)
37535>>>Use cWebView.pkg
37535>>>Use cWebPanel.pkg
37535>>>Use cWebForm.pkg 
37535>>>
37535>>>Use zEmailValidation.pkg
Including file: zEmailValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zEmailValidation.pkg)
37535>>>>>Function zValidarEmail String sEmail  String ByRef sMsg Returns Boolean
37538>>>>> 
37538>>>>>  Boolean bRet
37538>>>>>  String[] aEmail 
37539>>>>>  
37539>>>>>    Get zSplitEmail sEmail  to aEmail 
37540>>>>>    
37540>>>>>    Get zArrobaCheck aEmail (&sMsg)  to bRet
37541>>>>>    If (not (bRet)) Function_Return False 
37544>>>>>    
37544>>>>>    Get zLocalAndressCheck aEmail (&sMsg)  to bRet
37545>>>>>    If (not (bRet)) Function_Return False
37548>>>>>    
37548>>>>>    Get zDominioAndExtensionCheck aEmail (&sMsg) to bRet
37549>>>>>    If (not (bRet)) Function_Return False
37552>>>>>    
37552>>>>>    Get zLocalAndressSizeCheck aEmail (&sMsg) to bRet 
37553>>>>>    If (not (bRet)) Function_Return False 
37556>>>>>    
37556>>>>>    Get zDomSizeCheck aEmail (&sMsg) to bRet 
37557>>>>>    If (not (bRet)) Function_Return False
37560>>>>>    
37560>>>>>    
37560>>>>>    Function_Return True
37561>>>>>End_Function
37562>>>>>
37562>>>>>
37562>>>>>
37562>>>>>Function zSplitEmail String sEmail Returns String[]
37565>>>>>    String[] aEmail
37566>>>>>    
37566>>>>>    Move (StrSplitToArray (sEmail , "@")) to aEmail
37567>>>>>    Function_Return aEmail
37568>>>>>End_Function
37569>>>>>
37569>>>>>
37569>>>>>
37569>>>>>Function zArrobaCheck String[] aEmail String ByRef sMsg Returns Boolean
37572>>>>>    If (SizeOfArray(aEmail) > 2) Begin 
37574>>>>>        Move "No se permite más de un @ en el correo" to sMsg
37575>>>>>        Function_Return False 
37576>>>>>        
37576>>>>>    End
37576>>>>>>
37576>>>>>    If (SizeOfArray(aEmail) < 2) Begin
37578>>>>>        Move "Porfavor el correo tiene que contener un @" to sMsg
37579>>>>>        Function_Return False
37580>>>>>    End
37580>>>>>>
37580>>>>>    Function_Return True
37581>>>>>
37581>>>>>End_Function
37582>>>>>
37582>>>>>
37582>>>>>Function zLocalAndressCheck String[] aEmail String ByRef sMsg Returns Boolean
37585>>>>>    
37585>>>>>    String[] aRet
37586>>>>>    Object oEmailPattern is a cRegEx
37588>>>>>        Set psExpression to "^[a-zA-Z0-9._%+]+$"
37589>>>>>    End_Object
37590>>>>>    
37590>>>>>    Get MatchAll of oEmailPattern (aEmail[0]) to aRet
37591>>>>>    
37591>>>>>    If (SizeOfArray(aRet) = 1 ) Begin
37593>>>>>            Function_Return True
37594>>>>>            
37594>>>>>    End
37594>>>>>>
37594>>>>>    
37594>>>>>    Move "Antes del @ solo puede haber un codigo alfanumerico y/o (. , _ , % , +)" to sMsg
37595>>>>>    Function_Return False
37596>>>>>End_Function
37597>>>>>
37597>>>>>Function zDominioAndExtensionCheck String[] aEmail String ByRef sMsg Returns Boolean
37600>>>>>    
37600>>>>>    String[] aRet aDomRet
37602>>>>>    Integer iPospoint
37602>>>>>    String sExtensionDom
37602>>>>>    Object oEmailPattern is a cRegEx
37604>>>>>        Set psExpression to "^[a-zA-Z0-9-]+\.[a-zA-Z]{2,7}$"
37605>>>>>    End_Object
37606>>>>>    
37606>>>>>    Get MatchAll of oEmailPattern (aEmail[1]) to aRet
37607>>>>>    
37607>>>>>    
37607>>>>>    Move (RightPos ( "." , aRet[0] )) to iPospoint
37608>>>>>    Move (Mid(aRet[0] , (Length(aRet[0]) - iPospoint) , (iPospoint + 1))) to sExtensionDom
37609>>>>>    
37609>>>>>    If (SizeOfArray(aRet) = 1 ) Begin
37611>>>>>        If (Length(sExtensionDom) > 1 and Length(sExtensionDom) < 8) Begin
37613>>>>>            
37613>>>>>            Function_Return True 
37614>>>>>        End
37614>>>>>>
37614>>>>>            
37614>>>>>    End
37614>>>>>>
37614>>>>>    
37614>>>>>    Move "Despues del @ solo puede contener un codigo alfanumerico seguido de un punto y la extesion que tiene una longitud enttre 2 y 7, solo permitiendo letras" to sMsg
37615>>>>>    Function_Return False
37616>>>>>    
37616>>>>>    
37616>>>>>End_Function
37617>>>>>
37617>>>>>Function zLocalAndressSizeCheck String[] aEmail String ByRef sMsg Returns Boolean
37620>>>>>    
37620>>>>>     If (Length(aEmail[0]) < 65) Begin
37622>>>>>        Function_Return True
37623>>>>>     End
37623>>>>>>
37623>>>>>     Move "La parte de la dirección local Solo puede tener un maximo de 65 caracteres " to sMsg
37624>>>>>        Function_Return False
37625>>>>>End_Function
37626>>>>>
37626>>>>>
37626>>>>>Function zDomSizeCheck String[] aEmail String ByRef sMsg Returns Boolean
37629>>>>>    
37629>>>>>   
37629>>>>>    If (Length(aEmail[1]) < 256 ) Begin
37631>>>>>        Function_Return True
37632>>>>>    End
37632>>>>>>
37632>>>>>    
37632>>>>>    Move "El el dominio no puede superar los 255 caracteres" to sMsg
37633>>>>>    
37633>>>>>    
37633>>>>>    Function_Return False 
37634>>>>>End_Function
37635>>>>>
37635>>>>>
37635>>>Use cWebButton.pkg
37635>>>Use cWebSpacer.pkg
37635>>>Use cWebLabel.pkg
37635>>>
37635>>>Object oDummieEmail is a cWebView
37637>>>    Set piWidth to 700
37638>>>    Set psCaption to "DummieEmail"
37639>>>
37639>>>    // Your DDO structure will go here
37639>>>
37639>>>    Object oWebMainPanel is a cWebPanel
37641>>>        Set piColumnCount to 12
37642>>>        
37642>>>        // place controls here
37642>>>        // Your view will grow as controls are added
37642>>>        
37642>>>        Object oEmail_Form is a cWebForm
37644>>>            Set piColumnSpan to 0
37645>>>            Set psLabel to "Email"
37646>>>        End_Object
37647>>>
37647>>>        Object oError_Label is a cWebLabel
37649>>>            Set psCaption to ""
37650>>>            Set piColumnSpan to 13
37651>>>            Set piColumnIndex to 0
37652>>>        End_Object
37653>>>
37653>>>        Object oWebSpacer1 is a cWebSpacer
37655>>>            Set piColumnSpan to 12
37656>>>        End_Object
37657>>>
37657>>>        Object oValidar_Button is a cWebButton
37659>>>            Set piColumnSpan to 4
37660>>>            Set piColumnIndex to 4
37661>>>            Set psCaption to "Validar"
37662>>>        
37662>>>            Procedure OnClick
37665>>>                Boolean bRet
37665>>>                String sEmail sMsg
37665>>>                WebGet psValue of oEmail_Form to sEmail
37666>>>                Get zValidarEmail sEmail (&sMsg) to bRet
37667>>>                
37667>>>                WebSet psBackgroundColor of oEmail_Form to "#ffffff"
37668>>>                WebSet psCaption of oError_Label to ""
37669>>>                
37669>>>                If (bRet) Begin
37671>>>                    WebSet psBackgroundColor of oEmail_Form to "green"
37672>>>                    
37672>>>                End
37672>>>>
37672>>>                If (not (bRet)) Begin
37674>>>                    WebSet psBackgroundColor of oEmail_Form to "red"
37675>>>                    WebSet psCaption of oError_Label to sMsg
37676>>>                End
37676>>>>
37676>>>                
37676>>>            End_Procedure
37677>>>        End_Object
37678>>>        
37678>>>        
37678>>>        
37678>>>    End_Object 
37679>>>
37679>>>End_Object
37680>    Use DummineDniValidation.wo
Including file: DummineDniValidation.wo    (C:\DataFlex Projects\Centros\AppSrc\DummineDniValidation.wo)
37680>>>Use cWebWidget.pkg
Including file: cWebWidget.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cWebWidget.pkg)
37680>>>>>Use cWebGroup.pkg
37680>>>>>Use cWebDDOSync_Mixin.pkg
37680>>>>>Use WebWidgetStructs.pkg
Including file: WebWidgetStructs.pkg    (C:\Program Files\DataFlex 25.0\Pkg\WebWidgetStructs.pkg)
37680>>>>>>>// WCT: Wizard Control Type
37680>>>>>>>Enum_List
37680>>>>>>>    Define WCT_Form       for 0
37680>>>>>>>    Define WCT_Combo      for 1
37680>>>>>>>    Define WCT_Slider     for 2
37680>>>>>>>    Define WCT_Checkbox   for 3
37680>>>>>>>End_Enum_List
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigPropSettings
37680>>>>>>>    String sOptLabel
37680>>>>>>>    String sOptDescription
37680>>>>>>>    Integer eControlType        // 0 = form, 1 = combo, 2 = slider, 3 = checkbox. Use above enum
37680>>>>>>>    Boolean bOptValidateValue   // Whether to validate the given value versus any of the underlying options
37680>>>>>>>    Integer iOptMinValue
37680>>>>>>>    Integer iOptMaxValue
37680>>>>>>>    Integer iOptStepSize
37680>>>>>>>    String[] asOptValues
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigProp
37680>>>>>>>    String sObjName
37680>>>>>>>    String sPropName
37680>>>>>>>    tWidgetConfigPropSettings Settings
37680>>>>>>>    tWidgetConfigPropSettings Settings
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetConfigPropValue
37680>>>>>>>    String sObjName
37680>>>>>>>    String sPropName
37680>>>>>>>    String sValue
37680>>>>>>>End_Struct
37680>>>>>>>
37680>>>>>>>Struct tWidgetDef
37680>>>>>>>    String sName
37680>>>>>>>    String sDynId
37680>>>>>>>    Integer iRowIndex
37680>>>>>>>    Integer iColIndex
37680>>>>>>>    Integer iRowSpan
37680>>>>>>>    Integer iColSpan
37680>>>>>>>    Boolean bFillHeight
37680>>>>>>>    tWidgetConfigPropValue[] aConfig // ToDo: This could be smarter, aggregate by child-object and list all props there.
37680>>>>>>>    tWidgetConfigPropValue[] aConfig // ToDo: This could be smarter, aggregate by child-object and list all props there.
37680>>>>>>>    tWebPropRule[] aResponsivePropRules
37680>>>>>>>    tWebPropRule[] aResponsivePropRules
37680>>>>>>>End_Struct
37680>>>>>
37680>>>>>//  Function from cWebDynamicObjectContainer
37680>>>>>Register_Function TruncateName String sObjectName Returns String
37680>>>>>
37680>>>>>//Struct tWidget
37680>>>>>//    String sId
37680>>>>>//    tWidgetDef WidgetDef
37680>>>>>//End_Struct
37680>>>>>
37680>>>>>Class cWebWidget is a cWebGroup
37681>>>>>    
37681>>>>>    Procedure Construct_Object
37683>>>>>        Forward Send Construct_Object
37685>>>>>        
37685>>>>>        Property Integer piDefaultColSpan 1
37686>>>>>        Property Integer piDefaultRowSpan 1
37687>>>>>        
37687>>>>>        Property String psDynamicWidgetId                   // Set by the container to easily find this widget for dynamic configuration
37689>>>>>        
37689>>>>>        Property String psWidgetName
37691>>>>>        
37691>>>>>        Property String psWidgetCaption ""
37692>>>>>        Property String psWidgetDescription ""
37693>>>>>        
37693>>>>>        Property Boolean pbAllowConfiguration True
37695>>>>>        
37695>>>>>        Property Boolean pbConfigurable False
37697>>>>>        
37697>>>>>        Property Handle phoConfigWizard C_WebUnresolvedObject
37698>>>>>        
37698>>>>>        // Default to flow to make the designer work with the widgetcontainer and because we do not want widgets to inherit whatever is set at the dashboard view
37698>>>>>        Set peLayoutType to ltFlow
37699>>>>>        Set pbFillHeight to True
37700>>>>>        Set pbScroll to True
37701>>>>>        
37701>>>>>        Set psJSClass to 'df.WebWidget'
37702>>>>>        
37702>>>>>        Send Define_cWebDDOSync_mixin
37703>>>>>    End_Procedure
37704>>>>>    
37704>>>>>    Import_Class_Protocol cWebDDOSync_mixin
37705>>>>>    
37705>>>>>    Function IsWebWidget Returns Boolean
37707>>>>>        Function_Return True
37708>>>>>    End_Function
37709>>>>>    
37709>>>>>    Procedure InitWidget
37711>>>>>        Boolean bConfigurable
37711>>>>>        
37711>>>>>        Get IsConfigurable to bConfigurable
37712>>>>>        WebSet pbConfigurable to bConfigurable
37713>>>>>        
37713>>>>>        Send OnInitializeWidget
37714>>>>>    End_Procedure
37715>>>>>    
37715>>>>>    Function ConfigurablePropExists tWidgetConfigProp WidgetConfigProp Returns Boolean
37717>>>>>        Boolean bExists
37717>>>>>        tWidgetConfigProp[] aConfigurableProps 
37717>>>>>        tWidgetConfigProp[] aConfigurableProps 
37718>>>>>        
37718>>>>>        Get GetConfigurableProps to aConfigurableProps
37719>>>>>        
37719>>>>>        Get ConfigurablePropExistsEx aConfigurableProps WidgetConfigProp to bExists
37720>>>>>        
37720>>>>>        Function_Return bExists
37721>>>>>    End_Function
37722>>>>>    
37722>>>>>    Function ConfigurablePropExistsEx tWidgetConfigProp[] aConfigurableProps tWidgetConfigProp WidgetConfigProp Returns Boolean
37724>>>>>        Integer i iProps
37724>>>>>        String sTrimmedObjName
37724>>>>>        
37724>>>>>        Get TrimDynamicObjectName WidgetConfigProp.sObjName to sTrimmedObjName
37725>>>>>        
37725>>>>>        Move ((SizeOfArray(aConfigurableProps)) - 1) to iProps
37726>>>>>        
37726>>>>>        For i from 0 to iProps
37732>>>>>>
37732>>>>>            If (aConfigurableProps[i].sObjName = sTrimmedObjName and aConfigurableProps[i].sPropName = WidgetConfigProp.sPropName) Begin
37734>>>>>                Function_Return True
37735>>>>>            End
37735>>>>>>
37735>>>>>        Loop
37736>>>>>>
37736>>>>>        
37736>>>>>        Function_Return False
37737>>>>>    End_Function
37738>>>>>    
37738>>>>>    // Gets the configurable props for this widget
37738>>>>>    // This is used by the configuration wizard to build a configuration dialog, based on the prop settings
37738>>>>>    Function GetConfigurableProps Returns tWidgetConfigProp[]
37740>>>>>        tWidgetConfigProp[] aConfigurableProps
37740>>>>>        tWidgetConfigProp[] aConfigurableProps
37741>>>>>
37741>>>>>        Send OnGetConfigurableProps (&aConfigurableProps)
37742>>>>>        
37742>>>>>        Function_Return aConfigurableProps
37743>>>>>    End_Function
37744>>>>>    
37744>>>>>    Function IsConfigurable Returns Boolean
37746>>>>>        Boolean bAllowConfig
37746>>>>>        tWidgetConfigProp[] aConfigurableProps
37746>>>>>        tWidgetConfigProp[] aConfigurableProps
37747>>>>>        
37747>>>>>        Move ( ((phoConfigWizard(Self)) <> C_WebUnresolvedObject) and (pbAllowConfiguration(Self)) ) to bAllowConfig
37748>>>>>        
37748>>>>>        Send OnDetermineConfigurableState (&bAllowConfig)
37749>>>>>        
37749>>>>>        Function_Return bAllowConfig
37750>>>>>    End_Function
37751>>>>>    
37751>>>>>    Function GetConfigurablePropValues Returns tWidgetConfigPropValue[]
37753>>>>>        tWidgetConfigProp[] aProps
37753>>>>>        tWidgetConfigProp[] aProps
37754>>>>>        tWidgetConfigPropValue[] aValues
37754>>>>>        tWidgetConfigPropValue[] aValues
37755>>>>>        tWebPropMetaData PropMeta
37755>>>>>        tWebPropMetaData PropMeta
37755>>>>>        Variant vValue
37755>>>>>        Integer i iProps iType
37755>>>>>        Boolean bValid
37755>>>>>        String sDynamicObjectId
37755>>>>>        Handle hoObj
37755>>>>>        tWidgetConfigPropValue CurValue EmptyValue
37755>>>>>        tWidgetConfigPropValue CurValue EmptyValue
37755>>>>>        
37755>>>>>        // Get all config props
37755>>>>>        
37755>>>>>        Get GetConfigurableProps to aProps
37756>>>>>        
37756>>>>>        Move ((SizeOfArray(aProps)) - 1) to iProps
37757>>>>>        
37757>>>>>        For i from 0 to iProps
37763>>>>>>
37763>>>>>            Delegate Get TruncateName aProps[i].sObjName to sDynamicObjectId
37765>>>>>            If (sDynamicObjectId <> "") Begin
37767>>>>>                WebGet psDynamicWidgetId to sDynamicObjectId
37768>>>>>                Move (sDynamicObjectId + '.' + aProps[i].sObjName) to sDynamicObjectId
37769>>>>>                
37769>>>>>                Get DynamicObject sDynamicObjectId to hoObj
37770>>>>>            End
37770>>>>>>
37770>>>>>            Else Begin
37771>>>>>                Move (Self) to hoObj
37772>>>>>            End
37772>>>>>>
37772>>>>>            
37772>>>>>            If (hoObj <> 0) Begin
37774>>>>>                Move EmptyValue to CurValue
37775>>>>>                
37775>>>>>                Get FindWebPropertyMetaByName of hoObj aProps[i].sPropName to PropMeta
37776>>>>>                If (PropMeta.hmGetter <> 0) Begin
37778>>>>>                    Get GetSyncProp of hoObj hoObj PropMeta.hmGetter PropMeta.sName to vValue
37779>>>>>                    
37779>>>>>                    Get VariantType vValue to iType
37780>>>>>                    If (iType = OLE_VT_Empty) Begin
37782>>>>>                        Move False to bValid
37783>>>>>                    End
37783>>>>>>
37783>>>>>                    Else Begin
37784>>>>>                        Get VerifyConfigurablePropValue aProps[i] vValue to bValid
37785>>>>>                    End
37785>>>>>>
37785>>>>>                    
37785>>>>>                    If (bValid) Begin
37787>>>>>                        Move sDynamicObjectId to CurValue.sObjName
37788>>>>>                        Move aProps[i].sPropName to CurValue.sPropName
37789>>>>>                        Move vValue to CurValue.sValue
37790>>>>>                        Move CurValue to aValues[-1]
37791>>>>>                    End
37791>>>>>>
37791>>>>>                    Else Begin
37792>>>>>                        Function_Return EmptyValue
37793>>>>>                    End
37793>>>>>>
37793>>>>>                End
37793>>>>>>
37793>>>>>                Else Begin
37794>>>>>                    Function_Return EmptyValue
37795>>>>>                End
37795>>>>>>
37795>>>>>            End
37795>>>>>>
37795>>>>>        Loop
37796>>>>>>
37796>>>>>        
37796>>>>>        Function_Return aValues
37797>>>>>    End_Function
37798>>>>>    
37798>>>>>    Function VerifyConfigurablePropValue tWidgetConfigProp ConfigProp Variant vValue Returns Boolean
37800>>>>>        // Check variant type
37800>>>>>        // check if variant within acceptable range of values
37800>>>>>        Integer iType iVals i
37800>>>>>        Number nCur
37800>>>>>        
37800>>>>>        If (not(ConfigProp.Settings.bOptValidateValue)) Begin
37802>>>>>            Function_Return True
37803>>>>>        End
37803>>>>>>
37803>>>>>        
37803>>>>>        Get VariantType vValue to iType
37804>>>>>        Move ((SizeOfArray(ConfigProp.Settings.asOptValues)) -1) to iVals
37805>>>>>        
37805>>>>>        If (iType = OLE_VT_I4 or iType = OLE_VT_I8 or ;            iType = OLE_VT_R4 or iType = OLE_VT_I8) Begin
37807>>>>>            // compare min, max and allowed vals
37807>>>>>            If (vValue >= ConfigProp.Settings.iOptMinValue and vValue =< ConfigProp.Settings.iOptMaxValue) Begin
37809>>>>>                // check step size
37809>>>>>                If (ConfigProp.Settings.iOptStepSize > 0) Begin
37811>>>>>                    Move ConfigProp.Settings.iOptMinValue to nCur
37812>>>>>                    While (nCur <= ConfigProp.Settings.iOptMaxValue)
37816>>>>>                        If (vValue = nCur) Begin
37818>>>>>                            Function_Return True
37819>>>>>                        End
37819>>>>>>
37819>>>>>                        Move (nCur + ConfigProp.Settings.iOptStepSize) to nCur
37820>>>>>                    Loop
37821>>>>>>
37821>>>>>                End
37821>>>>>>
37821>>>>>                Else Begin
37822>>>>>                    Function_Return True
37823>>>>>                End
37823>>>>>>
37823>>>>>            End
37823>>>>>>
37823>>>>>            
37823>>>>>            For i from 0 to iVals
37829>>>>>>
37829>>>>>                If (vValue = ConfigProp.Settings.asOptValues[i]) Begin
37831>>>>>                    Function_Return True
37832>>>>>                End
37832>>>>>>
37832>>>>>            Loop
37833>>>>>>
37833>>>>>        End
37833>>>>>>
37833>>>>>        If (iType = OLE_VT_Bstr) Begin
37835>>>>>            // compare allowed values
37835>>>>>            If (iVals <= 0) Begin
37837>>>>>                Function_Return True
37838>>>>>            End
37838>>>>>>
37838>>>>>            
37838>>>>>            For i from 0 to iVals
37844>>>>>>
37844>>>>>                If (vValue = ConfigProp.Settings.asOptValues[i]) Begin
37846>>>>>                    Function_Return True
37847>>>>>                End
37847>>>>>>
37847>>>>>            Loop
37848>>>>>>
37848>>>>>        End
37848>>>>>>
37848>>>>>        
37848>>>>>        
37848>>>>>        
37848>>>>>        Function_Return False
37849>>>>>    End_Function
37850>>>>>    
37850>>>>>    // Performs the equivalent of a webget for objects within this widget
37850>>>>>    Function GetWidgetConfigurablePropValue String sObj String sProp Returns Variant
37852>>>>>        String sDynamicObjectId
37852>>>>>        Handle hoObj
37852>>>>>        tWebPropMetaData PropMeta
37852>>>>>        tWebPropMetaData PropMeta
37852>>>>>        Variant vRet
37852>>>>>        
37852>>>>>        Delegate Get TruncateName sObj to sDynamicObjectId
37854>>>>>        Get DynamicObject sDynamicObjectId to hoObj
37855>>>>>        
37855>>>>>        If (hoObj <> 0) Begin
37857>>>>>            Get FindWebPropertyMetaByName of hoObj sProp to PropMeta
37858>>>>>            Get GetSyncProp of hoObj hoObj PropMeta.hmGetter PropMeta.sName to vRet
37859>>>>>        End
37859>>>>>>
37859>>>>>        
37859>>>>>        Function_Return vRet
37860>>>>>    End_Function
37861>>>>>    
37861>>>>>    Function TrimDynamicObjectName String sObjName Returns String
37863>>>>>        String[] asObjName
37864>>>>>        String sRetName
37864>>>>>        
37864>>>>>        Delegate Get TruncateName sObjName to sObjName
37866>>>>>        
37866>>>>>        Move (StrSplitToArray(sObjName, psDynamicWidgetID(Self))) to asObjName
37867>>>>>        
37867>>>>>        If (SizeOfArray(asObjName) > 1) Begin
37869>>>>>            Move asObjName[1] to sRetName
37870>>>>>            // Get rid of initial '.' if we end up with such a name
37870>>>>>            If ((Pos('.', sRetName)) = 1) Begin
37872>>>>>                Move (Replace('.', sRetName, '')) to sRetName
37873>>>>>            End
37873>>>>>>
37873>>>>>        End
37873>>>>>>
37873>>>>>        
37873>>>>>        Function_Return sRetName
37874>>>>>    End_Function
37875>>>>>    
37875>>>>>    Function CreateConfigurableProp Handle hoObj Handle hmPropFunc Returns tWidgetConfigProp
37877>>>>>        tWidgetConfigProp WidgetConfigProp
37877>>>>>        tWidgetConfigProp WidgetConfigProp
37877>>>>>        tWebPropMetaData PropMeta
37877>>>>>        tWebPropMetaData PropMeta
37877>>>>>        String sObjName
37877>>>>>        String[] asObjName
37878>>>>>        Boolean bIsDynamic
37878>>>>>        
37878>>>>>        Get IsDynamicObject of hoObj to bIsDynamic
37879>>>>>        If (bIsDynamic) Begin
37881>>>>>            Get TrimDynamicObjectName (WebObjectName(hoObj)) to WidgetConfigProp.sObjName
37882>>>>>        End
37882>>>>>>
37882>>>>>        Else Begin
37883>>>>>            // Assume Default widget & top level prop (will correct itself when attempting to apply)
37883>>>>>            Move "" to WidgetConfigProp.sObjName
37884>>>>>        End
37884>>>>>>
37884>>>>>
37884>>>>>        Get FindWebPropertyMeta of hoObj hmPropFunc to PropMeta
37885>>>>>        Move PropMeta.sName to WidgetConfigProp.sPropName
37886>>>>>
37886>>>>>        Function_Return WidgetConfigProp
37887>>>>>    End_Function
37888>>>>>    
37888>>>>>    Procedure OnInitializeWidget
37890>>>>>    End_Procedure
37891>>>>>    
37891>>>>>    Procedure OnGetConfigurableProps tWidgetConfigProp[] ByRef aConfigurableProps
37893>>>>>        // This event can be used to modify the initial set of configurable props based on for example permissions
37893>>>>>    End_Procedure
37894>>>>>    
37894>>>>>    Procedure OnWidgetPropsChanged
37896>>>>>    End_Procedure
37897>>>>>    
37897>>>>>    Procedure OnDetermineConfigurableState Boolean ByRef bAllow
37899>>>>>    End_Procedure
37900>>>>>    
37900>>>>>    Function AllowAccess Returns Boolean
37902>>>>>        // Override with your custom logic to determine if this widget should be rendered or not under certain circumstances
37902>>>>>        Function_Return True
37903>>>>>    End_Function
37904>>>>>    
37904>>>>>    // Used by AllowViewAccess to determine the name passed to the session manager.
37904>>>>>    Function ViewName Returns String
37906>>>>>        Function_Return (psWidgetName(Self))
37907>>>>>    End_Function
37908>>>>>    
37908>>>>>    // DDO Sync logic
37908>>>>>    Procedure Call_PreSync
37910>>>>>        Boolean bAllow bOrigSync
37910>>>>>        
37910>>>>>        Get pbSynchronizing to bOrigSync
37911>>>>>        Set pbSynchronizing to True
37912>>>>>        
37912>>>>>        Get SyncDDOs to bAllow        
37913>>>>>         
37913>>>>>        Broadcast Recursive Send UpdateDataBinding
37915>>>>>        
37915>>>>>        Set pbSynchronizing to bOrigSync
37916>>>>>    End_Procedure
37917>>>>>    
37917>>>>>    Procedure Call_PostSync
37919>>>>>        Send StoreDDOStates
37920>>>>>    End_Procedure
37921>>>>>    
37921>>>>>    
37921>>>>>    Procedure RegisterDDOStructure
37923>>>>>        // Override to do nothing
37923>>>>>    End_Procedure
37924>>>>>    
37924>>>>>    // Called by cWebDDOSync_mixin
37924>>>>>    Function IsDynamicConstraints Returns Boolean
37926>>>>>        Function_Return False
37927>>>>>    End_Function
37928>>>>>
37928>>>>>    // Override to not check parent, widgets should be encapsulated - we don't want to bleed the view's DDO's into them
37928>>>>>    Function Server Returns Integer
37930>>>>>        Integer hoServer
37930>>>>>        Get private_Server to hoServer
37931>>>>>//        If (hoServer = 0) Begin
37931>>>>>//            Function_Return (Locate_Server(parent(Self)))
37931>>>>>//        End
37931>>>>>        Function_Return hoServer
37932>>>>>    End_Function  
37933>>>>>
37933>>>>>    Function Widget Returns Handle 
37935>>>>>        Function_Return Self
37936>>>>>    End_Function
37937>>>>>
37937>>>>>    Procedure End_Construct_Object
37939>>>>>        Forward Send End_Construct_Object
37941>>>>>        
37941>>>>>        Send Attach_Deo_To_Server                       // Attach the DEO to the server DDs
37942>>>>>        Broadcast Recursive Send Attach_Deo_To_Server   // Make Child DEO's attach to their server
37944>>>>>        Broadcast Recursive Set In_Use_State to True    // Set each DDO's In_Use_State
37946>>>>>        Send WriteDDOCache                              // Store a cache of the DDO objects
37947>>>>>    End_Procedure
37948>>>>>   
37948>>>>>End_Class
37949>>>
37949>>>Composite oDummineDniValidation is a cWebWidget
37953>>>
37953>>>    // Your DDO structure will go here
37953>>>
37953>>>    Set piDefaultColSpan to 4
37954>>>    Set piDefaultRowSpan to 5
37955>>>    
37955>>>    Set psWidgetName to "oDummineDniValidation"
37956>>>    Set psWidgetCaption to "DummineDniValidation"
37957>>>    Set psWidgetDescription to "My custom widget"
37958>>>
37958>>>    Set piColumnCount to 12
37959>>>        
37959>>>End_Composite
37961>    Use DummieDni.wo
Including file: DummieDni.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieDni.wo)
37961>>>Use cWebView.pkg
37961>>>Use cWebPanel.pkg
37961>>>Use cWebForm.pkg 
37961>>>Use cWebButton.pkg
37961>>>Use cWebSpacer.pkg
37961>>>Use cWebLabel.pkg
37961>>>
37961>>>Use zDniValidation.pkg
Including file: zDniValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zDniValidation.pkg)
37961>>>>>Function zDniValidation  String sDni  String ByRef sMsg Returns Boolean
37964>>>>>    String sLetter sNumber 
37964>>>>>    Boolean bRet
37964>>>>>    
37964>>>>>    Get zNieComprobation sDni to sDni
37965>>>>>    
37965>>>>>    Get zDniNumberComprobation sDni (&sMsg) to bRet
37966>>>>>    If (not (bRet)) Function_Return False
37969>>>>>    
37969>>>>>    Move (Mid(sDni, 1 , 9)) to   sLetter
37970>>>>>    Move (Mid(sDni, 8, 1 ))  to sNumber
37971>>>>>    Move (Uppercase(sLetter)) to sLetter
37972>>>>>
37972>>>>>   
37972>>>>>   Get zDniLetterComprobation sLetter sNumber (&sMsg) to bRet
37973>>>>>   If (not (bRet)) Function_Return False
37976>>>>>  Function_Return True
37977>>>>>      
37977>>>>>End_Function
37978>>>>>
37978>>>>>Function zNieComprobation String sDni Returns String 
37981>>>>>
37981>>>>>    
37981>>>>>    
37981>>>>>       If (Uppercase(sDni) matches "X????????" )  Begin
37983>>>>>        Move ("0" + Mid (sDni, 8, 2)) to sDni
37984>>>>>        Function_Return (sDni)
37985>>>>>    End
37985>>>>>>
37985>>>>>       If (Uppercase(sDni) matches "Y????????" )  Begin
37987>>>>>       
37987>>>>>        Move ("1" + Mid (sDni, 8, 2)) to sDni
37988>>>>>        Function_Return sDni
37989>>>>>    End
37989>>>>>>
37989>>>>>     If (Uppercase(sDni) matches "Z????????" )  Begin
37991>>>>>       
37991>>>>>        Move ("2" + Mid (sDni, 8, 2)) to sDni
37992>>>>>        Function_Return sDni
37993>>>>>    End
37993>>>>>>
37993>>>>>   
37993>>>>>    Function_Return sDni
37994>>>>>End_Function
37995>>>>>
37995>>>>>
37995>>>>>
37995>>>>>Function zDniNumberComprobation String sDni String ByRef sMSg Returns Boolean
37998>>>>>    String[] aRet
37999>>>>>    Object oDnipattern is a cRegEx
38001>>>>>        Set psExpression to "^[0-9]{8}[a-zA-Z]{1}+$"
38002>>>>>    End_Object
38003>>>>>    Get MatchAll of oDnipattern (sDni) to aRet
38004>>>>>    If (SizeOfArray(aRet) = 1) Begin
38006>>>>>        Function_Return True
38007>>>>>    End
38007>>>>>>
38007>>>>>    
38007>>>>>    Move "Porfavor Introduzca un formato de dni valido 8 digitos y una letra" to sMSg
38008>>>>>    Function_Return False
38009>>>>>End_Function
38010>>>>>
38010>>>>>
38010>>>>>/**Function zDniLetterComprobation String sLetter String sNumber String ByRef sMsg Returns Boolean    String sValidationLeter    Move "T,R,W,A,G,M,Y,F,P,D,X,B,N,J,Z,S,Q,V,H,L,C,K,E" to sValidationLeter     String[] aValidationLeter        Move (StrSplitToArray (sValidationLeter, ",")) to aValidationLeter    If (aValidationLeter[(Mod(Integer(sNumber), 23 ) )] = sLetter ) Begin        Function_Return True    End    Move "La letra no es coincidene con los numeros" to sMsg    Function_Return False    End_Function**/
38010>>>>>
38010>>>>>
38010>>>>>Function zDniLetterComprobation String sLetter String sNumber String ByRef sMsg Returns Boolean
38013>>>>>    String sValidationLeter sTrueLetter
38013>>>>>    Move "TRWAGMYFPDXBNJZSQVHLCKE" to sValidationLeter
38014>>>>>
38014>>>>>    
38014>>>>>    Move (Mid(sValidationLeter, 1 , (Mod(Integer(sNumber), 23) + 1))) to sTrueLetter
38015>>>>>    If (sTrueLetter = sLetter ) Begin
38017>>>>>        Function_Return True
38018>>>>>    End
38018>>>>>>
38018>>>>>    Move "La letra no es coincidene con los numeros" to sMsg
38019>>>>>    Function_Return False
38020>>>>>    
38020>>>>>End_Function
38021>>>
38021>>>Object oDummieDni is a cWebView
38023>>>    Set piWidth to 700
38024>>>    Set psCaption to "DummieDni"
38025>>>
38025>>>    // Your DDO structure will go here
38025>>>
38025>>>    Object oWebMainPanel is a cWebPanel
38027>>>        Set piColumnCount to 12
38028>>>        
38028>>>        // place controls here
38028>>>        // Your view will grow as controls are added
38028>>>        
38028>>>        Object oForm_Dni is a cWebForm
38030>>>            Set piColumnSpan to 0
38031>>>            Set psLabel to "introduzca DNI"
38032>>>        End_Object
38033>>>
38033>>>        Object oWebLabel_sMsg_Err is a cWebLabel
38035>>>            Set psCaption to ""
38036>>>            Set piColumnIndex to 0
38037>>>            Set piColumnSpan to 12
38038>>>        End_Object
38039>>>
38039>>>        Object oWebSpacer1 is a cWebSpacer
38041>>>            Set piColumnSpan to 12
38042>>>        End_Object
38043>>>
38043>>>        Object oValidationButton is a cWebButton
38045>>>            Set piColumnSpan to 6
38046>>>            Set psCaption to "Validar"
38047>>>            Set piColumnIndex to 3
38048>>>        
38048>>>            Procedure OnClick
38051>>>                Boolean bRet
38051>>>                String sDni sMsg
38051>>>                WebGet psValue of oForm_Dni to sDni
38052>>>                Get zDniValidation sDni (&sMsg) to bRet
38053>>>                
38053>>>                WebSet psBackgroundColor of oForm_Dni to "#ffffff"
38054>>>                WebSet psCaption of oWebLabel_sMsg_Err to ""
38055>>>                
38055>>>                If (bRet) Begin
38057>>>                    WebSet psBackgroundColor of oForm_Dni to "green"
38058>>>                    
38058>>>                End
38058>>>>
38058>>>                If (not (bRet)) Begin
38060>>>                    WebSet psBackgroundColor of oForm_Dni to "red"
38061>>>                    WebSet psCaption of oWebLabel_sMsg_Err to sMsg
38062>>>                End
38062>>>>
38062>>>                
38062>>>                
38062>>>            End_Procedure
38063>>>        End_Object
38064>>>        
38064>>>    End_Object 
38065>>>
38065>>>End_Object
38066>    Use ZoomAllStudents.wo
Including file: ZoomAllStudents.wo    (C:\DataFlex Projects\Centros\AppSrc\ZoomAllStudents.wo)
38066>>>// C:\DataFlex Projects\Centros\AppSrc\ZoomAllStudents.wo
38066>>>// Todos los estudiantes
38066>>>//
38066>>>
38066>>>Use cWebView.pkg
38066>>>Use cWebPanel.pkg
38066>>>Use cWebMenuGroup.pkg
38066>>>Use cWebMenuItem.pkg
38066>>>Use cWebForm.pkg
38066>>>Use cWebTabContainer.pkg
38066>>>Use cWebTabPage.pkg
38066>>>Use cWebCheckBox.pkg
38066>>>
38066>>>Use cCentrosDataDictionary.dd
Including file: cCentrosDataDictionary.dd    (C:\DataFlex Projects\Centros\DDSrc\cCentrosDataDictionary.dd)
38066>>>>>Use DataDict.pkg
38066>>>>>
38066>>>>>Open Centros
Including file: Centros.fd    (C:\DataFlex Projects\Centros\DDSrc\Centros.fd)
38068>>>>>Open Alumnos
Including file: Alumnos.fd    (C:\DataFlex Projects\Centros\DDSrc\Alumnos.fd)
38070>>>>>
38070>>>>>Class cCentrosDataDictionary is a DataDictionary
38071>>>>>    
38071>>>>>    Procedure Construct_Object
38073>>>>>        Forward Send Construct_Object
38075>>>>>        Set Main_File to Centros.File_Number
38076>>>>>
38076>>>>>        Set Add_Client_File to Alumnos.File_Number
38077>>>>>
38077>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
38078>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
38079>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
38080>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
38081>>>>>
38081>>>>>        Set Field_Mask_Type Field Centros.CodigoPostal to Mask_Numeric_Window
38082>>>>>        
38082>>>>>
38082>>>>>
38082>>>>>        Set Field_Mask_Type Field Centros.FechaCreacionRegistro to Mask_DateTime_Window
38083>>>>>        Set Field_Option Field Centros.FechaCreacionRegistro DD_NOENTER to True
38084>>>>>
38084>>>>>        Set Field_Mask_Type Field Centros.FechaUltimaModificacion to Mask_DateTime_Window
38085>>>>>        Set Field_Option Field Centros.FechaUltimaModificacion DD_NOENTER to True
38086>>>>>       
38086>>>>>         
38086>>>>>
38086>>>>>    End_Procedure
38087>>>>>
38087>>>>>    Procedure Field_Defaults
38089>>>>>         DateTime dtCurrentDateTime
38089>>>>>         
38089>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38090>>>>>       
38090>>>>>        Forward Send Field_Defaults
38092>>>>>        Set Field_Changed_Value Field Centros.FechaCreacionRegistro to  dtCurrentDateTime 
38093>>>>>        Set Field_Changed_Value Field Centros.FechaUltimaModificacion to  dtCurrentDateTime 
38094>>>>>        
38094>>>>>    End_Procedure
38095>>>>>    
38095>>>>>     Procedure Update
38097>>>>>        Forward Send Update
38099>>>>>        Move  (CurrentDateTime())  to Centros.FechaUltimaModificacion
38100>>>>>    End_Procedure
38101>>>>>
38101>>>>>
38101>>>>>End_Class
38102>>>Use cAlumnosDataDictionary.dd
Including file: cAlumnosDataDictionary.dd    (C:\DataFlex Projects\Centros\DDSrc\cAlumnosDataDictionary.dd)
38102>>>>>Use DataDict.pkg
38102>>>>>
38102>>>>>Use zEmailValidation.pkg
38102>>>>>Use zDniValidation.pkg
38102>>>>>Use zTelefonoiValidation.pkg
Including file: zTelefonoiValidation.pkg    (C:\DataFlex Projects\Centros\AppSrc\zTelefonoiValidation.pkg)
38102>>>>>>>Use cJsonHttpTransfer.pkg
Including file: cJsonHttpTransfer.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cJsonHttpTransfer.pkg)
38102>>>>>>>>>// DF JSON internet transfer class definitions.
38102>>>>>>>>>Use cHttpTransfer.pkg
Including file: cHttpTransfer.pkg    (C:\Program Files\DataFlex 25.0\Pkg\cHttpTransfer.pkg)
38102>>>>>>>>>>>Use VDFBase.pkg
38102>>>>>>>>>>>Use GlobalFunctionsProcedures.pkg
38102>>>>>>>>>>>
38102>>>>>>>>>>>External_Function WinAPI_HttpQueryInfo "HttpQueryInfoW" WinInet.dll ;    Handle hRequest ;    DWord dwInfoLevel ;    Pointer lpBuffer ;    Pointer lpdwBufferLength ;    Pointer lpdwIndex ;    Returns Integer
38103>>>>>>>>>>>
38103>>>>>>>>>>>/*BOOL InternetSetOptionW(  [in] HINTERNET hInternet,  [in] DWORD     dwOption,  [in] LPVOID    lpBuffer,  [in] DWORD     dwBufferLength);*/
38103>>>>>>>>>>>External_Function WinAPI_InternetSetOption "InternetSetOptionW" WinInet.dll ;    Handle hInternet ;    DWord dwOption ;    Pointer lpBuffer ;    DWord dwBufferLength ;    Returns Integer
38104>>>>>>>>>>>
38104>>>>>>>>>>>/*BOOL InternetQueryOptionW(  [in]      HINTERNET hInternet,  [in]      DWORD     dwOption,  [out]     LPVOID    lpBuffer,  [in, out] LPDWORD   lpdwBufferLength);*/
38104>>>>>>>>>>>External_Function WinAPI_InternetQueryOption "InternetQueryOptionW" WinInet.dll ;    Handle hInternet ;    DWord dwOption ;    Pointer lpBuffer ;    Pointer lpdwBufferLength ;    Returns Integer
38105>>>>>>>>>>>
38105>>>>>>>>>>>
38105>>>>>>>>>>>//  Available options for dwInfoLevel of WinAPI_HttpQueryInfo
38105>>>>>>>>>>>Define HTTP_QUERY_MIME_VERSION                for 0
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_TYPE                for 1
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_TRANSFER_ENCODING   for 2
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_ID                  for 3
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_DESCRIPTION         for 4
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_LENGTH              for 5
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_LANGUAGE            for 6
38105>>>>>>>>>>>Define HTTP_QUERY_ALLOW                       for 7
38105>>>>>>>>>>>Define HTTP_QUERY_PUBLIC                      for 8
38105>>>>>>>>>>>Define HTTP_QUERY_DATE                        for 9
38105>>>>>>>>>>>Define HTTP_QUERY_EXPIRES                     for 10
38105>>>>>>>>>>>Define HTTP_QUERY_LAST_MODIFIED               for 11
38105>>>>>>>>>>>Define HTTP_QUERY_MESSAGE_ID                  for 12
38105>>>>>>>>>>>Define HTTP_QUERY_URI                         for 13
38105>>>>>>>>>>>Define HTTP_QUERY_DERIVED_FROM                for 14
38105>>>>>>>>>>>Define HTTP_QUERY_COST                        for 15
38105>>>>>>>>>>>Define HTTP_QUERY_LINK                        for 16
38105>>>>>>>>>>>Define HTTP_QUERY_PRAGMA                      for 17
38105>>>>>>>>>>>Define HTTP_QUERY_VERSION                     for 18  // special: part of status line
38105>>>>>>>>>>>Define HTTP_QUERY_STATUS_CODE                 for 19  // special: part of status line
38105>>>>>>>>>>>Define HTTP_QUERY_STATUS_TEXT                 for 20  // special: part of status line
38105>>>>>>>>>>>Define HTTP_QUERY_RAW_HEADERS                 for 21  // special: all headers as ASCIIZ
38105>>>>>>>>>>>Define HTTP_QUERY_RAW_HEADERS_CRLF            for 22  // special: all headers
38105>>>>>>>>>>>Define HTTP_QUERY_CONNECTION                  for 23
38105>>>>>>>>>>>Define HTTP_QUERY_ACCEPT                      for 24
38105>>>>>>>>>>>Define HTTP_QUERY_ACCEPT_CHARSET              for 25
38105>>>>>>>>>>>Define HTTP_QUERY_ACCEPT_ENCODING             for 26
38105>>>>>>>>>>>Define HTTP_QUERY_ACCEPT_LANGUAGE             for 27
38105>>>>>>>>>>>Define HTTP_QUERY_AUTHORIZATION               for 28
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_ENCODING            for 29
38105>>>>>>>>>>>Define HTTP_QUERY_FORWARDED                   for 30
38105>>>>>>>>>>>Define HTTP_QUERY_FROM                        for 31
38105>>>>>>>>>>>Define HTTP_QUERY_IF_MODIFIED_SINCE           for 32
38105>>>>>>>>>>>Define HTTP_QUERY_LOCATION                    for 33
38105>>>>>>>>>>>Define HTTP_QUERY_ORIG_URI                    for 34
38105>>>>>>>>>>>Define HTTP_QUERY_REFERER                     for 35
38105>>>>>>>>>>>Define HTTP_QUERY_RETRY_AFTER                 for 36
38105>>>>>>>>>>>Define HTTP_QUERY_SERVER                      for 37
38105>>>>>>>>>>>Define HTTP_QUERY_TITLE                       for 38
38105>>>>>>>>>>>Define HTTP_QUERY_USER_AGENT                  for 39
38105>>>>>>>>>>>Define HTTP_QUERY_WWW_AUTHENTICATE            for 40
38105>>>>>>>>>>>Define HTTP_QUERY_PROXY_AUTHENTICATE          for 41
38105>>>>>>>>>>>Define HTTP_QUERY_ACCEPT_RANGES               for 42
38105>>>>>>>>>>>Define HTTP_QUERY_SET_COOKIE                  for 43
38105>>>>>>>>>>>Define HTTP_QUERY_COOKIE                      for 44
38105>>>>>>>>>>>Define HTTP_QUERY_REQUEST_METHOD              for 45  // special: GET/POST etc.
38105>>>>>>>>>>>Define HTTP_QUERY_REFRESH                     for 46
38105>>>>>>>>>>>Define HTTP_QUERY_CONTENT_DISPOSITION         for 47
38105>>>>>>>>>>>
38105>>>>>>>>>>>
38105>>>>>>>>>>>Class cHttpTransfer is a cBaseHttpTransfer
38106>>>>>>>>>>>    
38106>>>>>>>>>>>    Function HttpPostRequest String sFilePath String sData Integer bDataIsFile Returns Integer
38108>>>>>>>>>>>        Integer bStat
38108>>>>>>>>>>>        Get HttpPostAddrRequest sFilePath (AddressOf(sData)) (SizeOfString(sData)) bDataIsfile to bStat
38109>>>>>>>>>>>        Function_Return bStat
38110>>>>>>>>>>>    End_Function
38111>>>>>>>>>>>    
38111>>>>>>>>>>>    // This event is triggered from the runtime. It now uses UChar arrays as the data might 
38111>>>>>>>>>>>    // not be a valid string (it can be any binary data). It still calls the original event for 
38111>>>>>>>>>>>    // backwards compatibility.
38111>>>>>>>>>>>    Procedure OnDataReceivedUC String sContentType UChar[] ucData
38113>>>>>>>>>>>        Send OnDataReceived sContentType (UCharArrayToString(ucData))
38114>>>>>>>>>>>    End_Procedure
38115>>>>>>>>>>>    
38115>>>>>>>>>>>    // Only use this event if you know for sure the data is a string and make sure piBufferSize is
38115>>>>>>>>>>>    // smaller than the argument size.
38115>>>>>>>>>>>    Procedure OnDataReceived String sContentType String sData
38117>>>>>>>>>>>        
38117>>>>>>>>>>>    End_Procedure
38118>>>>>>>>>>>    
38118>>>>>>>>>>>    // Called just before the request is sent. Use this message to set options to the RequestHandle if nessecary.
38118>>>>>>>>>>>    Procedure OnPreSendRequest 
38120>>>>>>>>>>>        
38120>>>>>>>>>>>    End_Procedure
38121>>>>>>>>>>>    
38121>>>>>>>>>>>    Function HttpPutRequest String sFilePath String sData Integer bDataIsFile Returns Integer
38123>>>>>>>>>>>        Integer bStat
38123>>>>>>>>>>>        Get HttpPutAddrRequest sFilePath (AddressOf(sData)) (SizeOfString(sData)) bDataIsfile to bStat
38124>>>>>>>>>>>        Function_Return bStat
38125>>>>>>>>>>>    End_Function
38126>>>>>>>>>>>    
38126>>>>>>>>>>>    // Retrieve header information associated with the previous request.
38126>>>>>>>>>>>    Function QueryInfo DWord dwInfoLevel Returns String
38128>>>>>>>>>>>        Handle hRequestHandle
38128>>>>>>>>>>>        WString wResult
38128>>>>>>>>>>>        Integer iBufferSize iRes iVoid
38128>>>>>>>>>>>
38128>>>>>>>>>>>        Get RequestHandle to hRequestHandle
38129>>>>>>>>>>>        
38129>>>>>>>>>>>        If (hRequestHandle) Begin
38131>>>>>>>>>>>            Move 200 to iBufferSize
38132>>>>>>>>>>>            Move (Repeat(" ", iBufferSize)) to wResult
38133>>>>>>>>>>>            Move (WinAPI_HttpQueryInfo(hRequestHandle, dwInfoLevel, AddressOf(wResult), AddressOf(iBufferSize), 0)) to iRes
38134>>>>>>>>>>>            
38134>>>>>>>>>>>            If (not(iRes) and GetLastError() = 122) Begin //  Insufficient buffersize, retry with received iBufferSize value
38136>>>>>>>>>>>                Increment iBufferSize      
38137>>>>>>>>>>>                
38137>>>>>>>>>>>                Move (Repeat(" ", iBufferSize)) to wResult
38138>>>>>>>>>>>                Move (WinAPI_HttpQueryInfo(hRequestHandle, dwInfoLevel, AddressOf(wResult), AddressOf(iBufferSize), 0)) to iRes  
38139>>>>>>>>>>>            End
38139>>>>>>>>>>>>
38139>>>>>>>>>>>            
38139>>>>>>>>>>>            If (not(iRes)) Begin
38141>>>>>>>>>>>                Move (ShowLastError()) to iVoid
38142>>>>>>>>>>>            End
38142>>>>>>>>>>>>
38142>>>>>>>>>>>        End
38142>>>>>>>>>>>>
38142>>>>>>>>>>>        
38142>>>>>>>>>>>        Function_Return (CString(wResult))
38143>>>>>>>>>>>    End_Function
38144>>>>>>>>>>>    
38144>>>>>>>>>>>    // Returns the statustext returned by the previous request.
38144>>>>>>>>>>>    Function ResponseStatusText Returns String
38146>>>>>>>>>>>        String sStatus
38146>>>>>>>>>>>        
38146>>>>>>>>>>>        Get QueryInfo HTTP_QUERY_STATUS_TEXT to sStatus
38147>>>>>>>>>>>        
38147>>>>>>>>>>>        Function_Return sStatus
38148>>>>>>>>>>>    End_Function
38149>>>>>>>>>>>    
38149>>>>>>>>>>>End_Class
38150>>>>>>>>>Use cJsonObject.pkg
38150>>>>>>>>>Use GlobalFunctionsProcedures.pkg
38150>>>>>>>>>
38150>>>>>>>>>// these define the three characters that define BOM for utf8.
38150>>>>>>>>>// These serve no purpos and are rarely used. If used they must be removed
38150>>>>>>>>>Define C_BOM1 for |CI$EF
38150>>>>>>>>>Define C_BOM2 for |CI$BB
38150>>>>>>>>>Define C_BOM3 for |CI$BF
38150>>>>>>>>>
38150>>>>>>>>>
38150>>>>>>>>>
38150>>>>>>>>>// define JSON transfer status codes used by peJsonTransferStatus
38150>>>>>>>>>Enum_List
38150>>>>>>>>>    Define jtsOk                 // ok
38150>>>>>>>>>    Define jtsHttpRequestFailed  // the post/get http request returned an error
38150>>>>>>>>>    Define jtsInvalidContentType // response content type not JSON
38150>>>>>>>>>    Define jtsNotJson            // return value not JSON (could not load in object)
38150>>>>>>>>>    Define jtsError              // unspecified return error
38150>>>>>>>>>End_Enum_List
38150>>>>>>>>>
38150>>>>>>>>>
38150>>>>>>>>>Class cJsonHttpTransfer is a cHttpTransfer
38151>>>>>>>>>    
38151>>>>>>>>>    Procedure Construct_Object
38153>>>>>>>>>        Forward Send Construct_object
38155>>>>>>>>>        
38155>>>>>>>>>        Property String  psContentTypeSent "application/json; charset=utf-8"     // default content type for posted data
38156>>>>>>>>>        
38156>>>>>>>>>        Property Boolean pbClearHeaders      True         // should headers always be cleared after a post
38157>>>>>>>>>        
38157>>>>>>>>>        Property UChar[] pucDataReceived                 // maintained by object
38158>>>>>>>>>        
38158>>>>>>>>>        Property String  psContentTypeReceived ''         // content type received
38159>>>>>>>>>        
38159>>>>>>>>>        Property String  psJsonParseError ''              // Set if response JSON can't be parsed
38160>>>>>>>>>        
38160>>>>>>>>>        Property String  psContentTypeExpected 'application/json' // content type received - expected value should be contained in here.
38161>>>>>>>>>        
38161>>>>>>>>>        Property Integer peJsonTransferStatus jtsOk
38162>>>>>>>>>        
38162>>>>>>>>>        // if true, the http post does not happend and whatever was posted is just returned as a copy.
38162>>>>>>>>>        // Good for internal Testing
38162>>>>>>>>>        Property Boolean pbPostLoopTest False
38163>>>>>>>>>        
38163>>>>>>>>>        Set piBufferSize to -1  //  No chunking needed
38164>>>>>>>>>        Set psAcceptTypes to "application/json"
38165>>>>>>>>>    End_Procedure
38166>>>>>>>>>    
38166>>>>>>>>>    // private helper function. Convert data passed by pointer to an JSON document.
38166>>>>>>>>>    // return 0, if error
38166>>>>>>>>>    //
38166>>>>>>>>>    Function UCharDatatoJson UChar[] ucJson Returns Handle
38168>>>>>>>>>        Integer iVoid bOk
38168>>>>>>>>>        Handle hoJson
38168>>>>>>>>>        String sError
38168>>>>>>>>>        Get Create of Desktop (RefClass(cJsonObject)) to hoJson
38169>>>>>>>>>        Get ParseUTF8 of hoJson ucJson to bOk
38170>>>>>>>>>        If not bOk Begin
38172>>>>>>>>>            // store the JSON parse error info
38172>>>>>>>>>            Get psParseError of hoJson to sError
38173>>>>>>>>>            Set psJsonParseError to sError
38174>>>>>>>>>            Send Destroy of hoJson
38175>>>>>>>>>            Move 0 to hoJson
38176>>>>>>>>>        End
38176>>>>>>>>>>
38176>>>>>>>>>        Function_Return hoJson
38177>>>>>>>>>    End_Function
38178>>>>>>>>>    
38178>>>>>>>>>    // Clear pucDataReceived
38178>>>>>>>>>    Procedure ClearDataReceived
38180>>>>>>>>>        UChar[] ucEmpty
38181>>>>>>>>>        
38181>>>>>>>>>        Set pucDataReceived to ucEmpty
38182>>>>>>>>>        Set psJsonParseError to ''
38183>>>>>>>>>    End_Procedure
38184>>>>>>>>>    
38184>>>>>>>>>    // augment to release any memor
38184>>>>>>>>>    Procedure Destroy_Object
38186>>>>>>>>>        Send ClearDataReceived
38187>>>>>>>>>        Forward Send Destroy_object
38189>>>>>>>>>    End_Procedure
38190>>>>>>>>>    
38190>>>>>>>>>    // called during http transfer. Take passed data and append to pucDataReceived.
38190>>>>>>>>>    // If new transfer save contenttype.
38190>>>>>>>>>    Procedure OnDataReceivedUC String sContentType UChar[] ucData
38192>>>>>>>>>        UChar[] ucBuffer
38193>>>>>>>>>        Integer iDataLen
38193>>>>>>>>>        
38193>>>>>>>>>        Move (SizeOfArray(ucData)) to iDataLen
38194>>>>>>>>>        
38194>>>>>>>>>        If (iDataLen > 0) Begin
38196>>>>>>>>>            Get pucDataReceived to ucBuffer
38197>>>>>>>>>            If (SizeOfArray(ucBuffer) > 0) Begin
38199>>>>>>>>>                Set pucDataReceived to (AppendArray(ucBuffer, ucData))
38200>>>>>>>>>            End
38200>>>>>>>>>>
38200>>>>>>>>>            Else Begin
38201>>>>>>>>>                Set psContentTypeReceived to sContentType
38202>>>>>>>>>                
38202>>>>>>>>>                If (iDataLen > 3 and ucData[0]=C_BOM1 and ucData[1]=C_BOM2 and ucData[2]=C_BOM3) Begin
38204>>>>>>>>>                    Set pucDataReceived to (CopyArray(ucData, 3, iDataLen - 1))
38205>>>>>>>>>                End
38205>>>>>>>>>>
38205>>>>>>>>>                Else Begin
38206>>>>>>>>>                    Set pucDataReceived to ucData
38207>>>>>>>>>                End
38207>>>>>>>>>>
38207>>>>>>>>>            End
38207>>>>>>>>>>
38207>>>>>>>>>        End
38207>>>>>>>>>>
38207>>>>>>>>>    End_Procedure
38208>>>>>>>>>    
38208>>>>>>>>>    Function LoopDataBack UChar[] ucData Returns Boolean
38210>>>>>>>>>        Pointer pInData
38210>>>>>>>>>        Boolean bOk
38210>>>>>>>>>        
38210>>>>>>>>>        Set pucDataReceived to ucData
38211>>>>>>>>>        Set psContentTypeReceived to (psContentTypeExpected(Self))
38212>>>>>>>>>        
38212>>>>>>>>>        Function_Return True
38213>>>>>>>>>    End_Function
38214>>>>>>>>>    
38214>>>>>>>>>    
38214>>>>>>>>>    Function HttpVerbJsonAddrExec String sHost String sFilePath Pointer pJson Integer iLen String sVerb  Returns Boolean
38216>>>>>>>>>        Boolean bOk
38216>>>>>>>>>        Integer iError
38216>>>>>>>>>        String sContentType
38216>>>>>>>>>        
38216>>>>>>>>>        Send ClearDataReceived  // this should be zero, just in case it is not
38217>>>>>>>>>        Set psRemoteHost to sHost
38218>>>>>>>>>        
38218>>>>>>>>>        Get psContentTypeSent to sContentType
38219>>>>>>>>>        If (iLen > 0 and sContentType <> "") Begin
38221>>>>>>>>>            Get AddHeader "Content-Type" sContentType to bok
38222>>>>>>>>>        End
38222>>>>>>>>>>
38222>>>>>>>>>        Get HttpVerbAddrRequest sFilePath pJson iLen False sVerb to bOK
38223>>>>>>>>>        
38223>>>>>>>>>        // You need to clear headers between posts. If you need to set custom headers you should
38223>>>>>>>>>        // set pbClearHeaders to false and then manually send ClearHeaders and AddHeaders in your code
38223>>>>>>>>>        If (pbClearHeaders(Self)) ;            Send ClearHeaders
38226>>>>>>>>>        
38226>>>>>>>>>        
38226>>>>>>>>>        Function_Return bOk
38227>>>>>>>>>    End_Function
38228>>>>>>>>>    
38228>>>>>>>>>    // We assume but do not verify that the data in ucJson is actually UTF8 JSON
38228>>>>>>>>>    Function HttpVerbJsonUChar String sHost String sFilePath UChar[] ucJson String sVerb Returns UChar[]
38230>>>>>>>>>        Integer iLen
38230>>>>>>>>>        Boolean bOk
38230>>>>>>>>>        UChar[] ucJsonReceived
38231>>>>>>>>>        String sContentTypeReceived sContentTypeExpected
38231>>>>>>>>>        
38231>>>>>>>>>        Move (SizeOfArray(ucJson)) to iLen
38232>>>>>>>>>        
38232>>>>>>>>>        If (pbPostLoopTest(Self)) Begin
38234>>>>>>>>>            Get LoopDataBack ucJson to bOk
38235>>>>>>>>>        End
38235>>>>>>>>>>
38235>>>>>>>>>        Else Begin
38236>>>>>>>>>            Get HttpVerbJsonAddrExec sHost sFilePath (AddressOf(ucJson)) iLen sVerb to bOk
38237>>>>>>>>>        End
38237>>>>>>>>>>
38237>>>>>>>>>                
38237>>>>>>>>>        If bOk Begin
38239>>>>>>>>>            Set peJsonTransferStatus to jtsOk
38240>>>>>>>>>            Get pucDataReceived to ucJsonReceived
38241>>>>>>>>>            
38241>>>>>>>>>            If (SizeOfArray(ucJsonReceived) > 0) Begin
38243>>>>>>>>>                // we have data, check that the content type is ok. This is as far
38243>>>>>>>>>                // as we can go here.
38243>>>>>>>>>                Get psContentTypeReceived to sContentTypeReceived
38244>>>>>>>>>                Get psContentTypeExpected to sContentTypeExpected
38245>>>>>>>>>                // If contentType expected is empty, we allow anything
38245>>>>>>>>>                If (sContentTypeExpected<>"" and pos(lowercase(sContentTypeExpected),lowercase(sContentTypeReceived))=0) Begin
38247>>>>>>>>>                    Set peJsonTransferStatus to jtsInvalidContentType
38248>>>>>>>>>                End
38248>>>>>>>>>>
38248>>>>>>>>>            End
38248>>>>>>>>>>
38248>>>>>>>>>        End
38248>>>>>>>>>>
38248>>>>>>>>>        Else Begin
38249>>>>>>>>>            Set peJsonTransferStatus to jtsHttpRequestFailed
38250>>>>>>>>>        End
38250>>>>>>>>>>
38250>>>>>>>>>                
38250>>>>>>>>>        Function_Return ucJsonReceived
38251>>>>>>>>>    End_Function
38252>>>>>>>>>    
38252>>>>>>>>>    // Generic HTTP Request - it is passed the Verb. Used by all other http requests
38252>>>>>>>>>    Function HttpVerbJson  String sHost String sFilePath Handle  hoJsonRequest String sVerb Boolean ByRef bOk Returns Handle
38254>>>>>>>>>        UChar[] ucJsonRequest ucJsonResponse
38256>>>>>>>>>        Handle hoJsonResponse
38256>>>>>>>>>        Integer eStat
38256>>>>>>>>>        
38256>>>>>>>>>        If (hoJsonRequest<>0) Begin
38258>>>>>>>>>            Get StringifyUTF8 of hoJsonRequest to ucJsonRequest
38259>>>>>>>>>        End
38259>>>>>>>>>>
38259>>>>>>>>>        
38259>>>>>>>>>        Get HttpVerbJsonUChar sHost sFilePath ucJsonRequest sVerb to ucJsonResponse
38260>>>>>>>>>        
38260>>>>>>>>>        If (SizeOfArray(ucJsonResponse)) Begin
38262>>>>>>>>>            Get UCharDatatoJson ucJsonResponse to hoJsonResponse
38263>>>>>>>>>            If (hoJsonResponse=0) Begin
38265>>>>>>>>>                // this indicates that data was returned but it could not be loaded as Json
38265>>>>>>>>>                Set peJsonTransferStatus to jtsNotJson
38266>>>>>>>>>                // note bad data is still is ppDataReceived (might be useful for debugging)
38266>>>>>>>>>            End
38266>>>>>>>>>>
38266>>>>>>>>>        End
38266>>>>>>>>>>
38266>>>>>>>>>        
38266>>>>>>>>>        // return Ok status by reference
38266>>>>>>>>>        Get peJsonTransferStatus to eStat
38267>>>>>>>>>        Move (eStat=jtsOk) to bOk
38268>>>>>>>>>        
38268>>>>>>>>>        Function_Return hoJsonResponse
38269>>>>>>>>>    End_Function
38270>>>>>>>>>    
38270>>>>>>>>>    Function HttpPostJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
38272>>>>>>>>>        Handle hoJson
38272>>>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "POST" (&bOk) to hoJson
38273>>>>>>>>>        Function_Return hoJson
38274>>>>>>>>>    End_Function
38275>>>>>>>>>    
38275>>>>>>>>>    Function HttpGetJson String sHost String sFilePath Boolean ByRef bOk Returns Handle
38277>>>>>>>>>        Pointer pJson
38277>>>>>>>>>        Integer iVoid iLen
38277>>>>>>>>>        Handle hoJson
38277>>>>>>>>>        Get HttpVerbJson sHost sFilePath 0 "GET" (&bOk) to hoJson
38278>>>>>>>>>        Function_Return hoJson
38279>>>>>>>>>    End_Function
38280>>>>>>>>>    
38280>>>>>>>>>    Function HttpPutJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
38282>>>>>>>>>        Handle hoJson
38282>>>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "PUT" (&bOk) to hoJson
38283>>>>>>>>>        Function_Return hoJson
38284>>>>>>>>>    End_Function
38285>>>>>>>>>    
38285>>>>>>>>>    Function HttpDeleteJson String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
38287>>>>>>>>>        Handle hoJson
38287>>>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "DELETE" (&bOk) to hoJson
38288>>>>>>>>>        Function_Return hoJson
38289>>>>>>>>>    End_Function
38290>>>>>>>>>    
38290>>>>>>>>>    Function HttpPatchJson  String sHost String sFilePath Handle hoJsonRequest Boolean ByRef bOk Returns Handle
38292>>>>>>>>>        Handle hoJson
38292>>>>>>>>>        Get HttpVerbJson sHost sFilePath hoJsonRequest "PATCH" (&bOk) to hoJson
38293>>>>>>>>>        Function_Return hoJson
38294>>>>>>>>>    End_Function
38295>>>>>>>>>    
38295>>>>>>>>>    // After an Json xfer request this message can be sent to display an error message if one occurred.
38295>>>>>>>>>    // Normally you would first check peJsonTransferStatus to see if it is not jtsOk. If not, send
38295>>>>>>>>>    // LastError to see the error
38295>>>>>>>>>    
38295>>>>>>>>>    // return last JSON transfer error text
38295>>>>>>>>>    Function TransferErrorDescription Returns String
38297>>>>>>>>>        String  sError sJsonError
38297>>>>>>>>>        Integer eJsonTransferStatus
38297>>>>>>>>>        Get peJsonTransferStatus to eJsonTransferStatus
38298>>>>>>>>>        Get psJsonParseError to sJsonError
38299>>>>>>>>>        Case Begin
38299>>>>>>>>>            Case (eJsonTransferStatus=jtsOk) ;                Move '' to sError
38302>>>>>>>>>            Case (eJsonTransferStatus=jtsHttpRequestFailed) ;                Move C_$HttpRequestFailed to sError
38306>>>>>>>>>            Case (eJsonTransferStatus=jtsInvalidContentType) ;                Move (SFormat(C_$InvalidContentTypeReceived,psContentTypeReceived(Self))) to sError
38310>>>>>>>>>            Case (eJsonTransferStatus=jtsNotJson) ;                Move (C_$ReceivedDataNotInJsonFormat * sJsonError) to sError
38314>>>>>>>>>            Case Else ;                Move C_$ReceivedDataIsBad to sError
38316>>>>>>>>>        Case End
38316>>>>>>>>>        Function_Return sError
38317>>>>>>>>>    End_Function
38318>>>>>>>>>    
38318>>>>>>>>>    // can be send to raise an error.
38318>>>>>>>>>    Procedure LastError
38320>>>>>>>>>        Integer eJsonTransferStatus
38320>>>>>>>>>        String sError
38320>>>>>>>>>        
38320>>>>>>>>>        Get peJsonTransferStatus to eJsonTransferStatus
38321>>>>>>>>>        If (eJsonTransferStatus<>jtsOk) Begin
38323>>>>>>>>>            Get TransferErrorDescription to sError
38324>>>>>>>>>            Error DFERR_JSON_HTTP sError
38325>>>>>>>>>>
38325>>>>>>>>>        End
38325>>>>>>>>>>
38325>>>>>>>>>    End_Procedure
38326>>>>>>>>>    
38326>>>>>>>>>    
38326>>>>>>>>>End_Class
38327>>>>>>>
38327>>>>>>>
38327>>>>>>>Function zTelefonoValidation Boolean bUseApi String sPrefijo String sTelefono  String ByRef sMsg Returns Boolean
38330>>>>>>>    
38330>>>>>>>     Boolean bRet
38330>>>>>>>     
38330>>>>>>>     
38330>>>>>>>     Get zNumeroCorrecto sTelefono (&sMsg) to bRet
38331>>>>>>>     If (not(bRet)) Function_Return False 
38334>>>>>>>     If (bUseApi) Get zValidarConApi sTelefono sPrefijo (&sMsg) to bRet
38337>>>>>>>     If (not(bRet)) Function_Return False
38340>>>>>>>    Function_Return True
38341>>>>>>>End_Function
38342>>>>>>>
38342>>>>>>>
38342>>>>>>>
38342>>>>>>>Function zNumeroCorrecto String sTelefono String ByRef sMsg Returns Boolean
38345>>>>>>>    String[] aRet
38346>>>>>>>    Object oTelefonopattern is a cRegEx
38348>>>>>>>        Set psExpression to "^(?:[-\s])?\d(?:[\d\s-]*\d)?(?:[-\s])?$"
38349>>>>>>>    End_Object
38350>>>>>>>    Get MatchAll of oTelefonopattern (sTelefono) to aRet
38351>>>>>>>        If (SizeOfArray(aRet) = 1) Begin
38353>>>>>>>        Function_Return True
38354>>>>>>>        End
38354>>>>>>>>
38354>>>>>>>    
38354>>>>>>>    Move "Porfavor Introduzca un formato de Telefono valido" to sMsg
38355>>>>>>>    Function_Return False    
38356>>>>>>>End_Function 
38357>>>>>>>
38357>>>>>>>Function zValidarConApi String sTelefono String sPrefijo String ByRef sMsg Returns Boolean
38360>>>>>>>    
38360>>>>>>>    Handle hoJsonReceived hoHttp
38360>>>>>>>    Boolean bOk bIsNull bRet
38360>>>>>>>    String  sNum sUrl
38360>>>>>>>     
38360>>>>>>>    Move (sPrefijo + sTelefono) to sNum
38361>>>>>>>   
38361>>>>>>>    Get Create (RefClass(cJsonHttpTransfer)) to hoHttp
38362>>>>>>>    Move False to bRet
38363>>>>>>>    
38363>>>>>>>    Get HttpGetJson of hohttp ("phonevalidation.abstractapi.com") ("/v1/?api_key=713383f7f21e45b1ac4054a472e00971&phone=" + sNum) (&bOk) to hoJsonReceived
38364>>>>>>>
38364>>>>>>>
38364>>>>>>>    If (bOk = True and ResponseStatusCode(hohttp) = 200 and hoJsonReceived <> 0) Begin
38366>>>>>>>        
38366>>>>>>>        If (HasMember(hoJsonReceived,"valid"))  Begin
38368>>>>>>>            Get IsMemberOfJsonType of hoJsonReceived "valid" jsonTypeNull  to bIsNull
38369>>>>>>>            If bIsNull  Move False to bRet
38372>>>>>>>            Else Move (MemberValue(hoJsonReceived,"valid")) to bRet
38374>>>>>>>        End
38374>>>>>>>>
38374>>>>>>>    End
38374>>>>>>>>
38374>>>>>>>    Send Destroy of hohttp
38375>>>>>>>    If (not(bRet)) Move "Fallo validación API" to sMsg
38378>>>>>>>    Function_Return bRet
38379>>>>>>>End_Function
38380>>>>>>>    
38380>>>>>>>    
38380>>>>>
38380>>>>>Open Alumnos
38382>>>>>Open Centros
38384>>>>>
38384>>>>>Register_Function zValidateErr_StudentEmail Integer iField Returns Boolean
38384>>>>>Register_Function zValidateErr_StudentDni Integer iField Returns Boolean
38384>>>>>Register_Function zValidateErr_StudentTelefono Integer iField Returns Boolean
38384>>>>>
38384>>>>>Object oGender is a DescriptionValidationTable
38386>>>>>    Procedure Fill_List
38389>>>>>        Forward Send Fill_List
38391>>>>>        Send Add_Table_Value "H" "Hombre"
38392>>>>>        Send Add_Table_Value "M" "Mujer"
38393>>>>>        Send Add_Table_Value "N" "Prefiero no responder"
38394>>>>>        Send Add_Table_Value "O" "Otro"
38395>>>>>    End_Procedure
38396>>>>>End_Object
38397>>>>>
38397>>>>>
38397>>>>>
38397>>>>>
38397>>>>>Class cAlumnosDataDictionary is a DataDictionary
38398>>>>>    
38398>>>>>    Procedure Construct_Object
38400>>>>>        Forward Send Construct_Object
38402>>>>>        Set Main_File to Alumnos.File_Number
38403>>>>>
38403>>>>>        Set Add_Server_File to Centros.File_Number
38404>>>>>
38404>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_NOPUT to True
38405>>>>>        Set Foreign_Field_Option DD_KEYFIELD DD_FINDREQ to True
38406>>>>>        Set Foreign_Field_Option DD_INDEXFIELD DD_NOPUT to True
38407>>>>>        Set Foreign_Field_Option DD_DEFAULT DD_DISPLAYONLY to True
38408>>>>>
38408>>>>>        Set Field_Option Field Alumnos.AlumnosId DD_REQUIRED to True
38409>>>>>
38409>>>>>        Set Field_Class_Name Field Alumnos.Sexo to "Combo"
38410>>>>>        Set Field_Value_Table Field Alumnos.Sexo to oGender
38411>>>>>
38411>>>>>        Set Field_Mask_Type Field Alumnos.CodigoPostal to Mask_Numeric_Window
38412>>>>>        
38412>>>>>
38412>>>>>
38412>>>>>        Set Field_Mask_Type Field Alumnos.FechaCreacionRegistro to Mask_DateTime_Window
38413>>>>>        Set Field_Option Field Alumnos.FechaCreacionRegistro DD_NOENTER to True
38414>>>>>
38414>>>>>        Set Field_Mask_Type Field Alumnos.FechaUltimaModificacion to Mask_DateTime_Window
38415>>>>>        Set Field_Option Field Alumnos.FechaUltimaModificacion DD_NOENTER to True
38416>>>>>        
38416>>>>>        Set Field_Validate_msg Field Alumnos.Email to get_zValidateErr_StudentEmail
38417>>>>>        Set Field_Validate_msg Field Alumnos.Dni to get_zValidateErr_StudentDni
38418>>>>>        Set Field_Validate_msg Field Alumnos.NumeroTelefono to get_zValidateErr_StudentTelefono
38419>>>>>
38419>>>>>    End_Procedure
38420>>>>>
38420>>>>>
38420>>>>>
38420>>>>>    Function zValidateErr_StudentDni Integer iField Returns Boolean
38422>>>>>        Boolean bret
38422>>>>>        String sDni sMsg
38422>>>>>        Get Field_Current_Value Field Alumnos.Dni to sDni
38423>>>>>        Get zDniValidation sDni (&sMsg) to bret
38424>>>>>        If (not (bret)) Begin
38426>>>>>                Send Data_set_error iField DFERR_OPERATOR sMsg
38427>>>>>        Function_Return True        
38428>>>>>        End
38428>>>>>>
38428>>>>>        Function_Return False
38429>>>>>    End_Function
38430>>>>>
38430>>>>>
38430>>>>>    Function zValidateErr_StudentEmail Integer iField Returns Boolean
38432>>>>>        Boolean bret
38432>>>>>        String sEmail sMsg
38432>>>>>        Get Field_Current_Value Field Alumnos.Email to sEmail
38433>>>>>        Get zValidarEmail sEmail (&sMsg) to bret
38434>>>>>        If (not (bret)) Begin
38436>>>>>                Send Data_set_error iField DFERR_OPERATOR sMsg
38437>>>>>        Function_Return True        
38438>>>>>        End
38438>>>>>>
38438>>>>>        Function_Return False
38439>>>>>    End_Function
38440>>>>>                
38440>>>>>
38440>>>>>    Function zValidateErr_StudentTelefono Integer iField Returns Boolean
38442>>>>>        Boolean bret
38442>>>>>        String sPrefijo sTelefono sMsg
38442>>>>>        Get Field_Current_Value Field Alumnos.NumeroTelefono to sTelefono
38443>>>>>        Get Field_Current_Value Field Alumnos.PrefijoTlfn to sPrefijo
38444>>>>>        Get zTelefonoValidation True sPrefijo sTelefono (&sMsg) to bret
38445>>>>>        If (not (bret)) Begin
38447>>>>>                Send Data_set_error iField DFERR_OPERATOR sMsg
38448>>>>>        Function_Return True        
38449>>>>>        End
38449>>>>>>
38449>>>>>        Function_Return False
38450>>>>>    End_Function            
38451>>>>>  
38451>>>>>  
38451>>>>>    Procedure Field_Defaults
38453>>>>>         DateTime dtCurrentDateTime
38453>>>>>         
38453>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38454>>>>>       
38454>>>>>        Forward Send Field_Defaults
38456>>>>>        Set Field_Changed_Value Field Alumnos.FechaCreacionRegistro to  dtCurrentDateTime
38457>>>>>        Set Field_Changed_Value Field Alumnos.FechaUltimaModificacion to  dtCurrentDateTime 
38458>>>>>    End_Procedure
38459>>>>>
38459>>>>>    Procedure Update
38461>>>>>        Forward Send Update
38463>>>>>        
38463>>>>>         DateTime dtCurrentDateTime
38463>>>>>         
38463>>>>>         Move (CurrentDateTime()) to dtCurrentDateTime
38464>>>>>       
38464>>>>>        Set Field_Changed_Value Field Alumnos.FechaUltimaModificacion to  dtCurrentDateTime
38465>>>>>        
38465>>>>>    End_Procedure
38466>>>>>
38466>>>>>
38466>>>>>End_Class
38467>>>Use cWebCombo.pkg
38467>>>
38467>>>
38467>>>Object oZoomAllStudents is a cWebView
38469>>>    Set piColumnCount to 12
38470>>>    Set psCaption to "Todos los estudiantes"
38471>>>    Set peWebViewStyle to wvsDrilldown
38472>>>    Set peViewType to vtZoom
38473>>>    Set pbShowCaption to False
38474>>>    Set Verify_Save_Msg to 0
38475>>>    Set piMaxWidth to 1024
38476>>>
38476>>>    Object oCentros_DD is a cCentrosDataDictionary
38478>>>    End_Object 
38479>>>
38479>>>    Object oAlumnos_DD is a cAlumnosDataDictionary
38481>>>        Set DDO_Server To oCentros_DD
38482>>>    End_Object 
38483>>>
38483>>>    Set Main_DD To oAlumnos_DD
38484>>>    Set Server  To oAlumnos_DD
38485>>>
38485>>>
38485>>>    Object oWebMainPanel is a cWebPanel
38487>>>        Set piColumnCount to 12
38488>>>        WebSetResponsive piColumnCount rmMobile to 4
38489>>>
38489>>>        Object oAlumnosNombre is a cWebForm
38491>>>            Entry_Item Alumnos.Nombre
38492>>>            Set piColumnSpan to 6
38493>>>            Set piColumnIndex to 0
38494>>>            Set peLabelPosition to lpTop
38495>>>            Set psLabel to "Nombre"
38496>>>        End_Object 
38497>>>
38497>>>        Object oAlumnosApellidos is a cWebForm
38499>>>            Entry_Item Alumnos.Apellidos
38500>>>            Set piColumnSpan to 6
38501>>>            Set piColumnIndex to 6
38502>>>            Set peLabelPosition to lpTop
38503>>>            Set psLabel to "Apellidos"
38504>>>        End_Object 
38505>>>
38505>>>        Object oWebTabContainer is a cWebTabContainer
38507>>>            Set pbFillHeight to True
38508>>>            Set piColumnSpan to 12
38509>>>            Set pbShowLabel to False
38510>>>
38510>>>            Object oPage1 is a cWebTabPage
38512>>>                Set piColumnCount to 12
38513>>>                Set psCaption to "información Personal"
38514>>>
38514>>>                Object oAlumnoPrefijoTlfn is a cWebCombo
38516>>>                    Entry_Item Alumnos.PrefijoTlfn
38517>>>                    Set psLabel to "Prefijo"
38518>>>                    Set piColumnIndex to 0
38519>>>                    
38519>>>                    
38519>>>                    Set pbServerOnChange to True
38520>>>                    Set peLabelPosition to lpTop
38521>>>                    Set piColumnSpan to 2
38522>>>                    
38522>>>                    String[][] aResultsPrefijosPaises
38522>>>
38522>>>                    Procedure OnFill
38525>>>                    Integer inumPaises i
38525>>>                        Forward Send OnFill
38527>>>                        
38527>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT PrefijoTlfn, ISO3                            FROM Centros.dbo.Country;" to aResultsPrefijosPaises
38528>>>                            
38528>>>                        Move (SizeOfArray(aResultsPrefijosPaises)) to inumPaises    
38529>>>                        If (not(Err)) Begin
38531>>>                             For i from 0 to (inumPaises - 1)
38537>>>>
38537>>>                                Send AddComboItem aResultsPrefijosPaises[i][0] (aResultsPrefijosPaises[i][1] + "(" + aResultsPrefijosPaises[i][0] + ")")
38538>>>                             Loop
38539>>>>
38539>>>                        End
38539>>>>
38539>>>                        
38539>>>                    End_Procedure 
38540>>>                End_Object
38541>>>                WebSetResponsive piColumnCount rmMobile to 4
38542>>>
38542>>>                Object oAlumnosNumeroTelefono is a cWebForm
38544>>>                    Entry_Item Alumnos.NumeroTelefono
38545>>>                    Set piColumnSpan to 3
38546>>>                    Set piColumnIndex to 2
38547>>>                    Set peLabelPosition to lpTop
38548>>>                    Set psLabel to "Numero Telefono"
38549>>>                End_Object 
38550>>>
38550>>>                Object oAlumnosDni is a cWebForm
38552>>>                    Entry_Item Alumnos.Dni
38553>>>                    Set piColumnSpan to 2
38554>>>                    Set piColumnIndex to 5
38555>>>                    Set peLabelPosition to lpTop
38556>>>                    Set psLabel to "Dni"
38557>>>                End_Object 
38558>>>
38558>>>                Object oAlumnosSexo is a cWebCombo
38560>>>                    Entry_Item Alumnos.Sexo
38561>>>                    Set piColumnSpan to 3
38562>>>                    Set piColumnIndex to 8
38563>>>                    Set psCaption to "Sexo"
38564>>>                    Set pbShowLabel to True
38565>>>                    Set peLabelPosition to lpTop
38566>>>                    Set psLabel to "Género"
38567>>>                End_Object 
38568>>>
38568>>>                Object oAlumnosEmail is a cWebForm
38570>>>             
38570>>>                    Entry_Item Alumnos.Email
38571>>>                    Set piColumnSpan to 12
38572>>>                    Set piColumnIndex to 0
38573>>>                    Set peLabelPosition to lpTop
38574>>>                    Set psLabel to "Email"
38575>>>                End_Object 
38576>>>            End_Object 
38577>>>
38577>>>            Object oPage2 is a cWebTabPage
38579>>>                Set piColumnCount to 12
38580>>>                Set psCaption to "Ubicación"
38581>>>                WebSetResponsive piColumnCount rmMobile to 4
38582>>>
38582>>>                Object oAlumnosPais is a cWebCombo
38584>>>                    Entry_Item Alumnos.Pais
38585>>>                    Set piColumnSpan to 3
38586>>>                    Set piColumnIndex to 0
38587>>>                    Set peLabelPosition to lpTop
38588>>>                    Set psLabel to "Pais"
38589>>>                    
38589>>>                    Set pbServerOnChange to True
38590>>>                    
38590>>>                    String[][] aResultsPaises
38590>>>
38590>>>                    Procedure OnFill
38593>>>                    Integer inumPaises i
38593>>>                        Forward Send OnFill
38595>>>                        
38595>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT id, Nombre                            FROM Centros.dbo.Country;" to aResultsPaises
38596>>>                            
38596>>>                        Move (SizeOfArray(aResultsPaises[0])) to inumPaises    
38597>>>                        If (not(Err)) Begin
38599>>>                             For i from 0 to (inumPaises - 1)
38605>>>>
38605>>>                                Send AddComboItem aResultsPaises[i][0] aResultsPaises[i][1] 
38606>>>                             Loop
38607>>>>
38607>>>                        End
38607>>>>
38607>>>                     
38607>>>                        
38607>>>                        
38607>>>                    End_Procedure
38608>>>
38608>>>                    Procedure OnChange String sNewValue String sOldValue
38611>>>                        Forward Send OnChange sNewValue sOldValue
38613>>>                        WebSet psValue of oAlumnosComunidadAutonoma to ""
38614>>>                        WebSet psValue of oAlumnosLocalidad to ""
38615>>>                       Send Refill of oAlumnosComunidadAutonoma 
38616>>>                    End_Procedure
38617>>>
38617>>>                    
38617>>>                    
38617>>>
38617>>>
38617>>>                End_Object 
38618>>>
38618>>>                Object oAlumnosComunidadAutonoma is a cWebCombo
38620>>>                    Entry_Item Alumnos.ComunidadAutonoma
38621>>>                    Set piColumnSpan to 3
38622>>>                    Set piColumnIndex to 4
38623>>>                    Set peLabelPosition to lpTop
38624>>>                    Set psLabel to "Comunidad Autonoma"
38625>>>                    Set pbServerOnChange to True
38626>>>                    
38626>>>                    
38626>>>                    Procedure OnFill
38629>>>                        Forward Send OnFill
38631>>>                        String  sPaisElegido sSQL
38631>>>                        Integer  inumComunidadAutonoma  i
38631>>>                        String[][]  aResults
38632>>>                 
38632>>>                        WebGet psValue of oAlumnosPais to sPaisElegido                   
38633>>>                        If (sPaisElegido = "") Procedure_Return
38636>>>                        Move ("SELECT S.id AS ComunidadAutonomaId, S.Nombre AS ComunidadAutonoma FROM Centros.dbo.State S WHERE S.CountryId = '" + sPaisElegido + "';") to sSQL 
38637>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38638>>>                                                
38638>>>                        If (not(Err)) Begin
38640>>>                            Move (SizeOfArray(aResults)) to inumComunidadAutonoma    
38641>>>                            For i from 0 to (inumComunidadAutonoma - 1)
38647>>>>
38647>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38648>>>                            Loop
38649>>>>
38649>>>                        End                        
38649>>>>
38649>>>                    End_Procedure
38650>>>                    
38650>>>                    Procedure OnChange String sNewValue String sOldValue
38653>>>                        Forward Send OnChange sNewValue sOldValue
38655>>>                        Send Refill of oAlumnosLocalidad 
38656>>>                        WebSet psValue of oAlumnosLocalidad to ""
38657>>>                    End_Procedure    
38658>>>                    
38658>>>                End_Object 
38659>>>
38659>>>                Object oAlumnosLocalidad is a cWebCombo
38661>>>                    Entry_Item Alumnos.Localidad
38662>>>                    Set piColumnSpan to 4
38663>>>                    Set piColumnIndex to 8
38664>>>                    Set peLabelPosition to lpTop
38665>>>                    Set psLabel to "Localidad"
38666>>>                    
38666>>>                    Procedure OnFill
38669>>>                        Forward Send OnFill
38671>>>                        String  sComunidadAutonomaElegida sSQL
38671>>>                        Integer  inumProvincia  i
38671>>>                        String[][]  aResults
38672>>>                 
38672>>>                        WebGet psValue of oAlumnosComunidadAutonoma to sComunidadAutonomaElegida                   
38673>>>                        If (sComunidadAutonomaElegida = "") Procedure_Return
38676>>>                        Move ("SELECT P.id AS ProvinciaId, P.Nombre AS Provincia FROM Centros.dbo.Province P WHERE P.StateId = '" + sComunidadAutonomaElegida + "';") to sSQL 
38677>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
38678>>>                                                
38678>>>                        If (not(Err)) Begin
38680>>>                            Move (SizeOfArray(aResults)) to inumProvincia    
38681>>>                            For i from 0 to (inumProvincia - 1)
38687>>>>
38687>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
38688>>>                            Loop
38689>>>>
38689>>>                        End                        
38689>>>>
38689>>>                    End_Procedure
38690>>>                    
38690>>>                    
38690>>>                End_Object 
38691>>>
38691>>>                Object oAlumnosDirreccion is a cWebForm
38693>>>                    Entry_Item Alumnos.Dirreccion
38694>>>                    Set piColumnSpan to 7
38695>>>                    Set piColumnIndex to 0
38696>>>                    Set peLabelPosition to lpTop
38697>>>                    Set psLabel to "Dirreccion"
38698>>>                End_Object 
38699>>>
38699>>>                Object oAlumnosCodigoPostal is a cWebForm
38701>>>                    Entry_Item Alumnos.CodigoPostal
38702>>>                    Set piColumnSpan to 2
38703>>>                    Set piColumnIndex to 8
38704>>>                    Set peLabelPosition to lpTop
38705>>>                    Set psLabel to "Codigo Postal"
38706>>>                End_Object 
38707>>>
38707>>>                Object oCentrosId is a cWebForm
38709>>>                    Entry_Item Centros.Id
38710>>>                    Set piColumnSpan to 2
38711>>>                    Set piColumnIndex to 10
38712>>>                    Set peLabelPosition to lpTop
38713>>>                    Set psLabel to "id del Centro "
38714>>>                    Set pbPromptButton to True
38715>>>
38715>>>// ToDo: Fill in the from-child parent Select view object name for navigate forward
38715>>>                    WebRegisterPath ntNavigateForward oSelectCentro
38721>>>
38721>>>                    Procedure OnPrompt
38724>>>                        Send NavigatePath
38725>>>                        
38725>>>                        
38725>>>                        
38725>>>                    End_Procedure
38726>>>                End_Object 
38727>>>            End_Object 
38728>>>
38728>>>            Object oPage3 is a cWebTabPage
38730>>>                Set piColumnCount to 12
38731>>>                Set psCaption to "Registros"
38732>>>                WebSetResponsive piColumnCount rmMobile to 4
38733>>>
38733>>>                Object oAlumnosFechaCreacionRegistro is a cWebForm
38735>>>                    Entry_Item Alumnos.FechaCreacionRegistro
38736>>>                    Set piColumnSpan to 3
38737>>>                    Set piColumnIndex to 0
38738>>>                    Set peLabelPosition to lpTop
38739>>>                    Set psLabel to "Fecha de creacion del registro"
38740>>>                End_Object 
38741>>>
38741>>>                Object oAlumnosFechaUltimaModificacion is a cWebForm
38743>>>                    Entry_Item Alumnos.FechaUltimaModificacion
38744>>>                    Set piColumnSpan to 3
38745>>>                    Set piColumnIndex to 3
38746>>>                    Set peLabelPosition to lpTop
38747>>>                    Set psLabel to "Fecha ultima modificacion"
38748>>>                End_Object 
38749>>>            End_Object 
38750>>>        End_Object 
38751>>>    End_Object 
38752>>>
38752>>>    Object oActionGroup is a cWebMenuGroup
38754>>>
38754>>>        Object oSaveBtn is a cWebMenuItem
38756>>>            Set psCSSClass to "WebSaveMenuItem"
38757>>>            Set psCaption to "Save"
38758>>>
38758>>>            Procedure OnClick
38761>>>                Send Request_Save
38762>>>            End_Procedure
38763>>>
38763>>>        End_Object 
38764>>>
38764>>>        Object oEditBtn is a cWebMenuItem
38766>>>            Set psCSSClass to "WebEditMenuItem"
38767>>>            Set psCaption to "Edit"
38768>>>            Procedure OnClick
38771>>>                Send ChangeEditMode True
38772>>>                Send SetActionButtons
38773>>>            End_Procedure
38774>>>
38774>>>        End_Object 
38775>>>
38775>>>        Object oDeleteBtn is a cWebMenuItem
38777>>>            Set psCSSClass to "WebDeleteMenuItem"
38778>>>            Set psCaption to "Delete"
38779>>>            Set peActionDisplay to adMenu
38780>>>
38780>>>            Procedure OnClick
38783>>>                Send Request_Delete
38784>>>            End_Procedure
38785>>>
38785>>>        End_Object 
38786>>>
38786>>>        Object oCancelChangesBtn is a cWebMenuItem
38788>>>            Set psCSSClass to "WebIcon_Refresh"
38789>>>            Set psCaption to "Clear Changes"
38790>>>            Set peActionDisplay to adMenu
38791>>>            Procedure OnClick
38794>>>                Send RefreshRecord
38795>>>            End_Procedure
38796>>>
38796>>>        End_Object 
38797>>>    End_Object 
38798>>>
38798>>>    Procedure SetActionButtons
38801>>>        tWebNavigateData NavigateData
38801>>>        tWebNavigateData NavigateData
38801>>>        Boolean bHasRecord
38801>>>        Handle hoDD
38801>>>
38801>>>        Get Server to hoDD
38802>>>        Get GetNavigateData to NavigateData
38803>>>        Get HasRecord of hoDD to bHasRecord
38804>>>
38804>>>        // let's hide all buttons and then Show the ones we want
38804>>>        WebSet pbRender of oEditBtn to False
38805>>>        WebSet pbRender of oSaveBtn to False
38806>>>        WebSet pbRender of oCancelChangesBtn to False
38807>>>        WebSet pbRender of oDeleteBtn to False
38808>>>
38808>>>        If (NavigateData.bReadOnly) Begin
38810>>>            WebSet pbRender of oEditBtn to True
38811>>>        End
38811>>>>
38811>>>        Else Begin
38812>>>            WebSet pbRender of oSaveBtn to True
38813>>>            WebSet pbRender of oCancelChangesBtn to True
38814>>>            WebSet pbRender of oDeleteBtn to bHasRecord
38815>>>        End
38815>>>>
38815>>>    End_Procedure
38816>>>
38816>>>    Procedure OnViewSaved Handle hoServer Boolean bChanged
38819>>>        // Close after save
38819>>>        Send NavigateClose Self
38820>>>    End_Procedure
38821>>>
38821>>>    // this will close the view after a delete
38821>>>    Procedure OnViewDeleted Handle hoDDO
38824>>>        Send NavigateClose Self
38825>>>    End_Procedure
38826>>>
38826>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
38829>>>        Case Begin
38829>>>            Case (NavigateData.eNavigateType = nfFromMain)
38831>>>                // If from main, this is a propbably a main file Select to Zoom.
38831>>>                Case Break
38832>>>
38832>>>            Case (NavigateData.eNavigateType = nfFromParent)
38835>>>                // If from parent, this is a constrained drill down.
38835>>>                Case Break
38836>>>
38836>>>            Case (NavigateData.eNavigateType = nfFromChild)
38839>>>                // If from child, this is a probably a parent Zoom from a Zoom.
38839>>>                Case Break
38840>>>
38840>>>            Case Else // must be nfUndefined
38840>>>
38840>>>        Case End
38840>>>
38840>>>        Send SetActionButtons
38841>>>
38841>>>    End_Procedure
38842>>>
38842>>>End_Object 
38843>    Use SelectStudents.wo
Including file: SelectStudents.wo    (C:\DataFlex Projects\Centros\AppSrc\SelectStudents.wo)
38843>>>// C:\DataFlex Projects\Centros\AppSrc\SelectStudents.wo
38843>>>// Students
38843>>>//
38843>>>
38843>>>Use cWebView.pkg
38843>>>Use cWebList.pkg
38843>>>Use cWebMenuGroup.pkg
38843>>>Use cWebMenuItem.pkg
38843>>>Use cWebColumnButton.pkg
38843>>>Use cWebColumn.pkg
38843>>>Use ZoomAllStudents.wo
38843>>>
38843>>>Use cCentrosDataDictionary.dd
38843>>>Use cAlumnosDataDictionary.dd
38843>>>
38843>>>Object oSelectStudents is a cWebView
38845>>>    Set psCaption to "Students"
38846>>>    Set peWebViewStyle to wvsDrilldown
38847>>>    Set peViewType to vtSelect
38848>>>    Set piColumnCount to 12
38849>>>    Set pbShowCaption to False
38850>>>    Set piMaxWidth to 1024
38851>>>
38851>>>    Object oCentros_DD is a cCentrosDataDictionary
38853>>>    End_Object 
38854>>>
38854>>>    Object oAlumnos_DD is a cAlumnosDataDictionary
38856>>>        Set DDO_Server To oCentros_DD
38857>>>    End_Object 
38858>>>
38858>>>    Set Main_DD To oAlumnos_DD
38859>>>    Set Server  To oAlumnos_DD
38860>>>
38860>>>
38860>>>    Object oList is a cWebList
38862>>>        Set piColumnSpan to 0
38863>>>        Set psCSSClass to "MobileList"
38864>>>        Set pbServerOnRowClick to True
38865>>>        Set pbFillHeight to True
38866>>>        Set pbShowHeader to False
38867>>>        Set piSortColumn to 0
38868>>>
38868>>>        Object oAlumnosNombre is a cWebColumn
38870>>>            Entry_Item Alumnos.Nombre
38871>>>            Set psCaption to "Alumnos.Nombre"
38872>>>            Set piWidth to 1000
38873>>>        End_Object 
38874>>>
38874>>>        Object oAlumnosApellidos is a cWebColumn
38876>>>            Entry_Item Alumnos.Apellidos
38877>>>            Set psCaption to "Alumnos.Apellidos"
38878>>>            Set piWidth to 1000
38879>>>        End_Object 
38880>>>
38880>>>        Object oDetailButton is a cWebColumnButton
38882>>>            Set psCaption to "btn"
38883>>>            Set piWidth to 45
38884>>>            Set pbFixedWidth to True
38885>>>            Set pbResizable to False
38886>>>            Set piListRowSpan to 2
38887>>>            Set psBtnCssClass to "WebButtonIcon WebIcon_Info"
38888>>>            Set peAlign to alignRight
38889>>>
38889>>>            WebRegisterPath ntNavigateForward oZoomAllStudents
38895>>>
38895>>>            Procedure OnClick
38898>>>                Send NavigatePath
38899>>>            End_Procedure
38900>>>
38900>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38903>>>                Move True to NavigateData.bReadOnly
38904>>>            End_Procedure
38905>>>
38905>>>        End_Object 
38906>>>
38906>>>        Object oAlumnosDni is a cWebColumn
38908>>>            Entry_Item Alumnos.Dni
38909>>>            Set psCaption to "Alumnos.Dni"
38910>>>            Set piWidth to 100
38911>>>            Set pbNewLine to True
38912>>>            Set psCSSClass to "RowDetail"
38913>>>        End_Object 
38914>>>
38914>>>        Object oCentrosId is a cWebColumn
38916>>>            Entry_Item Centros.Id
38917>>>            Set psCaption to "Alumnos.CentrosId"
38918>>>            Set piWidth to 100
38919>>>            Set psCSSClass to "RowDetail"
38920>>>        End_Object 
38921>>>
38921>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38921>>>//        WebRegisterPath ntNavigateForward oSelectView
38921>>>
38921>>>        Procedure OnRowClick String sRowId
38924>>>            tWebNavigateData NavigateData
38924>>>            tWebNavigateData NavigateData
38924>>>            Get GetNavigateData to NavigateData
38925>>>
38925>>>            Case Begin
38925>>>                Case (NavigateData.eNavigateType = nfFromParent)
38927>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38927>>>Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
38928>>>>
38928>>>//                    Send NavigateForward of oSelectView Self
38928>>>                    Case Break
38929>>>
38929>>>                Case (NavigateData.eNavigateType = nfFromChild)
38932>>>                    Send NavigateClose Self
38933>>>                    Case Break
38934>>>
38934>>>                Case (NavigateData.eNavigateType = nfFromMain)
38937>>>                    Send NavigateClose Self
38938>>>                    Case Break
38939>>>
38939>>>                Case Else // must be nfUndefined
38939>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
38939>>>Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
38940>>>>
38940>>>//                    Send NavigateForward of oSelectView Self
38940>>>
38940>>>            Case End
38940>>>        End_Procedure
38941>>>
38941>>>        Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38944>>>            Move True to NavigateData.bReadOnly
38945>>>        End_Procedure
38946>>>
38946>>>    End_Object 
38947>>>
38947>>>    Object oActionGroup is a cWebMenuGroup
38949>>>
38949>>>        Object oSearch is a cWebMenuItem
38951>>>            Set psCSSClass to "WebPromptMenuItem"
38952>>>            Set psCaption to "Search"
38953>>>
38953>>>            Procedure OnClick
38956>>>                Send Search of oList
38957>>>            End_Procedure
38958>>>
38958>>>        End_Object 
38959>>>
38959>>>        Object oNewButton is a cWebMenuItem
38961>>>            Set psCSSClass to "WebClearMenuItem"
38962>>>            Set psCaption to "New"
38963>>>
38963>>>            WebRegisterPath ntNavigateForward oZoomAllStudents
38969>>>
38969>>>            Procedure OnClick
38972>>>                Send NavigatePath
38973>>>            End_Procedure
38974>>>
38974>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
38977>>>                Move True to NavigateData.bNewRecord
38978>>>            End_Procedure
38979>>>
38979>>>        End_Object 
38980>>>    End_Object 
38981>>>
38981>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
38984>>>        WebSet pbRender of oNewButton to True
38985>>>        WebSet pbRender of oDetailButton to True
38986>>>
38986>>>        Case Begin
38986>>>            Case (NavigateData.eNavigateType = nfFromParent)
38988>>>                // If from parent, this is a constrained drill down
38988>>>                Case Break
38989>>>
38989>>>            Case (NavigateData.eNavigateType = nfFromChild)
38992>>>                // If from child, this is a probably a parent lookup from a Zoom
38992>>>                Case Break
38993>>>
38993>>>            Case (NavigateData.eNavigateType = nfFromMain)
38996>>>                // If from main, this is a probably a main-file lookup from a Zoom
38996>>>                WebSet pbRender of oDetailButton to False
38997>>>                Case Break
38998>>>
38998>>>            Case Else // must be nfUndefined
38998>>>                // This may be the start of a drilldown query or this may be used for some kind of custom query.
38998>>>
38998>>>        Case End
38998>>>
38998>>>    End_Procedure
38999>>>
38999>>>
38999>>>End_Object 
39000>    Use ZoomCentros.wo
Including file: ZoomCentros.wo    (C:\DataFlex Projects\Centros\AppSrc\ZoomCentros.wo)
39000>>>// C:\DataFlex Projects\Centros\AppSrc\ZoomCentros.wo
39000>>>// Centros
39000>>>//
39000>>>
39000>>>Use cWebView.pkg
39000>>>Use cWebPanel.pkg
39000>>>Use cWebMenuGroup.pkg
39000>>>Use cWebMenuItem.pkg
39000>>>Use cWebForm.pkg
39000>>>Use cWebTabContainer.pkg
39000>>>Use cWebTabPage.pkg
39000>>>
39000>>>Use cCentrosDataDictionary.dd
39000>>>
39000>>>Object oZoomCentros is a cWebView
39002>>>    Set piColumnCount to 12
39003>>>    Set psCaption to "Centros"
39004>>>    Set peWebViewStyle to wvsDrilldown
39005>>>    Set peViewType to vtZoom
39006>>>    Set pbShowCaption to False
39007>>>    Set Verify_Save_Msg to 0
39008>>>    Set piMaxWidth to 1024
39009>>>
39009>>>    Object oCentros_DD is a cCentrosDataDictionary
39011>>>    End_Object 
39012>>>
39012>>>    Set Main_DD To oCentros_DD
39013>>>    Set Server  To oCentros_DD
39014>>>
39014>>>
39014>>>    Object oWebMainPanel is a cWebPanel
39016>>>        Set piColumnCount to 12
39017>>>        WebSetResponsive piColumnCount rmMobile to 4
39018>>>
39018>>>        Object oCentrosNombre is a cWebForm
39020>>>            Entry_Item Centros.Nombre
39021>>>            Set piColumnSpan to 6
39022>>>            Set piColumnIndex to 0
39023>>>            Set peLabelPosition to lpTop
39024>>>            Set psLabel to "Nombre"
39025>>>        End_Object 
39026>>>
39026>>>        Object oCentrosPsNombre is a cWebForm
39028>>>            Entry_Item Centros.PsNombre
39029>>>            Set piColumnSpan to 6
39030>>>            Set piColumnIndex to 6
39031>>>            Set peLabelPosition to lpTop
39032>>>            Set psLabel to "PsNombre"
39033>>>        End_Object 
39034>>>
39034>>>        Object oCentrosEmpresa is a cWebForm
39036>>>            Entry_Item Centros.Empresa
39037>>>            Set piColumnSpan to 8
39038>>>            Set piColumnIndex to 0
39039>>>            Set peLabelPosition to lpTop
39040>>>            Set psLabel to "Empresa"
39041>>>        End_Object 
39042>>>
39042>>>        Object oWebTabContainer is a cWebTabContainer
39044>>>            Set pbFillHeight to True
39045>>>            Set piColumnSpan to 12
39046>>>            Set pbShowLabel to False
39047>>>
39047>>>            Object oPage1 is a cWebTabPage
39049>>>                Set piColumnCount to 12
39050>>>                Set psCaption to "Ubicación"
39051>>>                WebSetResponsive piColumnCount rmMobile to 4
39052>>>
39052>>>                Object oCentrosPais is a cWebCombo
39054>>>                    Entry_Item Centros.Pais
39055>>>                    Set piColumnSpan to 4
39056>>>                    Set piColumnIndex to 0
39057>>>                    Set peLabelPosition to lpTop
39058>>>                    Set psLabel to "Pais"
39059>>>                    Set pbServerOnChange to True
39060>>>//                    
39060>>>//                    String[][] aResultsPaises
39060>>>
39060>>>                    Procedure OnFill
39063>>>                    Integer inumPaises i
39063>>>                        Forward Send OnFill
39065>>>                        
39065>>>                        Get SQLExecDirect of ghoSQLExecutor @SQL" SELECT id, Nombre                            from Centros.dbo.Country;" to aResultsPaises
39066>>>                            
39066>>>                        Move (SizeOfArray(aResultsPaises[0])) to inumPaises    
39067>>>                        If (not(Err)) Begin
39069>>>                             For i from 0 to (inumPaises - 1)
39075>>>>
39075>>>                                Send AddComboItem aResultsPaises[i][0] aResultsPaises[i][1] 
39076>>>                             Loop
39077>>>>
39077>>>                        End
39077>>>>
39077>>>                     
39077>>>                        
39077>>>                        
39077>>>                    End_Procedure
39078>>>
39078>>>                    Procedure OnChange String sNewValue String sOldValue
39081>>>                        Forward Send OnChange sNewValue sOldValue
39083>>>                        WebSet psValue of oCentrosComunidadAutonoma to ""
39084>>>                        WebSet psValue of oCentrosLocalidad to ""
39085>>>                       Send Refill of oCentrosComunidadAutonoma 
39086>>>                    End_Procedure
39087>>>
39087>>>                    
39087>>>                    
39087>>>                End_Object 
39088>>>
39088>>>                Object oCentrosComunidadAutonoma is a cWebCombo
39090>>>                    Entry_Item Centros.ComunidadAutonoma                   
39091>>>                    Set piColumnSpan to 4
39092>>>                    Set piColumnIndex to 4
39093>>>                    Set peLabelPosition to lpTop
39094>>>                    Set psLabel to "Comunidad Autonoma"
39095>>>                    Set pbServerOnChange to True
39096>>>                    
39096>>>                    
39096>>>                    Procedure OnFill
39099>>>                        Forward Send OnFill
39101>>>                        String  sPaisElegido sSQL
39101>>>                        Integer  inumComunidadAutonoma  i
39101>>>                        String[][]  aResults
39102>>>                 
39102>>>                        WebGet psValue of oCentrosPais to sPaisElegido                   
39103>>>                        If (sPaisElegido = "") Procedure_Return
39106>>>                        Move ("SELECT S.id AS ComunidadAutonomaId, S.Nombre AS ComunidadAutonoma FROM Centros.dbo.State S WHERE S.CountryId = '" + sPaisElegido + "';") to sSQL 
39107>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
39108>>>                                                
39108>>>                        If (not(Err)) Begin
39110>>>                            Move (SizeOfArray(aResults)) to inumComunidadAutonoma    
39111>>>                            For i from 0 to (inumComunidadAutonoma - 1)
39117>>>>
39117>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
39118>>>                            Loop
39119>>>>
39119>>>                        End                        
39119>>>>
39119>>>                    End_Procedure
39120>>>                    
39120>>>                    Procedure OnChange String sNewValue String sOldValue
39123>>>                        Forward Send OnChange sNewValue sOldValue
39125>>>                        Send Refill of oCentrosLocalidad 
39126>>>                        WebSet psValue of oCentrosLocalidad to ""
39127>>>                    End_Procedure    
39128>>>                    
39128>>>                    
39128>>>                End_Object 
39129>>>
39129>>>                Object oCentrosLocalidad is a cWebCombo
39131>>>                    Entry_Item Centros.Localidad
39132>>>                    Set piColumnSpan to 4
39133>>>                    Set piColumnIndex to 8
39134>>>                    Set peLabelPosition to lpTop
39135>>>                    Set psLabel to "Provincia"
39136>>>                    Set pbServerOnChange to True
39137>>>                    
39137>>>                    
39137>>>                    Procedure OnFill
39140>>>                        Forward Send OnFill
39142>>>                        String  sComunidadAutonomaElegida sSQL
39142>>>                        Integer  inumProvincia  i
39142>>>                        String[][]  aResults
39143>>>                 
39143>>>                        WebGet psValue of oCentrosComunidadAutonoma to sComunidadAutonomaElegida                   
39144>>>                        If (sComunidadAutonomaElegida = "") Procedure_Return
39147>>>                        Move ("SELECT P.id AS ProvinciaId, P.Nombre AS Provincia FROM Centros.dbo.Province P WHERE P.StateId = '" + sComunidadAutonomaElegida + "';") to sSQL 
39148>>>                        Get SQLExecDirect of ghoSQLExecutor sSQL to aResults
39149>>>                                                
39149>>>                        If (not(Err)) Begin
39151>>>                            Move (SizeOfArray(aResults)) to inumProvincia    
39152>>>                            For i from 0 to (inumProvincia - 1)
39158>>>>
39158>>>                                Send AddComboItem (aResults[i][0]) (aResults[i][1])
39159>>>                            Loop
39160>>>>
39160>>>                        End                        
39160>>>>
39160>>>                    End_Procedure
39161>>>            
39161>>>                End_Object 
39162>>>
39162>>>                Object oCentrosDireccion is a cWebForm
39164>>>                    Entry_Item Centros.Direccion
39165>>>                    Set piColumnSpan to 9
39166>>>                    Set piColumnIndex to 0
39167>>>                    Set peLabelPosition to lpTop
39168>>>                    Set psLabel to "Direccion"
39169>>>                End_Object 
39170>>>
39170>>>                Object oCentrosCodigoPostal is a cWebForm
39172>>>                    Entry_Item Centros.CodigoPostal
39173>>>                    Set piColumnSpan to 2
39174>>>                    Set piColumnIndex to 9
39175>>>                    Set peLabelPosition to lpTop
39176>>>                    Set psLabel to "Codigo Postal"
39177>>>                End_Object 
39178>>>            End_Object 
39179>>>
39179>>>            Object oPage2 is a cWebTabPage
39181>>>                Set piColumnCount to 12
39182>>>                Set psCaption to "Datos de Registro"
39183>>>                WebSetResponsive piColumnCount rmMobile to 4
39184>>>
39184>>>                Object oCentrosFechaCreacionRegistro is a cWebForm
39186>>>                    Entry_Item Centros.FechaCreacionRegistro
39187>>>                    Set piColumnSpan to 3
39188>>>                    Set piColumnIndex to 0
39189>>>                    Set peLabelPosition to lpTop
39190>>>                    Set psLabel to "Fecha de creacion del registro"
39191>>>                End_Object 
39192>>>
39192>>>                Object oCentrosFechaUltimaModificacion is a cWebForm
39194>>>                    Entry_Item Centros.FechaUltimaModificacion
39195>>>                    Set piColumnSpan to 3
39196>>>                    Set piColumnIndex to 3
39197>>>                    Set peLabelPosition to lpTop
39198>>>                    Set psLabel to "Fecha ultima de la modificacion"
39199>>>                End_Object 
39200>>>            End_Object 
39201>>>        End_Object 
39202>>>    End_Object 
39203>>>
39203>>>    Object oActionGroup is a cWebMenuGroup
39205>>>
39205>>>        Object oSaveBtn is a cWebMenuItem
39207>>>            Set psCSSClass to "WebSaveMenuItem"
39208>>>            Set psCaption to "Save"
39209>>>
39209>>>            Procedure OnClick
39212>>>                Send Request_Save
39213>>>            End_Procedure
39214>>>
39214>>>        End_Object 
39215>>>
39215>>>        Object oEditBtn is a cWebMenuItem
39217>>>            Set psCSSClass to "WebEditMenuItem"
39218>>>            Set psCaption to "Edit"
39219>>>            Procedure OnClick
39222>>>                Send ChangeEditMode True
39223>>>                Send SetActionButtons
39224>>>            End_Procedure
39225>>>
39225>>>        End_Object 
39226>>>
39226>>>        Object oDeleteBtn is a cWebMenuItem
39228>>>            Set psCSSClass to "WebDeleteMenuItem"
39229>>>            Set psCaption to "Delete"
39230>>>            Set peActionDisplay to adMenu
39231>>>
39231>>>            Procedure OnClick
39234>>>                Send Request_Delete
39235>>>            End_Procedure
39236>>>
39236>>>        End_Object 
39237>>>
39237>>>        Object oCancelChangesBtn is a cWebMenuItem
39239>>>            Set psCSSClass to "WebIcon_Refresh"
39240>>>            Set psCaption to "Clear Changes"
39241>>>            Set peActionDisplay to adMenu
39242>>>            Procedure OnClick
39245>>>                Send RefreshRecord
39246>>>            End_Procedure
39247>>>
39247>>>        End_Object 
39248>>>    End_Object 
39249>>>
39249>>>    Procedure SetActionButtons
39252>>>        tWebNavigateData NavigateData
39252>>>        tWebNavigateData NavigateData
39252>>>        Boolean bHasRecord
39252>>>        Handle hoDD
39252>>>
39252>>>        Get Server to hoDD
39253>>>        Get GetNavigateData to NavigateData
39254>>>        Get HasRecord of hoDD to bHasRecord
39255>>>
39255>>>        // let's hide all buttons and then Show the ones we want
39255>>>        WebSet pbRender of oEditBtn to False
39256>>>        WebSet pbRender of oSaveBtn to False
39257>>>        WebSet pbRender of oCancelChangesBtn to False
39258>>>        WebSet pbRender of oDeleteBtn to False
39259>>>
39259>>>        If (NavigateData.bReadOnly) Begin
39261>>>            WebSet pbRender of oEditBtn to True
39262>>>        End
39262>>>>
39262>>>        Else Begin
39263>>>            WebSet pbRender of oSaveBtn to True
39264>>>            WebSet pbRender of oCancelChangesBtn to True
39265>>>            WebSet pbRender of oDeleteBtn to bHasRecord
39266>>>        End
39266>>>>
39266>>>    End_Procedure
39267>>>
39267>>>    Procedure OnViewSaved Handle hoServer Boolean bChanged
39270>>>        // Close after save
39270>>>        Send NavigateClose Self
39271>>>    End_Procedure
39272>>>
39272>>>    // this will close the view after a delete
39272>>>    Procedure OnViewDeleted Handle hoDDO
39275>>>        Send NavigateClose Self
39276>>>    End_Procedure
39277>>>
39277>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
39280>>>        Case Begin
39280>>>            Case (NavigateData.eNavigateType = nfFromMain)
39282>>>                // If from main, this is a propbably a main file Select to Zoom.
39282>>>                Case Break
39283>>>
39283>>>            Case (NavigateData.eNavigateType = nfFromParent)
39286>>>                // If from parent, this is a constrained drill down.
39286>>>                Case Break
39287>>>
39287>>>            Case (NavigateData.eNavigateType = nfFromChild)
39290>>>                // If from child, this is a probably a parent Zoom from a Zoom.
39290>>>                Case Break
39291>>>
39291>>>            Case Else // must be nfUndefined
39291>>>
39291>>>        Case End
39291>>>
39291>>>        Send SetActionButtons
39292>>>
39292>>>    End_Procedure
39293>>>
39293>>>    Procedure OnBeforeShow
39296>>>        Forward Send OnBeforeShow
39298>>>        Send Refill of oCentrosComunidadAutonoma
39299>>>        Send Refill of oCentrosLocalidad
39300>>>    End_Procedure
39301>>>
39301>>>End_Object 
39302>    Use SelectCentro.wo
Including file: SelectCentro.wo    (C:\DataFlex Projects\Centros\AppSrc\SelectCentro.wo)
39302>>>// C:\DataFlex Projects\Centros\AppSrc\SelectCentro.wo
39302>>>// Centro
39302>>>//
39302>>>
39302>>>Use cWebView.pkg
39302>>>Use cWebList.pkg
39302>>>Use cWebMenuGroup.pkg
39302>>>Use cWebMenuItem.pkg
39302>>>Use cWebColumnButton.pkg
39302>>>Use cWebColumn.pkg
39302>>>Use ZoomCentros.wo
39302>>>
39302>>>Use cCentrosDataDictionary.dd
39302>>>Use cWebLabel.pkg
39302>>>
39302>>>Object oSelectCentro is a cWebView
39304>>>    Set psCaption to "Centro"
39305>>>    Set peWebViewStyle to wvsDrilldown
39306>>>    Set peViewType to vtSelect
39307>>>    Set piColumnCount to 12
39308>>>    Set pbShowCaption to False
39309>>>    Set piMaxWidth to 1024
39310>>>
39310>>>    Object oCentros_DD is a cCentrosDataDictionary
39312>>>    End_Object 
39313>>>
39313>>>    Set Main_DD To oCentros_DD
39314>>>    Set Server  To oCentros_DD
39315>>>
39315>>>
39315>>>    Object oList is a cWebList
39317>>>        Set piColumnSpan to 0
39318>>>        Set psCSSClass to "MobileList"
39319>>>        Set pbServerOnRowClick to True
39320>>>        Set pbFillHeight to True
39321>>>        Set pbShowHeader to False
39322>>>        Set piSortColumn to 0
39323>>>
39323>>> 
39323>>>        
39323>>>        Object oCentrosPsNombre is a cWebColumn
39325>>>            Entry_Item Centros.PsNombre
39326>>>            Set psCaption to "Centros.PsNombre"
39327>>>            Set psCSSClass to "RowCapion"
39328>>>            Set piWidth to 750
39329>>>        End_Object 
39330>>>    
39330>>>        Object oCentrosEmpresa is a cWebColumn
39332>>>            Entry_Item Centros.Empresa
39333>>>            Set psCaption to "Centros.Empresa"
39334>>>            Set piWidth to 188
39335>>>        End_Object 
39336>>>
39336>>>        Object oDetailButton is a cWebColumnButton
39338>>>            Set psCaption to "btn"
39339>>>            Set piWidth to 126
39340>>>            Set pbFixedWidth to True
39341>>>            Set pbResizable to False
39342>>>            Set piListRowSpan to 2
39343>>>            Set psBtnCssClass to "WebButtonIcon WebIcon_Info"
39344>>>            Set peAlign to alignRight
39345>>>            
39345>>>
39345>>>            WebRegisterPath ntNavigateForward oZoomCentros
39351>>>
39351>>>            Procedure OnClick
39354>>>                Send NavigatePath
39355>>>            End_Procedure
39356>>>
39356>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39359>>>                Move True to NavigateData.bReadOnly
39360>>>            End_Procedure
39361>>>
39361>>>        End_Object 
39362>>>
39362>>>        
39362>>>        Object oCentrosNombre is a cWebColumn
39364>>>            Entry_Item Centros.Nombre
39365>>>            Set psCaption to "Centros.Nombre"
39366>>>            Set piWidth to 750
39367>>>            Set psCSSClass to "RowDetail"
39368>>>            Set pbNewLine to True
39369>>>        End_Object
39370>>>
39370>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39370>>>       WebRegisterPath ntNavigateForward oZoomCentros
39376>>>
39376>>>        Procedure OnRowClick String sRowId
39379>>>            tWebNavigateData NavigateData
39379>>>            tWebNavigateData NavigateData
39379>>>            Get GetNavigateData to NavigateData
39380>>>
39380>>>            Case Begin
39380>>>                Case (NavigateData.eNavigateType = nfFromParent)
39382>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39382>>>//Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
39382>>>//                    Send NavigateForward of oSelectView Self
39382>>>                    Case Break
39383>>>
39383>>>                Case (NavigateData.eNavigateType = nfFromChild)
39386>>>                    Send NavigateClose Self
39387>>>                    Case Break
39388>>>
39388>>>                Case (NavigateData.eNavigateType = nfFromMain)
39391>>>                    Send NavigateClose Self
39392>>>                    Case Break
39393>>>
39393>>>                Case Else // must be nfUndefined
39393>>>// ToDo: Fill in the from-parent child Select view object name for navigate forward
39393>>>//Error DFERR_PROGRAM "NavigateForward to this from-parent child Select view not yet defined"
39393>>>//                    Send NavigateForward of oSelectCentro Self
39393>>>
39393>>>            Case End
39393>>>        End_Procedure
39394>>>
39394>>>        Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39397>>>            Move True to NavigateData.bReadOnly
39398>>>        End_Procedure
39399>>>
39399>>>    End_Object 
39400>>>
39400>>>    Object oActionGroup is a cWebMenuGroup
39402>>>
39402>>>        Object oSearch is a cWebMenuItem
39404>>>            Set psCSSClass to "WebPromptMenuItem"
39405>>>            Set psCaption to "Search"
39406>>>
39406>>>            Procedure OnClick
39409>>>                Send Search of oList
39410>>>            End_Procedure
39411>>>
39411>>>        End_Object 
39412>>>
39412>>>        Object oNewButton is a cWebMenuItem
39414>>>            Set psCSSClass to "WebClearMenuItem"
39415>>>            Set psCaption to "New"
39416>>>
39416>>>            WebRegisterPath ntNavigateForward oZoomCentros
39422>>>
39422>>>            Procedure OnClick
39425>>>                Send NavigatePath
39426>>>            End_Procedure
39427>>>
39427>>>            Procedure OnGetNavigateForwardData tWebNavigateData ByRef NavigateData Handle hoToView
39430>>>                Move True to NavigateData.bNewRecord
39431>>>            End_Procedure
39432>>>
39432>>>        End_Object 
39433>>>    End_Object 
39434>>>
39434>>>    Procedure OnNavigateForward tWebNavigateData NavigateData Integer hoInvokingView Integer hoInvokingObject
39437>>>        WebSet pbRender of oNewButton to True
39438>>>        WebSet pbRender of oDetailButton to True
39439>>>
39439>>>        Case Begin
39439>>>            Case (NavigateData.eNavigateType = nfFromParent)
39441>>>                // If from parent, this is a constrained drill down
39441>>>                Case Break
39442>>>
39442>>>            Case (NavigateData.eNavigateType = nfFromChild)
39445>>>                // If from child, this is a probably a parent lookup from a Zoom
39445>>>                Case Break
39446>>>
39446>>>            Case (NavigateData.eNavigateType = nfFromMain)
39449>>>                // If from main, this is a probably a main-file lookup from a Zoom
39449>>>                WebSet pbRender of oDetailButton to False
39450>>>                Case Break
39451>>>
39451>>>            Case Else // must be nfUndefined
39451>>>                // This may be the start of a drilldown query or this may be used for some kind of custom query.
39451>>>
39451>>>        Case End
39451>>>
39451>>>    End_Procedure
39452>>>
39452>>>
39452>>>End_Object 
39453>    Use DummieTelefono.wo
Including file: DummieTelefono.wo    (C:\DataFlex Projects\Centros\AppSrc\DummieTelefono.wo)
39453>>>Use cWebView.pkg
39453>>>Use cWebPanel.pkg
39453>>>Use cWebForm.pkg 
39453>>>Use cWebGroup.pkg
39453>>>Use cWebMenuGroup.pkg 
39453>>>Use cWebMenuItem.pkg
39453>>>
39453>>>Use zTelefonoiValidation.pkg
39453>>>
39453>>>Object oDummieTelefono is a cWebView
39455>>>
39455>>>    // Your DDO structure will go here
39455>>>    Set piWidth to 700
39456>>>    Set psCaption to "DummieDni"
39457>>>
39457>>>    // Your DDO structure will go here
39457>>>
39457>>>    Object oWebMainPanel is a cWebPanel
39459>>>        Set piColumnCount to 12
39460>>>
39460>>>        Object oForm_Prefijo is a cWebForm
39462>>>            Set piColumnSpan to 3
39463>>>            Set psLabel to "Prefijo telefonico"
39464>>>            Set peLabelPosition to lpTop
39465>>>        End_Object
39466>>>        
39466>>>        // place controls here
39466>>>        // Your view will grow as controls are added
39466>>>        
39466>>>        Object oForm_telefono is a cWebForm
39468>>>            Set piColumnSpan to 9
39469>>>            Set psLabel to "Introduzca el telefono"
39470>>>            Set piColumnIndex to 3
39471>>>            Set peLabelPosition to lpTop
39472>>>        End_Object
39473>>>
39473>>>        Object oWebLabel_sMsg_Err is a cWebLabel
39475>>>            Set psCaption to ""
39476>>>            Set piColumnIndex to 0
39477>>>            Set piColumnSpan to 12
39478>>>        End_Object
39479>>>
39479>>>        Object oWebSpacer1 is a cWebSpacer
39481>>>            Set piColumnSpan to 12
39482>>>        End_Object
39483>>>
39483>>>        Object oValidationButton is a cWebButton
39485>>>            Set piColumnSpan to 6
39486>>>            Set psCaption to "Validar"
39487>>>            Set piColumnIndex to 3
39488>>>        
39488>>>            Procedure OnClick
39491>>>                Boolean bRet
39491>>>                String sTelefono sPrefijo sMsg
39491>>>                WebGet psValue of oForm_telefono to sTelefono
39492>>>                WebGet psValue of oForm_Prefijo to sPrefijo
39493>>>                Get zTelefonoValidation True sPrefijo sTelefono (&sMsg) to bRet
39494>>>                
39494>>>                WebSet psBackgroundColor of oForm_telefono to "#ffffff"
39495>>>                WebSet psBackgroundColor of oForm_Prefijo to "#ffffff"
39496>>>                WebSet psCaption of oWebLabel_sMsg_Err to ""
39497>>>                
39497>>>                If (bRet) Begin
39499>>>                    WebSet psBackgroundColor of oForm_telefono to "green"
39500>>>                    WebSet psBackgroundColor of oForm_Prefijo to "green"
39501>>>                    
39501>>>                End
39501>>>>
39501>>>                If (not (bRet)) Begin
39503>>>                    WebSet psBackgroundColor of oForm_Prefijo to "red"
39504>>>                    WebSet psBackgroundColor of oForm_telefono to "red"
39505>>>                    WebSet psCaption of oWebLabel_sMsg_Err to sMsg
39506>>>                End
39506>>>>
39506>>>                
39506>>>                
39506>>>            End_Procedure
39507>>>        End_Object
39508>>>        
39508>>>    End_Object
39509>>>
39509>>>    Procedure OnBeforeShow
39512>>>        Forward Send OnBeforeShow
39514>>>        WebSet psValue of oForm_Prefijo to "+34"
39515>>>    End_Procedure
39516>>>
39516>>>End_Object
39517>    Set phoDefaultView to oDashboard
39518>
39518>End_Object
39519>
39519>Send StartWebApp of oWebApp
39520>
Summary
Memory Available: 8100663296
Total Warnings : 0
Total Errors   : 0
Total Symbols  : 26024
Total Resources: 0
Total Commands : 39519
Total Windows  : 0
Total Pages    : 0
Static Data    : 494457
Message area   : 264488
Total Blocks   : 17589
